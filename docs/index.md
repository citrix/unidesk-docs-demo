#Welcome to Citrix App Layering 4<a name="Welcome_to_Citrix_App_Layering_4"></a>
In this article:
<table><tbody><tr><td><p>The ultimate in application management simplicity</p><p>Provision servers in any environment</p><p>Deliver applications with ease</p><p>A simple addition to your environment</p><p>Get started</p></td></tr></tbody></table>
##The ultimate in application management simplicity<a name="The_ultimate_in_application_management_simplicity"></a><a name="Applicat"></a>
Unidesk makes it easier to manage your Windows applications. Regardless of which hypervisor or provisioning service you use, Unidesk can help you manage your applications and operating systems.
Unidesk separates the management of your Operating System and applications from your infrastructure. With Unidesk you can install each of your applications and operating system patches once, and use them as part of any image you deploy. You can publish Layered Images as open standard virtual disks usable in any environment. This allows you to maintain a single Windows installation, and a single copy of each application, that you use for all of your images across all of your virtual environments.
<ul><li>Unidesk wraps each of your applications in a Layer, and stores the Layers as virtual disks.</li><li>You can pull together any combination of these App Layers and an OS Layer as part of a Layered Image, and publish it to your target platform.</li><li>That means that you can install an application or an operating system once, and deploy it as part of any number of images.</li></ul>
##Provision servers in any environment<a name="Provision_servers_in_any_environment"></a><a name="Provision"></a>
Unidesk lets you to package any Windows app as a virtual disk ***Layer***  and deliver it, installation-free, to session hosts. With Unidesk Layering, you can:
<ul><li>Install and manage a single copy of your Windows OS and a single copy of each of your applications in Layers.</li><li>Select any combination of Layers to create Layered Images that are deployable as Session Hosts.</li><li>Deploy those Layered Images to virtual machine session hosts, making the applications available to users.</li></ul>
New applications, application updates, and Windows patches can be delivered to an entire RDSH farm with a single image update.
##Deliver applications with ease<a name="Deliver_applications_with_ease"></a><a name="Provide"></a>
Using the Unidesk Management Console, you can:
<ul><li>Layer Applications and deliver them as read-only virtual disks to session hosts. Layering is faster and easier than app virtualization and is compatible with more apps. Layers have the look and feel of a local installation and enable full application interoperability.</li><li>Layer a Windows OS and deliver it as a read-only virtual disk to all session hosts. Patch an OS layer once to update an entire RDSH server farm.</li><li>Maintain platform-independent OS and App Layers by creating Platform Layers to hold infrastructure-related software and settings.</li><li>Provision RDSH VMs. You can create custom RDSH virtual machines by assigning any combination of compatible OS and App layers in any order.</li></ul>
##A simple addition to your environment<a name="A_simple_addition_to_your_environment"></a><a name="Works"></a>
The heart of the Unidesk deployment is the Enterprise Layer Manager (ELM), a virtual appliance that you deploy in your environment. The ELM hosts the Unidesk Management Console (UMC), a friendly interface where you create Unidesk Layers and assign the OS Layer and App Layers for each of your Layered Images.
###Unidesk Layers<a name="Unidesk_Layers"></a>
With Unidesk you can create an OS Layer or App Layer once, and use it to create any number of images. You can then update the OS or application by adding a new Version to the Layer for each patch or update that you apply.
In App Layers you can deploy virtually any applications compatible with the OS. Each App Layer can include one or more applications. When it's time to upgrade an application, you can add a new version to the Layer for the latest update.
Platform Layers are designed to support your environment. A Platform Layer containing your hypervisor tools and settings makes it easy to create layers using VMs in your hypervisor environment. A Platform Layer containing your hypervisor, provisioning service, and connection broker software isolates App and OS Layers from the infrastructure where they will be published.
###Layered Images for provisioning Session Hosts<a name="Layered_Images_for_provisioning_Session_Hosts"></a>
Image Templates are where you choose the Operating System and Layer assignments for an Image. You can include OS and App layers in any number of Image Templates. Using an Image Template and a Platform Layer, you can publish a Layered Image to your provisioning service, hypervisor, or network file share .
You can publish Layered Images as virtual disks to any location to which the ELM has access, and use the disks to provision as many servers as you need.
###Platform Connectors<a name="Platform_Connectors"></a>
A Unidesk Platform Connector configured with the credentials for a specific location in your virtual environment, allows Unidesk to publish the Layered Images and provision servers in a specific location.
##Compatibility<a name="Compatibility"></a>
For compatibility details, see Supported Platforms.
##Get started<a name="Get_started"></a><a name="Get"></a>
If you haven't yet started your free trial, you can find out how to install Unidesk [here](#Install_the_Unidesk_Enterprise_Layer_Manager_(ELM))[.](#Install_the_Unidesk_Enterprise_Layer_Manager_(ELM))


#Unidesk Release Notes and Platform Support<a name="Unidesk_Release_Notes_and_Platform_Support"></a>
Find out what's new, what to watch out for, and what platforms are supported in this release.


#Unidesk 4 Release Notes<a name="Unidesk_4_Release_Notes"></a>
In this article:
<table><tbody><tr><td><p>Welcome to Unidesk 4.0.8!</p><p>Unidesk 4 Release Notes</p><p>New in Unidesk Labs!</p><p>Supported Platforms</p><p>Upgrade path</p><p>Known issues and considerations</p><p>How can I contact Unidesk?</p></td></tr></tbody></table>
##Welcome to Unidesk 4.0.8!<a name="Welcome_to_Unidesk_4.0.8!"></a><a name="What's"></a>
This release adds full support for Nutanix AHV, making Unidesk the only solution to support all leading hypervisors. You now have complete agility and flexibility in deciding where to host your Windows workspaces, today and into the future.
We have also made performance improvements and added support for Windows Server 2016.
You'll also get your first look at the Unidesk 4 User Layer, now supported in Unidesk Labs. Those of you who have been waiting to test the ability to persist user settings, data, and applications in non-persistent VDI environments need wait no longer!
##What's new in this release?<a name="What(SINGLEQUOTE)s_new_in_this_release_"></a>
<ul><li><p><strong>Full support for Nutanix AHV.</strong> Unidesk now fully supports Nutanix AHV, adding to our existing support for Hyper-V, vSphere/ESX, Citrix XenServer, and Azure. Like the other platforms, you can now use Nutanix AHV to host the Unidesk Enterprise Layer Manager (ELM) virtual appliance; package App Layers and Layer versions; create and publish Layered Images; and use Elastic Layering to deliver custom applications to both virtual desktops and XenApp/RDSH sessions at login. You can also deliver Layers and Layered Images to all supported platforms without costly re-packaging or re-imaging. Moving your users from one end user computing environment or hypervisor to another, and managing across multiple environments has never been easier.</p></li><li><p><strong>Unidesk Connector for Citrix MCS support for Nutanix AHV.</strong> You can now publish Unidesk Layered Images directly to Citrix Machine Creation Services (MCS) running on Nutanix AHV. You'll be able to manage image content (OS and Apps) once with Unidesk and continue to use MCS to manage image delivery for both your XenApp and XenDesktop environments. Instead of having to update Windows and common applications once for every delivery group and MCS image, you'll only have to apply updates once.</p></li><li><p><strong>Windows Server 2016 Support.</strong> You can now use Windows Server 2016 as a supported operating system (OS) layer for Citrix XenApp and RDSH published application and desktop deployments. Import your Windows Server 2016 OS and you can start building App Layers and Platform Layers on top of it!</p></li><li><p><strong>Improved performance when Creating App Layers on VMware vSphere.</strong> You can configure the VMware vSphere Connector to cache boot and packaging disks and reuse them. Once these disks have been cached as part of creating your first App Layer, the time it takes to create subsequent App Layers is cut in half.</p></li><li><p><strong>Layer Management updates.</strong> We made several enhancements to general layer management usability including improvements to the Virtual Appliance Configuration Tool, the ability to edit the Layer version description, and listing the OS type in the OS Layer detail information.</p></li><li><p><strong>Imprivata OneSign Single Sign-On.</strong> Unidesk is fully compatible with Imprivata OneSign for single sign-on efficiency. Imprivata can be packaged as a Unidesk application layer to make distribution to all virtual workspaces fast and easy.</p></li><li><p><strong>Unidesk Roles.</strong> Previously released in Labs, Unidesk Roles are now generally available and with a new capability to assign Roles to AD Groups in addition to directly assigning Roles to individual users.</p></li><li><p><strong>Elastic Fit.</strong> Also previously released in Labs, Elastic Fit is now Generally Available. This feature alerts you if an Application Layer can be delivered as an Elastic Layer at login. Unidesk gives you the option of delivering applications as Layered Images or as Elastic Layers, Elastic Fit will advise you on which of Unidesk's layer delivery options to use.</p></li><li><p><a href="#User_Layer_(Unidesk_Labs)">User Layer (Unidesk Labs).</a> You can now test the ability to persist user profile settings, data, and user-installed applications in non-persistent VDI environments with the new User Layer. Initially, the User Layer will support Windows 7 64-bit environments for Citrix XenDesktop, VMware Horizon View and View JIT. Additional operating systems and session environments will be supported going forward.</p></li></ul>
##New in Unidesk Labs!<a name="New_in_Unidesk_Labs!"></a><a name="Early"></a>
<ul><li><p><a href="#top">User Layers (Unidesk Labs)</a>.</p><p>You can now test the ability to persist user profile settings, data, and user-installed applications in non-persistent VDI environments with the new User Layer. Initially, the User Layer will support Windows 7 64-bit environments for Citrix XenDesktop and VMware Horizon View. Additional operating systems and session environments will be supported going forward.</p></li></ul>
For the steps to enable Unidesk Labs features, click [here](#Enable_Unidesk_Labs_features_..6)[.](#Enable_Unidesk_Labs_features_..6)
##Supported Platforms<a name="Supported_Platforms_..482"></a><a name="Platform"></a>
For information about Unidesk-supported platforms, see Supported Platforms.
##Upgrade path<a name="Upgrade_path"></a><a name="Upgrade"></a>
You can upgrade from 4.0.x to the current release.
##Known issues and considerations<a name="Known_issues_and_considerations"></a><a name="Consider"></a>
###User Layer (Unidesk Labs)<a name="User_Layer_(Unidesk_Labs)_..483"></a>
<ul><li>MS Office should be in the Layered Image. If using add-ins or Office 365, you <em>must</em> include Office in the Layered Image, not in the User Layer. If not, you will have activation issues. (UNI-53474)</li><li>There are issues with Windows Search when using a User Layer. (UNI-53320), (UNI-54524), (UNI-54520)</li><li>Red '<span>X</span>' network adapter icon indicates there's an issue even when the network is functional. When using a User Layer, the network icon will appear as a red x, even when everything is functional. You can ignore the red '<span>X</span>'. (UNI-53443)</li></ul>
###Common across platforms<a name="Common_across_platforms"></a>
<ul><li>Tasks created prior to this release do not have fully qualified owners and can only be canceled by an Administrator. (UNI-52741)</li><li>App may appear to load slowly on a user's session. For applications that automatically update, like Chrome and Firefox, updates should be turned off. Windows will prompt the user to make changes with Admin rights even though the user does not have those rights. Instruct the user to click <strong>No</strong> when prompted, and the application will load successfully.</li><li>Unidesk Agent requires .NET Framework 4.5, but the installer lists 4.0 as a prerequisite.The Unidesk Agent needs .NET Framework 4.5 but lists 4.0 as a prerequisite. This causes the installer to fail when it reaches "Starting services", and the Unidesk Agent logs show the service trying to start up repeatedly. Please install .NET Framework 4.5 as a prerequisite for the Unidesk Agent. (UNI-50769)</li><li>User receives alert on first launch of an elastically assigned Skype Layer.When a Skype Layer is elastically assigned, the user receives this alert the first time the app is launched, "The Installer has insufficient privileges to modify this file: <em>url</em>." If the user clicks the <strong>Ignore</strong> button, Skype opens as expected. (UNI-52164) </li><li>Use the same hypervisor when adding a Version to your OS Layer. When adding a Version to an OS Layer, you must package the Layer on the same hypervisor from which you imported the OS during Layer creation. (UNI-44372)</li><li>After adding new disks to the ELM, be sure to reboot. When adding disks to expand storage, a reboot of the ELM is recommended after the disk expansion wizard has completed the operation. (UNI-53580)</li></ul>
####Elastic Layering
<ul><li>Elastic Layers require .NET Framework 4.5.If you are using Unidesk Elastic Layers, .NET Framework 4.5 must be installed on any Layered Image where Elastic Layers are enabled.</li><li>Empty directories visible to Windows Explorer users when Unidesk drivers are running. When an image has been enabled with Elastic Layering, a user using Windows Explorer to view files and directories may be able to see empty directories associated with other sessions using Elastic Layering if they also use Windows Explorer to browse files. Directories explored in the other session may create folders visible to all sessions that have the rights to browse that directory. The directories and the contents of them will not be visible to users who do not have access to the volume.</li><li>If using Elastic Layer Assignments with Windows Server 2008 or Windows 7, your fileshare must be created with a sector size of 512. <br></br> For details about this issue and related OS updates, see the Microsoft articles about <a href="https://support.microsoft.com/en-us/kb/2510009">Microsoft support policy for 4K sector hard drives in Windows</a>, and <a href="https://support.microsoft.com/en-us/kb/982018">Update that improves the compatibility of Win 7 and Win Server 2008 R2 with Advanced Format Disks</a>. (UNI-48984)</li><li>When using Elastic Layer Assignments, Persona Management in Horizon View is <em>not</em> supported. Although Unidesk supports Horizon View 6.1 and later, Elastic Layer Assignments do not work with these versions of View Persona Management. (UNI-53639) </li></ul>
####Elastic Layering MS Office
<ul><li>Shortcuts to elastically assigned Office apps may be visible on the Start menu for users who are not assigned the apps. Although these shortcuts are visible, they only work for users who are assigned the apps. (UNI-49687)</li><li>When MS Office is assigned elastically, use built-in license activation scripting. For best results when using office elastically, consider using built-in license activation scripting and adding c:\windows\setup\scripts\officeactivate.cmd to the script path when finalizing the Office App Layer or editing its properties. (UNI-50467)</li><li>When elastically layering MS Office, do not install One Note. Instead, include OneNote in the Layered Image. The One Note printer driver allows other Office apps to print to One Note. For further details, refer to the <a href="http://www.unidesk.com/forum/application-layer-recipes/microsoft-office-recipe">Microsoft Office Recipe</a>. (UNI-50449)</li></ul>
####Windows 10
<ul><li>Windows 10 upgrades require a 60 GB disk for the OS Layer Version. When adding a Version for upgrading your Windows 10 OS Layer, be sure to change the Max Layer Size from the default of 30 GB to the required 60 GB. (UNI-52422)</li><li>Additional step required when upgrading a major Win 10. During a major upgrade, for example when upgrading from 1511 to 1607, Windows 10 sometimes creates a Recovery Volume as a new partition on the same disk as the OS Layer Version. This volume should always be removed before you finalize the OS Layer Version. Otherwise, the recovery volume can cause desktops to fail to boot correctly. For the steps to safely remove a recovery volume, click <a href="http://www.unidesk.com/support/kb/windows-10-upgrade-may-result-new-recovery-volume-partition">here</a>. </li></ul>
###Citrix PVS<a name="Citrix_PVS"></a>
<ul><li>When creating an Image Template, the template's target device hardware settings must match the Windows OS and Platform Layer settings. Make sure the target device hardware settings match the OS and Platform layer hardware settings, especially the number of CPUs. If they don't match, you can get a <em>reboot required</em> message when the published image is booted. (UNI-50799, UNI-46333, UNI-51599)</li><li>When using PVS, you must disable IPv6 in the OS Layer. If this is configured in the Platform Layer instead of in the OS Layer, when the resulting PVS machines boot, they will lose their network connection and hang. (UNI-53600)</li><li>If permissions are wrong when publishing an image, you may get an error message that states that the operation has timed out. (UNI-54516)</li><li>Although the UMC allows image names that contain a period ("."), those names fail in the PVS environment. Do not include a period in the name. UNI-54263)</li></ul>
###XenServer<a name="XenServer"></a>
<ul><li>When preparing your OS image for use in XenServer, you must open port 5900. (UNI-50846)</li><li>Creating a Unidesk Connector Configuration that points to a <em>slave</em> node in a XenServer pool produces an unexpected error message. To avoid this issue, only use the <em>master</em> node when creating Connector Configurations. (UNI-52454) </li></ul>
###VMware Horizon View<a name="VMware_Horizon_View"></a>
Elastic layers are only supported with floating desktop pools. (UNI-53442) 
###Microsoft Azure<a name="Microsoft_Azure"></a><a name="Az_Considerations"></a>
<ul><li>The Azure File Share <em>feature</em> is not supported. However, you must create an NFS or SMB file share in Azure to use with Unidesk. (UNI-42272)</li><li>Publishing Layered Images simultaneously to the same Azure resource group fails. Either deploy one at a time, or deploy the Layered Images to different resource groups.(UNI-43376)</li><li>Using a Fully Qualified Domain Name (FQDN) in Azure can fail if not entered in the format Azure expects. When deploying in Azure, the Azure template requires the FQDN in a specific format, or it will fail. Click <a href="#IMPORTANT_FQDN">here</a> for details. (UNI-51587) </li></ul>
###Microsoft Hyper-V<a name="Microsoft_Hyper-V"></a>
<ul><li>When using Elastic Layering in Hyper-V, you must use <em>unmanaged</em> RDS pools. (UNI-53545) </li></ul>
###Imprivata<a name="Imprivata"></a>
<ul><li><p>Imprivata App Layers must be created with the appropriate broker Platform Layer as a prerequisite. This is critical for Citrix PVS/MCS and Horizon View environments</p></li></ul>
##How can I contact Unidesk?<a name="How_can_I_contact_Unidesk_"></a><a name="How"></a>
We welcome your feedback about this release.
<ul><li>Use our online <a href="http://www.unidesk.com/forum">Forum</a> to talk directly with Unidesk employees and other organizations deploying Unidesk.</li></ul>
<ul><li>For product issues and questions, open a <a href="http://success.unidesk.com/">Support Case</a>.</li></ul>
We look forward to hearing what you think about Unidesk 4!
#Supported Platforms<a name="Supported_Platforms"></a>
In this article:
<table><tbody><tr><td><p>Hypervisor</p><p>Image publishing</p><p>Operating System for Layered Images</p><p>Directory Service</p><p>Internet browser</p></td></tr></tbody></table>
##Hypervisor<a name="Hypervisor"></a><a name="Virtualization"></a>
###Unidesk Enterprise Layer Manager (ELM)<a name="Unidesk_Enterprise_Layer_Manager_(ELM)"></a>
The Unidesk ELM can be installed in the following environments:
<ul><li>Azure Resource Manager</li><li>Citrix XenServer 6.5, 7.0</li><li>Microsoft Hyper-V, Windows Server 2012 R2</li><li>Nutanix Acropolis</li><li>vSphere vCenter 5.5.x, 6.0.x</li></ul>
###Network File Share protocol<a name="Network_File_Share_protocol"></a>
<ul><li><p>Server Message Block (SMB)</p></li><li><p>Network File System (NFS)</p><p><strong>Note:</strong> <em>Elastic Layers</em> can only use SMB file shares. NFS shares are not supported for Elastic Layering.</p></li></ul>
###Network connection<a name="Network_connection"></a>
<ul><li>A 10 GB connection is recommended between the Unidesk ELM and the file share.</li></ul>
##Image publishing<a name="Image_publishing"></a><a name="Provisio"></a>
Unidesk 4 lets you publish to these platforms:
<ul><li><p>Citrix MCS for Nutanix AHV</p></li><li><p>Citrix MCS for vSphere</p></li><li><p>Citrix MCS for XenServer</p></li><li><p>Citrix PVS 7.1, 7.6 - 7.9, 7.11 - 7.12 with recommended network speeds to the PVS Store of 10 GB.</p></li><li><p>Citrix XenApp and XenDesktop 6.5, 7.0 - 7.11</p></li><li><p>Microsoft Azure, with recommended network speeds to the Azure publishing location of 10 GB.</p></li><li><p>VMware Horizon View 6.x, 7.x</p><p><strong>Note:</strong> View Persona Management is <em>not</em> supported with Elastic Layering.</p></li></ul>
You can use Unidesk Layers and Layered Images with other provisioning systems and hypervisors, although the solution is not fully integrated.
##Operating System for Layered Images<a name="Operating_System_for_Layered_Images"></a><a name="Session"></a>
<ul><li><p>Windows Server 2016, 64-bit (Standard and Datacenter Editions)</p></li><li>Windows Server 2012 R2, 64-bit (Standard and Datacenter Editions)</li><li>Windows Server 2008 R2, 64-bit (Standard and Datacenter Editions)</li><li>Windows 10, 64-bit</li><li>Windows 7, 64-bit</li><li>Windows 7, 32-bit</li></ul>
Unidesk supports single-byte language packs for the base US English Windows operating system. Language packs must be installed on the OS Machine before importing the OS into a Layer. Language packs installed on a Version added to the OS Layer will not work correctly.
##Directory Service<a name="Directory_Service"></a><a name="Service"></a>
<ul><li>Microsoft Active Directory</li></ul>
##Internet browser<a name="Internet_browser"></a><a name="Browser"></a>
The Unidesk Management Console (UMC) supports the following browsers with Silverlight 4.0 support:
<ul><li><p>Internet Explorer v11</p></li><li><p>Firefox v45 and later versions that support MS Silverlight 4.0.</p></li></ul>



#Install the Unidesk Enterprise Layer Manager (ELM)<a name="Install_the_Unidesk_Enterprise_Layer_Manager_(ELM)"></a>
Where are you installing the Unidesk ELM?


#Install the Unidesk ELM in Citrix XenServer<a name="Install_the_Unidesk_ELM_in_Citrix_XenServer"></a>
Review the prerequisites and follow the steps to install the ELM in Citrix XenServer. You will then be able to log into the Unidesk Management Console (UMC) and complete the Unidesk setup.

#Unidesk Prerequisites (XenServer)<a name="Unidesk_Prerequisites_(XenServer)"></a>
In this article:
<table><tbody><tr><td><p> </p><p><a href="#storage_req">Storage requirements</a></p><p><a href="#xenserver_reqs">XenServer requirements</a></p></td></tr></tbody></table>

###Operating System requirement <a name="Operating_System_requirement"></a><a name="General"></a>
<ul><li><p><strong>OS for Layered Images</strong></p><p>You need a Unidesk-supported <a href="#Session">operating system</a> to import into an OS Layer. This OS will be used to build your Layered Images.</p></li></ul>

###Storage requirements<a name="Storage_requirements"></a>
<ul><li><p><strong>350-500 GB Storage Space</strong></p><p>The Unidesk ELM uses local storage for temporary files and finalized layers. The more layers you create, the more space you need. However, if you run low on space, you can expand the size of the current disk, or add other disks to the ELM when needed.</p></li><li><p><a href="#Session"></a><strong>40-100 GB network file share (SMB/NFS)</strong></p><p>The file share connected to the ELM is used for upgrades, Elastic Layers, and cross-platform publishing. This space is easy to expand, if needed.</p></li></ul>

###Citrix XenServer prerequisites<a name="Citrix_XenServer_prerequisites"></a>
<ul><li><p><strong>XenServer account and privileges</strong></p><ul><li>A XenServer account (new or existing) to use for Unidesk.</li><li>The account must have XenServer privileges to:<ul><li>Create and remove virtual disks.</li><li>Copy and delete layers on virtual disks using XenServer file APIs.</li></ul></li></ul></li><li><p><strong>Citrix XenServer software and settings</strong></p><p>Access to the XenServer Tools to install on the layer.</p></li><li><p><strong>XenServer resource information</strong></p><p>The XenServer info listed in <a href="#Connector_Configuration_(AND)_Optional_Script__(Citrix_XenServer)">Citrix XenServer Connector Configuration</a>.</p></li><li><p><strong>Network access to Unidesk OS Machine Tools</strong></p><p>When you create Layer or add a Version to it, the Unidesk Management Console (UMC) uses a Connector Configuration to create a VM called a Packaging Machine for the Layer you are building. The Packaging Machine <em>must</em> have access to the Unidesk OS Machine Tools download, which is available on the Unidesk Download page.</p></li></ul>
#Install the Unidesk Enterprise Layer Manager (ELM) (XenServer)<a name="Install_the_Unidesk_Enterprise_Layer_Manager_(ELM)_(XenServer)"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Deploy the Unidesk Enterprise Layer Manager (ELM)</p><p>Expand locally attached storage, if needed</p><p>Next Step</p></td></tr></tbody></table>
##Before you start<a name="Before_you_start"></a><a name="Before"></a>
To get started with Unidesk, you will need:
<ul><li>A Unidesk account.</li><li><a href="#Supported_Platforms">A supported version of Citrix XenServer</a>.</li><li>A Virtual Network in XenServer.</li><li>Storage requirements and XenServer requirements listed <a href="#Unidesk_Prerequisites_(XenServer)">here</a>.</li><li>A XenCenter Client.</li></ul>
##Deploy the Unidesk Enterprise Layer Manager (ELM)<a name="Deploy_the_Unidesk_Enterprise_Layer_Manager_(ELM)"></a><a name="Deploy_ELM"></a>
Using this procedure, you will do a basic Unidesk ELM installation on your XenServer Server. Once you complete these steps, use the following sections to ***change the administrator password***  (strongly recommended), and configure more advanced options, such as Static IP.
<ol><li><p>Download the Unidesk installation package, Unidesk_install_xenserver_pkg_4.x.x, from the Unidesk download site. This zip file contains the xenserver_elm_4.x.x.x.ova and other files.</p></li><li><p>Extract the xenserver_elm_4.x.x.x.ova file to a folder on your local drive.</p></li><li><p>In your XenCenter Client, select <strong>File > Import</strong>.</p></li><li>In the wizard that opens, select the following values:<ul><li><strong>Import Source</strong> - Browse to <em>your</em> unique location.</li></ul><ul><li><strong>Location</strong> - Choose the XenServer where you want to deploy the ELM.</li><li><strong>Storage</strong> - Use the default value to put the Unidesk disks on the Local XenServer Storage.</li><li><strong>Networking</strong> - Select the correct network for your XenServer configuration.</li><li><strong>Security</strong> - This tab should be grayed out. Click <strong>Next</strong> to continue.</li><li><strong>OS Fixup Settings</strong> - Select <strong>Don't use Operating System Fixup</strong>.</li><li><strong>Transfer VM Settings</strong> - Choose the correct network , and choose <strong>DHCP</strong>.</li><li><strong>Finish</strong> - Review your settings and select <strong>Finish</strong>.</li></ul></li><li><p>Switch to <strong>Notification view</strong> and wait for deployment to complete. This takes about 20-35 minutes.</p></li><li>Switch to <strong>Infrastructure view</strong>.</li><li><p>Rename your new appliance:</p><ol><li>Select your new appliance, which will be named <em>CentOS-7_x86_64_build_template_xenserver</em>.</li><li>Click <strong>Properties</strong>, and enter a good name and description for your new ELM.</li></ol></li></ol>
The new VM created from the Unidesk_ELM.ova file has 8 GB of memory and 4 CPUs.
##Configure advanced settings<a name="Configure_advanced_settings"></a>
Once you've completed the ELM installation, you should immediately log into the ELM and:
<ul><li>Modify the administrator password.</li><li>(Optional) Configure advanced network options, such as Static IP, as needed.</li><li>Make any changes required to the existing settings, for example, the NTP servers you use or the Time Zone.</li></ul>
The Unidesk Appliance Configuration utility lets you configure these settings. For details, click Manage the Unidesk ELM (virtual appliance) .
##Expand locally attached storage, if needed<a name="Expand_locally_attached_storage,_if_needed"></a><a name="Expand"></a>
If you need to expand the ELM's local storage, see Manage system storage.
##Next Step<a name="Next_Step"></a><a name="Next"></a>
Once you're satisfied that the ELM is correctly configured and has the required storage space, you can log into the Unidesk Management Console, and begin creating your layers.
[Log into the Unidesk Management Console (UMC)](#Log_into_the_Unidesk_Management_Console_(UMC)_..4)

#Log into the Unidesk Management Console (UMC)<a name="Log_into_the_Unidesk_Management_Console_(UMC)"></a>
In this article:
<table><tbody><tr><td><p>Log into the UMC</p><p>Next step</p></td></tr></tbody></table>
##Log into the UMC<a name="Log_into_the_UMC"></a><a name="Log"></a>
Once you have [set up the Unidesk ELM](#Install_the_Unidesk_Enterprise_Layer_Manager_(ELM))[, you can log into the Unidesk Management Console, which is the user interface for creating and managing Unidesk Layers and Layered Images.](#Install_the_Unidesk_Enterprise_Layer_Manager_(ELM))
The following steps explain how to log into the UMC using the default User Name and Password.
<ol><li><p>Locate the VM you created for the Unidesk ELM and determine the IP address for this VM.</p></li><li><p>Using the IP address for the ELM, enter the following URL in a compatible web browser:</p><p>http://<em><ip_address_of new_vm></em>/udmc</p><p>This displays the Login page for the Unidesk Management Console.</p><p><img></img></p></li><li><p>Enter <strong>Administrator</strong> in the User Name field and <strong>Unidesk1</strong> in the Password field to log in to the Unidesk Management Console for the first time.</p></li></ol>
##Next step<a name="Next_step"></a><a name="Next_..14"></a>
[Obtain a Unidesk license](#Obtain_a_Unidesk_license)
#Install the Unidesk ELM in Azure<a name="Install_the_Unidesk_ELM_in_Azure"></a>
Review the prerequisites for installing the Unidesk Enterprise Layer Manager in Azure. Next,follow the steps to install the ELM in Azure. You will then be able to log in to the Unidesk Management Console and complete the Unidesk setup.

#Unidesk Prerequisites (Azure)<a name="Unidesk_Prerequisites_(Azure)"></a>
In this article:
<table><tbody><tr><td><p>Unidesk Prerequisites (Azure)</p><p><a href="#storage_reqs">Storage requirements</a></p><p><a href="#azure_reqs">Azure-specific requirements</a></p></td></tr></tbody></table>

###Operating System requirement <a name="Operating_System_requirement_..484"></a><a name="General_..15"></a>
<ul><li><p><strong>OS for Layered Images</strong></p><p>You need a Unidesk-supported <a href="#Session">operating system</a> to import into an OS Layer. This OS will be used to build your Layered Images.</p></li></ul>

###Storage requirements<a name="Storage_requirements_..485"></a>
<ul><li><p><strong>350-500 GB Storage Space</strong></p><p>The Unidesk ELM uses local storage for temporary files and finalized layers. The more layers you create, the more space you need. However, if you run low on space, you can expand the size of the current disk, or add other disks to the ELM when needed.</p></li><li><p><a href="#Session"></a><strong>40-100 GB network file share (SMB/NFS)</strong></p><p>The file share connected to the ELM is used for upgrades, Elastic Layers, and cross-platform publishing. This space is easy to expand, if needed.</p></li></ul>

###Azure prerequisites<a name="Azure_prerequisites"></a>
Before installing the Unidesk ELM in Azure, be sure to meet the following prerequisites.
<ul><li><p><strong>Network File Share (Azure specifics)</strong></p><p>A file share server in Azure will perform significantly better than an on-premise file share. Even though the <em>Azure</em> file share feature is not supported, you can use an existing network file share or create a new file share in the Azure environment.</p><ul><li>Using <em>Premium Storage</em> is strongly recommended.</li><li>Only fixed VHD disks will deploy successfully.</li></ul></li><li><p><a href="#Session"></a><strong>Azure account and subscription</strong></p><p>To deploy and configure the Unidesk Enterprise Layer Manager, you will need the credentials for an account that has administrative access to your Azure subscription. For more information, refer to the <a href="https://account.windowsazure.com/signup?offer">Microsoft Azure Sign in page</a>.</p></li></ul>
<ul><li><p><a href="https://account.windowsazure.com/signup?offer"></a><strong>Azure Resource Manager</strong></p><p>Unidesk is designed to work with Azure's new Resource Management (ARM) model. It does not support Azure's Classic deployment model. All resources such as virtual network, file shares and OS machines that Unidesk will work with must be created with Azure Resource Manager. For more information, refer to the <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-overview/">Azure Resource Manager overview page</a>.</p></li><li><p><a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-overview/"></a><strong>Azure network topology</strong></p><p>Before deploying the Unidesk Enterprise Layer Manager (ELM), you must define and create your Azure network topology. The ELM and its Network File Share must have network connectivity. However, the ELM does not require network connectivity to the Session Hosts that are created. Unidesk recommends utilizing a site-to-site connection between your corporate and Azure networks to access the Unidesk Management Console on the ELM. For more information, refer to the <a href="https://azure.microsoft.com/en-us/services/virtual-network/">Microsoft Azure Virtual Network page</a>.</p></li></ul>

#Install the Unidesk Enterprise Layer Manager (ELM) with local storage (Azure)<a name="Install_the_Unidesk_Enterprise_Layer_Manager_(ELM)_with_local_storage_(Azure)"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Deploy the Unidesk ELM from the Azure Marketplace</p><p>Next Step</p></td></tr></tbody></table>
##Before you start<a name="Before_you_start_..486"></a><a name="Before_..18"></a>
To get started with Unidesk in Azure, you will need:
<ul><ul><li>An Azure subscription</li><li>A Virtual Network in Azure. Your Unidesk deployment in Azure can operate in a point-to-site or site-to-site Virtual Network.</li></ul></ul>
***Note:***  If you have not already set up a connection to an Azure Virtual Network, see [https://azure.microsoft.com/en-us/documentation/articles/?service=vpn-gateway](https://azure.microsoft.com/en-us/documentation/articles/?service=vpn-gateway)[ for more information.](https://azure.microsoft.com/en-us/documentation/articles/?service=vpn-gateway)
<ul><li>The storage and Azure requirements listed <a href="#Unidesk_Prerequisites_(Azure)">here</a></li></ul>
##Deploy the Unidesk ELM from the Azure Marketplace<a name="Deploy_the_Unidesk_ELM_from_the_Azure_Marketplace"></a><a name="Deploy_ELM_..19"></a>
To deploy Unidesk for Azure, create a Virtual Machine in the Azure Marketplace using the Unidesk offering. This installs the Unidesk ELM with local storage for Unidesk Layers, Templates, and temporary files.
Using this procedure, you will do a basic Unidesk ELM installation in Azure. Once you complete these steps, use the following sections to ***change the administrator password***  (strongly recommended), and configure more advanced options, such as Static IP.
<ol><ol><li><p>Open a web browser, navigate to the <a href="https://portal.azure.com/">Microsoft Azure portal</a>, sign in with your Azure credentials, and click <strong>New</strong>.</p></li><li>In the search field in the New panel, type <strong>Unidesk</strong> and press <strong>Enter</strong>. The window displays Unidesk for Azure as a Publisher. Select it and click <strong>Create</strong>.</li><li><p>Fill out the Basics, Size, and Settings options for creating a new VM.</p></li></ol></ol>
***Notes:*** 
<ol><ul><li>IMPORTANT: Record the User name and Password that you specify for the Azure VM for later use, as this becomes the User name and Password for the Administrator account of your Unidesk ELM. There is no root password on the ELM and if you lose the ELM credentials you will have to reinstall the ELM. You may also be asked to furnish the ELM credentials when you contact Unidesk Support. Note that the User name and Password for the ELM (which runs on Linux) is different from the User name and Password of the Unidesk Management Console (which runs on Windows).</li><li>IMPORTANT: Be sure to note the Resource group location you select now as you will require this information later. For more information about resource groups, refer to <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-portal/">Using the Azure Portal to manage your Azure resources</a>.</li><li>When selecting a virtual machine size, Unidesk recommends creating an D3 Standard machine.</li><li>The name you specify for the new virtual machine must comply with Azure naming conventions.</li><li>Select a Virtual Network in which HTTP port: 80 is accessible (Public IP can be disabled).</li><li>On the Monitoring Diagnostics entry, select <strong>Disabled</strong>.</li></ul></ol>
To complete the process, view the Summary of the options you selected and, when you are satisfied with your selections, click ***OK*** , and click ***Purchase*** .
***Note:***  If you experience a failed deployment of a Virtual Machine in Azure, you can obtain more detail regarding the nature of the failure by browsing to the relevant resource group and clicking the related "(Failed)" link.

##Configure advanced settings<a name="Configure_advanced_settings_..487"></a>
Once you've completed the ELM installation, you should immediately log into the ELM and:
<ul><li>Modify the administrator password.</li><li>(Optional) Configure advanced network options, such as Static IP, as needed.</li><li>Make any changes required to the existing settings, for example, the NTP servers you use or the Time Zone.</li></ul>
The Unidesk Appliance Configuration utility lets you configure these settings. For details, click Manage the Unidesk ELM (virtual appliance) .
##Expand locally attached storage, if needed<a name="Expand_locally_attached_storage,_if_needed_..488"></a><a name="Expand_..20"></a>
If you need to expand the ELM's local storage, see Manage system storage.
##Next Step<a name="Next_Step_..489"></a><a name="Next_..21"></a>
Once you're satisfied that the ELM is correctly configured and has the required storage space, you can log into the Unidesk Management Console, and begin creating your layers.
[Log into the Unidesk Management Console (UMC)](#Log_into_the_Unidesk_Management_Console_(UMC)_..1)

#Log into the Unidesk Management Console (UMC)<a name="Log_into_the_Unidesk_Management_Console_(UMC)_..1"></a>
In this article:
Log into the UMC
Next step
##Log into the UMC<a name="Log_into_the_UMC_..490"></a><a name="Log_..22"></a>
Once you have [set up the Unidesk ELM](#Install_the_Unidesk_Enterprise_Layer_Manager_(ELM))[, you can log into the Unidesk Management Console, which is the user interface for creating and managing Unidesk Layers and Layered Images.](#Install_the_Unidesk_Enterprise_Layer_Manager_(ELM))
The following steps explain how to log into the UMC using the default User Name and Password.
<ol><li><p>Locate the VM you created for the Unidesk ELM and determine the IP address for this VM.</p></li><li><p>Using the IP address for the ELM, enter the following URL in a compatible web browser:</p><p>http://<em><ip_address_of new_vm></em>/udmc</p><p>This displays the Login page for the Unidesk Management Console.</p><p><img></img></p></li><li><p>Enter <strong>Administrator</strong> in the User Name field and <strong>Unidesk1</strong> in the Password field to log in to the Unidesk Management Console for the first time.</p></li></ol>
##Next step<a name="Next_step_..491"></a><a name="Next_..23"></a>
[Obtain a Unidesk license](#Obtain_a_Unidesk_license)

#Install the Unidesk ELM in Hyper-V<a name="Install_the_Unidesk_ELM_in_Hyper-V"></a>
Review the prerequisites and follow the steps to install the ELM in Hyper-V. You will then be able to log into the Unidesk Management Console (UMC) and complete the Unidesk setup.

#Unidesk Prerequisites (Hyper-V)<a name="Unidesk_Prerequisites_(Hyper-V)"></a>
In this article:
<table><tbody><tr><td><p> </p><p><a href="#storage_req_..27">Storage requirements</a></p><p><a href="#prereqs_hyperv">Hyper-V-specific requirements</a></p></td></tr></tbody></table>

###Operating System requirement <a name="Operating_System_requirement_..492"></a><a name="General_..25"></a>
<ul><li><p><strong>OS for Layered Images</strong></p><p>You need a Unidesk-supported <a href="#Session">operating system</a> to import into an OS Layer. This OS will be used to build your Layered Images.</p></li></ul>

###Storage requirements<a name="Storage_requirements_..493"></a>
<ul><li><p><strong>350-500 GB Storage Space</strong></p><p>The Unidesk ELM uses local storage for temporary files and finalized layers. The more layers you create, the more space you need. However, if you run low on space, you can expand the size of the current disk, or add other disks to the ELM when needed.</p></li><li><p><a href="#Session"></a><strong>40-100 GB network file share (SMB/NFS)</strong></p><p>The file share connected to the ELM is used for upgrades, Elastic Layers, and cross-platform publishing. This space is easy to expand, if needed.</p></li></ul>

###Hyper-V prerequisites<a name="Hyper-V_prerequisites"></a>
Be sure the Hyper-V VM where you are installing the ELM meets the following prerequisites.
<ul><li>A Windows Hyper-V 2012 R2 server</li><li>A Virtual Network in Hyper-V</li></ul>

#Install the Unidesk Enterprise Layer Manager (ELM) (Hyper-V)<a name="Install_the_Unidesk_Enterprise_Layer_Manager_(ELM)_(Hyper-V)"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Deploy the Unidesk Enterprise Layer Manager (ELM)</p><p>Next Step</p></td></tr></tbody></table>
##Before you start<a name="Before_you_start_..494"></a><a name="Before_..29"></a>
###Prerequisites<a name="Prerequisites"></a>
To install the Unidesk ELM in Hyper-V environment you need:
<ul><li>A Unidesk account.</li><li>The Storage and Hyper-V requirements listed <a href="#Unidesk_Prerequisites_(Hyper-V)">here</a>.</li></ul>
###Virtual appliance details<a name="Virtual_appliance_details"></a>
<table><thead><tr><th>Name</th><th>Value</th></tr></thead><tbody><tr><td>Virtual Machine Name</td><td>Unidesk Enterprise Layer Manager</td></tr><tr><td>VIrtual Machine Generation</td><td>Generation 1</td></tr><tr><td>Memory</td><td>8192 MB</td></tr><tr><td>CPUs</td><td>4</td></tr><tr><td>Disk 1</td><td>unidesk_hyperv-system.vhdx</td></tr><tr><td>Disk 2</td><td>unidesk_hyperv-repository.vhdx</td></tr></tbody></table>
##Deploy the Unidesk Enterprise Layer Manager (ELM)<a name="Deploy_the_Unidesk_Enterprise_Layer_Manager_(ELM)_..495"></a><a name="Deploy_ELM_..30"></a>
Using this procedure, you will do a basic Unidesk ELM installation on your Hyper-V Server. Once you complete these steps, use the following sections to ***change the administrator password***  (strongly recommended), and configure more advanced options, such as Static IP.
<ol><li><p>Download the Unidesk Hyper-V installation package from the <a href="http://www.unidesk.com/support/downloads">Unidesk 4 Downloads</a> page to a file system on a Windows Server 2012 R2 Hyper-V-enabled system.</p></li><li><p>Extract the Hyper-V zip package containing two disks, and copy the disks to a storage location that Hyper-V can access.</p></li><li><p>Open the Hyper-V Manager, right-click the Hyper-V server where you want to deploy the Unidesk ELM, and select <strong>New Virtual Machine</strong>.</p><p><img></img></p><p>This opens the New Virtual Machine Wizard.</p></li><li><p>On the first wizard tab, click Next to begin configuring the virtual machine:</p><p><img></img></p></li><li><p>On the Specify Name and Location tab, set the <strong>Name</strong> and <strong>Location</strong> of the new VM. Ideally, use the location where you extracted the disks in step 2:</p><p><img></img></p></li><li><p>On the Specify Generation tab, ensure that <em>Generation 1 VM's</em> is selected, as Unidesk currently only supports Generation 1.</p></li><li><p>On the Assign Memory tab, set the VM to use 8 GB of RAM. Make sure the <strong>Use Dynamic Memory for this virtual machine</strong> check box is <em>not</em> selected.</p></li><li><p>On the Configure Networking tab, specify the NIC for the network adapter to use to connect to the network.</p></li><li><p>On the Connect Virtual Hard Disk tab, attach the system disk (<strong>unidesk_hyperv-system.vhdx</strong>), one of the disks that you extracted in step 2.</p></li><li><p>On the Summary tab, verify your choices and click <strong>Finish</strong>.</p></li><li><p>Back in the Hyper-V Manager, select the VM and click <strong>Settings</strong> from the VM panel.</p></li><li><p>Select <strong>Hardware > Processor</strong>, and set the Number of Virtual Processors to 4.</p><p><img></img></p></li><li><p>Select <strong>IDE Controller 0 > Hard Drive</strong>, click <strong>Add</strong>.</p></li><li><p>Select the <strong>Virtual Disk</strong> radio button, click <strong>Browse</strong>, and select the <em>repository</em> disk (<strong>unidesk_hyperv-repository.vhdx</strong>) extracted in step 2.</p></li><li>Power on the VM.</li></ol>
##Configure advanced settings<a name="Configure_advanced_settings_..496"></a>
Once you've completed the ELM installation, you should immediately log into the ELM and:
<ul><li>Change the <a href="#Change4">administrator password</a>.</li><li>(Optional) Configure <a href="#Change2">advanced network</a> options, such as Static IP, as needed.</li><li>Make any changes required to the existing settings, for example, the <a href="#Synchron">NTP servers</a> you use or the <a href="#Change3">Time Zone</a>.</li></ul>
The Unidesk [Appliance Configuration utility](#Manage_the_Unidesk_ELM_(virtual_appliance))[ lets you configure these settings.](#Manage_the_Unidesk_ELM_(virtual_appliance))
##Expand locally attached storage, if needed<a name="Expand_locally_attached_storage,_if_needed_..497"></a><a name="Expand_..31"></a>
If you need to expand the ELM's local storage, see Manage system storage.
##Next Step<a name="Next_Step_..498"></a><a name="Next_..32"></a>
Once you're satisfied that the ELM is correctly configured and has the required storage space, you can log into the Unidesk Management Console, and begin creating your layers.
[Log into the Unidesk Management Console (UMC)](#Log_into_the_Unidesk_Management_Console_(UMC)_..4)

#Log into the Unidesk Management Console (UMC)<a name="Log_into_the_Unidesk_Management_Console_(UMC)_..2"></a>
In this article:
<table><tbody><tr><td><p>Log into the UMC</p><p>Next step</p></td></tr></tbody></table>
##Log into the UMC<a name="Log_into_the_UMC_..499"></a><a name="Log_..33"></a>
Once you have [set up the Unidesk ELM](#Install_the_Unidesk_Enterprise_Layer_Manager_(ELM))[, you can log into the Unidesk Management Console, which is the user interface for creating and managing Unidesk Layers and Layered Images.](#Install_the_Unidesk_Enterprise_Layer_Manager_(ELM))
The following steps explain how to log into the UMC using the default User Name and Password.
<ol><li><p>Locate the VM you created for the Unidesk ELM and determine the IP address for this VM.</p></li><li><p>Using the IP address for the ELM, enter the following URL in a compatible web browser:</p><p>http://<em><ip_address_of new_vm></em>/udmc</p><p>This displays the Login page for the Unidesk Management Console.</p><p><img></img></p></li><li><p>Enter <strong>Administrator</strong> in the User Name field and <strong>Unidesk1</strong> in the Password field to log in to the Unidesk Management Console for the first time.</p></li></ol>
##Next step<a name="Next_step_..500"></a><a name="Next_..34"></a>
[Obtain a Unidesk license](#Obtain_a_Unidesk_license)
#Install the Unidesk ELM in Nutanix AHV<a name="Install_the_Unidesk_ELM_in_Nutanix_AHV"></a>
Review the prerequisites and follow the steps to install the ELM in Nutanix AHV. You will then be able to log into the Unidesk Management Console (UMC) and complete the Unidesk setup.

#Unidesk Prerequisites (Nutanix AHV)<a name="Unidesk_Prerequisites_(Nutanix_AHV)"></a>
In this article:
<table><tbody><tr><td><p><a href="#os_reqs">OS requirements</a></p><p>Storage requirements</p><p><a href="#acropolis_reqs">Nutanix Acropolis requirements</a></p></td></tr></tbody></table>

###Operating System requirement <a name="Operating_System_requirement_..501"></a><a name="General_..35"></a>
<ul><li><p><strong>OS for Layered Images</strong></p><p>You need a Unidesk-supported <a href="#Session">operating system</a> to import into an OS Layer. This OS will be used to build your Layered Images.</p></li></ul>
###Storage requirements<a name="Storage_requirements_..502"></a><a name="Storage"></a>
<ul><li><p><strong>350-500 GB Storage Space</strong></p><p>The Unidesk ELM uses local storage for temporary files and finalized layers. The more layers you create, the more space you need. However, if you run low on space, you can expand the size of the current disk, or add other disks to the ELM when needed.</p></li><li><p><a href="#Session"></a><strong>40-100 GB network file share (SMB/NFS)</strong></p><p>The file share connected to the ELM is used for upgrades, Elastic Layers, and cross-platform publishing. This space is easy to expand, if needed.</p></li></ul>

###Nutanix Acropolis requirements for installing the Unidesk ELM<a name="Nutanix_Acropolis_requirements_for_installing_the_Unidesk_ELM"></a>
If you are installing the Unidesk ELM and building your Layers on Acropolis VMs, or you are publishing Layered Images that will be used in a Acropolis environment, you need:
<ul><li><p><strong>Acropolis account and privileges</strong></p><ul><li>An existing or new Acropolis account to use for Unidesk.</li><li>The account must have Acropolis privileges to:<ul><li>Create and remove virtual disks.</li><li>Copy and delete layers on virtual disks using Acropolis file APIs.</li></ul></li></ul></li><li><p><strong>Nutanix Acropolis software and settings</strong></p><p>Access to the Acropolis Tools to install on the layer.</p></li><li><p><strong>Acropolis resource information</strong></p><p>The Acropolis info listed in <a href="#Connector_Configuration_(AND)_Optional_Script__(Nutanix_AHV)">Acropolis Connector Configuration</a>.</p></li></ul>
#Install the Unidesk Enterprise Layer Manager (ELM) (Nutanix AHV)<a name="Install_the_Unidesk_Enterprise_Layer_Manager_(ELM)_(Nutanix_AHV)"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Deploy the Unidesk Enterprise Layer Manager (ELM) (Nutanix AHV)</p><p>Change the administrator password</p><p>Configure advanced settings</p><p>Expand locally attached storage, if needed</p><p>Next Step</p></td></tr></tbody></table>
##Before you start<a name="Before_you_start_..503"></a><a name="Before_..38"></a>
To get started with Unidesk, you will need:
<ul><li>A Unidesk account</li><li><a href="#Supported_Platforms">A supported version of Nutanix AHV</a></li><li>A virtual network in Nutanix AHV</li><li>Storage requirements and Nutanix AHV requirements listed <a href="#Unidesk_Prerequisites_(Nutanix_AHV)">here</a>.</li></ul>
##Deploy the Unidesk Enterprise Layer Manager (ELM) (Nutanix AHV)<a name="Deploy_the_Unidesk_Enterprise_Layer_Manager_(ELM)_(Nutanix_AHV)"></a><a name="Deploy_ELM_..39"></a>
Using this procedure, you will do a basic Unidesk ELM installation on your Nutanix AHV Server. Using this process you will create the new VM for the Unidesk ELM, and has 8 GB of memory and 1 VCPU with 4 cores.
Once you complete these steps, use the remaining sections to ***change the administrator password***  (strongly recommended), and configure more advanced options, such as Static IP.
<ol><li><p>Download the Unidesk installation package, Unidesk_install_pkg_4.x.x, from the Unidesk download site. This zip file contains two unidesk_elm_4.x.x.x.vhd files.</p></li><li><p>Unzip the Unidesk installation package, and place the two .vhd files on a file share that the Nutanix server can access.</p></li><li><p>Log into the Nutanix Prism console, where you will upload the Unidesk VHD disks, and then create a VM for the Unidesk ELM.</p></li><li><p>Select the <strong>Tools</strong> menu in the top right corner of the UI, and choose <strong>Image Configuration</strong>.</p></li><li><p>Click the <strong>Upload Image</strong> button, and name the disk.</p></li><li><p>Select the <strong>Disk Image Type</strong>.</p></li><li><p>Select the <strong>Upload a File</strong> option, browse to your file share, and choose the ELM Boot Disk. Wait for the upload to complete.</p></li><li><p>Repeat steps 2 - 7 for the ELM Local Storage Disk.</p></li><li><p>Select <strong>Tasks</strong> and make sure that for each of the disks, <em>both</em> the Image Create and Image Update tasks are complete. Once this is done, you can create the VM.</p></li><li><p>Select the <strong>VM</strong> tab on the top left dropdown menu, and click the <strong>Create VM</strong> button.</p></li><li><p>Complete the <strong>Name</strong> and <strong>Description</strong> of the new VM.</p></li><li><p>Set VCPU(S) to <strong>1</strong>.</p></li><li><p>Set Number of Cores per VCPU to <strong>4</strong>.</p></li><li><p>Set Memory to <strong>8</strong> GB.</p></li><li><p>To add the Disks to the VM, click <strong>Add new disk</strong> and choose type <strong>Disk</strong>.</p></li><li><p>In the Operation drop-down, choose <strong>Clone from Image Service</strong>.</p></li><li><p>In the <strong>Bus Type</strong> drop-down select <strong>IDE</strong>.</p></li><li><p>In the Image Box select the Boot disk that you uploaded, and click <strong>Add</strong>.</p></li><li><p>Repeat the above steps for the following disks:</p><p><strong>Boot Disk:</strong> unidesk_nutanix-system.img</p><p><strong>Repository Disk:</strong> unidesk_nutanix-repository.img</p></li><li><p>Add NIC by clicking on <strong>Add new NIC</strong>.</p></li><li><p>Click <strong>Save</strong> to complete dialog and create VM.</p></li><li><p>Power on the VM.</p></li></ol>
###If you receive the error: "Cannot create UUID from string "undefined""<a name="If_you_receive_the_error:_&quot;Cannot_create_UUID_from_string_&quot;undefined&quot;&quot;"></a>
Ensure that you have waited for both tasks for each disk to be completed before attempting to create the VM.
##Change the administrator password<a name="Change_the_administrator_password"></a><a name="Change"></a>
<ol><li><a href="#Log">Log in</a> to the ELM's Appliance Configuration utility, as described above.</li><li>At the Appliance Configuration utility's Action prompt, enter <strong>P</strong> (for <em>Password change</em>), and press <strong>Return</strong>.</li><li>When prompted, enter the new password, and then confirm the password. A message confirms that the <em>** Password changed successfully</em>.</li><li>Press the <strong>Enter</strong> key to continue.</li><li>At the Action prompt, enter <strong>Q</strong> to quit.</li></ol>
##Configure advanced settings<a name="Configure_advanced_settings_..504"></a><a name="Configur"></a>
<ol><li>Configure advanced <a href="#Change2">network options</a>, such as Static IP, NTP servers and Time Zone.</li></ol>
The Unidesk Appliance Configuration utility lets you configure these settings. For details, click Manage the Unidesk ELM (virtual appliance) .
##Expand locally attached storage, if needed<a name="Expand_locally_attached_storage,_if_needed_..505"></a><a name="Expand_..40"></a>
If you need to expand the ELM's local storage, see Manage system storage.
##Next Step<a name="Next_Step_..506"></a><a name="Next_..41"></a>
Once you're satisfied that the ELM is correctly configured and has the required storage space, you can log into the Unidesk Management Console (UMC), and begin creating your layers.
<ul><li><a href="#Log_into_the_Unidesk_Management_Console_(UMC)_..3">Log into the Unidesk Management Console (UMC)</a></li></ul>



#Log into the Unidesk Management Console (UMC)<a name="Log_into_the_Unidesk_Management_Console_(UMC)_..3"></a>
In this article:
<table><tbody><tr><td><p>Log into the UMC</p><p>Next step</p></td></tr></tbody></table>
##Log into the UMC<a name="Log_into_the_UMC_..507"></a><a name="Log_..42"></a>
Once you have [set up the Unidesk ELM](#Install_the_Unidesk_Enterprise_Layer_Manager_(ELM))[, you can log into the Unidesk Management Console, which is the user interface for creating and managing Unidesk Layers and Layered Images.](#Install_the_Unidesk_Enterprise_Layer_Manager_(ELM))
The following steps explain how to log into the UMC using the default User Name and Password.
<ol><li><p>Locate the VM you created for the Unidesk ELM and determine the IP address for this VM.</p></li><li><p>Using the IP address for the ELM, enter the following URL in a compatible web browser:</p><p>http://<em><ip_address_of new_vm></em>/udmc</p><p>This displays the Login page for the Unidesk Management Console.</p><p><img></img></p></li><li><p>Enter <strong>Administrator</strong> in the User Name field and <strong>Unidesk1</strong> in the Password field to log in to the Unidesk Management Console for the first time.</p></li></ol>
##Next step<a name="Next_step_..508"></a><a name="Next_..43"></a>
[Obtain a Unidesk license](#Obtain_a_Unidesk_license)
#Install the Unidesk ELM in vSphere<a name="Install_the_Unidesk_ELM_in_vSphere"></a>
Review the prerequisites for installing the Unidesk Enterprise Layer Manager in vSphere. Next, follow the steps to install the ELM on your vSphere server. You will then be able to log in to the Unidesk Management Console and complete the Unidesk setup.

#Unidesk Prerequisites (vSphere)<a name="Unidesk_Prerequisites_(vSphere)"></a>
In this article:
<table><tbody><tr><td><p> </p><p><a href="#storage_req_..47">Storage requirements</a></p><p><a href="#vsphere_reqs">vSphere requirements</a></p></td></tr></tbody></table>

###Operating System requirement <a name="Operating_System_requirement_..509"></a><a name="General_..45"></a>
<ul><li><p><strong>OS for Layered Images</strong></p><p>You need a Unidesk-supported <a href="#Session">operating system</a> to import into an OS Layer. This OS will be used to build your Layered Images.</p></li></ul>

###Storage requirements<a name="Storage_requirements_..510"></a>
<ul><li><p><strong>350-500 GB Storage Space</strong></p><p>The Unidesk ELM uses local storage for temporary files and finalized layers. The more layers you create, the more space you need. However, if you run low on space, you can expand the size of the current disk, or add other disks to the ELM when needed.</p></li><li><p><a href="#Session"></a><strong>40-100 GB network file share (SMB/NFS)</strong></p><p>The file share connected to the ELM is used for upgrades, Elastic Layers, and cross-platform publishing. This space is easy to expand, if needed.</p></li></ul>

###vSphere prerequisites<a name="vSphere_prerequisites"></a>
If you are installing the Unidesk ELM in vSphere and building your layers on vSphere VMs or publishing Layered Images to vSphere, you need:
<ul><li><p><strong>Network access to Unidesk Tools download</strong></p><p>You need access from the Packaging Machine VM in vSphere to the Unidesk Tools download (available on the Unidesk Download page).</p></li><li><p><strong>vCenter account and privileges</strong></p><ul><li>An existing or new vCenter account to use for Unidesk.</li><li>The account must have vCenter privileges to: Create and remove VMDKs, and to copy and delete layers on VMDKs using vSphere file APIs (see detailed list of vCenter permissions below).</li></ul></li><li><p><strong>Dedicated vCenter role for Unidesk (optional)</strong></p><p>To set up a new role:</p><ol><li>In the vSphere Client, navigate to <span>Home > Administration > Roles</span>.</li><li>Click <strong>Add Role</strong>.</li><li>Enter a name. Example: <em>UDAdmin</em>.</li><li>Set the privileges for this account.</li></ol></li><li><p><strong>Privileges set for the vCenter role you are using for Unidesk</strong></p><p><a href="#Session"></a> Add the required vCenter permissions (detailed permissions list below).</p><ol><li>Open the <strong>Assign Permissions</strong> window.</li><li>In the vSphere Client, navigate to <span>Home > Inventory > Hosts and Clusters</span>.</li><li>Select your <strong>vCenter</strong>, right-click, and select <strong>Add permission</strong>.</li><li><a href="#Session"></a> In the Assign Permissions window, under Assigned Role, expand All Privileges.</li><li>Select the permissions listed below, make sure that the <strong>Propogate to Child Objects</strong> check box is selected, and click <strong>OK</strong>. displayed.</li></ol></li><li><p><strong>The </strong><span>Unidesk</span><strong> role associated with the administrator account</strong></p><p>Associate the Unidesk role with the administrator account:</p><ol><li>Add the administrator account and assign the Unidesk role to it.</li><li><p>Allow the permissions to propagate to the entire Datacenter.</p><p><span>Note:</span> If you want to restrict this use from accessing specific folders in the Datacenter, grant the user more restrictive permissions for those folders.</p></li></ol></li><li><p><a href="#Session"></a><strong>vCenter permissions</strong></p><p>Unidesk needs vCenter-level privileges to request information about the execution status of tasks. Without those privileges, Unidesk would consider the tasks failed.</p><table><thead><tr><th>Expand <em>All Privileges</em>, and each of the following...</th><th>Then select...</th></tr></thead><tbody><tr><td>Datastore</td><td><ul><li>Allocate space</li><li>Browse datastore</li><li>Low level file operations</li></ul></td></tr><tr><td>Folder</td><td><ul><li>Create folder</li><li>Delete folder</li></ul></td></tr><tr><td>Global</td><td><ul><li>Cancel task</li></ul></td></tr><tr><td>Host > Configuration</td><td><ul><li>System Management</li></ul></td></tr><tr><td>Network</td><td><ul><li>Assign network</li></ul></td></tr><tr><td>Resource</td><td><ul><li>Assign virtual machine to resource pool</li></ul></td></tr><tr><td>vApp</td><td><ul><li>Export</li><li>Import</li><li>vApp application configuration</li></ul></td></tr><tr><td>Virtual machine > Configuration</td><td><ul><li>Add existing disk</li><li>Add new disk</li><li>Add or remove device</li><li><a href="#Session"></a> Advanced</li><li>Change CPU count</li><li>Change resource</li><li><a href="#Session"></a> Configure managedBy</li><li>Disk change tracking</li><li>Memory</li><li>Modify device settings</li><li>Remove disk</li><li>Rename</li><li>Reset guest information</li><li>Set annotation</li><li>Settings</li><li>Swapfile placement</li><li>Upgrade virtual hardware</li></ul></td></tr><tr><td>Virtual machine > Interaction</td><td><ul><li>Answer question</li><li>Configure CD media</li><li>Console interaction</li><li>Device connection</li><li>Power off</li><li>Power on</li><li>Reset</li><li>Suspend</li></ul></td></tr><tr><td>Virtual machine > Inventory</td><td><ul><li>Create from existing</li><li>Create new</li><li>Register</li><li>Remove</li><li>Unregister</li></ul></td></tr><tr><td>Virtual machine > Provisioning</td><td><ul><li>Clone template (optional, but required to use a vSphere template as the source VM)</li><li>Clone virtual machine</li><li>Customize</li><li>Deploy template</li><li>Mark as template</li></ul></td></tr><tr><td>Virtual machine > Snapshot management</td><td><ul><li>Create snapshot</li><li>Remove Snapshot</li></ul></td></tr></tbody></table></li></ul>

#Install the Unidesk Enterprise Layer Manager (ELM) (vSphere)<a name="Install_the_Unidesk_Enterprise_Layer_Manager_(ELM)_(vSphere)"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Deploy the Unidesk Enterprise Layer Manager (ELM)</p><p>Expand locally attached storage, if needed</p><p>Next Step</p></td></tr></tbody></table>
##Before you start<a name="Before_you_start_..511"></a><a name="Before_..49"></a>
To get started with Unidesk, you will need:
<ul><li>A Unidesk account</li><li><a href="#Supported_Platforms">A supported version of VMware vSphere</a></li><li>A Virtual Network in vSphere</li><li>Storage requirements and vSphere requirements listed <a href="#Unidesk_Prerequisites_(vSphere)">here</a>.</li></ul>
##Deploy the Unidesk Enterprise Layer Manager (ELM)<a name="Deploy_the_Unidesk_Enterprise_Layer_Manager_(ELM)_..512"></a><a name="Deploy_ELM_..50"></a>
Using this procedure, you will do a basic Unidesk ELM installation on your vSphere Server. Once you complete these steps, use the following sections to ***change the administrator password***  (strongly recommended), and configure more advanced options, such as Static IP.
<ol><li><p>Download the Unidesk Tools installation package, Unidesk_install_pkg_4.x.x, from the Unidesk download site. This zip file contains the unidesk_elm_4.x.x.x.ova file and other files.</p></li><li><p>Extract the Unidesk_ELM.ova file to a folder on your local drive.</p></li><li><p>In the vSphere Web Client you are using, navigate to the <strong>VMs and Templates</strong> page.</p></li><li><p>Right-click the folder in vSphere where you want to deploy the template and select <strong>Deploy OVF Template</strong>. The Deploy OVF Template wizard appears.</p></li><li><p>In the Deploy OVF Template wizard, do the following:</p><ul><li><p>On the <em>Select source</em> page, select the <strong>Local file</strong> option, and browse to the <strong>Unidesk_ELM.ova</strong> file to select it.</p></li><li><p>On the <em>Select name and folder</em> page, designate a name and location for the deployed OVF template.</p></li><li><p>On the <em>Select a resource</em> page, select a location to run the deployed OVF template.</p></li><li><p>On the <em>Select storage</em> page, select the <strong>Thick Provision Lazy Zeroed</strong> setting of the <strong>Select virtual disk format</strong> option, select a storage policy, and specify a storage location.</p></li><li><p>On the <em>Setup networks</em> page, select your vSphere virtual network in the <strong>Destination</strong> column and select the <strong>IPv4</strong> setting of the <strong>IP protocol</strong> option.</p></li><li><p>On the <em>Ready to complete</em> page, review the template settings and click <strong>Finish</strong> when you are satisfied with the settings.</p></li></ul></li></ol>
The new VM created from the Unidesk_ELM.ova file has 8 GB of memory and 4 CPUs.
##Configure advanced settings<a name="Configure_advanced_settings_..513"></a>
Once you've completed the ELM installation, you should immediately log into the ELM and:
<ul><li>Modify the administrator password.</li><li>(Optional) Configure advanced network options, such as Static IP, as needed.</li><li>Make any changes required to the existing settings, for example, the NTP servers you use or the Time Zone.</li></ul>
The Unidesk Appliance Configuration utility lets you configure these settings. For details, click Manage the Unidesk ELM (virtual appliance) .
##Expand locally attached storage, if needed<a name="Expand_locally_attached_storage,_if_needed_..514"></a><a name="Expand_..51"></a>
If you need to expand the ELM's local storage, see Manage system storage.
##Next Step<a name="Next_Step_..515"></a><a name="Next_..52"></a>
Once you're satisfied that the ELM is correctly configured and has the required storage space, you can log into the Unidesk Management Console, and begin creating your layers.
[Log into the Unidesk Management Console (UMC)](#Log_into_the_Unidesk_Management_Console_(UMC)_..4)

#Log into the Unidesk Management Console (UMC)<a name="Log_into_the_Unidesk_Management_Console_(UMC)_..4"></a>
In this article:
<table><tbody><tr><td><p>Log into the UMC</p><p>Next step</p></td></tr></tbody></table>
##Log into the UMC<a name="Log_into_the_UMC_..516"></a><a name="Log_..53"></a>
Once you have [set up the Unidesk ELM](#Install_the_Unidesk_Enterprise_Layer_Manager_(ELM))[, you can log into the Unidesk Management Console, which is the user interface for creating and managing Unidesk Layers and Layered Images.](#Install_the_Unidesk_Enterprise_Layer_Manager_(ELM))
The following steps explain how to log into the UMC using the default User Name and Password.
<ol><li><p>Locate the VM you created for the Unidesk ELM and determine the IP address for this VM.</p></li><li><p>Using the IP address for the ELM, enter the following URL in a compatible web browser:</p><p>http://<em><ip_address_of new_vm></em>/udmc</p><p>This displays the Login page for the Unidesk Management Console.</p><p><img></img></p></li><li><p>Enter <strong>Administrator</strong> in the User Name field and <strong>Unidesk1</strong> in the Password field to log in to the Unidesk Management Console for the first time.</p></li></ol>
##Next step<a name="Next_step_..517"></a><a name="Next_..54"></a>
[Obtain a Unidesk license](#Obtain_a_Unidesk_license)
#Set up Unidesk<a name="Set_up_Unidesk"></a>
Once the Unidesk Enterprise Layer Manager (ELM) is installed, complete these setup instructions before attempting to use the ELM.
##Before you start<a name="Before_you_start_..518"></a>
Install the Unidesk Enterprise Layer Manager (ELM)
##Set up the Unidesk environment<a name="Set_up_the_Unidesk_environment"></a>
<ol><li><p>Obtain a Unidesk license</p></li><li><p>Change the Administrator password</p></li><li><p>Set up a network file share</p></li><li><p>Open firewall ports for Unidesk, as needed</p></li><li><p>Install the Unidesk Agent (required for PVS and Connector Scripts)</p></li><li><p><a href="#Connect_to_a_Directory_Service">Create a directory junction </a></p></li><li><p><a href="#Assign_Unidesk_Roles_to_users">Assign Unidesk Roles to users</a></p></li><li>Enable Unidesk Labs features</li></ol>
##Next Step<a name="Next_Step_..519"></a>
[Create Layers](#Create_Layers)
#Obtain a Unidesk license<a name="Obtain_a_Unidesk_license"></a>
In this article:
<table><tbody><tr><td><p>Register with Unidesk and log in</p><p>Download the license</p><p>Next step</p></td></tr></tbody></table>
To acquire a Unidesk license, you must be logged in to Unidesk. If you have not already done so, register on the Unidesk website to obtain a User Name and Password.
##Register with Unidesk and log in<a name="Register_with_Unidesk_and_log_in"></a><a name="Register"></a>
To register on the Unidesk website:
<ol><li>In a web browser, navigate to <a href="http://www.unidesk.com">the Unidesk website</a> and click <strong>Login</strong>.</li><li>In the Register section of the login page, enter your email address and click <strong>Register.</strong><p>Unidesk sends a confirmation email message to the address you provided.</p></li><li>Open the confirmation email message from Unidesk, which contains the Subject line "Confirming your registration at www.unidesk.com", and click the link it contains or paste the link into a web browser.</li><li>To finish registering, fill out the fields in the "Email address confirmed" page and click the <strong>Complete registration</strong> button.</li></ol>
##Download the license<a name="Download_the_license"></a><a name="Download"></a>
Once you are registered on the Unidesk site, you can obtain a Unidesk license by downloading a license.xml file. To obtain a license:
<ol><li>In the Unidesk Management Console, click <strong>About</strong>.</li><li>In the About Unidesk box, click the License tab.</li><li>On the License tab, click <strong>Manage License</strong>.</li><li>In the Update License box, click <strong>Download your license now by entering your credentials for the www.unidesk.com website</strong> option and enter your Unidesk <strong>User Name</strong> and <strong>Password</strong> and click the Next icon <img></img> to access the Confirm Your License Update tab.</li><li>In the Confirm Your License Update tab, click <strong>Finish</strong>.</li></ol>
##Next step<a name="Next_step_..520"></a><a name="Next_..55"></a>
Change the Administrator password
#Change the Administrator password<a name="Change_the_Administrator_password"></a>
Use these steps to change the password for the original Administrator account created for the Unidesk Management Console (UMC).
<ol><li>Log into the Unidesk Management Console (UMC).</li><li>Select <strong>User > Administrators</strong>.</li><li>In the list of Administrators select <strong>Administrator</strong> and click <strong>Edit Properties</strong>.</li><li>Enter the new password and type it again in the <strong>Confirm Password</strong> field.</li><li>On the Confirm and Complete tab, click <strong>Update User</strong>.</li></ol>
##Next step<a name="Next_step_..521"></a>
Set up a network file share
#Set up a network file share<a name="Set_up_a_network_file_share"></a>
In this article:
<table><tbody><tr><td><p>Network file share requirements and recommendations</p><p>Create the network file share</p><p>Configure Unidesk to access the file share</p><p>Next step</p></td></tr></tbody></table>
The Unidesk ELM must be connected to a network file share.
##Network file share requirements and recommendations<a name="Network_file_share_requirements_and_recommendations"></a><a name="Share"></a>
###Requirements<a name="Requirements"></a>
When setting up the ELM's file share:
<ul><li><p>The file share must be configured using SMB or NFS technology. However, if you plan to use Elastic Layer assignments, you must use SMB protocol, as NFS technology is <em>not</em> supported when using Elastic Layers.</p></li><li><p>The user credentials for the file share must have full permissions for that share.</p></li><li><p>The share must be set up by the admin to be <strong>readonly</strong> for all users except for the one configured in the ELM. This secures the Layers and other files stored on the share.</p></li><li><p>Ensure that you have the minimum storage space requirement of 40-100GB for your file share.</p><p><strong>Note:</strong> Storage space is expandable, as you can add space to a disk, or other disks to the ELM.</p></li></ul>
###Recommendations<a name="Recommendations"></a>
<ul><li><p>For convenience, set up a Network File Share hosted in your hypervisor.</p></li><li><p><strong>For Azure:</strong> Currently, the Unidesk ELM does not support the <em>Azure File Share feature</em>. For best performance, it is best to create a file share server in Azure using a fast system with a Premium Disk, for example, a DS class machine.</p></li></ul>
##Create the network file share<a name="Create_the_network_file_share"></a><a name="Create_Share"></a>
Depending on your environment, configure a file share that uses either Network File System (NFS) or Server Message Block (SMB) protocol.
<ul><li><p>Follow the vendor's instructions for setting up a file share using the protocol supported in your environment.</p></li><li><p>If you are planning to deploy Elastic Layers, the share <em>must be configured using SMB technology</em>. When using Elastic Layer assignments, <em>NFS technology is not supported</em> for the file share.</p></li></ul>
##Configure Unidesk to access the file share<a name="Configure_Unidesk_to_access_the_file_share"></a><a name="Cfg_Share"></a>
Once you have created a file share, configure the Unidesk Enterprise Layer Manager (ELM) to attach to it. You can configure the ELM via the Unidesk Management Console (UMC).
<ol><li><p>In the Unidesk Management Console, select <strong>System > Settings and Configuration</strong>, then scroll down to the network file shares setting and click <strong>Edit</strong>.</p></li><li><p>Specify a Type, Path, User name, and Password for the file share.</p></li><li><p>Click <strong>Test Network File Share</strong> to see if you can connect to the file share. The test returns a message stating either <em>Success</em> or <em>Failed to mount network file share path</em>.</p></li><li><p>Once the test returns a <em>Success</em> message, click <strong>Save</strong>.</p></li></ol>
##Next step<a name="Next_step_..522"></a><a name="Next_..56"></a>
[Open ports in your firewall for Unidesk](#Open_firewall_ports_for_Unidesk,_as_needed_..10)

#Open firewall ports for Unidesk, as needed<a name="Open_firewall_ports_for_Unidesk,_as_needed"></a>
In this article:
<table><tbody><tr><td><p>Admin User</p><p>Unidesk Enterprise Layer Manager Appliance</p><p>Next step</p></td></tr></tbody></table>
The Unidesk ELM must be connected to a network file share.
The Unidesk installer opens ports that the Unidesk Enterprise Layer Manager (ELM) needs to interact with services on the virtual server where it is hosted. The default ports that Unidesk uses are listed in the tables below.
If there is a firewall between the Unidesk appliance and the machine on which you are running the Unidesk Agent or one of the Unidesk Connectors, you must manually open the port in the firewall used for that purpose. If during installation you changed any of the ports from the default setting, be sure to open the correct port.
##Admin User<a name="Admin_User"></a><a name="Admin"></a>
By default, Unidesk uses the following ports in your firewall for the Unidesk Admin User to interact with the Unidesk Management Console (UMC).
<table><thead><tr><th>Destination</th><th>Activity</th><th>Protocol</th><th>Ports</th></tr></thead><tbody><tr><td>Unidesk Enterprise Layer Manager (ELM)</td><td>Unidesk Management Console (UMC)</td><td>TCP</td><td>80,443</td></tr></tbody></table>
##Unidesk Enterprise Layer Manager Appliance<a name="Unidesk_Enterprise_Layer_Manager_Appliance"></a><a name="Unidesk"></a>
###Internal Connections<a name="Internal_Connections"></a>
By default, Unidesk uses the following ports in your firewall for internal connections between the Unidesk appliance and each of the destinations listed below.
<table><thead><tr><th>Destination</th><th>Activity</th><th>Protocol</th><th>Ports</th></tr></thead><tbody><tr><td>Unidesk ELM</td><td>ActiveMQ Console</td><td>TCP</td><td>8161</td></tr><tr><td>Unidesk ELM</td><td>Log deliveries from the Unidesk Agent</td><td>TCP</td><td>8787</td></tr><tr><td>Unidesk ELM</td><td>Log deliveries from users</td><td>TCP</td><td>8888</td></tr><tr><td>Unidesk ELM</td><td>Communication with datastore via ESXI Host</td><td>TCP</td><td>443</td></tr><tr><td>Unidesk Agent</td><td>Communication</td><td>TCP</td><td>8016</td></tr><tr><td>Unidesk Agent</td><td>Log gathering</td><td>TCP</td><td>14243</td></tr><tr><td>Active Directory</td><td>LDAP</td><td>TCP</td><td>389, 636</td></tr><tr><td>Connector for Azure</td><td>Communication</td><td>TCP</td><td>3000 (HTTP) <br></br>3500 (HTTPS)</td></tr><tr><td>Connector for PVS</td><td>Communication</td><td>TCP</td><td>3009 (HTTP) <br></br>3509 (HTTPS)</td></tr><tr><td>Connector for vSphere</td><td>Communication</td><td>TCP</td><td>3004 (HTTP)<br></br>3504 (HTTPS)</td></tr><tr><td>Connector for XenServer</td><td>Communication</td><td>TCP</td><td>3002 (HTTP)<br></br>3502 (HTTPS)</td></tr></tbody></table>
###External connection<a name="External_connection"></a>
By default, Unidesk uses the following port in your firewall for external connections between the Unidesk appliance and the destination listed below.
<table><thead><tr><th>Destination</th><th>Activity</th><th>Protocol</th><th>Ports</th></tr></thead><tbody><tr><td>api.unidesk.com</td><td>Logs and Phone Home data uploads from the Unidesk ELM (optional)</td><td>TCP</td><td>443</td></tr></tbody></table>
##OS Image (XenServer requirement)<a name="OS(SPACE)Image__(XenServer_requirement)"></a>
Citrix XenServer uses Port 5900 for communications between your OS Image and XenCenter or other Xen client.
<table><thead><tr><th>Destination</th><th>Activity</th><th>Protocol</th><th>Ports</th></tr></thead><tbody><tr><td>XenCenter</td><td>Communications</td><td> </td><td>5900</td></tr></tbody></table>
##Next step<a name="Next_step_..523"></a><a name="Next_..57"></a>
If you are publishing to PVS: Install the Unidesk Agent (required for PVS and Connector Scripts)
If you are ***not***  publishing to PVS: Assign Unidesk Roles to users

#Install the Unidesk Agent (required for PVS and Connector Scripts)<a name="Install_the_Unidesk_Agent_(required_for_PVS_and_Connector_Scripts)"></a>
In this article:
<table><tbody><tr><td><p>About installing the Unidesk Agent</p><p>Prerequisites</p><p>Install the Unidesk Agent</p><p>Register with the Unidesk ELM manually</p><p>Next step</p></td></tr></tbody></table>
##About installing the Unidesk Agent<a name="About_installing_the_Unidesk_Agent"></a><a name="About"></a>
The Unidesk Agent enables the Unidesk Enterprise Layer Manager (ELM) or a Unidesk Packaging Machine VM to run PowerShell commands locally. If you supply the proper credentials, the agent can run PowerShell commands as a specific user.
The Unidesk Agent is required in cases where one of your Connector Configurations launches a PowerShell script. This includes Connector Configurations you use to:
<ul><li>Publish Layered Images to a provisioning system.</li><li>Package Layers in your hypervisor environment.</li></ul>
The Unidesk Agent installer prompts you to register the agent with a Unidesk ELM. If you do not register the agent during installation, you can manually register it later. However, keep in mind that the PowerShell scripts will not run until the agent is registered with the ELM.
##Prerequisites<a name="Prerequisites_..524"></a><a name="Prereq"></a>
Before you install the Unidesk Agent, you must have the following requirements on the system where you are installing the Unidesk Agent:
<ul><li><p>An account with administrator privileges</p></li><li><p>.NET 4.5</p></li><li><p>PowerShell 3.0 or greater</p></li><li><p>PowerShell Snap-in</p><p>Before using the Unidesk Agent on a PVS server you must ensure the PowerShell Snap-in is installed. This is a manual step.</p><ul><li><p>For PVS 7.7 and later, you must install the Powershell Snap-in <span>Citrix.PVS.Snapin.dll</span>.</p></li><li><p>For PVS 7.6 and PVS 7.1, you must install <span>McliPSSnapIn.dll</span>. Use the <span>installutil.exe</span> to install the Snap-in.</p><p>Example (7.6):</p><ol><li><p>From a command prompt, go to:</p><p><code>c:\program files\citrix\provisioning services console</code></p></li><li><p>Run this command:</p><pre>"C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe" McliPSSnapIn.dll</pre></li></ol><p>Example (7.7):</p><ol><li><p>From a command prompt, go to:</p><p><code>c:\program files\citrix\provisioning services console</code></p></li><li><p>Run this command:</p><pre>"C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe" Citrix.PVS.snapin.dll</pre></li></ol></li></ul><p>On Windows 2008 R2, you must also enable PowerShell remote commands. For background information, see this Microsoft article:</p><p>https://technet.microsoft.com/en-us/library/hh849694.aspx</p><p>If your 2008 R2 OS does not have PowerShell remoting enabled, run the following PowerShell command on the PVS server:</p><pre>Enable-PSRemoting</pre></li></ul>
##Install the Unidesk Agent<a name="Install_the_Unidesk_Agent"></a><a name="Create_Share_..58"></a>
<ol><li><p>Log in as an administrator on the system where you are installing the agent.</p></li><li><p>Download the Unidesk Agent from the Unidesk Download page.</p></li><li><p>Copy the <span>Unidesk_agent_installer.exe</span> file from the Unidesk Agent folder to a convenient location on the PVS server.</p></li><li><p>Run the <span>Unidesk_agent_installer.exe</span> as Administrator, and when prompted, enter the path to the directory where you want to install the Unidesk Agent. The default location is <span>C:\\Program Files (x86)\Unidesk\Agent</span>.</p><p>The Unidesk Agent installer checks to see if all Prerequisites are present. If any prerequisites are missing, the installer reports this and exits without installing.</p></li><li><p>The installer prompts you for an Agent Port number. You can accept the default port number (8016) or specify a different one if the default port is already in use.</p></li><li><p>The installer prompts you for the credentials (<em>address</em>, <em>username</em>, and <em>password</em>) for your Unidesk ELM. Register the Unidesk Agent with the ELM by entering the IP address and login credentials for a Unidesk Management Console (UMC) user on the ELM with Administrator privileges, (for example, the credentials you use to log into the UMC).</p><p><strong>Note:</strong> If the Unidesk ELM is not available yet or you choose not to register with it now, you can manually register at a later time using the procedure described in Register with the Unidesk ELM manually.</p></li><li><p>Click <strong>Finish</strong> to exit the wizard.</p></li></ol>
The Unidesk Agent registration appears in the Audit log for the Management Service in the Unidesk Management Console.
##Register with the Unidesk ELM manually<a name="Register_with_the_Unidesk_ELM_manually"></a><a name="Manual_Register"></a>
If the Unidesk Agent was not registered with a Unidesk ELM during installation, you can register it later by using the following procedure.
To manually register the Unidesk Agent with the ELM:
<ol><li><p>As an <em>administrator</em>, log in to the server where you installed the Unidesk Agent.</p></li><li><p>Open a command window (cmd.exe) as administrator and navigate to the directory where the Unidesk Agent is installed. (The default location is <span>C:\\Program Files (x86)\Unidesk\Agent</span>.)</p></li><li><p>Run the following command, using the IP address of the ELM where indicated:</p><p><span>Unidesk.Agent.Service.exe register /i /e:<em>IP_address_of_ELM</em> /u:Administrator</span> </p></li><li><p>When prompted, enter the password for a user who has Administrator privileges in the Unidesk Management Console (UMC) on the ELM.</p></li><li><p>When the registration process completes, a message appears informing you of the successful outcome. The Unidesk Agent registration appears in the Audit log for the Management Service in the UMC.</p></li></ol>
If the process does not succeed, examine the ```\Unidesk\Agent\Logs\unidesk.agent.log```
 file in the Unidesk Agent installation directory. You can also view Help for the Unidesk Agent command line options by running the following command: Unidesk.Agent.Service.exe /?.
##Next step<a name="Next_step_..525"></a><a name="Next_..59"></a>
Connect to a Directory Service
#Connect to a Directory Service<a name="Connect_to_a_Directory_Service"></a>
In this article:
<table><tbody><tr><td><p>About connecting Unidesk to a directory service</p><p>Create a directory junction</p><p>Connect to a Directory Service</p></td></tr></tbody></table>
You can configure Unidesk to connect to a Directory Service, for example, Active Directory. When you connect to your directory service, you will create one or more Directory Junctions to access specific domains or OUs. Unidesk does ***not***  modify the directory service you connect to. The Unidesk software caches the attributes for each directory service entry, so that if the connection to the directory service is lost temporarily, the software can use the cached information for management tasks.
##About connecting Unidesk to a directory service<a name="About_connecting_Unidesk_to_a_directory_service"></a><a name="About_..60"></a>
The Unidesk Management Console Directory Tree displays a hierarchical view of Users and Groups. Each Directory Junction that you create specifies a starting node in the directory tree.
###Overlapping Directory Junctions<a name="Overlapping_Directory_Junctions"></a>
Overlapping (or nested) Directory Junctions occur when you create multiple Directory Junctions that contain the same users and then import the users into the Unidesk directory tree. When overlapping occurs, each Directory Junction contains its own copy of the duplicate users.
Example: Overlapping directory junctions
Assume you create Directory Junction A that starts at the Marketing folder in a directory service tree. Next, you create Directory Junction B which starts at a folder above the Marketing folder. If you browse both Directory Junctions, you can see the Marketing users in both folders.
###User attributes are imported from the directory service<a name="User_attributes_are_imported_from_the_directory_service"></a>
The Unidesk software imports and caches user and group attributes from your directory service when:
<ul><li>You assign administrator privileges to a user.</li><li>The values of the attributes change in the directory service.</li></ul>
The attributes that the Unidesk software caches are read only. All changes to the attributes for directory service users come from the directory server.
###Imported attributes are synchronized regularly<a name="Imported_attributes_are_synchronized_regularly"></a>
The Unidesk software synchronizes the information it caches for directory service users with the directory service every 12 hours. If the software discovers that a user is no longer an object in the directory service, it classifies the user as abandoned (you can view this information in the Information view for the user).
##Create a directory junction<a name="Create_a_directory_junction"></a><a name="Cr_junction"></a>
Create the folders where you want to place the Directory Junctions or decide which existing folder you want to use. You can add a Directory Junction folder to any existing folder in the Unidesk Management Console directory tree.
***Best Practice:***  Avoid creating overlapping Directory Junctions, if possible. In some circumstances, deleting an overlapping Directory Junction can affect your ability to delete another Directory Junction that contains the same users.
<ol><li><p>Select <strong>Users > Directory Service</strong>.</p></li><li><p>Select <strong>Create Directory Junction</strong> in the Action bar. This opens the Create Directory Junction wizard.</p></li><li><p>In the Connection Details tab, specify the details for the directory server.</p><ul><li>Directory Junction Name- This name becomes the name of the folder that you see in the tree view. You can use any name, including the name of a domain in your directory service tree.</li><li>Server address - This is the name for the server you will use for the directory service. (IP Address or DNS Name)</li><li>Port - Specify the port number for communicating with the directory server.</li><li><p>SSL check box - Select this if you want to use Secure Sockets Layer (SSL) communication.</p><p><a href="#Open_firewall_ports_for_Unidesk,_as_needed_..10"></a> If certificate errors occur, the wizard displays a list of these errors. If you know it is safe to ignore them, select <span>Ignore Certificate Errors</span>.</p></li><li><span>Test Connection</span> - Click to verify that the Unidesk ELM can connect to the directory service.</li></ul></li><li><p>In the Authentication Details tab, enter the authentication details for a user who has permissions to search the directory service.</p><ul><li><p>Bind Distinguished Name - To determine the correct syntax for the Bind DN or user name, see the documentation for your directory.</p><p><span>Examples: </span>The following examples shows some of the ways you can specify a user for the directory service: <span>domain\username </span>or <span>username@domain.com</span>.</p></li><li><p>Bind Password.</p></li><li>Test Authentication - Click to verify that the connection to the directory server is valid.</li></ul></li><li><p>In the Distinguished Name Details tab, specify where the software should start searching for users and groups in the remote directory service.</p><ul><li><p>Base Distinguished Name (DN) - The software starts searching for users and groups in the remote directory service. Once you establish a connection to the server for the directory service, the wizard displays a list of available DNs. You can select a DN from the list or enter the DN directly in the box.</p><p><span>Example</span>: Assume that you want to start the search at the Marketing Organizational Unit at the root of a domain. You would enter the following Base DN:</p><p><span>OU=marketing, DC=root,DC=mydomain DC=com</span></p></li><li>Test Base DN - Click to verify that the Base DN is valid.</li></ul></li><li>In the Folder Location tab, select the folder in the Unidesk tree where you want to add the directory junction for the remote directory service.</li><li><p>In the Attribute Mapping tab, enter the names of directory service attributes that you want to map to the local attributes or use the default settings.</p><p>Note: To change the mapping from local attributes back to default mappings, click Use Defaults.</p></li><li><p>In the Confirm and Complete tab, verify the Directory Junction settings, enter a comment if required, and click Create Directory Junction.</p><p>If you enter comments, they appear in the Information view Audit History.</p></li></ol>
##Next step<a name="Next_step_..526"></a>
Assign Unidesk Roles to users


# Assign Unidesk Roles to users<a name="Assign_Unidesk_Roles_to_users"></a>
In this article:
<table><tbody><tr><td><p>Unidesk Roles defined</p><p>Assign Unidesk Roles to users</p><p>Next step</p></td></tr></tbody></table>
##About Unidesk users, roles, and rights<a name="About_Unidesk_users,_roles,_and_rights"></a>
Built-in Administrator account<a name="Built-in_Administrator_account"></a>
When you first install the Unidesk ELM (appliance) and log onto the Unidesk Management Console (UMC), there is a "built-in" Administrator account that you can use to get started. This Administrator has the rights to perform all Unidesk operations. You can edit this user's properties, including the name, password, and contact info. Be sure to change the password for this built-in Administrator account as part of installing and configuring the Unidesk ELM.
 AD User accounts<a name="AD(SPACE)User_accounts"></a>
Other than the built-in Administrator account, all Unidesk users are actually AD users imported via one or more directory junctions. Once your directory junction(s) have been created, you can assign Unidesk Roles to each user, as described later in this topic. You can see which roles are assigned to a user in the User Details.

###Unidesk Roles defined<a name="Unidesk_Roles_defined"></a><a name="Unidesk_..61"></a>
Unidesk Roles determine which Unidesk modules a user can manage. Users assigned one or more Unidesk Roles can log into the UMC, and these users are listed on the Administrators tab (select ***Users > Administrators*** ).
***Note:***  When upgrading from Unidesk 4.0.6 or earlier, users assigned the Machine Administrator Role in earlier releases will now be assigned the ***Read Only***  Role. If the user needs more than read only access, reconfigure the user roles, as needed.
###Rights by Role<a name="Rights_by_Role"></a>
<table><thead><tr><th>Role</th><th>Rights</th></tr></thead><tbody><tr><td><p>Administrator</p></td><td><ul><li>Can do every operation available in the UMC.</li><li>Only users assigned the Administrator Role can edit user properties on the Users tab (Select <strong>Users > Users</strong>).</li><li>Only administrators can configure ELM system settings. and manage licenses.</li></ul></td></tr><tr><td><p>Manage App Layers</p></td><td><ul><li>Can create, edit, and delete application layers and versions.</li></ul></td></tr><tr><td><p>Manage Elastic Layer Assignments</p></td><td><ul><li>Can add, update, and remove Elastic layer assignments.</li></ul></td></tr><tr><td><p>Manage Image Templates</p></td><td><ul><li>Can create, edit and delete Image templates.</li><li>Can add, update, and remove app layer assignments for image templates.</li><li>Can update platform layer assignments for image templates.</li><li>Can update OS layer assignments for image templates.</li></ul></td></tr><tr><td><p>Manage OS Layers</p></td><td><ul><li>Can create, edit, and delete OS layers and versions.</li></ul></td></tr><tr><td><p>Manage Platform Layers</p></td><td><ul><li>Can create, edit, and delete Platform layers and versions.</li></ul></td></tr><tr><td><p>Publish Layered Images</p></td><td><ul><li>Can publish layered images.</li><li>Cannot create or modify existing image templates.</li></ul></td></tr><tr><td><p>Read Only</p></td><td><ul><li>Can view information about any items in the UMC.</li><li>Cannot launch any wizards or make any changes.</li><li>The Read Only user cannot cancel any tasks.</li></ul></td></tr></tbody></table>
###User credentials for logging into the UMC<a name="User_credentials_for_logging_into_the_UMC"></a>
When you assign Unidesk Roles to Directory Service users, they can use their Directory Service credentials to log into the UMC.
###Who can assign Unidesk Roles?<a name="Who_can_assign_Unidesk_Roles_"></a><a name="Who"></a>
You can change a user's role if you are logged into the UMC as a user assigned the Administrator Role.
##Assign Unidesk Roles to users<a name="Assign_Unidesk_Roles_to_users_..527"></a><a name="Assign"></a>
<ol><li>Log into the UMC.</li><li>Select <strong>Users > Users</strong>.</li><li>Select a user and click <span>Edit Properties</span>. This opens the Edit User wizard.</li><li><p>Skip to the Roles tab, and select one or more roles for this user. For details, see <em>Rights by Role</em> above.</p><p><img></img></p></li><li>In the Confirm and Complete tab, click <span>Update User</span>. Any comments you enter will appear in the Information view Audit History.</li></ol>
##Next step<a name="Next_step_..528"></a><a name="Next_..62"></a>
[Create Layers](#Create_Layers)
# Enable Unidesk Labs features<a name="Enable_Unidesk_Labs_features"></a>
In this article:
<table><tbody><tr><td><p>Welcome to Unidesk Labs</p><p>Enable a Unidesk Labs feature</p><p>Labs features in this release</p></td></tr></tbody></table>
##Welcome to Unidesk Labs<a name="Welcome_to_Unidesk_Labs"></a><a name="Welcome"></a>
Want to experiment with cool new features that are under development? Through the Unidesk Management Console, you can now see which features are available in Unidesk Labs in any given release. You can enable features you're interested in, try them out, and let us know what you think. The only caveat? Best not use Labs features in your production environment, as they are likely to evolve with the feedback we receive from users like you!
In the Learning Center, features that are available through Unidesk Labs are marked (Unidesk Labs) in the title. ***Some***  Unidesk Labs features require enabling, as described in the next section, though in the current release, the features available through Labs do ***not***  need to be enabled.
##Enable a Unidesk Labs feature<a name="Enable_a_Unidesk_Labs_feature"></a><a name="Turn"></a>
When a release includes a Unidesk Labs feature that you want to enable:
<ol><li>Log into the UMC and select <strong>System > Settings and Configuration</strong>.</li><li>Select the check box for the feature you want to enable, and click <strong>Save</strong>. The feature's status changes to <em>Enabled</em>.</li></ol>
You can turn off the feature at any time by deselecting the check box and clicking ***Save*** .
##Labs features in this release<a name="Labs_features_in_this_release"></a><a name="Labs"></a>
To find out which Labs features are available in this release, see the [Release Notes](#Early)[.](#Early)
# Enable Unidesk Labs features<a name="Enable_Unidesk_Labs_features_..6"></a>
In this article:
<table><tbody><tr><td><p>Welcome to Unidesk Labs</p><p>Enable a Unidesk Labs feature</p><p>Labs features in this release</p></td></tr></tbody></table>
##Welcome to Unidesk Labs<a name="Welcome_to_Unidesk_Labs_..529"></a><a name="Welcome_..63"></a>
Want to experiment with cool new features that are under development? Through the Unidesk Management Console, you can now see which features are available in Unidesk Labs in any given release. You can enable features you're interested in, try them out, and let us know what you think. The only caveat? Best not use Labs features in your production environment, as they are likely to evolve with the feedback we receive from users like you!
In the Learning Center, features that are available through Unidesk Labs are marked (Unidesk Labs) in the title. ***Some***  Unidesk Labs features require enabling, as described in the next section, though in the current release, the features available through Labs do ***not***  need to be enabled.
##Enable a Unidesk Labs feature<a name="Enable_a_Unidesk_Labs_feature_..530"></a><a name="Turn_..64"></a>
When a release includes a Unidesk Labs feature that you want to enable:
<ol><li>Log into the UMC and select <strong>System > Settings and Configuration</strong>.</li><li>Select the check box for the feature you want to enable, and click <strong>Save</strong>. The feature's status changes to <em>Enabled</em>.</li></ol>
You can turn off the feature at any time by deselecting the check box and clicking ***Save*** .
##Labs features in this release<a name="Labs_features_in_this_release_..531"></a><a name="Labs_..65"></a>
To find out which Labs features are available in this release, see the [Release Notes](#Early)[.](#Early)
#Upgrade Unidesk<a name="Upgrade_Unidesk"></a>
Are you upgrading the Unidesk ELM and Agent, or your Unidesk license?

#Upgrade the Unidesk ELM and Agent<a name="Upgrade_the_Unidesk_ELM_and_Agent"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Download the upgrade media to the Network File Share</p><p>Load the Unidesk upgrade</p><p>Upgrade the Unidesk Agent (PVS Servers only)</p></td></tr></tbody></table>
##Prerequisites<a name="Prerequisites_..532"></a><a name="Prerequi"></a>
Verify that a Set up a network file share has been configured. You can confirm that this has been done by logging into the Unidesk Management Appliance (UMC), selecting ***System > Settings and Configuration*** , and finding the Network File Share setting. If the file share has been configured, you can upgrade the ELM. If not, click Set up a network file share to configure a file share.
##Download Packages<a name="Download_Packages"></a>
<table><thead><tr><th>Platform</th><th>Package</th><th>Files included</th></tr></thead><tbody><tr><td>Citrix XenServer</td><td>unidesk_upgrade_xenserver_pkg_4.x.x.zip</td><td>upgrade_xenserver_elm_4.x.x.xx.vhd</td></tr><tr><td>MS Azure</td><td>unidesk_upgrade_azure_pkg_4.x.x.zip</td><td>upgrade_azure_elm_4.x.x.xx.vhd</td></tr><tr><td>MS Hyper-V</td><td><p>unidesk_upgrade_hyperv_pkg_4.x.x.zip</p></td><td>upgrade_hyperv_elm_4.x.x.xx.vhd</td></tr><tr><td>VMware vSphere</td><td>unidesk_upgrade_pkg_4.x.x.zip</td><td><p>upgrade_vmware_elm_4.x.x.xx.vhd</p><p>unidesk_agent_installer.exe</p><p><strong>Note:</strong> A Unidesk Agent upgrade is only required if you've installed the agent for your implementation, for example, if you are using PVS, or Connector Scripts.</p></td></tr></tbody></table>
##Back up the Unidesk ELM<a name="Back_up_the_Unidesk_ELM"></a>
<ol><li>Take a snapshot or checkpoint of the Unidesk ELM.</li></ol>
##Download the upgrade media to the Network File Share<a name="Download_the_upgrade_media_to_the_Network_File_Share"></a><a name="Download_..66"></a>
The Unidesk 4 upgrade files to download include the ELM upgrade and the Unidesk Agent upgrade, which is used to upgrade the agent on PVS servers and on servers where Layered Images are enabled for Elastic Layers.
<ol><li>In a network browser, navigate to the <a href="http://www.unidesk.com/support/unidesk-4-download">Unidesk 4 Download</a> page.</li><li>Download the Unidesk package for your platform to the <em>\Upgrade</em> folder on the Network File Share.</li><li><p>Unzip the package in \Upgrade.</p></li><li>Copy the Unidesk Agent upgrade to the server(s) where the agent is installed, and refer to Upgrade the Unidesk Agent below.</li></ol>
##Load the Unidesk upgrade<a name="Load_the_Unidesk_upgrade"></a><a name="Run"></a>
<ol><li>Log into the UMC, select <strong>System</strong> and click the <strong>Upgrade</strong> action to launch the Upgrade Wizard.</li><li>On the Upgrade Disk Details tab, click <strong>Browse</strong>.</li><li>Navigate to the upgrade file, and click <strong>Choose</strong>.</li><li>Verify the Upgrade path, and click <strong>Upgrade</strong>. This starts the upgrade process, and opens a status page in the browser.</li><li>Once the upgrade has completed, the status changes to "Upgrade Status: Complete."</li><li>Refresh the Web page to return to the UMC.</li><li>Verify that the upgrade was successful by clicking the <strong>About</strong> link in the UMC to confirm the version number.</li></ol>
##Upgrade the Unidesk Agent<a name="Upgrade_the_Unidesk_Agent"></a><a name="Upgrade_..67"></a>
In cases where the Unidesk Agent is required, for example when using PVS or Elastic Layers, upgrade the Unidesk Agent as follows.
<ol><li>Make sure that you have copied the Unidesk Agent Upgrade file to the PVS server(s) where the agent is installed.</li><li>Double-click the Agent upgrade file, and follow the instructions for upgrading the agent.</li></ol>


#Update your Unidesk license<a name="Update_your_Unidesk_license"></a>
In this article:
<table><tbody><tr><td><p>Log into the Unidesk site</p><p>Update your Unidesk license (with web access to the ELM)</p><p>Update your Unidesk license (without web access to the ELM))</p></td></tr></tbody></table>
To acquire a Unidesk license, you must be logged in to Unidesk. If you have not already done so, register on the Unidesk website to obtain a User Name and Password.
##Log into the Unidesk site<a name="Log_into_the_Unidesk_site"></a><a name="Register_..68"></a>
<ol><li>In a web browser, navigate to <a href="http://www.unidesk.com">the Unidesk website</a> and click <strong>Login</strong>.</li><li>If you have not yet registered with Unidesk, go to the Register section of the login page, enter your email address and click <strong>Register.</strong><p>Unidesk sends a confirmation email message to the address you provided.</p></li><li>Open the confirmation email message from Unidesk, which contains the Subject line "Confirming your registration at www.unidesk.com", and click the link it contains or paste the link into a web browser.</li><li>To finish registering, fill out the fields in the "Email address confirmed" page and click the <strong>Complete registration</strong> button.</li></ol>
##Update your Unidesk license (<a name="Update_your_Unidesk_license_(with_web_access_to_the_ELM)"></a><a name="Update"></a>***with***  web access to the ELM)<a name="Update_your_Unidesk_license_(with_web_access_to_the_ELM)"></a><a name="Update"></a>
If you receive a message that your license needs updating, and your Enterprise Layer Manager has web access:
<ol><li>In the License Expired message, click <span>License</span>. This opens the Update License wizard.</li><li>Select <strong>Download your license now by entering your credentials for the www.unidesk.com website</strong>.</li><li>Enter your credentials for the Unidesk website.</li><li>On the Confirm Your License tab, click <span>Finish</span>.</li><li>You can return to the Licensing wizard at any time by logging into the Unidesk Management Console and clicking <strong>About</strong>, and then the <strong>License</strong> tab.</li></ol>
##Update your Unidesk license (<a name="Update_your_Unidesk_license_(without_web_access_to_the_ELM))"></a><a name="Update2"></a>***without***  web access to the ELM))<a name="Update_your_Unidesk_license_(without_web_access_to_the_ELM))"></a><a name="Update2"></a>
If you receive a message that your license needs updating, and your Enterprise Layer Manager does ***not***  have web access:
<ol><li>Obtain a license file from Unidesk Sales or Support, and move the file to a drive that Enterprise Layer Manager can access.</li><li>If the License Expired message, is still open, click <span>License</span> in the message. If not, click <strong>About</strong>, then the <strong>Update License</strong> button. This opens the Update License wizard.</li><li>Select <strong>Upload your license file from a local drive</strong>.</li><li>Click <strong>Browse</strong>, and select the license file.</li><li>On the Confirm Your License tab, click <span>Finish</span>.</li><li>You can return to the Licensing wizard at any time by logging into the Unidesk Management Console and clicking <strong>About</strong>, and then the <strong>License</strong> tab.</li></ol>
#Unidesk Glossary<a name="Unidesk_Glossary"></a>
This section contains terminology across all platforms and operating systems that Unidesk supports. Note that some of the terms may not pertain to your specific environment.
A
App Layer
A virtual disk containing one or more applications that you can use in any number of Layered Images. When publishing a Layered Image, you can combine an App Layer with the OS Layer used to create it, other App Layers, and a Platform Layer.

C
Connector
Connectors are the interfaces to environments where layers are created and images are published. The type of platform connector determines the information required to create a specific Connector Configuration.

Connector Configuration
A stored set of values for connecting to a specific environment. A configuration typically includes credentials for authentication, a storage location, and any other information required to interface with the environment where you will be creating layers or publishing images.

D
Directory Junction
A connection to a base Distinguished Name in a directory service (such as Microsoft Active Directory). Adding a Directory Junction to the local tree allows you to assign Administrator privileges to users that are defined in the directory service instead of in the Unidesk Management Console.

Directory service
A hierarchical repository of information about users, devices and services on a network server. Microsoft Active Directory and LDAP are examples of directory services.

Directory service user
A user whose attributes reside in a remote directory service but is also visible in the Unidesk environment through the use of a directory junction. You can assign Unidesk Administrator privileges to users.

Directory tree
A view of data in a hierarchical, tree-like structure. The Unidesk directory tree contains entries for users, groups, containers, and Virtual Machines. You can extend this view by adding connections to a remote directory service, such as Active Directory.

E
Elastic Layer
A Unidesk App Layer that the Unidesk administrator can deliver based on user entitlements when users log onto sessions or standalone desktops. Elastic Layers allow administrators to give each user his/her own unique set of applications, on top of the base Layered Image used across sessions (in the case of session hosts), and across floating pools/shared groups (in the case of desktops). This can drastically reduce the number of base Layered Images that administrators need to maintain.

Enterprise Layer Manager (ELM)
A virtual appliance that coordinates communication in the Unidesk environment, and hosts the Unidesk Management Console (UMC), the administrator interface for the Unidesk environment. The ELM also manages copies of all Layers.

I
Image Template
An Image Template saves the OS Layer, App Layer, and Platform Layer assignments you have chosen for a Layered Image, allowing you to use any combination of layers to provision any number of servers.

L
Layer
A Unidesk layer captures a Windows Operating System, a Windows Application, or the configuration settings and tools required for Images to run on a particular platform in a virtual disk that can be combined with other layers to create a Layered Image. Layers are created from a simple install of the application or operating system. You can select any combination of Layers for each Layered Image. You can reuse the same layers in any combination to provision a variety of servers.

Layered Image
A bootable image composited from an OS Layer, a Platform Layer, and any number of App Layers. Layered Image(s) are published using Image Templates where you save your layer selections for a particular use, usually provisioning servers in a specific silo.

Layering Management Console (LMC)
The Web-based management console that runs on the Enterprise Layer Manager (ELM). This console allows you to manage the App Layering components in your environment. You can use is to create Layers, publish Layered Images, and manage system settings.

Local Storage
A Layer repository where the ELM creates, composites, and stores Layers and Layered Images. Local storage is used for temporary files during the creation of Layers and Layered Images, and for persistent files, for example, Layers and Image Templates. Administrators can define the Network File Share location that will be used for Elastic Layers in the UMC's System and Settings.

O
OS Disk
The virtual disk containing the Operating System that is imported to create an OS layer. To prepare the OS disk you will install and configure an Operating System on a virtual machine and install the Unidesk tools. The OS Disk is the virtual disk where the Operating System was installed.

OS Layer
A virtual disk containing the operating system. You can use an OS Layer with any compatible App Layers in any number of Layered Images. You can create a new Version of the OS Layer for every patch you need to roll out, and continue deploying every and all versions of the layer as you add patches.

OS Machine
The Operating System (OS) Machine is a virtual machine that you create from which you can generate an OS Disk and an OS Layer.

P
Packaging Disk
A bootable virtual disk used to create a Packaging Machine needed for creating or updating a Layer. The Packaging Disk always includes your OS Layer and may also include selected Application and Platform Layers.

Packaging Machine
A virtual machine that acts as a staging area for the creation of App Layers, App Layer Versions, and OS Layer Versions. The Packaging Machine is booted from a Packaging Disk using the credentials and location specified in the selected Connector Configuration.

Platform Layer
A layer that includes configuration settings, tools, and other software required for Images to run on a particular platform. For example, a platform layer for vSphere would include vmTools. Platform Layers also remove leftover software from other platforms from your image.

Prerequisite Layer
An application that is required when installing another application for a new Application Layer or Layer Version. For example, you would select your Microsoft Office App Layer as a Prerequisite Layer when installing a Microsoft Office plugin in a separate App Layer. Or, you would select your Java App Layer as a Prerequisite Layer when creating a Layer for an application that requires Java.

S
Session Container
A Citrix technology that allows different users logged into the same Session Host to be assigned different versions of the same Elastic Layer, and ensures that those Layer versions do not conflict.


#Test drive: Publish to Citrix XenServer<a name="Test_drive:_Publish_to_Citrix_XenServer"></a>
Once Unidesk is set up, you can use this test drive to create your first layers in XenServer, and then publish a test image to Citrix PVS. This example uses Windows Server 2012, Citrix PVS 7, and Citrix XenApp 7.
Please download the Test Drive from this Unidesk [forum article](http://www.unidesk.com/forum/unidesk-4/process-documentation-publish-citrix-xenserver)[.](http://www.unidesk.com/forum/unidesk-4/process-documentation-publish-citrix-xenserver)
If you have any questions, please ask your Unidesk Solutions Architect for assistance.

#Test drive: Publish to PVS, XenApp 7 in vSphere<a name="Test_drive:_Publish_to_PVS,_XenApp_7_in_vSphere"></a>
In this article:
<table><tbody><tr><td><p>Platforms used in this test drive</p><p>Components you will create</p><p>Prerequisites</p><p>Publish a test image with an OS Layer and a Platform Layer</p><p>Add your first App Layer and republish the Layered Image</p></td></tr></tbody></table>
##Platforms used in this test drive<a name="Platforms_used_in_this_test_drive"></a><a name="Platform_..69"></a>
<table><tbody><tr><td>Create Layers in:</td><td>vSphere</td></tr><tr><td>Publish Layered Images to:</td><td>PVS</td></tr><tr><td>For delivery to:</td><td>XenApp users</td></tr></tbody></table>
This test drive leads you through the process of publishing a Layered Image as a vDisk to a PVS server. As this diagram shows, the hypervisor in this scenario is vSphere, and the connection broker is Citrix XenApp.

##Components you will create<a name="Components_you_will_create"></a><a name="Componen"></a>
<table><tbody><tr><th>Component</th><th>Description</th></tr><tr><td>OS Layer</td><td><ul><li>Contains Windows Server 2012 R2</li><li>Unidesk Tools are installed</li><li>Network card is set to VMXNet3</li></ul></td></tr><tr><td>Platform Layer</td><td><ul><li>Layer containing all platform-related software and settings</li><li>Created in vSphere using a VMware VM for the Packaging Machine</li></ul></td></tr><tr><td>App Layer</td><td><ul><li>Notepad++</li></ul></td></tr><tr><td>Image Template</td><td><ul><li>Created in two stages:<ul><li>Stage 1: Includes OS Layer ; Platform Layer</li><li>Stage 2: Includes the addition of App Layer</li></ul></li></ul></td></tr><tr><td>Layered Image</td><td><ul><li>Image Template</li><li>OS Layer</li><li>Platform Layer</li><li>App Layer</li></ul></td></tr><tr><td>PVS vDisk</td><td><ul><li>Contains the Unidesk Layered Image</li></ul></td></tr></tbody></table>
##Prerequisites<a name="Prerequisites_..533"></a><a name="Prerequi_..70"></a>
<table><tbody><tr><td><h3><a href="http://www.unidesk.com/forum/unidesk-4/process-documentation-publish-citrix-xenserver"></a>Unidesk</h3><p><span>o</span> Unidesk ELM installed on a server in your vSphere environment.</p><p><span>o</span> Unidesk Tools downloaded from the Unidesk Download page and copied to a location that the Packaging Machine VM will be able to access.</p><h3><a href="http://www.unidesk.com/forum/unidesk-4/process-documentation-publish-citrix-xenserver"></a>vSphere</h3><p><span>o</span> Access from the Packaging Machine VM in vSphere to the Unidesk Tools download, which is available on the Unidesk Download page.</p><p><span>o</span> vSphere resource information for Unidesk <a href="#Connector_Configuration_(AND)_Optional_Script__(vSphere)">vSphere Connector Configuration</a>.</p><h3><a href="#Connector_Configuration_(AND)_Optional_Script__(vSphere)"></a>Citrix XenApp</h3><p><span>o</span> XenApp Virtual Delivery Agent Installer for Windows Server OS. The XenApp version must match the version of the XenApp server on which the Layered Image will be used.</p></td><td><h3><a href="#Connector_Configuration_(AND)_Optional_Script__(vSphere)"></a>PVS</h3><p><span>o</span> Unidesk Agent - Installed on all PVS servers used to access the PVS servers to which you will publish images. (Agent must be registered with the Unidesk ELM.)</p><p><span>o</span> All PVS servers where the Unidesk Agent is installed must have the PVS Console installed.</p><p><span>o</span> PVS Target Device Imaging software (version must match the PVS server to which the Layered Image will be published).</p><p><span>o</span> PVS resource information for the Unidesk <a href="#Connector_Configuration_(AND)_Optional_Script_(PVS)">PVS Connector Configuration</a>.</p><p><span>o</span> Appropriate PowerShell Snap-in must be installed.</p><p><span>o</span> When using KMS licensing, PVS requires that each target device has a unique CMID. For more about this, see the Citrix article, <a href="https://www.citrix.com/blogs/2014/05/01/demystifying-kms-and-provisioning-services/">Demystifying KMS and Provisioning Services</a>. The steps for rearming KMS are covered in the <a href="#Step3_platform_pulishing">Platform Layer instructions</a> below.</p></td></tr></tbody></table>
##Publish a test image with an OS Layer and a Platform Layer<a name="Publish_a_test_image_with_an_OS(SPACE)Layer_and_a_Platform_Layer"></a><a name="Part"></a>
In this part of the test drive you will:
<table><tbody><tr><td><p>Step 1: Create an OS Layer</p><p>Step 2: Create a Platform Layer to include in Layered Images</p><p>Step 3: Create an Image Template</p><p>Step 4: Publish a Layered Image to PVS</p><p>Step 5: Assign the new vDisk to a collection</p></td></tr></tbody></table>
###Step 1: Create an OS Layer<a name="Step_1:_Create_an_OS(SPACE)Layer"></a><a name="Step"></a>

In this step you will create a vSphere VM to use as your OS Machine, and prepare the OS on it. Then you will download the OS .vmdk file to the Network File Share and import the OS Disk into the Unidesk OS Layer.
<ol><li><p>In vSphere, create a Windows Server 2012 R2 VM, specifying a network adaptor of VMXNet3.</p><p><strong>Important:</strong> When creating the image, be sure to choose the default cluster allocation size of 4K.</p></li><li>Log into the new VM.</li><li>Check to see if the operating system is configured with a VMXNet3 card, and if not, change the setting to VMXNet3. Then restart the system and ensure the new network adapter setting is working.</li><li>Install Windows Server 2012 <strong>Session Host role</strong>.</li><li>Download the Unidesk OS Machine Tools from the Unidesk Support Download Center.</li><li>Double-click the executable to copy the scripts and files to <code>C:\Windows\Setup\scripts</code>.</li><li>From the <code>C:\Windows\Setup\scripts</code> folder, run the included Setup_x64.exe file on the VM to install the Unidesk tools.</li><li>Shut down the VM.</li><li>Right-click the VM and select <strong>Template > Export OVF Template</strong>. This preserves any snapshots you may have made.</li><li>In the wizard that opens, select the name of the file that will be created, and the directory in which you would like to store the file and format: "Folder of files (OVF)". Files are downloaded to the Network File Share.</li><li>In the Unidesk ELM, select <strong>Layers > OS Layers</strong> and click <strong>Create OS Layer</strong>. This opens the Create OS Layer Wizard so you can set up the new Layer and import your operating system into it.</li><li>First, specify a <strong>Layer Name</strong> and <strong>Version</strong> in the Layer Details tab.</li><li>In the Connector tab, select the <strong>Network File Share</strong> where you downloaded the vSphere .vmdk files. Once connected to the file share, you can select the operating system to import.</li><li>In the OS Disk Details tab, click <strong>Browse</strong> to select the *.vmdk file.</li><li>In the Icon Assignment tab, select the 2012 icon for this Layer.</li><li>In the Confirm and Complete tab, make sure the details of the OS Layer are correct, and click <strong>Create Layer</strong>.</li></ol>
When the task completes, the new OS Layer in the Unidesk Management Console (UMC) displays a ***Deployable***  status.
###Step 2: Create a Platform Layer to include in Layered Images<a name="Step_2:_Create_a_Platform_Layer_to_include_in_Layered_Images"></a><a name="Step3_platform_pulishing"></a>
Platform Layers contain the software and settings required to either:
<ul><li>Create other Layers in your hypervisor environment, or</li><li>Publish and run your Layered Images in the target environment</li></ul>
By putting all platform-specific software and settings into Platform Layers, your other Layers and Image Templates are free of any platform-specific software, and can be used to create Layered Images for multiple environments.
Now you will create a Platform Layer to use in your Layered Images. This Platform Layer helps to ensure that Layered Images run correctly in your environment.
For this test drive, the platform software and settings you will include in the Platform Layer are for vSphere, PVS, and XenApp. Using the Create Platform Layer wizard in the UMC, you will:
<ul><li>Deploy a Packaging Machine in vSphere.</li><li>Install the platform software, configure platform settings, and verify the Layer.</li><li>Rearm KMS (assuming your OS image was activated using KMS).</li><li>Finalize the Platform Layer by importing the Packaging Machine.</li></ul>
Here's how:
<ol><li>Select <strong>Layers > Platform Layers</strong> and then <strong>Create Platform Layer</strong> from the Action bar to open the Create Platform Layer wizard.</li><li>On the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values.</li><li>On the OS Layer tab, select the OS Layer you created earlier.</li><li>On the Connector tab, click <strong>New</strong> to add a vSphere Connector Configuration for creating the Packaging Machine VM. Use the <a href="#Connector_Configuration_(AND)_Optional_Script__(vSphere)">prerequisite</a> vSphere Connector Configuration <a href="#Connector_Configuration_(AND)_Optional_Script__(vSphere)">information</a> to complete the fields. Click <strong>TEST</strong> to verify the connection, then click <strong>SAVE</strong>.</li><li><p>On the Platform Types tab, select <strong>This platform layer will be used for publishing Layered Images</strong>, and select the hypervisor, Provisioning Service, and Connection Broker where you will publish your Layered Images.</p><p><img></img></p></li><li>On the Packaging Disk tab, notice the Packaging Disk <strong>File name</strong>. This disk will be used for the Packaging Machine (the VM) where you will install the platform tools and configure the settings.</li><li>In the Icon Assignment tab, select one of the default icons.</li><li>In the Confirm and Complete tab, review the settings and click <strong>Create Layer</strong>.</li><li><p>Expand the Tasks bar at the bottom of the UI, and double-click the Packaging Disk task to show the full task description. Once the Packaging Disk has been created, the Task bar displays the location of the Packaging Disk in your environment. Example:</p><p><img></img></p></li><li><p>Log into your vSphere web client, then use the information displayed in the Create Platform Layer Task (shown above) to navigate to the Packaging Machine in vSphere.</p></li><li><p>Power on the Packaging Machine, and remote log into it. Remote log into the Packaging Machine with the User account you used to create the operating system.</p></li><li><p>Domain join the Packaging Machine VM.</p></li><li><p>Install your vmTools, and configure the vSphere settings as you want them to be when the Packaging Machine starts.</p></li><li><p>Run the PVS Target Device Installation software. In the installation wizard, take the default settings, except on the last page of the wizard, deselect the Launch Imaging Wizard checkbox.</p><p><strong>Important:</strong> Do not run the device Imaging Wizard.</p></li><li><p>Run the PVS Device optimization tool.</p></li><li><p>Install the XenApp Virtual Delivery Agent for Windows Server OS using the default settings. For the Master device option, choose MCS/PVS.</p></li><li><p>Verify the Rearm count on the OS by running slmgr /dlv from a command prompt.</p><pre>slmgr /dlv</pre></li><li><p>Rearm KMS:</p><pre>slmgr /rearm</pre></li><li><p>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages about the layer verification process. If there is an outstanding operation, wait for it to complete.</p><p><img></img></p></li><li>Once any pending operations are complete, if the Finalize process tells you to reboot the machine, be sure to rearm KMS again.</li><li>Shut down the Packaging Machine by double-clicking the <em>Shutdown For Finalize</em> icon again.</li><li>Return to the UMC, and select <strong>Layers > Platform Layers</strong>, then select the Platform Layer and click <strong>Finalize</strong>.</li><li><a href="#Connector_Configuration_(AND)_Optional_Script__(vSphere)"></a> Use the Task bar to monitor when the layer becomes deployable.</li></ol>
When the new task becomes ***Deployable*** , you can add your new layers to an Image Template.
###Step 3: Create an Image Template<a name="Step_3:_Create_an_Image_Template"></a><a name="Step4_template"></a>

Create an Image Template that includes the same OS Layer as you used in the Platform Layer you just created.
<ol><li>Select <strong>Images</strong> and click <strong>Create Template</strong>. The Create Template Wizard opens.</li><li>Type a name for the template and select an icon for the Layer.</li><li>In the OS Layer tab choose the OS Layer.</li><li>Skip the App Layer Assignment tab for now. You'll add App Layers in the next part of this test drive.</li><li>On the Connector tab, select the PVS Connector Configuration. If you don't have one yet, click <strong>New</strong> to open the Citrix PVS Connector Configuration page, and enter the information, as described <a href="#Connector_Configuration_(AND)_Optional_Script_(PVS)">here</a>.</li><li>On the Platform Layer tab, select the Platform Layer that contains the PVS and XenApp software and settings.</li><li>On the Layered Image Disk tab, edit the Layered Image Disk Filename, and keep the default values for the rest of the settings.</li><li>On the Confirm and Complete tab, click <strong>Create Template</strong>.</li></ol>
Next, you can publish the Layered Image using this template.
###Step 4: Publish a Layered Image to PVS<a name="Step_4:_Publish_a_Layered_Image_to_PVS"></a><a name="Step5_publish"></a>
<ol><li>Select <strong>Images</strong>. Your Template is displayed.</li><li>Select the Template and click <strong>Publish Layered Image</strong>. This opens the Publish Layered Image wizard.</li><li>Confirm and complete the wizard, then expand the Task bar at the bottom of the window and monitor the task. When the task is <em>Done</em>, the vDisk is ready to add to a collection.</li></ol>
###Step 5: Assign the new vDisk to a collection<a name="Step_5:_Assign_the_new_vDisk_to_a_collection"></a><a name="Step6_provision"></a>
<ol><li>Access the target PVS server via the PVS Console. The new vDisk should appear under the targeted PVS store (refresh may be required).</li><li>Test the new vDisk by assigning it to a device.</li><li>Using Citrix PVS best practices, assign the new vDisk to a collection of targeted devices.</li></ol>
Now that you have tested your Layered Image in PVS, it's time to add an App Layer to the image.
##Add your first App Layer and republish the Layered Image<a name="Add_your_first_App_Layer_and_republish_the_Layered_Image"></a><a name="Part2"></a>
In this part of the test drive you will:
<table><tbody><tr><td><p>Step 1: Create a Platform Layer for packaging other layers</p><p>Step 2: Create an App Layer</p><p>Step 3: Publish a new Layered Image containing the new App Layer</p></td></tr></tbody></table>
Similar to the process for creating a Platform Layer, you will prepare an App Layer in the UMC, deploy a Packaging Machine VM in vSphere where you install Notepad++, then import the VM into the new layer. You will add this layer to your Image Template, and publish a new version of the Layered Image.
###Step 1: Create a Platform Layer for packaging other layers<a name="Step_1:_Create_a_Platform_Layer_for_packaging_other_layers"></a><a name="Step1_platform_packaging"></a>

The Platform Layer for packaging layers is where you install the tools and settings specific to a particular hypervisor. Putting platform-specific software on the Platform Layer means that your App Layers do not need to include it, and therefore can be used on multiple platforms.
Using the UMC, you will prepare this layer and deploy a Packaging Machine VM in vSphere. On the Packaging Machine, you will install the hypervisor software and configure the hypervisor settings, as needed. Finally, you will import the Packaging Machine to create the Platform Layer for packaging layers.
<ol><li>Select <strong>Layers > Platform Layers</strong> and then <strong>Create Platform Layer</strong> from the Action bar to open the Create Platform Layer wizard.</li><li>In the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values.</li><li>In the OS Layer tab, select the OS Layer you created earlier.</li><li>In the Connector tab, the <strong>vSphere</strong> Connector Configuration.</li><li>On the Packaging Disk tab, notice the Packaging Disk <strong>File name</strong>. This disk will be used for the Packaging Machine (the VM) where you will install the platform tools and configure the settings.</li><li>In the Icon Assignment tab, select one of the default icons.</li><li>In the Confirm and Complete tab, review the settings and click <strong>Create Layer</strong>.</li><li><p>Expand the Tasks bar at the bottom of the UI, and double-click the Packaging Disk task to show the full task description. Once the Packaging Disk has been created, the Task bar displays the location of the Packaging Disk in your environment. Example:</p><p><img></img></p></li><li><p>Log into your vSphere web client, then use the information displayed in the Packaging Disk Task (shown above) to navigate to the Packaging Machine in vSphere.</p></li><li><p>Power on the Packaging Machine, and remote log into it. Remote log in to the Packaging Machine with the User account you used to create the operating system.</p></li><li><p>Domain join the Packaging Machine VM.</p></li><li><p>Install your vmTools, and configure the vSphere settings as you want them to be when the Packaging Machine for this layer starts.</p></li><li><p>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages about the layer verification process. If there is an outstanding operation, wait for it to complete.</p><p><img></img></p></li><li>Once any pending operations are complete, shut down the Packaging Machine by double-clicking the <em>Shutdown For Finalize</em> icon again.</li><li>Return to the UMC, and select <strong>Layers > Platform Layers</strong>, then select the Platform Layer and click <strong>Finalize</strong>.</li><li><a href="#Connector_Configuration_(AND)_Optional_Script_(PVS)"></a> Use the Task bar to monitor when the layer becomes deployable.</li></ol>
###Step 2: Create an App Layer<a name="Step_2:_Create_an_App_Layer"></a><a name="Step6"></a>

<ol><li>Select <strong>Layers > App Layers</strong> and then <strong>Create App Layer</strong> from the Action bar to open the Create App Layer wizard.</li><li>In the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values.</li><li>In the OS Layer tab, select the OS Layer you created earlier.</li><li>In the Connector tab, choose the vSphere <strong>Connector Configuration</strong> you used to create the Platform Layer for packaging other layers.</li><li>On the Platform Layer tab, choose the Platform Layer you just created.</li><li>On the Packaging Disk tab, enter a <strong>File name</strong> for the Packaging Disk. This disk will be used for the Packaging Machine (the VM) where you will install the application.</li><li>In the Icon Assignment tab, select one of the supplied icons for the layer, or if you'd like to use the application icon, you can browse for it and import it into this tab.</li><li>In the Confirm and Complete tab, review the settings and click <strong>Create Layer</strong>.</li><li><p>Expand the Tasks bar at the bottom of the UI, and double-click the task to expand it. Once complete, the Task bar displays the location of the Packaging Disk or Machine in your environment.</p><p><img></img></p></li><li>Log into your vSphere web client, then use the information displayed in the above Task to navigate to the Packaging Machine in vSphere.</li><li>Power on the Packaging Machine, and remote log into it. Remote log in to the Packaging Machine with the User account you used to create the operating system in vSphere.</li><li>Install the application, leaving the application and the Packaging Machine in the state you want it to be for the user.</li><li><p>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages about the layer verification process.</p><p><img></img></p></li><li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to expedite the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Verifyin">here</a>.</li><li>Once any pending operations are complete, shut down the Packaging Machine by double-clicking the <em>Shutdown For Finalize</em> icon again.</li><li>Return to the UMC, and select <strong>Layers > App Layers</strong>, and select <strong>Finalize</strong> in the Action bar.</li><li><a href="#Verifyin"></a> Use the Task bar to monitor when the layer becomes deployable.</li></ol>
Once the App Layer task is marked ***Deployable*** , you can add the new App Layer to your Image Template.
###Step 3: Publish a new Layered Image containing the new App Layer<a name="Step_3:_Publish_a_new_Layered_Image_containing_the_new_App_Layer"></a><a name="Step7"></a>
<ol><li>Select <strong>Images</strong>, then select your Image Template and click <strong>Edit Template</strong>.</li><li>In the Edit Template wizard, select the Application Assignment tab and select the <strong>Notepad++ Layer</strong>.</li><li>Skip the Confirm and Complete tab, and click Save Template Changes to save the updated template.</li><li>Back in the Images module, select the Template again and click <strong>Publish Layered Image</strong>. This opens the Publish Layered Image wizard.</li><li>Confirm the settings and click <strong>Publish Layered Image</strong>.</li><li>Monitor the tasks for completion.</li><li>Once the task is complete, access the target PVS server via the PVS Console. The new vDisk should appear under the targeted PVS store (refresh may be required).</li><li><p>Assign the new vDisk either to a new or existing collection.</p></li></ol>

#Test drive: Publish to PVS for XenApp 6.5 users<a name="Test_drive:_Publish_to_PVS_for_XenApp_6.5_users"></a>
Once Unidesk is set up, you can use this test drive to create your first layers in vSphere, and then publish a test image to Horizon View. With this first experience will come an understanding of the layering work flow, and relatively easy image maintenance.
Please download the Test Drive from this Unidesk [forum article](http://www.unidesk.com/forum/unidesk-4/process-documentation-publish-pvs-7-vsphere-xenapp-65-broker)[.](http://www.unidesk.com/forum/unidesk-4/process-documentation-publish-pvs-7-vsphere-xenapp-65-broker)
If you have any questions, please ask your Unidesk Solutions Architect for assistance.


#Test drive: Publish to MCS for Nutanix AHV<a name="Test_drive:_Publish_to_MCS_for_Nutanix_AHV"></a>
Once Unidesk is set up, you can use this test drive to create your first layers in Nutanix AHV, and then publish a test image to Citrix MCS. This example uses Windows 10 64-bit, Citrix MCS, and Citrix XenDesktop 7.
Please download the Test Drive from this Unidesk [forum article](http://www.unidesk.com/forum/unidesk-4/process-documentation-nutanix)[.](http://www.unidesk.com/forum/unidesk-4/process-documentation-nutanix)
If you have any questions, please ask your Unidesk Solutions Architect for assistance.

#Test drive: Publishing to Azure RDSH<a name="Test_drive:_Publishing_to__Azure_RDSH"></a>
In this article:
<table><tbody><tr><td><p>Platforms used in this test drive</p><p>Components you will create</p><p>Prerequisites</p><p>Publish a test image with an OS Layer and a Platform Layer</p><p>Add your first App Layer and republish the Layered Image</p></td></tr></tbody></table>
##Platforms used in this test drive<a name="Platforms_used_in_this_test_drive_..534"></a><a name="Platform_..71"></a>
<table><tbody><tr><td>Create Layers in:</td><td>Azure</td></tr><tr><td>Publish Layered Images to:</td><td>Azure RDSH</td></tr><tr><td>For delivery to:</td><td>Azure users</td></tr></tbody></table>
This test drive leads you through the process of publishing a Layered Image as a virtual disk to an Azure server. the hypervisor in this scenario is Azure, and the connection broker is Azure.

##Components you will create<a name="Components_you_will_create_..535"></a><a name="Componen_..72"></a>
<table><tbody><tr><th>Component</th><th>Description</th></tr><tr><td>OS Layer</td><td><ul><li>Contains Windows Server 2012 R2</li><li>Unidesk Tools are installed</li></ul></td></tr><tr><td>Platform Layer</td><td><ul><li>Layer containing all platform-related software and settings</li><li>Created in Azure using an Azure VM for the Packaging Machine</li></ul></td></tr><tr><td>App Layer</td><td><ul><li>Notepad++</li></ul></td></tr><tr><td>Image Template</td><td><ul><li>Created in two stages:<ul><li>Stage 1: Includes OS Layer ; Platform Layer</li><li>Stage 2: Includes the addition of App Layer</li></ul></li></ul></td></tr><tr><td>Layered Image</td><td><ul><li>Image Template</li><li>OS Layer</li><li>Platform Layer</li><li>App Layer</li></ul></td></tr><tr><td>Azure virtual disk</td><td><ul><li>Contains the Unidesk Layered Image</li></ul></td></tr></tbody></table>
##Prerequisites<a name="Prerequisites_..536"></a><a name="Prerequi_..73"></a>
<table><tbody><tr><td><h3><a href="http://www.unidesk.com/forum/unidesk-4/process-documentation-nutanix"></a>Unidesk</h3><p><span>o</span> Unidesk ELM installed on a server in your Azure environment.</p><p><span>o</span> Unidesk Tools downloaded from the Unidesk Download page and copied to a location that the Packaging Machine VM will be able to access.</p><h3><a href="http://www.unidesk.com/forum/unidesk-4/process-documentation-nutanix"></a>OS for images</h3><p><span>o</span> OS for Layered Images. You need a Unidesk-supported <a href="#Session">operating system</a> to import into an OS Layer. This OS will be used to build your Layered Images.</p></td><td><h3><a href="#Session"></a><a href="#Session"></a>Azure</h3><p><span>o</span> Azure account and subscription. To deploy and configure the Unidesk ELM, you will need the credentials for an account that has administrative access to your Azure subscription. For more information, refer to the <a href="https://account.windowsazure.com/signup?offer">Microsoft Azure Sign in page</a>.</p></td></tr></tbody></table>
##Publish a test image with an OS Layer and a Platform Layer<a name="Publish_a_test_image_with_an_OS(SPACE)Layer_and_a_Platform_Layer_..538"></a><a name="Part_..74"></a>
In this part of the test drive you will:
<table><tbody><tr><td><p>Step 1: Create an OS Layer</p><p>Step 2: Create a Platform Layer for Publishing Layered Images</p><p>Step 3: Create an Image Template</p><p>Step 4: Publish a Layered Image to Azure RDSH</p><p>Step 5: Provision a Session Host</p></td></tr></tbody></table>
###Step 1: Create an OS Layer<a name="Step_1:_Create_an_OS(SPACE)Layer_..539"></a><a name="Step_..75"></a>

In this step you will create an Azure VM to use as your OS Machine, and prepare the OS on it. You will then use an Azure Connector Configuration to import the OS image into a new OS Layer.
<ol><li><p>In the <a href="https://portal.azure.com/">Microsoft Azure portal</a>, create a new VM from the "Windows Server Remote Desktop Session Host Windows Server 2012 R2" image (<strong>New > Virtual Machine > Windows Server Remote Desktop Session Host Windows Server 2012 R2</strong>).</p><p><strong>Important:</strong> When creating the image, be sure to choose the default cluster allocation size of 4K.</p></li><li><p>Choose <strong>Resource Manager</strong> from the <strong>Select a deployment model</strong> option list and click <strong>Create</strong>.</p><p><strong>Note:</strong> Unidesk for Azure does <em>not</em> support the <strong>Classic</strong> option from the <strong>Select a deployment model</strong> option list.</p></li><li><p>Create the OS machine by completing the Create virtual machine wizard.</p><ul><li>The name of the new server machine you specify must comply with Azure naming conventions.</li><li>The User name and Password of the new server machine you specify becomes the User name and Password of any Packaging Machines that are subsequently created containing this OS Layer.</li><li>Be sure that the value for the Resource group location matches the Storage account location that you configured in the Platform Connector Configuration.</li></ul></li><li><p>Reboot the new machine, and log into it remotely.</p></li><li><p>On the new machine, turn off Windows Automatic Updates (<strong>Control Panel > System and Security > Windows Update > Change Settings</strong>).</p></li><li><p>In a web browser, navigate to the <a href="http://www.unidesk.com/support/downloads">Unidesk Download Center</a>, and in the Tools section, download the Unidesk OS Machine Tools.</p></li><li><p>In Windows Explorer, navigate to the C:\Windows\OEM directory, and rename or delete the "Unattend.wsf" file.</p></li><li><p>On the new machine, install the Unidesk drivers by running <strong>setup_x64.exe</strong>.</p></li><li><p>Ensure that this machine is <em>not</em> joined to a domain, as Session Hosts join a domain when you provision them from a Layered Image.</p></li><li><p>Perform any pending reboots to the OS machine, and shut down the new OS machine.</p></li><li><p>In the Unidesk ELM, select <strong>Layers > OS Layers</strong> and click <strong>Create OS Layer</strong>. This opens the Create Operating System Layer Wizard.</p></li><li><p>First, specify a <strong>Layer Name</strong> and <strong>Version</strong> in the Layer Details tab.</p></li><li><p>In the Connector tab, select the <strong>Azure Connector Configuration</strong>, which is where you downloaded the Azure files. Once connected to the file share, you can select the operating system to import.</p></li><li><p>In the Import Disk Details tab, enter the name of the Azure Resource Group that contains the OS disk, and the name of the OS disk, both required values.</p><p><strong>Note:</strong> If you specified a file share on the Connector tab, enter the name of the OS disk residing on that file share or click <strong>Browse</strong> to select it.</p></li><li><p>In the Icon Assignment tab, select an icon image to assign to this Layer.</p></li><li><p>In the Confirm and Complete tab, review the details of the OS Layer, enter a comment if required, and click <strong>Create Layer</strong>. If you enter comments, they appear in the Information view Audit History.</p></li><li><p>When the task completes, the new OS Layer in the Unidesk Management Console (UMC) displays a <em>Deployable</em> status.</p></li></ol>
###Step 2: Create a Platform Layer for Publishing Layered Images<a name="Step_2:_Create_a_Platform_Layer_for_Publishing_Layered_Images"></a><a name="Step3_platform_pulishing_..76"></a>
The Platform Layer is where you will install software specific to an environment. Putting all platform-specific software in a Platform Layer allows you to reuse OS and App Layers in Layered Images on multiple platforms. The platforms for this test drive include Azure and Azure RDSH.
Using the Create Platform Layer wizard in the UMC, you will:
<ul><li>Deploy a Packaging Machine in Azure.</li><li>Install all platform software and tools.</li><li>Once the Layer is ready, rearm KMS. Assuming your OS image was activated using KMS, you'll rearm KMS when creating the Platform Layer. (This also applies to when you add a version to the Platform Layer.)</li><li>Import the Packaging Machine to create the Platform Layer.</li></ul>
Here's how to create the Platform Layer:
<ol><li>Select <strong>Layers > Platform Layers</strong> and then <strong>Create Platform Layer</strong> to open the Create Platform Layer wizard.</li><li>In the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values.</li><li>In the OS Layer tab, select the OS Layer you created.</li><li>In the Connector tab, click <strong>New</strong> to add an <a href="#Azure_Connector_Configuration">Azure Connector Configuration information</a> for creating the Packaging Machine VM. Use the <a href="#Azure">prerequisite</a> Azure account and subscription information to complete the fields. Click <strong>TEST</strong> to verify the connection, then click <strong>SAVE</strong>.</li><li>In the Platform Types tab, select <strong>This Platform Layer: will be used for creating and updating Layers</strong>. For about this choice, see Platform Layer Essentials.</li><li>From the Hypervisor menu, select <strong>Azure</strong>.</li><li>On the Packaging Disk tab, notice the Packaging Disk <strong>File name</strong>. This disk will be used for the Packaging Machine (the VM) where you will install the hypervisor tools and configure the settings.</li><li>In the Icon Assignment tab, select one of the default icons.</li><li>In the Confirm and Complete tab, review the settings and click <strong>Create Layer</strong>.</li><li><p>Expand the Tasks bar at the bottom of the UI, and double-click the Packaging Disk task to show the full task description. Once the Packaging Disk has been created, the Task bar displays the location of the Packaging Disk in your environment. Example:</p><p><img></img></p></li><li><p>Log into the Azure portal (https://portal.azure.com) from your web browser.</p></li><li><p>Click the link in the Create Platform Layer Task (shown above) to navigate to the Packaging Machine in Azure. (You must be logged into Azure for the link to work.)</p></li><li><p>On the Custom deployment panel, complete the required fields for customizing your Azure parameters.</p><ul><li>Packaging Machine Name - must conform to Azure VM name requirements.</li><li>Size - the Azure VM size of the packaging machine.</li><li>Virtual Network and Subnet - the virtual network and subnet for deploying the Packaging Machine.</li></ul><p>IMPORTANT: Be sure that the value for the <strong>Resource group location</strong> matches the <strong>Storage account location</strong> that you configured in the Platform Connector Configuration. If these locations are not the same, the Packaging Machine will fail to deploy and you will have to reattempt deployment. If your deployment does fail, you can simply re-paste the link into the browser to start over.</p><p><img></img></p></li><li><p>Remote log in to the Packaging Machine you created in Azure. Be sure to log in using the User account you used to create the OS in Azure.</p></li><li><p>Install your Azure tools, and configure the Azure settings as you want them to be when the Packaging Machine for this layer starts.</p></li><li><p>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages about the layer verification process. If there is an outstanding operation, wait for it to complete.</p><p><img></img></p></li><li>Once any pending operations are complete, if the Finalize process tells you to reboot the machine, be sure to rearm KMS again.</li><li>Shut down the Packaging Machine by double-clicking the <em>Shutdown For Finalize</em> icon again.</li><li>Return to the UMC, and select <strong>Layers > Platform Layers</strong>, then select the Platform Layer and click <strong>Finalize</strong>.</li><li><a href="#Azure"></a> Use the Task bar to monitor when the layer becomes deployable.</li></ol>
When the new task becomes ***Deployable*** , you can add your new layers to an Image Template.
###Step 3: Create an Image Template<a name="Step_3:_Create_an_Image_Template_..540"></a><a name="Step4_template_..77"></a>

Create an Image Template that includes the same OS Layer as you used in the Platform Layer you just created.
<ol><li>Select <strong>Images</strong> and click <strong>Create Template</strong>. The Create Template Wizard opens.</li><li>Type a name for the template and select an icon for the Layer.</li><li>In the OS Layer tab choose the OS Layer.</li><li>On the Confirm and Complete tab, click <strong>Create Template</strong>.</li></ol>
Next, you can publish the Layered Image using this template.
###Step 4: Publish a Layered Image to Azure RDSH<a name="Step_4:_Publish_a_Layered_Image_to_Azure_RDSH"></a><a name="Step5_publish_..78"></a>
<ol><li>Select <strong>Images</strong>. Your Template is displayed.</li><li>Select the Template and click <strong>Publish Layered Image</strong>. This opens the Publish Layered Image wizard.</li><li><p>On the Connector tab, select the Azure RDSH Connector Configuration. If you don't have one yet, click <strong>New</strong> to open the Azure RDSH Connector Configuration page, and enter the information, as described <a href="#Azure_Connector_Configuration">here</a>.</p></li><li>On the Platform Layer tab, select the Platform Layer that contains the Azure software and settings.</li><li>On the Layered Image Disk tab, edit the Layered Image Disk Filename, and keep the default values for the rest of the settings.</li><li>Confirm and complete the wizard, then expand the Task bar at the bottom of the window and monitor the task. When the task is <em>Done</em>, the Layered Image virtual disk is ready.</li></ol>
###Step 5: Provision a Session Host<a name="Step_5:_Provision_a_Session_Host"></a><a name="Step6_provision_..79"></a>
In the ***Custom deployment***  template, enter the information to provision a Azure RD Session Host.
<ol><li><p>Complete the Session Host Parameters shown below, using the host's Fully Qualified Domain Name (FQDN).</p><p><img></img></p></li><li><p>Select the Azure Resource Group.</p><p><img></img></p></li><li><p>Specify the Resource Group Location.</p><p>IMPORTANT: Be sure that the value for the <strong>Resource group location</strong> matches the <strong>Storage account location</strong> that you configured in the Platform Connector Configuration. If these locations are not the same, the Packaging Machine will not be deployed and you will have to reattempt deployment.</p></li><li><p>Review the legal terms, and if you accept them, click <strong>Create</strong>. This creates a Session Host provisioned with the Layered Image in Azure.</p></li><li><p>While Azure creates the virtual machine, you can track the progress under Virtual Machines in the hub menu.</p></li><li>Power off the Session Host, power it back on, and add it to an RDS collection. Please see the <a href="https://technet.microsoft.com/en-us/library/jj215452.aspx">TechNet Reference</a> for details.</li></ol>
Once you have tested your Layered Image in Azure, it's time to add an App Layer to the image.
##Add your first App Layer and republish the Layered Image<a name="Add_your_first_App_Layer_and_republish_the_Layered_Image_..541"></a><a name="Part2_..80"></a>
In this part of the test drive you will:
<table><tbody><tr><td><p>Step 1: Create a Platform Layer for packaging other layers</p><p>Step 2: Create an App Layer</p><p>Step 3: Publish a new Layered Image containing the new App Layer</p></td></tr></tbody></table>
Similar to the process for creating a Platform Layer, you will prepare an App Layer in the UMC, deploy a Packaging Machine VM in Azure where you install Notepad++, then import the VM into the new layer. You will add this layer to your Image Template, and publish a new version of the Layered Image.
###Step 1: Create a Platform Layer for packaging other layers<a name="Step_1:_Create_a_Platform_Layer_for_packaging_other_layers_..542"></a><a name="Step1_platform_packaging_..81"></a>

The Platform Layer for packaging layers is where you install the tools and settings specific to a particular hypervisor. Putting platform-specific software on the Platform Layer means that your App Layers do not need to include it, and therefore can be used on multiple platforms.
Using the UMC, you will prepare this layer and deploy a Packaging Machine VM in Azure. On the Packaging Machine, you will install the hypervisor software and configure the hypervisor settings, as needed. Finally, you will import the Packaging Machine to create the Platform Layer for packaging layers.
<ol><li>Select <strong>Layers > Platform Layers</strong> and then <strong>Create Platform Layer</strong> from the Action bar to open the Create Platform Layer wizard.</li><li>In the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values.</li><li>In the OS Layer tab, select the OS Layer you created earlier.</li><li>In the Connector tab, the <strong>Azure</strong> Connector Configuration.</li><li>On the Packaging Disk tab, notice the Packaging Disk <strong>File name</strong>. This disk will be used for the Packaging Machine (the VM) where you will install the platform tools and configure the settings.</li><li>In the Icon Assignment tab, select one of the default icons.</li><li>In the Confirm and Complete tab, review the settings and click <strong>Create Layer</strong>.</li><li><p>Expand the Tasks bar at the bottom of the UI, and double-click the Packaging Disk task to show the full task description. Once the Packaging Disk has been created, the Task bar displays the location of the Packaging Disk in your environment. Example:</p><p><img></img></p></li><li><p>Log into the Azure portal (https://portal.azure.com) from your web browser.</p></li><li><p>Click the link in the Create Platform Layer Task (shown above) to navigate to the Packaging Machine in Azure. (You must be logged into Azure for the link to work.)</p></li><li><p>On the Custom deployment panel, complete the required fields for customizing your Azure parameters.</p><ul><li>Packaging Machine Name - must conform to Azure VM name requirements.</li><li>Size - the Azure VM size of the packaging machine.</li><li>Virtual Network and Subnet - the virtual network and subnet for deploying the Packaging Machine.</li></ul><p>IMPORTANT: Be sure that the value for the <strong>Resource group location</strong> matches the <strong>Storage account location</strong> that you configured in the Connector Configuration. If these locations are not the same, the Packaging Machine will fail to deploy and you will have to reattempt deployment. If your deployment does fail, you can simply re-paste the link into the browser to start over.</p><p><img></img></p></li><li><p>Install the Azure tools, and configure the Azure settings as you want them to be when the Packaging Machine for this layer starts.</p></li><li><p>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages about the layer verification process. If there is an outstanding operation, wait for it to complete.</p><p><img></img></p></li><li>Once any pending operations are complete, shut down the Packaging Machine by double-clicking the <em>Shutdown For Finalize</em> icon again.</li><li>Return to the UMC, and select <strong>Layers > Platform Layers</strong>, then select the Platform Layer and click <strong>Finalize</strong>.</li><li><a href="https://technet.microsoft.com/en-us/library/jj215452.aspx"></a> Use the Task bar to monitor when the layer becomes deployable.</li></ol>
###Step 2: Create an App Layer<a name="Step_2:_Create_an_App_Layer_..543"></a><a name="Step6_..82"></a>

<ol><li>Select <strong>Layers > App Layers</strong> and then <strong>Create App Layer</strong> from the Action bar to open the Create App Layer wizard.</li><li>In the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values.</li><li>In the OS Layer tab, select the OS Layer you created earlier.</li><li>In the Connector tab, choose the Azure <strong>Connector Configuration</strong> you used to create the Platform Layer for packaging other layers.</li><li>On the Platform Layer tab, choose the Platform Layer you just created.</li><li>On the Packaging Disk tab, enter a <strong>File name</strong> for the Packaging Disk. This disk will be used for the Packaging Machine (the VM) where you will install the application.</li><li>In the Icon Assignment tab, select one of the supplied icons for the layer, or if you'd like to use the application icon, you can browse for it and import it into this tab.</li><li>In the Confirm and Complete tab, review the settings and click <strong>Create Layer</strong>.</li><li><p>Expand the Tasks bar at the bottom of the UI, and double-click the task to expand it. Once complete, the Task bar displays the location of the Packaging Disk or Machine in your environment.</p><p><img></img></p></li><li><p>Log into the Azure portal (https://portal.azure.com) from your web browser.</p></li><li><p>Click the link in the Create App Layer Task (shown above) to navigate to the Packaging Machine in Azure. (You must be logged into Azure for the link to work.)</p></li><li><p>On the Custom deployment panel, complete the required fields for customizing your Azure parameters.</p><ul><li>Packaging Machine Name - must conform to Azure VM name requirements.</li><li>Size - the Azure VM size of the packaging machine.</li><li>Virtual Network and Subnet - the virtual network and subnet for deploying the Packaging Machine.</li></ul><p>IMPORTANT: Be sure that the value for the <strong>Resource group location</strong> matches the <strong>Storage account location</strong> that you configured in the Connector Configuration. If these locations are not the same, the Packaging Machine will fail to deploy and you will have to reattempt deployment. If your deployment does fail, you can simply re-paste the link into the browser to start over.</p></li><li><p>Install the application, leaving the app and the Packaging Machine in the state you want it to be for the user.</p></li><li><p>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages about the layer verification process.</p><p><img></img></p></li><li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to expedite the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Verifyin">here</a>.</li><li>Once any pending operations are complete, shut down the Packaging Machine by double-clicking the <em>Shutdown For Finalize</em> icon again.</li><li>Return to the UMC, and select <strong>Layers > App Layers</strong>, and select <strong>Finalize</strong> in the Action bar.</li><li><a href="#Verifyin"></a> Use the Task bar to monitor when the layer becomes deployable.</li></ol>
Once the App Layer task is marked ***Deployable*** , you can add the new App Layer to your Image Template.
###Step 3: Publish a new Layered Image containing the new App Layer<a name="Step_3:_Publish_a_new_Layered_Image_containing_the_new_App_Layer_..544"></a><a name="Step7_..83"></a>
<ol><li>Select <strong>Images</strong>, then select your Image Template and click <strong>Edit Template</strong>.</li><li>In the Edit Template wizard, go to the Application Assignment tab and select the <strong>Notepad++ Layer</strong>. Then complete the wizard to save the template.</li><li>Back in the Images module, select the Template again and click <strong>Publish Layered Image</strong>. This opens the Publish Layered Image wizard.</li><li>In the Publish Layered Image wizard, select the Azure RDSH Connector Configuration you created earlier.</li><li>In the Platform Layer, select the layer you created earlier.</li><li>Confirm the settings and click <strong>Publish Layered Image</strong>.</li><li>Monitor the tasks for completion.</li><li>Once the task is complete, access the target Azure server via the Azure Portal. The new virtual disk should appear under the targeted Azure store (refresh may be required).</li><li><p>Assign the new virtual disk either to a new or existing collection.</p></li></ol>



#Test drive: Publish to VMware Horizon View<a name="Test_drive:_Publish_to_VMware_Horizon_View"></a>
Once Unidesk is set up, you can use this test drive to create your first layers in vSphere, and then publish a test image to Horizon View. With this first experience will come an understanding of the layering work flow, and relatively easy image maintenance.
Please download the Test Drive from this Unidesk [forum article](http://www.unidesk.com/forum/unidesk-4/process-documentation-publish-horizon-view-composer-automated-pools)[.](http://www.unidesk.com/forum/unidesk-4/process-documentation-publish-horizon-view-composer-automated-pools)
If you have any questions, please ask your Unidesk Solutions Architect for assistance.

#Test drive: Publish to Microsoft RDS in Hyper-V<a name="Test_drive:_Publish_to_Microsoft_RDS_in_Hyper-V"></a>
Once Unidesk is set up, you can use this test drive to create your first layers in Hyper-V, and then publish a test image to MS RDS. With this first experience will come an understanding of the layering work flow, and relatively easy image maintenance.
Please download the Test Drive from this Unidesk [forum article](http://www.unidesk.com/forum/unidesk-4/process-documentation-publish-rds-and-hyper-v)[.](http://www.unidesk.com/forum/unidesk-4/process-documentation-publish-rds-and-hyper-v)
If you have any questions, please ask your Unidesk Solutions Architect for assistance.



#Layer Essentials<a name="Layer_Essentials"></a>
In this article:
<table><tbody><tr><td><p>OS Layers</p><p>Platform Layers</p><p>App Layers</p><p>User Layers (Unidesk Labs)</p><p>Verifying Layers</p></td></tr></tbody></table>
##OS Layers<a name="OS(SPACE)Layers"></a><a name="OS(SPACE)Layer"></a>
###What is an OS Layer?<a name="What_is_an_OS(SPACE)Layer_"></a><a name="What"></a>
An OS Layer includes the software and settings for the operating system that you deploy as part of your other layers and ultimately, your Layered Images. Once you have prepared the OS disk for deployment, you can create a Unidesk Operating System Layer by importing the OS disk into a new Layer.
###Why layer my OS image?<a name="Why_layer_my_OS(SPACE)image_"></a><a name="How2"></a>
With an OS Layer, you can install your operating system once, and update it by adding a new Version to the Layer whenever there's a new patch or update. You can deploy this layer, or a version of it, in every image you publish. This allows you to maintain one OS image and use it to provision all of your servers.
###Can I deploy more than one OS Layer?<a name="Can_I_deploy_more_than_one_OS(SPACE)Layer_"></a><a name="How2_..84"></a>
If you need to support more than one operating system, for example, if you need both Windows Server 2012 R2 and Windows Server 2008 R2, you can create more than one OS Layer. However, each App Layer is only compatible with the OS Layer you use to create it, and if you deploy two OS Layers, you will also need to deploy a compatible App Layer for each one. Further, in future releases when deploying Elastic Layers to users, those layers will only be compatible with users' desktops that use the same OS Layer.
If you can support your users with a single OS Layer, the work associated with creating and updating App Layers will be much reduced.
###Can I deploy more than one version of the same OS Layer?<a name="Can_I_deploy_more_than_one_version_of_the_same_OS(SPACE)Layer_"></a><a name="Can"></a>
Each time you need to deploy operating system patches and updates, you will do so by adding a new Version to the OS Layer. You can continue to publish Layered Images using any version of the OS Layer.
###What do I need to create an OS Layer?<a name="What_do_I_need_to_create_an_OS_Layer_"></a><a name="What2"></a>
The prerequisites for creating an OS Layer include:
<ul><li>A <a href="#Session">Unidesk-supported operating system</a></li><li>Unidesk ELM and network file share installed and configured</li></ul>
###How do I start?<a name="How_do_I_start_"></a><a name="How_..85"></a>
See the steps to [Create an OS Layer](#Create_an_OS_Layer)[.](#Create_an_OS_Layer)
##Platform Layers<a name="Platform_Layers"></a><a name="Platform_..86"></a>
A Platform Layer is a layer that includes platform-specific configuration settings, tools, and other software required for your OS and Apps to be installed in or to run in a particular environment.
###Types of Platform Layers<a name="Types_of_Platform_Layers"></a><a name="When"></a>
<ul><li>A Platform Layer for <em>Packaging</em> (required in some cases, see below)</li><li>Platform Layer for <em>Publishing</em> (always required)</li></ul>
####Platform Layer for packaging layers and versions
The only time you need a Platform Layer for ***Packaging***  layers is when your OS image was created on a different hypervisor than the one where you are building your other layers. When ***creating an App Layer or Layer Version*** , or OS Versions, the purpose of the Platform Layer is to ensure that any hypervisor-related software and settings are available during the installation of the application(s) on that layer, if needed. If you choose to use a Platform Layer for Packaging a layer, the hypervisor-related software will only be used during layer packaging, and has ***no effect***  on where you can ***publish***  the layer as part of a Layered Image.
####Platform Layer for publishing Layered Images
A Platform Layer for ***Publishing***  is ***required***  when you publish Layered Images. The purpose of the Platform Layer for Publishing is to include the settings and software that the Layered Image needs to be ***deployed in your environment*** . When creating a Platform Layer for Publishing, Unidesk removes unselected (and unnecessary) tools and software related to the platforms you are ***not***  publishing to. This is to prevent any unnecessary platform software from slowing down the Layered Image when it runs in the target environment.
###Get started with Platform Layers<a name="Get_started_with_Platform_Layers"></a><a name="Get_..87"></a>
For details about creating Platform Layers, see Create a Platform Layer .
##App Layers<a name="App_Layers_..545"></a><a name="App"></a>
###What is an App Layer?<a name="What_is_an_App_Layer_"></a><a name="What_..88"></a>
An App Layer is a virtual disk containing one or more applications that you can use in Layered Images. You can combine an App Layer with any other App Layers and a Platform Layer, as long as the OS Layer used to create the App Layer is selected.
With most applications, creating an App Layer is simple. In a few cases, it's best to start with tips from experienced users, so the Unidesk Forum includes [Application Layer Recipes](#Recipes_for_layering_Applications)[ that you can search for tips about a particular application before you start.](#Recipes_for_layering_Applications)
###Get started with App Layers<a name="Get_started_with_App_Layers"></a><a name="Get_..89"></a>
To create an App Layer, you use the Create App Layer wizard to deploy a Packaging Machine in your environment and install the application on the Packaging Machine, leaving the application in the state you want it to be in for users. Then you finalize the Layer.
To get started with App Layers, see Create an App Layer.
##User Layers (Unidesk Labs)<a name="User_Layers_(Unidesk_Labs)"></a><a name="User"></a>
A User Layer is a virtual disk where a user's app data and configuration settings are saved. User Layers are created when you:
<ul><li>Publish a Layered Image with <em>Elastic Layering</em> set to <em>Application and User Layers</em>.</li><li>Users log into their desktops on the above Layered Image.</li></ul>
With User Layers enabled on the Layered Image, users can install applications locally on their desktops, and the apps and their data will be saved in the User Layer.
Learn more about how to User Layers (Unidesk Labs).
##Verifying Layers<a name="Verifying_Layers"></a><a name="Verifyin"></a>
###If there are Layer integrity messages during the finalization process<a name="If_there_are_Layer_integrity_messages_during_the_finalization_process"></a><a name="Layer_Integrity_Check"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized. The new Layer or Version can only be finalized when the following conditions have been addressed:<a name="Layer_Integrity_Messages"></a>
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p><strong>Note:</strong> If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
###Expediting a Microsoft NGen operation<a name="Expediting_a_Microsoft_NGen_operation"></a><a name="Complete_MS_NGen_Operations"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>
#Create Layers<a name="Create_Layers"></a>
Once Unidesk is installed and set up, you can install your software in Layers.
##Before you start<a name="Before_you_start_..546"></a>
Install the Unidesk Enterprise Layer Manager (ELM)
Set up Unidesk
##Install your software in reusable Unidesk Layers<a name="Install_your_software_in_reusable_Unidesk_Layers"></a>
<ol><li>Create an OS Layer</li><li>Create a Platform Layer</li><li>Create an App Layer</li></ol>
##Next Step<a name="Next_Step_..547"></a>
[Publish a Layered Image](#Publish_Layered_Images)

#Create and update OS Layers<a name="Create_and_update_OS_Layers"></a>
Start by preparing your OS image for use in Unidesk, then import it to create your OS Layer. Then use the instructions listed below to update the layer.






#Prepare an OS image<a name="Prepare_an_OS_image"></a>
On which platform are you preparing the OS?


# Prepare the OS Image (vSphere)<a name="Prepare_the_OS(SPACE)Image_(vSphere)"></a>
This topic explains how to prepare an OS Image for the Unidesk environment, using the ***OS Machine Tools***  available for download on the Unidesk [Download](http://www.unidesk.com/support/downloads)[ page.](http://www.unidesk.com/support/downloads)
Notes:
<ul><li>The OS Image should <em>not</em> be in a domain.</li><li>The OS Image should get its IP address from DHCP.</li><li>Using Third-party optimization scripts can have adverse effects in Unidesk, as they can change services and features that Unidesk uses, for example, Universal Plug and Play and the 8.3 file names setting. Use the optimization tools in the Unidesk Installer download to optimize your image.</li><li>Ensure that the VM for your OS Layer is MBR partitioned, rather than GPT partitioned. Otherwise, you will not be able to install the Unidesk OS Machine Tools.</li><li>The Paravirtual SCSI controller is <em>not</em> supported. You must use the default controller (SCSI BusLogic) for the OS to be functional. Unidesk supports the LSI Logic SAS controller type. If you subsequently change the SCSI controller type to anything else, such as VMware Paravirtual SCSI controller, the OS Layer import will fail.</li></ul>
## Which operating system are you using?<a name="Which_operating_system_are_you_using_"></a>
Choose the operating system you are using for the OS Image:
<ul><li><a href="#Prepare_win2012">Windows Server 2012 R2 (Session Host)</a></li><li><a href="#Prepare2">Windows Server 2008 R2</a></li><li><a href="#Prepare3">Windows 10</a></li><li><a href="#Prepare">Windows 7 </a></li></ul>
##Prepare a Windows Server 2012 R2 image (Session Host)<a name="Prepare_a_Windows_Server_2012_R2_image_(Session_Host)"></a><a name="Prepare_win2012"></a>
###STEP 1: Set up a Windows Server 2012 R2 OS Image on a virtual machine<a name="STEP_1:_Set_up_a_Windows_Server_2012_R2_OS_Image_on_a_virtual_machine"></a><a name="STEP1_win2012r2"></a>
In the vSphere client:
<ol><li><a href="#Prepare"></a> Create a VM for the OS image.</li><li><p><a href="#Prepare"></a> Configure the virtual machine hardware settings, for example, the NIC and video memory.</p><p><strong>Important:</strong> You can have just <em>one network device</em> for the virtual machine, and it must be the VMXNET 3 network adapter, as the default E1000 adapter (or even a ghost NIC leftover from an E1000 adapter) can cause customization timeout errors on the VM when attempting to boot the image in environments such as Citrix PVS, Citrix MCS, or VMware Horizon View.</p></li><li>Configure a virtual hard disk that is large enough for a Windows operating system installation, and make sure it is accessible by the Unidesk Management Appliance.</li><li>Install Windows Server 2012 R2.</li><li>Disable Windows System Restore and Windows Automatic Updates. The Unidesk<a href="#Prepare"></a> system handles restore points for you, and Unidesk layer versions allow you to control when updates occur.</li><li>Install VMware Tools on your OS image.</li></ol>
###STEP 2: Copy the Unidesk OS Machine Tools onto the OS Image<a name="STEP_2:_Copy_the_Unidesk_OS(SPACE)Machine_Tools_onto_the_OS_Image"></a><a name="STEP4_win2012r2"></a>
<ol><li><a href="http://www.unidesk.com/support/downloads">Download</a> the Unidesk_OS_Machine_Tools ZIP file onto the OS Image.</li><li>Extract the Unidesk_OS_Machine_Tools_<em>x.x.x</em> to c:\windows\setup\scripts.</li></ol>
###STEP 3: (Optional) Create an answer file for unattended installation on Unidesk desktops<a name="STEP_3:_(Optional)_Create_an_answer_file_for_unattended_installation_on_Unide..."></a><a name="STEP5_win2012r2"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, right-click the unattend.exe tool and choose <strong>Run as administrator</strong>. The unattend builder form opens.</p></li><li><p>Complete the unattend form.</p><ul><li>Product key activation<ul><li>For KMS activation, select KMS Server.</li><li>For KMS with a Multiple Activation Key (MAK), select KMS with MAK and enter the MAK.</li><li>For Retail Licensing with a MAK, select Retail with MAK, and the MAK.</li></ul></li><li>Domain Join<ul><li>Select Enable if you want to configure the unattend.xml file to join desktops to a specific domain. If you plan to use AD join scripts, ensure Enable is <em>not</em> selected.</li><li><a href="http://www.unidesk.com/support/downloads"></a><a href="http://www.unidesk.com/support/downloads"></a>You can add desktops to the Computer's container in Active Directory by deleting the OU entry. However, we recommend that you use an alternate OU for Unidesk desktops, both to segregate the desktop from other machines and to avoid applying virtual desktop-specific GPOs to other types of machines.</li><li><a href="http://www.unidesk.com/support/downloads"></a> If you are supporting multiple OUs within one or more domains, you can join machines in different Domains or OUs by creating different unattend.xml files in different application layers.</li></ul></li><li>Local Administrator account<ul><li><a href="http://www.unidesk.com/support/downloads"></a>If you want to use the unattend.xml file to enable the Administrator account on each Unidesk desktop, select <strong>Enable</strong>. Remember to also enable this account in your OS Image or Operating System Layer revision. It is possible to enable the Administrator account for your OS Image and then have it disabled in the deployed desktops by clearing the check box.</li><li>If you want to add an alternate Administrator account, select Enable and enter the account information. This account cannot be pre-configured in the OS Image.</li><li>You can create a desktop where the Administrator is disabled and the alternate administrator is created and enabled. However for this to work, the Administrator account must be enabled in the OS Image and it cannot be renamed.</li></ul></li><li>Time zone<ul><li><a href="http://www.unidesk.com/support/downloads"></a>Select the time zone. If your time zone is not listed, you can add it to the Other box. Be sure to use the time zone, <em>not</em> the display setting. A list of time zone settings can be found <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx">here</a>.</li></ul></li><li>Disabling automatic activation<ul><li>Select this option if you plan to use the Microsoft Volume Activation Management Tool.</li></ul></li></ul></li><li><p>Click <strong>Save File</strong>.</p></li></ol>
###STEP 4: (Optional) Optimize the OS Image for the Unidesk environment<a name="STEP_4:_(Optional)_Optimize_the_OS_Image_for_the_Unidesk_environment"></a><a name="STEP7_win2012r2"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, run the Optimize executable to create a .cmd file (optimization.cmd) that will be run to optimize the image during Desktop creation.</p></li><li><p>Follow the instructions to run the optimize.cmd file on the OS Image. This removes installation-specific drivers and settings.</p><p>If you are using the Unidesk Optimizer script and you are enabling the View Persona feature, you must go to the section of the Optimizer script called <strong>Disable Unnecessary Services to Save Memory and CPU</strong>, <em>deselect</em> the option to <strong>Disable Offline File Service</strong>, and click <strong>Save File</strong>. This is because View Persona folder redirection requires Offline files to be enabled, and by default, the Unidesk Optimizer turns off Offline files, which are not a requirement for Unidesk.</p></li></ol>
###STEP 5: Create a snapshot of the OS Image<a name="STEP_5:_Create_a_snapshot_of_the_OS_Image"></a><a name="STEP3_win2012r2"></a>
Once the OS Image is ready, create a VMware snapshot of it, so that you can return to this state at any time.
Important: It is critical to create a snapshot before installing the Unidesk software onto the OS Image. Without this snapshot, returning to this state requires rebuilding the image.
###STEP 6: Install the Unidesk tools onto the OS Image<a name="STEP_6:_Install_the_Unidesk_tools_onto_the_OS_Image"></a><a name="STEP6_win2012r2"></a>
<ol><li>In the Unidesk_OS_Machine_Tools folder, run the Unidesk setup_x86.exe (32-bit) or setup_x64.exe (64-bit).</li><li><p>The installation prompts for the location of the unattend.xml file (the default location is c:\windows\panther).</p></li></ol>
Once this is done, you are ready to [create a Unidesk Operating System Layer](#Create_an_OS_Layer_(vSphere))[.](#Create_an_OS_Layer_(vSphere))
##Prepare a Windows 2008 R2 image<a name="Prepare_a_Windows_2008_R2_image"></a><a name="Prepare2"></a>
###STEP 1: Set up a Windows Server 2008 R2 OS Image on a virtual machine<a name="STEP_1:_Set_up_a_Windows_Server_2008_R2_OS_Image_on_a_virtual_machine"></a><a name="STEP1_win2008r2"></a>
In the vSphere client:
<ol><li><p><a href="#Create_an_OS_Layer_(vSphere)"></a> Create a VM for your OS image, making sure to choose the default cluster allocation size of 4K.</p></li><li><p><a href="#Create_an_OS_Layer_(vSphere)"></a> Configure the virtual machine hardware settings, for example, the NIC and video memory.</p><p><strong>Important:</strong> You can have just <em>one network device</em> for the virtual machine, and it must be the VMXNET 3 network adapter, as the default E1000 adapter (or even a ghost NIC leftover from an E1000 adapter) can cause customization timeout errors on the VM when attempting to boot the image in environments such as Citrix PVS, Citrix MCS, or VMware Horizon View.</p></li><li><p>If you are using Citrix PVS or VMware Horizon View, install Windows Server 2008 R2 Service Pack 1 (SP1).</p><p><span>Notes:</span> </p><ul><li>If you do not install SP1, an error occurs when you try to install View Agent in the virtual machine.</li><li>When creating the image, be sure to choose the default cluster allocation size of 4K.</li></ul></li><li><p>If using PVS:</p><ol><li><p>In the VM properties, make sure the PCI slot number is 192, as shown below (mouse over the image to enlarge it):</p><p><img></img></p></li><li><p>Install KB2550978 hotfix:</p><p>https://support.microsoft.com/en-us/kb/2550978</p></li><li><p>Run cmd as Administrator, and enter the following commands:</p><pre>set devmgr_show_nonpresent_devices=1run devmgmt.msc in the same cmd window</pre><p><strong>Note:</strong> You must run these commands, or the next command will not show hidden devices (ghost NICs)</p></li><li>Select <strong>View >Show hidden devices </strong> in Device Manager. This shows dead NICs as grayed out.</li><li><p>Uninstall the dead NIC and reboot the system.</p></li></ol></li><li><p>Install VMware Tools on the OS image.</p></li></ol>
###STEP 2: Copy the Unidesk Tools onto the OS Image<a name="STEP_2:_Copy_the_Unidesk_Tools_onto_the_OS_Image"></a><a name="STEP4_win2008r2"></a>
<ol><li><a href="http://www.unidesk.com/support/downloads">Download</a> the Unidesk_OS_Machine_Tools ZIP file onto the OS Image.</li><li>Extract the Unidesk_OS_Machine_Tools_<em>x.x.x</em> to c:\windows\setup\scripts.</li></ol>
###STEP 3: (Optional) Create an answer file for unattended installation on Unidesk desktops<a name="STEP_3:_(Optional)_Create_an_answer_file_for_unattended_installation_on_Unide..._..548"></a><a name="STEP5_win2008r2"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, right-click the unattend.exe tool and choose <strong>Run as administrator</strong>. The unattend builder form opens.</p></li><li><p>Complete the unattend form.</p><ul><li>Product key activation<ul><li>For KMS activation, select KMS Server.</li><li>For KMS with a Multiple Activation Key (MAK), select KMS with MAK and enter the MAK.</li><li>For Retail Licensing with a MAK, select Retail with MAK, and the MAK.</li></ul></li><li>Domain Join<ul><li>Select Enable if you want to configure the unattend.xml file to join desktops to a specific domain. If you plan to use AD join scripts, ensure Enable is <em>not</em> selected.</li><li><a href="http://www.unidesk.com/support/downloads"></a><a href="http://www.unidesk.com/support/downloads"></a>You can add desktops to the Computer's container in Active Directory by deleting the OU entry. However, we recommend that you use an alternate OU for Unidesk desktops, both to segregate the desktop from other machines and to avoid applying virtual desktop-specific GPOs to other types of machines.</li><li><a href="http://www.unidesk.com/support/downloads"></a> If you are supporting multiple OUs within one or more domains, you can join machines in different Domains or OUs by creating different unattend.xml files in different application layers.</li><li><p><a href="http://www.unidesk.com/support/downloads"></a>For information about domain join scripts, see the following Support articles:</p><p><a href="troubleshoot_domain_join.htm">Debugging Domain Join Problems in Windows 7 and Windows Server 2008 R2</a></p></li></ul></li><li>Local Administrator account<ul><li><a href="troubleshoot_domain_join.htm"></a>If you want to use the unattend.xml file to enable the Administrator account on each Unidesk desktop, select Enable. Remember to also enable this account in your OS Image or Operating System Layer revision. It is possible to enable the Administrator account for your OS Image and then have it disabled in the deployed desktops by clearing the check box.</li><li>If you want to add an alternate Administrator account, select Enable and enter the account information. This account cannot be pre-configured in the OS Image.</li><li>You can create a desktop where the Administrator is disabled and the alternate administrator is created and enabled. However for this to work, the Administrator account must be enabled in the OS Image and it cannot be renamed.</li></ul></li><li>Time zone<ul><li><a href="troubleshoot_domain_join.htm"></a>Select the time zone. If your time zone is not listed, you can add it to the Other box. Be sure to use the time zone, <em>not</em> the display setting. A list of time zone settings can be found <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx">here</a>.</li></ul></li><li>Disabling automatic activation<ul><li>Select this option if you plan to use the Microsoft Volume Activation Management Tool.</li></ul></li></ul></li><li><p>Click <strong>Save File</strong>.</p></li></ol>
###STEP 4: (Optional) Optimize the OS Image for the Unidesk environment<a name="STEP_4:_(Optional)_Optimize_the_OS_Image_for_the_Unidesk_environment_..549"></a><a name="STEP7_win2008r2"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, run the Optimize executable to create a .cmd file (optimize.cmd) that will be run to optimize the image during desktop creation.</p></li><li><p>Follow the instructions to run the optimize.cmd file on the OS Image. This removes installation-specific drivers and settings.</p><p>If you are using the Unidesk Optimizer script and you are enabling the View Persona feature, you must go to the section of the Optimizer script called <strong>Disable Unnecessary Services to Save Memory and CPU</strong>, <em>deselect</em> the option to <strong>Disable Offline File Service</strong>, and click <strong>Save File</strong>. This is because View Persona folder redirection requires Offline files to be enabled, and by default, the Unidesk Optimizer turns off Offline files, which are not a requirement for Unidesk.</p></li></ol>
###STEP 5: Create a VMware snapshot of the OS Image<a name="STEP_5:_Create_a_VMware_snapshot_of_the_OS_Image"></a><a name="STEP3_win2008r2"></a>
Once the OS Image is ready, create a VMware snapshot of it so you can return to this state at any time.
Important: It is critical to create a snapshot before installing the Unidesk software onto the OS Image. Without this snapshot, returning to this state requires rebuilding the image.
###STEP 6: Install the Unidesk tools onto the OS Image<a name="STEP_6:_Install_the_Unidesk_tools_onto_the_OS_Image_..550"></a><a name="STEP6_win2008r2"></a>
<ol><li>In the Unidesk_OS_Machine_Tools folder, run the Unidesk setup_x86.exe (32-bit) or setup_x64.exe (64-bit).</li><li><p><a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> The installation prompts for the location of the unattend.xml file (the default location is c:\windows\panther).</p></li></ol>
Once this is done, you are ready to [create a Unidesk Operating System Layer](deploy_os_layer_create_first.htm)[.](deploy_os_layer_create_first.htm)
##Prepare a Windows 10 image<a name="Prepare_a_Windows_10_image"></a><a name="Prepare3"></a>
When preparing the OS Image for import into a Unidesk Operating System Layer, you can speed up start times by [removing Windows 10 built-in applications](http://www.howtogeek.com/224798/how-to-uninstall-windows-10s-built-in-apps-and-how-to-reinstall-them/)[. If you do, we recommend removing these applications either on the OS Image itself, or on the Operating System Layer.](http://www.howtogeek.com/224798/how-to-uninstall-windows-10s-built-in-apps-and-how-to-reinstall-them/)
###STEP 1: Set up a Windows 10 image on a virtual machine<a name="STEP_1:_Set_up_a_Windows_10_image_on_a_virtual_machine"></a><a name="STEP1_8.1"></a>
In the vSphere client:
<ol><li><p><a href="http://www.howtogeek.com/224798/how-to-uninstall-windows-10s-built-in-apps-and-how-to-reinstall-them/"></a> Create a VM for your OS image.</p><p><strong>Important:</strong> When creating the image, be sure to choose the default cluster allocation size of 4K.</p></li><li><p><a href="http://www.howtogeek.com/224798/how-to-uninstall-windows-10s-built-in-apps-and-how-to-reinstall-them/"></a> Configure the virtual machine hardware settings, for example, the NIC and video memory.</p></li><li><p>Disable Windows System Restore and Windows Automatic Updates:</p><ol><li><p>Log into the VM.</p></li><li>Select <strong>Computer Config > Administrative Templates > Windows Components > Windows Updates > Config Auto Updates</strong>.</li><li>Set this to <strong>Disabled</strong>.</li></ol><p>The Unidesk<a href="http://www.howtogeek.com/224798/how-to-uninstall-windows-10s-built-in-apps-and-how-to-reinstall-them/"></a> system handles restore points for you, and Unidesk layer versions allow you to control when updates occur.</p></li><li><p>If using KMS licensing, run a command window as Administrator, and enter these commands:</p><pre>slmgr /skms <kmsserverhost>slmgr /rearmrebootslmgr /ipk XXXX-YOUR-KMS-KEY-XXXXslmgr /ato</pre></li><li>Install the VMware Tools on the OS image.</li></ol>
###STEP 2: Copy the Unidesk Tools onto the OS Image<a name="STEP_2:_Copy_the_Unidesk_Tools_onto_the_OS_Image_..551"></a><a name="STEP3_8.1"></a>
<ol><li><a href="http://www.unidesk.com/support/downloads">Download</a> the Unidesk_OS_Machine_Tools ZIP file onto the OS Image.</li><li>Extract the Unidesk_OS_Machine_Tools_<em>x.x.x</em> to c:\windows\setup\scripts.</li></ol>
###STEP 3: (Optional) Create an answer file for unattended installation on Unidesk Desktops<a name="STEP_3:_(Optional)_Create_an_answer_file_for_unattended_installation_on_Unide..._..552"></a><a name="STEP5_8.1"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, right-click the unattend.exe tool and choose <strong>Run as administrator</strong>. The unattend builder form opens.</p></li><li><p>Complete the unattend form.</p>Product key activation<p>For KMS activation, select KMS Server.</p><p>For KMS with a Multiple Activation Key (MAK), select KMS with MAK and enter the MAK.</p><p>For Retail Licensing with a MAK, select Retail with MAK, and the MAK.</p>Domain Join<p>Select Enable if you want to configure the unattend.xml file to join Desktops to a specific domain. If you plan to use AD join scripts, ensure Enable is <em>not</em> selected.</p><p>You can add Desktops to the Computer's container in Active Directory by deleting the OU entry. However, we recommend that you use an alternate OU for Unidesk Desktops, both to segregate the Desktop from other machines and to avoid applying virtual Desktop-specific GPOs to other types of machines.</p><p>If you are supporting multiple OUs within one or more domains, you can join machines in different Domains or OUs by creating different unattend.xml files in different application layers.</p>Local Administrator account<p>You can enable the Administrator account on each Unidesk Desktop by selecting Enable. Remember to also enable this account in your OS Image or Operating System Layer version. You can also enable the Administrator account for your OS Image and then have it disabled in the deployed Desktops by clearing the check box.</p><p>If you want to add an alternate Administrator account, select Enable and enter the account information. This account <em>cannot</em> be preconfigured in the OS Image.</p><p>You can create a Desktop where the Administrator is disabled and the alternate administrator is created and enabled. However for this to work, the Administrator account must be enabled in the OS Image and it cannot be renamed.</p>Time Zone<p>If your time zone is not listed, you can add it to the <strong>Other</strong> box. Be sure to use the <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx">time zone</a>, <em>not</em> the display setting.</p>Disabling automatic activation<p>Select this option if you plan to use the Microsoft Volume Activation Management Tool.</p></li><li><p>Click <strong>Save File</strong>.</p></li></ol>
###STEP 4: (Optional) Optimize the OS Image for the Unidesk environment<a name="STEP_4:_(Optional)_Optimize_the_OS_Image_for_the_Unidesk_environment_..553"></a><a name="STEP6_8.1"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, right-click the optimizations.exe tool and choose <strong>Run as administrator</strong>. This creates a .cmd file (optimizations.cmd) that will be run during Desktop creation to optimize the image.</p></li><li><p>Follow the instructions to run the optimizations.cmd file on the OS Image. This removes installation-specific drivers and settings.</p><p>If you are using the Unidesk Optimizer script and you are enabling the View Persona feature, you must go to the section of the Optimizer script called <strong>Disable Unnecessary Services to Save Memory and CPU</strong>, <em>deselect</em> the option to <strong>Disable Offline File Service</strong>, and click <strong>Save File</strong>. This is because View Persona folder redirection requires Offline files to be enabled, and by default, the Unidesk Optimizer turns off Offline files, which are not a requirement for Unidesk.</p></li></ol>
###STEP 5: Install .Net Framework 3.5.1<a name="STEP_5:_Install_.Net_Framework_3.5.1"></a><a name="STEP2_8.1"></a>
The .Net Framework is a software framework provided by Microsoft that is required for many 3rd party applications to run. To install this feature, follow the steps below.
<ol><li><p>On the Start menu, select <strong>Control Panel > Programs and Features</strong>.</p></li><li><p>In the left panel select <strong>Turn Windows features on or off.</strong> A window opens.</p></li><li><p>Select <strong>.NET Framework 3.5</strong>, click <strong>OK</strong>, and wait for the installation to complete.</p><p><strong>Important:</strong> Even if .NET is already installed, continue with the rest of these steps.</p></li><li><p>Exit the Control Panel.</p></li><li><p>In Notifications in the right-side of your taskbar, click <strong>All Settings</strong>, and open the Windows 10 Settings app.</p></li><li><p>Select Settings > Update ; Security.</p></li><li><p>Check for updates, and install all updates available.</p></li><li><p>Exit Settings.</p></li><li><p>Open an administrator-level command prompt, and enter the following commands:</p><pre>cd \windows\Microsoft.Net\Framework\v4.nnnnnngen update /force</pre></li><li><p>Wait for the command to complete, and enter the following commands:</p><pre>cd \windows\Microsoft.Net\Framework64\v4.nnnnnngen update /force</pre></li><li>Exit the command prompt.</li></ol>
###STEP 6: If using PVS, follow these steps to avoid ghost NICs.<a name="STEP_6:_If_using_PVS,_follow_these_steps_to_avoid_ghost_NICs."></a><a name="Step6_..90"></a>
<ol><li><p>Install KB2550978 hotfix.</p></li><li><p>Reboot the VM,</p></li><li><p>Enter the commands:</p><pre>set devmgr_show_nonpresent_devices=devmgmt.msc</pre></li><li><p>Remove any ghost NICs.</p></li><li><p>Reboot the system.</p></li></ol>
###STEP 7: Create a backup copy of the OS Image<a name="STEP_7:_Create_a_backup_copy_of_the_OS_Image"></a><a name="STEP7"></a>
Once the OS Image is ready, create a copy of it so you can return to this state at any time.
Important: It is critical to create a backup copy before installing the Unidesk software onto the OS Image. Without this backup copy, returning to this state requires rebuilding the image.
###STEP 8: Install the Unidesk software onto the OS Image<a name="STEP_8:_Install_the_Unidesk_software_onto_the_OS_Image"></a><a name="STEP8"></a>
<ol><li>Run setup_x64.exe from c:\Windows\setup\scripts.</li></ol>
Once this is done, you are ready to create a Unidesk Operating System Layer.
##Prepare a Windows 7 image<a name="Prepare_a_Windows_7_image"></a><a name="Prepare"></a>
###STEP 1: Set up a Windows 7 OS Image on a virtual machine<a name="STEP_1:_Set_up_a_Windows_7_OS_Image_on_a_virtual_machine"></a><a name="STEP1_win7"></a>
In the vSphere client:
<ol><li><p><a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> Create a VM for your OS Image.</p><p>Important: When creating the image, be sure to choose the default cluster allocation size of 4K.</p></li><li><p><a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> Configure the virtual machine hardware settings, for example, the NIC and video memory.</p></li><li><p>Disable Windows System Restore and Windows Automatic Updates. The Unidesk<a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> system handles restore points for you, and Unidesk layer versions allow you to control when updates occur.</p></li><li><p>Make sure you have installed VMware Tools on the OS image.</p></li></ol>
###STEP 2: Mount or copy the Unidesk Tools onto the OS Image<a name="STEP_2:_Mount_or_copy_the_Unidesk_Tools_onto_the_OS_Image"></a><a name="STEP3_win7"></a>
<ol><li><a href="http://www.unidesk.com/support/downloads">Download</a> the Unidesk_OS_Machine_Tools ZIP file onto the OS Image.</li><li>Extract the Unidesk_OS_Machine_Tools_<em>x.x.x</em> to c:\windows\setup\scripts.</li></ol>
###STEP 3: (Optional) Create an answer file for unattended installation on Unidesk desktops<a name="STEP_3:_(Optional)_Create_an_answer_file_for_unattended_installation_on_Unide..._..554"></a><a name="STEP4_win7"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, right-click the unattend.exe tool and choose <strong>Run as administrator</strong>. The unattend builder form opens.</p></li><li><p>Complete the unattend form.</p><ul><li>Product key activation<ul><li>For KMS activation, select KMS Server.</li><li>For KMS with a Multiple Activation Key (MAK), select KMS with MAK and enter the MAK.</li><li>For Retail Licensing with a MAK, select Retail with MAK, and the MAK.</li></ul></li><li>Domain Join<ul><li>Select Enable if you want to configure the unattend.xml file to join desktops to a specific domain. If you plan to use AD join scripts, ensure Enable is <em>not</em> selected.</li><li><a href="http://www.unidesk.com/support/downloads"></a><a href="http://www.unidesk.com/support/downloads"></a>You can add desktops to the Computer's container in Active Directory by deleting the OU entry. However, we recommend that you use an alternate OU for Unidesk desktops, both to segregate the desktop from other machines and to avoid applying virtual desktop-specific GPOs to other types of machines.</li><li><a href="http://www.unidesk.com/support/downloads"></a> If you are supporting multiple OUs within one or more domains, you can join machines in different Domains or OUs by creating different unattend.xml files in different application layers.</li><li><p><a href="http://www.unidesk.com/support/downloads"></a>For information about domain join scripts,see the following Support articles:</p><p><a href="troubleshoot_domain_join.htm">Debugging Domain Join Problems in Windows 7 and Windows 2008 R2</a></p><p><a href="http://www.unidesk.com/support/kb/using-powershell-advanced-domain-join-operations">Using PowerShell for Advanced Domain Join Operations</a></p></li></ul></li><li>Local Administrator account<ul><li><a href="http://www.unidesk.com/support/kb/using-powershell-advanced-domain-join-operations"></a>If you want to use the unattend.xml file to enable the Administrator account on each Unidesk desktop, select Enable. Remember to also enable this account in your OS Image or Operating System Layer revision. It is possible to enable the Administrator account for your OS Image and then have it disabled in the deployed desktops by clearing the check box.</li><li>If you want to add an alternate Administrator account, select Enable and enter the account information. This account cannot be pre-configured in the OS Image.</li><li>You can create a desktop where the Administrator is disabled and the alternate administrator is created and enabled. However for this to work, the Administrator account must be enabled in the OS Image and it cannot be renamed.</li></ul></li><li>Time zone<ul><li><a href="http://www.unidesk.com/support/kb/using-powershell-advanced-domain-join-operations"></a>Select the time zone. If your time zone is not listed, you can add it to the Other box. Be sure to use the time zone, <em>not</em> the display setting. A list of time zone settings can be found <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx">here</a>.</li></ul></li><li>Disabling automatic activation<ul><li>Select this option if you plan to use the Microsoft Volume Activation Management Tool.</li></ul></li></ul></li><li><p>Click <strong>Save File</strong>.</p></li></ol>
###STEP 4: (Optional) Optimize the OS Image for the Unidesk environment<a name="STEP_4:_(Optional)_Optimize_the_OS_Image_for_the_Unidesk_environment_..555"></a><a name="STEP6_win7"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, run the Optimize executable to create a .cmd file (optimize.cmd) that will be run to optimize the image during desktop creation.</p></li><li><p>Follow the instructions to run the optimize.cmd file on the OS Image. This removes installation-specific drivers and settings.</p><p>If you are using the Unidesk Optimizer script and you are enabling the View Persona feature, you must go to the section of the Optimizer script called <strong>Disable Unnecessary Services to Save Memory and CPU</strong>, <em>deselect</em> the option to <strong>Disable Offline File Service</strong>, and click <strong>Save File</strong>. This is because View Persona folder redirection requires Offline files to be enabled, and by default, the Unidesk Optimizer turns off Offline files, which are not a requirement for Unidesk.</p></li></ol>
###STEP 5: If using PVS, follow these steps to avoid ghost NICs<a name="STEP_5:_If_using_PVS,_follow_these_steps_to_avoid_ghost_NICs"></a>
<ol><li>Install KB2550978 hotfix.</li><li>Reboot the VM,</li><li><p>Enter the commands:</p><pre>set devmgr_show_nonpresent_devices=1devmgmt.msc</pre></li><li>Remove any ghost NICs.</li><li>Reboot the system.</li></ol>
###STEP 6: Create a VMware snapshot of the OS Image<a name="STEP_6:_Create_a_VMware_snapshot_of_the_OS_Image"></a><a name="STEP2_win7"></a>
<ol><li><p>Create a VMware snapshot of the OS image so you can return to this state at any time.</p><p><span>Important:</span> It is critical to create a snapshot before installing the Unidesk software onto the OS Image. Without this snapshot, returning to this state requires rebuilding the image.</p></li></ol>
###STEP 7: Install the Unidesk software onto the OS Image<a name="STEP_7:_Install_the_Unidesk_software_onto_the_OS_Image"></a><a name="STEP5_win7"></a>
<ol><li>In the Unidesk_OS_Machine_Tools folder, run the Unidesk setup_x86.exe (32-bit) or setup_x64.exe (64-bit).</li><li><p><a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> The installation prompts for the location of the unattend.xml file (the default location is c:\windows\panther).</p></li></ol>
Once this is done, you are ready to [create a Unidesk Operating System Layer](deploy_os_layer_create_first.htm)[.](deploy_os_layer_create_first.htm)

#Prepare the OS Image (Azure)<a name="Prepare_the_OS_Image_(Azure)"></a>
This topic explains how to prepare an OS Image for the Unidesk environment.
##Prepare a Windows 2012 R2 image (Session Host)<a name="Prepare_a_Windows_2012_R2_image_(Session_Host)"></a><a name="Prep_2012_Host"></a>
This topic explains how to prepare an OS Image for Session Hosts in the Unidesk environment.
***Notes:*** 
<ul><li>The OS Image should <em>not</em> be in a domain.</li><li>The OS Image should get its IP address from DHCP.</li><li>Ensure that the VM for your OS Layer is MBR partitioned, rather than GPT partitioned. Otherwise, you will not be able to install the Unidesk OS Machine Tools.</li></ul>
###STEP 1: Set up a Windows Server 2012 R2 OS Image on a virtual machine<a name="STEP_1:_Set_up_a_Windows_Server_2012_R2_OS_Image_on_a_virtual_machine_..556"></a>
<ol><li>In the Azure Portal, create a new VM from the "Windows Server Remote Desktop Session Host Windows Server 2012 R2" image (<strong>New > Compute > Virtual Machine > From Gallery > Windows Server Remote Desktop Session Host Windows Server 2012 R2</strong>).</li><li>When specifying the Size of the virtual machine, we recommend you select A2 or larger.</li><li><strong>Important:</strong> When specifying the Cloud Service, select the same Cloud Service that contains your [[[Undefined variable Unidesk.MA]]].</li><li>Select the same Storage Account that contains your appliances, unless your appliances are in <em>Premium Storage</em>, in which case you must use a <em>Standard Storage</em> group.</li><li>Log into the new VM, open a Windows PowerShell window, and run the <strong>Enable-PSRemoting</strong> command.</li><li>Restart the new VM.</li></ol>
###STEP 2: Apply Windows Updates<a name="STEP_2:_Apply_Windows_Updates"></a>
<ol><li><p>Apply all Windows Updates to the image so that it is at the most current Microsoft patch level and complete any reboot processes that Windows Updates may require.</p></li></ol>
###STEP 3: Copy the Unidesk Tools onto the OS Image<a name="STEP_3:_Copy_the_Unidesk_Tools_onto_the_OS_Image"></a>
<ol><li>Copy the Unidesk_OS_Machine_Tools RAR file onto the OS Image. You can find these tools in the Unidesk Download center.</li><li>Run the RAR file. This copies the tools to the C:windows\setup\scripts directory.</li></ol>
###STEP 4: Install the Unidesk tools onto the OS Image<a name="STEP_4:_Install_the_Unidesk_tools_onto_the_OS_Image"></a>
<ol><li><p>In the c:\Windows\Setup\Scripts folder, run Unidesk setup_x64.exe.</p></li><li><p><a href="deploy_os_layer_create_first.htm"></a> <a href="deploy_os_layer_create_first.htm"></a> <a href="deploy_os_layer_create_first.htm"></a> The installation prompts for the location of the Management Appliance <em>IP address</em> and the location of the unattend.xml file (the default location is c:\windows\panther).</p><p>Note: Do <em>not</em> run the UnattendBuilder included with the tools.</p></li></ol>
###STEP 5: Run NGen<a name="STEP_5:_Run_NGen"></a>
About Microsoft NGen operations
NGen is the Microsoft "Native Image Generator". It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
Force an NGen operation to the foreground
Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible.
<ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p></li><li><p>Ensure that all NGen processes have run to completion. Optionally, you can now shut down the OS Image VM.</p></li></ol>
Once you have completed these steps, you are ready to [create a Unidesk Operating System Layer](#Add_a_version_to_an_OS_Layer_(Azure))[.](#Add_a_version_to_an_OS_Layer_(Azure))


# Prepare the OS Image (Nutanix AHV)<a name="Prepare_the_OS(SPACE)Image_(Nutanix_AHV)"></a>
This topic explains how to prepare an OS Image for the Unidesk environment, using the ***OS Machine Tools***  available for download on the Unidesk [Download](http://www.unidesk.com/support/downloads)[ page.](http://www.unidesk.com/support/downloads)
Notes:
<ul><li>The OS Image should <em>not</em> be in a domain.</li><li>The OS Image should get its IP address from DHCP.</li><li>Ensure that the VM for your OS Layer is MBR partitioned, rather than GPT partitioned. Otherwise, you will not be able to install the Unidesk OS Machine Tools.</li><li>Using Third-party optimization scripts can have adverse effects in Unidesk, as they can change services and features that Unidesk uses, for example, Universal Plug and Play and the 8.3 file names setting. Use the optimization tools in the Unidesk Installer download to optimize your image.</li></ul>
## Which operating system are you using?<a name="Which_operating_system_are_you_using__..557"></a>
Choose the operating system you are using for the OS Image:
<ul><li><a href="#Prepare_win2012_..98">Windows Server 2016 (Session Host)</a></li><li><a href="#Prepare_win2012_..98">Windows Server 2012 R2 (Session Host)</a></li><li><a href="#Prepare2_..105">Windows Server 2008 R2 </a></li><li><a href="#Prepare3_..112">Windows 10</a></li><li><a href="#Prepare_..121">Windows 7 </a></li></ul>
##Prepare a Windows Server 2016 image (Session Host)<a name="Prepare_a_Windows_Server_2016_image_(Session_Host)"></a><a name="Prepare_win2012_..91"></a>
###STEP 1: Set up a Windows Server 2016 OS Image on a virtual machine<a name="STEP_1:_Set_up_a_Windows_Server_2016_OS_Image_on_a_virtual_machine"></a><a name="STEP1_win2012r2_..92"></a>
In the Prism Console:
<ol><li>Select <strong>Task > VM</strong>, and switch to <strong>Table View</strong> to see the existing VMs.</li><li>Click <strong>+Create VM</strong> in the upper right corner, and enter the specifics about the new VM:<ol><li><p>Enter a <strong>Name</strong> and add a <strong>Description</strong>.</p></li><li><p>Select the number of <strong>VCPUs</strong>.</p></li><li><p>Set the <strong>Cores per CPU</strong>.</p></li><li><p>Set <strong>Memory</strong>.</p></li><li><p>Select <strong>Disks</strong>, and create a VM with three disks. The first CD-ROM is the ISO for the OS, the second CD-ROM is for the Nutanix VIRTIO drivers that allow the Nutanix VM to access the disk where you install the OS. To start, one CD-ROM is assigned.</p><ol><li>Edit the values for the assigned CD-ROM:</li><li>For Operation, select <strong>Clone from ADSF file</strong>.</li></ol><ol><li><p>For Bus Type, select <strong>IDE</strong>.</p></li><li><p>Enter the <em>path</em> to your Windows ISO. The path is the combination of the Storage Container and the ISO Name. For example:</p><p>/ISOStore/en_windows_16_enterprise_version_1511_x64_dvd_7224901.iso</p></li><li>Click <strong>Update</strong>.</li></ol></li><li>Add another disk by clicking the <strong>+Add New Disk</strong> button:</li><ol><li>Set the Type to <strong>CDROM</strong>.</li><li>Set the Operation to <strong>Clone from ADSF file</strong>.</li><li>Set the Bus Type to <strong>IDE</strong></li><li><p>Enter the path to the Windows VIRTIO Drivers. For example:</p><p>/ISOStore/virtio-win-0.1.102.iso</p></li><li>Click <strong>Add</strong>.</li></ol><li>Click the <strong>+Add New Disk</strong> button.</li><ol><li>Set the Type to <strong>Disk</strong>.</li><li>Set the Operation to <em>Allocate on Container.</em></li><li>Set the Bus Type to <strong>SCSI</strong>.</li><li>Select the Container you want to use.</li><li>Enter the <strong>Size</strong> </li><li>Click <strong>Add</strong>.</li></ol><li>Click <strong>+Add new Nic</strong>.</li><ol><li>Enter the <strong>VLAN Name</strong>.</li></ol><li><p>Click <strong>Save</strong>.</p></li></ol></li><li><p>Power on the VM:</p><ol><li>Select <strong>Tasks > VM</strong>.</li><li>Switch to the Table View to see existing VMs.</li><li>Select the VM in the Table, and click <strong>Power On</strong>.</li></ol></li><li><p>Launch the Console by selecting the VM and clicking <strong>Launch Console</strong>. When the VM boots it begins to install the Windows OS from the ISO disk. When the VM boots it will <em>begi</em>n to install the Windows OS from the ISO disk.</p><ol><li><p>When asked, "Where do you want to install Windows?" notice that even though you added a disk in the VM creation wizard, there is no disk.</p></li><li><p>Select the Load Driver option, and select Browse.</p></li><li><p>Select the CD with the virtio-win-0.1.1 drivers.</p></li><li><p>Select the vioscsi folder, and choose the folder for your Windows OS.</p></li><li><p>Once the driver is installed, select the hard drive that you added earlier and finish installing the OS.</p></li></ol></li><li><p>After the OS is installed, manually install the VirtIO drivers:</p><ol><li><p>Launch Device Manager.</p></li><li><p>Select <strong>Other Devices</strong>, right-click <strong>Ethernet Controller</strong> and choose <strong>Update Driver Software</strong>.</p></li><li><p>Browse My Computer, and choose the <strong>VirtIO CD</strong>. The ethernet drivers are stored in the <strong>NetKVM</strong> folder.</p></li></ol></li><li><p>Disable Windows System Restore and Windows Automatic Updates. The Unidesk<a href="#Prepare_..121"></a> system handles restore points for you, and Unidesk layer versions allow you to control when updates occur.</p></li></ol>
###STEP 2: Copy the Unidesk OS Machine Tools onto the OS Image<a name="STEP_2:_Copy_the_Unidesk_OS(SPACE)Machine_Tools_onto_the_OS_Image_..558"></a><a name="STEP4_win2012r2_..93"></a>
<ol><li><a href="http://www.unidesk.com/support/downloads">Download</a> the Unidesk_OS_Machine_Tools ZIP file onto the OS Image.</li><li>Extract the Unidesk_OS_Machine_Tools_<em>x.x.x</em> to c:\windows\setup\scripts.</li></ol>
###STEP 3: (Optional) Create an answer file for unattended installation on Unidesk desktops<a name="STEP_3:_(Optional)_Create_an_answer_file_for_unattended_installation_on_Unide..._..559"></a><a name="STEP5_win2012r2_..94"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, right-click the unattend.exe tool and choose <strong>Run as administrator</strong>. The unattend builder form opens.</p></li><li><p>Complete the unattend form.</p><ul><li>Product key activation<ul><li>For KMS activation, select KMS Server.</li><li>For KMS with a Multiple Activation Key (MAK), select KMS with MAK and enter the MAK.</li><li>For Retail Licensing with a MAK, select Retail with MAK, and the MAK.</li></ul></li><li>Domain Join<ul><li>Select Enable if you want to configure the unattend.xml file to join desktops to a specific domain. If you plan to use AD join scripts, ensure Enable is <em>not</em> selected.</li><li><a href="http://www.unidesk.com/support/downloads"></a><a href="http://www.unidesk.com/support/downloads"></a>You can add desktops to the Computer's container in Active Directory by deleting the OU entry. However, we recommend that you use an alternate OU for Unidesk desktops, both to segregate the desktop from other machines and to avoid applying virtual desktop-specific GPOs to other types of machines.</li><li><a href="http://www.unidesk.com/support/downloads"></a> If you are supporting multiple OUs within one or more domains, you can join machines in different Domains or OUs by creating different unattend.xml files in different application layers.</li></ul></li><li>Local Administrator account<ul><li><a href="http://www.unidesk.com/support/downloads"></a>If you want to use the unattend.xml file to enable the Administrator account on each Unidesk desktop, select <strong>Enable</strong>. Remember to also enable this account in your OS Image or Operating System Layer revision. It is possible to enable the Administrator account for your OS Image and then have it disabled in the deployed desktops by clearing the check box.</li><li>If you want to add an alternate Administrator account, select Enable and enter the account information. This account cannot be pre-configured in the OS Image.</li><li>You can create a desktop where the Administrator is disabled and the alternate administrator is created and enabled. However for this to work, the Administrator account must be enabled in the OS Image and it cannot be renamed.</li></ul></li><li>Time zone<ul><li><a href="http://www.unidesk.com/support/downloads"></a>Select the time zone. If your time zone is not listed, you can add it to the Other box. Be sure to use the time zone, <em>not</em> the display setting. A list of time zone settings can be found <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx">here</a>.</li></ul></li><li>Disabling automatic activation<ul><li>Select this option if you plan to use the Microsoft Volume Activation Management Tool.</li></ul></li></ul></li><li><p>Click <strong>Save File</strong>.</p></li></ol>
###STEP 4: (Optional) Optimize the OS Image for the Unidesk environment<a name="STEP_4:_(Optional)_Optimize_the_OS_Image_for_the_Unidesk_environment_..560"></a><a name="STEP7_win2012r2_..95"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, run the Optimize executable to create a .cmd file (optimization.cmd) that will be run to optimize the image during Desktop creation.</p></li><li><p>Follow the instructions to run the optimize.cmd file on the OS Image. This removes installation-specific drivers and settings.</p><p>If you are using the Unidesk Optimizer script and you are enabling the View Persona feature, you must go to the section of the Optimizer script called <strong>Disable Unnecessary Services to Save Memory and CPU</strong>, <em>deselect</em> the option to <strong>Disable Offline File Service</strong>, and click <strong>Save File</strong>. This is because View Persona folder redirection requires Offline files to be enabled, and by default, the Unidesk Optimizer turns off Offline files, which are not a requirement for Unidesk.</p></li></ol>
###STEP 5: Create a snapshot of the OS Image<a name="STEP_5:_Create_a_snapshot_of_the_OS_Image_..561"></a><a name="STEP3_win2012r2_..96"></a>
Once the OS Image is ready, create a snapshot of it, so that you can return to this state at any time.
Important: It is critical to create a snapshot before installing the Unidesk software onto the OS Image. Without this snapshot, returning to this state requires rebuilding the image.
###STEP 6: Install the Unidesk tools onto the OS Image<a name="STEP_6:_Install_the_Unidesk_tools_onto_the_OS_Image_..562"></a><a name="STEP6_win2012r2_..97"></a>
<ol><li>In the Unidesk_OS_Machine_Tools folder, run the Unidesk setup_x86.exe (32-bit) or setup_x64.exe (64-bit).</li><li><p>The installation prompts for the location of the unattend.xml file (the default location is c:\windows\panther).</p></li></ol>
Once this is done, you are ready to [create a Unidesk Operating System Layer](#Create_an_OS_Layer_(vSphere))[.](#Create_an_OS_Layer_(vSphere))
##Prepare a Windows Server 2012 R2 image (Session Host)<a name="Prepare_a_Windows_Server_2012_R2_image_(Session_Host)_..563"></a><a name="Prepare_win2012_..98"></a>
###STEP 1: Set up a Windows Server 2012 R2 OS Image on a virtual machine<a name="STEP_1:_Set_up_a_Windows_Server_2012_R2_OS_Image_on_a_virtual_machine_..564"></a><a name="STEP1_win2012r2_..99"></a>
In the Prism Console:
<ol><li>Select <strong>Task > VM</strong>, and switch to <strong>Table View</strong> to see the existing VMs.</li><li>Click <strong>+Create VM</strong> in the upper right corner, and enter the specifics about the new VM:<ol><li><p>Enter a <strong>Name</strong> and add a <strong>Description</strong>.</p></li><li><p>Select the number of <strong>VCPUs</strong>.</p></li><li><p>Set the <strong>Cores per CPU</strong>.</p></li><li><p>Set <strong>Memory</strong>.</p></li><li><p>Select <strong>Disks</strong>, and create a VM with three disks. The first CD-ROM is the ISO for the OS, the second CD-ROM is for the Nutanix VIRTIO drivers that allow the Nutanix VM to access the disk where you install the OS. To start, one CD-ROM is assigned.</p><ol><li>Edit the values for the assigned CD-ROM:</li><li>For Operation, select <strong>Clone from ADSF file</strong>.</li></ol><ol><li><p>For Bus Type, select <strong>IDE</strong>.</p></li><li><p>Enter the <em>path</em> to your Windows ISO. The path is the combination of the Storage Container and the ISO Name. For example:</p><p>/ISOStore/en_windows_12_enterprise_version_1511_x64_dvd_7224901.iso</p></li><li>Click <strong>Update</strong>.</li></ol></li><li>Add another disk by clicking the <strong>+Add New Disk</strong> button:</li><ol><li>Set the Type to <strong>CDROM</strong>.</li><li>Set the Operation to <strong>Clone from ADSF file</strong>.</li><li>Set the Bus Type to <strong>IDE</strong></li><li><p>Enter the path to the Windows VIRTIO Drivers. For example:</p><p>/ISOStore/virtio-win-0.1.102.iso</p></li><li>Click <strong>Add</strong>.</li></ol><li>Click the <strong>+Add New Disk</strong> button.</li><ol><li>Set the Type to <strong>Disk</strong>.</li><li>Set the Operation to <em>Allocate on Container.</em></li><li>Set the Bus Type to <strong>SCSI</strong>.</li><li>Select the Container you want to use.</li><li>Enter the <strong>Size</strong></li><li>Click <strong>Add</strong>.</li></ol><li>Click <strong>+Add new Nic</strong>.</li><ol><li>Enter the <strong>VLAN Name</strong>.</li></ol><li><p>Click <strong>Save</strong>.</p></li></ol></li><li><p>Power on the VM:</p><ol><li>Select <strong>Tasks > VM</strong>.</li><li>Switch to the Table View to see existing VMs.</li><li>Select the VM in the Table, and click <strong>Power On</strong>.</li></ol></li><li><p>Launch the Console by selecting the VM and clicking <strong>Launch Console</strong>. When the VM boots it begins to install the Windows OS from the ISO disk. When the VM boots it will <em>begi</em>n to install the Windows OS from the ISO disk.</p><ol><li><p>When asked, "Where do you want to install Windows?" notice that even though you added a disk in the VM creation wizard, there is no disk.</p></li><li><p>Select the Load Driver option, and select Browse.</p></li><li><p>Select the CD with the virtio-win-0.1.1 drivers.</p></li><li><p>Select the vioscsi folder, and choose the folder for your Windows OS.</p></li><li><p>Once the driver is installed, select the hard drive that you added earlier and finish installing the OS.</p></li></ol></li><li><p>After the OS is installed, manually install the VirtIO drivers:</p><ol><li><p>Launch Device Manager.</p></li><li><p>Select <strong>Other Devices</strong>, right-click <strong>Ethernet Controller</strong> and choose <strong>Update Driver Software</strong>.</p></li><li><p>Browse My Computer, and choose the <strong>VirtIO CD</strong>. The ethernet drivers are stored in the <strong>NetKVM</strong> folder.</p></li></ol></li><li><p>Disable Windows System Restore and Windows Automatic Updates. The Unidesk<a href="#Create_an_OS_Layer_(vSphere)"></a> system handles restore points for you, and Unidesk layer versions allow you to control when updates occur.</p></li></ol>
###STEP 2: Copy the Unidesk OS Machine Tools onto the OS Image<a name="STEP_2:_Copy_the_Unidesk_OS(SPACE)Machine_Tools_onto_the_OS_Image_..565"></a><a name="STEP4_win2012r2_..100"></a>
<ol><li><a href="http://www.unidesk.com/support/downloads">Download</a> the Unidesk_OS_Machine_Tools ZIP file onto the OS Image.</li><li>Extract the Unidesk_OS_Machine_Tools_<em>x.x.x</em> to c:\windows\setup\scripts.</li></ol>
###STEP 3: (Optional) Create an answer file for unattended installation on Unidesk desktops<a name="STEP_3:_(Optional)_Create_an_answer_file_for_unattended_installation_on_Unide..._..566"></a><a name="STEP5_win2012r2_..101"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, right-click the unattend.exe tool and choose <strong>Run as administrator</strong>. The unattend builder form opens.</p></li><li><p>Complete the unattend form.</p><ul><li>Product key activation<ul><li>For KMS activation, select KMS Server.</li><li>For KMS with a Multiple Activation Key (MAK), select KMS with MAK and enter the MAK.</li><li>For Retail Licensing with a MAK, select Retail with MAK, and the MAK.</li></ul></li><li>Domain Join<ul><li>Select Enable if you want to configure the unattend.xml file to join desktops to a specific domain. If you plan to use AD join scripts, ensure Enable is <em>not</em> selected.</li><li><a href="http://www.unidesk.com/support/downloads"></a><a href="http://www.unidesk.com/support/downloads"></a>You can add desktops to the Computer's container in Active Directory by deleting the OU entry. However, we recommend that you use an alternate OU for Unidesk desktops, both to segregate the desktop from other machines and to avoid applying virtual desktop-specific GPOs to other types of machines.</li><li><a href="http://www.unidesk.com/support/downloads"></a> If you are supporting multiple OUs within one or more domains, you can join machines in different Domains or OUs by creating different unattend.xml files in different application layers.</li></ul></li><li>Local Administrator account<ul><li><a href="http://www.unidesk.com/support/downloads"></a>If you want to use the unattend.xml file to enable the Administrator account on each Unidesk desktop, select <strong>Enable</strong>. Remember to also enable this account in your OS Image or Operating System Layer revision. It is possible to enable the Administrator account for your OS Image and then have it disabled in the deployed desktops by clearing the check box.</li><li>If you want to add an alternate Administrator account, select Enable and enter the account information. This account cannot be pre-configured in the OS Image.</li><li>You can create a desktop where the Administrator is disabled and the alternate administrator is created and enabled. However for this to work, the Administrator account must be enabled in the OS Image and it cannot be renamed.</li></ul></li><li>Time zone<ul><li><a href="http://www.unidesk.com/support/downloads"></a>Select the time zone. If your time zone is not listed, you can add it to the Other box. Be sure to use the time zone, <em>not</em> the display setting. A list of time zone settings can be found <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx">here</a>.</li></ul></li><li>Disabling automatic activation<ul><li>Select this option if you plan to use the Microsoft Volume Activation Management Tool.</li></ul></li></ul></li><li><p>Click <strong>Save File</strong>.</p></li></ol>
###STEP 4: (Optional) Optimize the OS Image for the Unidesk environment<a name="STEP_4:_(Optional)_Optimize_the_OS_Image_for_the_Unidesk_environment_..567"></a><a name="STEP7_win2012r2_..102"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, run the Optimize executable to create a .cmd file (optimization.cmd) that will be run to optimize the image during Desktop creation.</p></li><li><p>Follow the instructions to run the optimize.cmd file on the OS Image. This removes installation-specific drivers and settings.</p><p>If you are using the Unidesk Optimizer script and you are enabling the View Persona feature, you must go to the section of the Optimizer script called <strong>Disable Unnecessary Services to Save Memory and CPU</strong>, <em>deselect</em> the option to <strong>Disable Offline File Service</strong>, and click <strong>Save File</strong>. This is because View Persona folder redirection requires Offline files to be enabled, and by default, the Unidesk Optimizer turns off Offline files, which are not a requirement for Unidesk.</p></li></ol>
###STEP 5: Create a snapshot of the OS Image<a name="STEP_5:_Create_a_snapshot_of_the_OS_Image_..568"></a><a name="STEP3_win2012r2_..103"></a>
Once the OS Image is ready, create a snapshot of it, so that you can return to this state at any time.
Important: It is critical to create a snapshot before installing the Unidesk software onto the OS Image. Without this snapshot, returning to this state requires rebuilding the image.
###STEP 6: Install the Unidesk tools onto the OS Image<a name="STEP_6:_Install_the_Unidesk_tools_onto_the_OS_Image_..569"></a><a name="STEP6_win2012r2_..104"></a>
<ol><li>In the Unidesk_OS_Machine_Tools folder, run the Unidesk setup_x86.exe (32-bit) or setup_x64.exe (64-bit).</li><li><p>The installation prompts for the location of the unattend.xml file (the default location is c:\windows\panther).</p></li></ol>
Once this is done, you are ready to [create a Unidesk Operating System Layer](#Create_an_OS_Layer_(vSphere))[.](#Create_an_OS_Layer_(vSphere))
##Prepare a Windows 2008 R2 image<a name="Prepare_a_Windows_2008_R2_image_..570"></a><a name="Prepare2_..105"></a>
###STEP 1: Set up a Windows Server 2008 R2 OS Image on a virtual machine<a name="STEP_1:_Set_up_a_Windows_Server_2008_R2_OS_Image_on_a_virtual_machine_..571"></a><a name="STEP1_win2008r2_..106"></a>
In the Prism Console:
<ol><li>Select <strong>Task > VM</strong>, and switch to <strong>Table View</strong> to see the existing VMs.</li><li>Click <strong>+Create VM</strong> in the upper right corner, and enter the specifics about the new VM:<ol><li><p>Enter a <strong>Name</strong> and add a <strong>Description</strong>.</p></li><li><p>Select the number of <strong>VCPUs</strong>.</p></li><li><p>Set the <strong>Cores per CPU</strong>.</p></li><li><p>Set <strong>Memory</strong>.</p></li><li><p>Select <strong>Disks</strong>, and create a VM with three disks. The first CD-ROM is the ISO for the OS, the second CD-ROM is for the Nutanix VIRTIO drivers that allow the Nutanix VM to access the disk where you install the OS. To start, one CD-ROM is assigned.</p><ol><li>Edit the values for the assigned CD-ROM:</li><li>For Operation, select <strong>Clone from ADSF file</strong>.</li></ol><ol><li><p>For Bus Type, select <strong>IDE</strong>.</p></li><li><p>Enter the <em>path</em> to your Windows ISO. The path is the combination of the Storage Container and the ISO Name. For example:</p><p>/ISOStore/en_windows_08_enterprise_version_1511_x64_dvd_7224901.iso</p></li><li>Click <strong>Update</strong>.</li></ol></li><li>Add another disk by clicking the <strong>+Add New Disk</strong> button:</li><ol><li>Set the Type to <strong>CDROM</strong>.</li><li>Set the Operation to <strong>Clone from ADSF file</strong>.</li><li>Set the Bus Type to <strong>IDE</strong></li><li><p>Enter the path to the Windows VIRTIO Drivers. For example:</p><p>/ISOStore/virtio-win-0.1.102.iso</p></li><li>Click <strong>Add</strong>.</li></ol><li>Click the <strong>+Add New Disk</strong> button.</li><ol><li>Set the Type to <strong>Disk</strong>.</li><li>Set the Operation to <em>Allocate on Container.</em></li><li>Set the Bus Type to <strong>SCSI</strong>.</li><li>Select the Container you want to use.</li><li>Enter the <strong>Size</strong></li><li>Click <strong>Add</strong>.</li></ol><li>Click <strong>+Add new Nic</strong>.</li><ol><li>Enter the <strong>VLAN Name</strong>.</li></ol><li><p>Click <strong>Save</strong>.</p></li></ol></li><li><p>Power on the VM:</p><ol><li>Select <strong>Tasks > VM</strong>.</li><li>Switch to the Table View to see existing VMs.</li><li>Select the VM in the Table, and click <strong>Power On</strong>.</li></ol></li><li><p>Launch the Console by selecting the VM and clicking <strong>Launch Console</strong>. When the VM boots it begins to install the Windows OS from the ISO disk. When the VM boots it will <em>begi</em>n to install the Windows OS from the ISO disk.</p><ol><li><p>When asked, "Where do you want to install Windows?" notice that even though you added a disk in the VM creation wizard, there is no disk.</p></li><li><p>Select the Load Driver option, and select Browse.</p></li><li><p>Select the CD with the virtio-win-0.1.1 drivers.</p></li><li><p>Select the vioscsi folder, and choose the folder for your Windows OS.</p></li><li><p>Once the driver is installed, select the hard drive that you added earlier and finish installing the OS.</p></li></ol></li><li><p>After the OS is installed, manually install the VirtIO drivers:</p><ol><li><p>Launch Device Manager.</p></li><li><p>Select <strong>Other Devices</strong>, right-click <strong>Ethernet Controller</strong> and choose <strong>Update Driver Software</strong>.</p></li><li><p>Browse My Computer, and choose the <strong>VirtIO CD</strong>. The ethernet drivers are stored in the <strong>NetKVM</strong> folder.</p></li></ol></li><li><p>Disable Windows System Restore and Windows Automatic Updates. The Unidesk<a href="#Create_an_OS_Layer_(vSphere)"></a> system handles restore points for you, and Unidesk layer versions allow you to control when updates occur.</p></li></ol>
###STEP 2: Copy the Unidesk Tools onto the OS Image<a name="STEP_2:_Copy_the_Unidesk_Tools_onto_the_OS_Image_..572"></a><a name="STEP4_win2008r2_..107"></a>
<ol><li><a href="http://www.unidesk.com/support/downloads">Download</a> the Unidesk_OS_Machine_Tools ZIP file onto the OS Image.</li><li>Extract the Unidesk_OS_Machine_Tools_<em>x.x.x</em> to c:\windows\setup\scripts.</li></ol>
###STEP 3: (Optional) Create an answer file for unattended installation on Unidesk desktops<a name="STEP_3:_(Optional)_Create_an_answer_file_for_unattended_installation_on_Unide..._..573"></a><a name="STEP5_win2008r2_..108"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, right-click the unattend.exe tool and choose <strong>Run as administrator</strong>. The unattend builder form opens.</p></li><li><p>Complete the unattend form.</p><ul><li>Product key activation<ul><li>For KMS activation, select KMS Server.</li><li>For KMS with a Multiple Activation Key (MAK), select KMS with MAK and enter the MAK.</li><li>For Retail Licensing with a MAK, select Retail with MAK, and the MAK.</li></ul></li><li>Domain Join<ul><li>Select Enable if you want to configure the unattend.xml file to join desktops to a specific domain. If you plan to use AD join scripts, ensure Enable is <em>not</em> selected.</li><li><a href="http://www.unidesk.com/support/downloads"></a><a href="http://www.unidesk.com/support/downloads"></a>You can add desktops to the Computer's container in Active Directory by deleting the OU entry. However, we recommend that you use an alternate OU for Unidesk desktops, both to segregate the desktop from other machines and to avoid applying virtual desktop-specific GPOs to other types of machines.</li><li><a href="http://www.unidesk.com/support/downloads"></a> If you are supporting multiple OUs within one or more domains, you can join machines in different Domains or OUs by creating different unattend.xml files in different application layers.</li><li><p><a href="http://www.unidesk.com/support/downloads"></a>For information about domain join scripts, see the following Support articles:</p><p><a href="troubleshoot_domain_join.htm">Debugging Domain Join Problems in Windows 7 and Windows Server 2008 R2</a></p></li></ul></li><li>Local Administrator account<ul><li><a href="troubleshoot_domain_join.htm"></a>If you want to use the unattend.xml file to enable the Administrator account on each Unidesk desktop, select Enable. Remember to also enable this account in your OS Image or Operating System Layer revision. It is possible to enable the Administrator account for your OS Image and then have it disabled in the deployed desktops by clearing the check box.</li><li>If you want to add an alternate Administrator account, select Enable and enter the account information. This account cannot be pre-configured in the OS Image.</li><li>You can create a desktop where the Administrator is disabled and the alternate administrator is created and enabled. However for this to work, the Administrator account must be enabled in the OS Image and it cannot be renamed.</li></ul></li><li>Time zone<ul><li><a href="troubleshoot_domain_join.htm"></a>Select the time zone. If your time zone is not listed, you can add it to the Other box. Be sure to use the time zone, <em>not</em> the display setting. A list of time zone settings can be found <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx">here</a>.</li></ul></li><li>Disabling automatic activation<ul><li>Select this option if you plan to use the Microsoft Volume Activation Management Tool.</li></ul></li></ul></li><li><p>Click <strong>Save File</strong>.</p></li></ol>
###STEP 4: (Optional) Optimize the OS Image for the Unidesk environment<a name="STEP_4:_(Optional)_Optimize_the_OS_Image_for_the_Unidesk_environment_..574"></a><a name="STEP7_win2008r2_..109"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, run the Optimize executable to create a .cmd file (optimize.cmd) that will be run to optimize the image during desktop creation.</p></li><li><p>Follow the instructions to run the optimize.cmd file on the OS Image. This removes installation-specific drivers and settings.</p><p>If you are using the Unidesk Optimizer script and you are enabling the View Persona feature, you must go to the section of the Optimizer script called <strong>Disable Unnecessary Services to Save Memory and CPU</strong>, <em>deselect</em> the option to <strong>Disable Offline File Service</strong>, and click <strong>Save File</strong>. This is because View Persona folder redirection requires Offline files to be enabled, and by default, the Unidesk Optimizer turns off Offline files, which are not a requirement for Unidesk.</p></li></ol>
###STEP 5: Create a snapshot of the OS Image<a name="STEP_5:_Create_a_snapshot_of_the_OS_Image_..575"></a><a name="STEP3_win2008r2_..110"></a>
Once the OS Image is ready, create a VMware snapshot of it so you can return to this state at any time.
Important: It is critical to create a snapshot before installing the Unidesk software onto the OS Image. Without this snapshot, returning to this state requires rebuilding the image.
###STEP 6: Install the Unidesk tools onto the OS Image<a name="STEP_6:_Install_the_Unidesk_tools_onto_the_OS_Image_..576"></a><a name="STEP6_win2008r2_..111"></a>
<ol><li>In the Unidesk_OS_Machine_Tools folder, run the Unidesk setup_x86.exe (32-bit) or setup_x64.exe (64-bit).</li><li><p><a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> The installation prompts for the location of the unattend.xml file (the default location is c:\windows\panther).</p></li></ol>
Once this is done, you are ready to [create a Unidesk Operating System Layer](deploy_os_layer_create_first.htm)[.](deploy_os_layer_create_first.htm)
##Prepare a Windows 10 image<a name="Prepare_a_Windows_10_image_..577"></a><a name="Prepare3_..112"></a>
When preparing the OS Image for import into a Unidesk Operating System Layer, you can speed up start times by [removing Windows 10 built-in applications](http://www.howtogeek.com/224798/how-to-uninstall-windows-10s-built-in-apps-and-how-to-reinstall-them/)[. If you do, we recommend removing these applications either on the OS Image itself, or on the Operating System Layer.](http://www.howtogeek.com/224798/how-to-uninstall-windows-10s-built-in-apps-and-how-to-reinstall-them/)
###STEP 1: Set up a Windows 10 image on a virtual machine<a name="STEP_1:_Set_up_a_Windows_10_image_on_a_virtual_machine_..578"></a><a name="STEP1_8.1_..113"></a>
In the Prism console:
<ol><li><p><a href="http://www.howtogeek.com/224798/how-to-uninstall-windows-10s-built-in-apps-and-how-to-reinstall-them/"></a> Create a VM for your OS image.</p><p><strong>Important:</strong> When creating the image, be sure to choose the default cluster allocation size of 4K.</p></li><li><p><a href="http://www.howtogeek.com/224798/how-to-uninstall-windows-10s-built-in-apps-and-how-to-reinstall-them/"></a> Configure the virtual machine hardware settings, for example, the NIC and video memory.</p></li><li><p>Disable Windows System Restore and Windows Automatic Updates:</p><ol><li><p>Log into the VM.</p></li><li>Select <strong>Computer Config > Administrative Templates > Windows Components > Windows Updates > Config Auto Updates</strong>.</li><li>Set this to <strong>Disabled</strong>.</li></ol><p>The Unidesk<a href="http://www.howtogeek.com/224798/how-to-uninstall-windows-10s-built-in-apps-and-how-to-reinstall-them/"></a> system handles restore points for you, and Unidesk layer versions allow you to control when updates occur.</p></li><li><p>If using KMS licensing, run a command window as Administrator, and enter these commands:</p><pre>slmgr /skms <kmsserverhost>slmgr /rearmrebootslmgr /ipk XXXX-YOUR-KMS-KEY-XXXXslmgr /ato</pre></li><li>Install the VMware Tools on the OS image.</li></ol>
###STEP 2: Copy the Unidesk Tools onto the OS Image<a name="STEP_2:_Copy_the_Unidesk_Tools_onto_the_OS_Image_..579"></a><a name="STEP3_8.1_..114"></a>
<ol><li><a href="http://www.unidesk.com/support/downloads">Download</a> the Unidesk_OS_Machine_Tools ZIP file onto the OS Image.</li><li>Extract the Unidesk_OS_Machine_Tools_<em>x.x.x</em> to c:\windows\setup\scripts.</li></ol>
###STEP 3: (Optional) Create an answer file for unattended installation on Unidesk Desktops<a name="STEP_3:_(Optional)_Create_an_answer_file_for_unattended_installation_on_Unide..._..580"></a><a name="STEP5_8.1_..115"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, right-click the unattend.exe tool and choose <strong>Run as administrator</strong>. The unattend builder form opens.</p></li><li><p>Complete the unattend form.</p>Product key activation<p>For KMS activation, select KMS Server.</p><p>For KMS with a Multiple Activation Key (MAK), select KMS with MAK and enter the MAK.</p><p>For Retail Licensing with a MAK, select Retail with MAK, and the MAK.</p>Domain Join<p>Select Enable if you want to configure the unattend.xml file to join Desktops to a specific domain. If you plan to use AD join scripts, ensure Enable is <em>not</em> selected.</p><p>You can add Desktops to the Computer's container in Active Directory by deleting the OU entry. However, we recommend that you use an alternate OU for Unidesk Desktops, both to segregate the Desktop from other machines and to avoid applying virtual Desktop-specific GPOs to other types of machines.</p><p>If you are supporting multiple OUs within one or more domains, you can join machines in different Domains or OUs by creating different unattend.xml files in different application layers.</p>Local Administrator account<p>You can enable the Administrator account on each Unidesk Desktop by selecting Enable. Remember to also enable this account in your OS Image or Operating System Layer version. You can also enable the Administrator account for your OS Image and then have it disabled in the deployed Desktops by clearing the check box.</p><p>If you want to add an alternate Administrator account, select Enable and enter the account information. This account <em>cannot</em> be preconfigured in the OS Image.</p><p>You can create a Desktop where the Administrator is disabled and the alternate administrator is created and enabled. However for this to work, the Administrator account must be enabled in the OS Image and it cannot be renamed.</p>Time Zone<p>If your time zone is not listed, you can add it to the <strong>Other</strong> box. Be sure to use the <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx">time zone</a>, <em>not</em> the display setting.</p>Disabling automatic activation<p>Select this option if you plan to use the Microsoft Volume Activation Management Tool.</p></li><li><p>Click <strong>Save File</strong>.</p></li></ol>
###STEP 4: (Optional) Optimize the OS Image for the Unidesk environment<a name="STEP_4:_(Optional)_Optimize_the_OS_Image_for_the_Unidesk_environment_..581"></a><a name="STEP6_8.1_..116"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, right-click the optimizations.exe tool and choose <strong>Run as administrator</strong>. This creates a .cmd file (optimizations.cmd) that will be run during Desktop creation to optimize the image.</p></li><li><p>Follow the instructions to run the optimizations.cmd file on the OS Image. This removes installation-specific drivers and settings.</p><p>If you are using the Unidesk Optimizer script and you are enabling the View Persona feature, you must go to the section of the Optimizer script called <strong>Disable Unnecessary Services to Save Memory and CPU</strong>, <em>deselect</em> the option to <strong>Disable Offline File Service</strong>, and click <strong>Save File</strong>. This is because View Persona folder redirection requires Offline files to be enabled, and by default, the Unidesk Optimizer turns off Offline files, which are not a requirement for Unidesk.</p></li></ol>
###STEP 5: Install .Net Framework 3.5.1<a name="STEP_5:_Install_.Net_Framework_3.5.1_..582"></a><a name="STEP2_8.1_..117"></a>
The .Net Framework is a software framework provided by Microsoft that is required for many 3rd party applications to run. To install this feature, follow the steps below.
<ol><li><p>On the Start menu, select <strong>Control Panel > Programs and Features</strong>.</p></li><li><p>In the left panel select <strong>Turn Windows features on or off.</strong> A window opens.</p></li><li><p>Select <strong>.NET Framework 3.5</strong>, click <strong>OK</strong>, and wait for the installation to complete.</p><p><strong>Important:</strong> Even if .NET is already installed, continue with the rest of these steps.</p></li><li><p>Exit the Control Panel.</p></li><li><p>In Notifications in the right-side of your taskbar, click <strong>All Settings</strong>, and open the Windows 10 Settings app.</p></li><li><p>Select Settings > Update ; Security.</p></li><li><p>Check for updates, and install all updates available.</p></li><li><p>Exit Settings.</p></li><li><p>Open an administrator-level command prompt, and enter the following commands:</p><pre>cd \windows\Microsoft.Net\Framework\v4.nnnnnngen update /force</pre></li><li><p>Wait for the command to complete, and enter the following commands:</p><pre>cd \windows\Microsoft.Net\Framework64\v4.nnnnnngen update /force</pre></li><li>Exit the command prompt.</li></ol>
###STEP 6: If using PVS, follow these steps to avoid ghost NICs.<a name="STEP_6:_If_using_PVS,_follow_these_steps_to_avoid_ghost_NICs._..583"></a><a name="Step6_..118"></a>
<ol><li><p>Enter the commands:</p><pre>set devmgr_show_nonpresent_devices=devmgmt.msc</pre></li><li><p>Remove any ghost NICs.</p></li><li><p>Reboot the system.</p></li></ol>
###STEP 7: Create a backup copy of the OS Image<a name="STEP_7:_Create_a_backup_copy_of_the_OS_Image_..584"></a><a name="STEP7_..119"></a>
Once the OS Image is ready, create a copy of it so you can return to this state at any time.
Important: It is critical to create a backup copy before installing the Unidesk software onto the OS Image. Without this backup copy, returning to this state requires rebuilding the image.
###STEP 8: Install the Unidesk software onto the OS Image<a name="STEP_8:_Install_the_Unidesk_software_onto_the_OS_Image_..585"></a><a name="STEP8_..120"></a>
<ol><li>Run setup_x64.exe from c:\Windows\setup\scripts.</li></ol>
Once this is done, you are ready to create a Unidesk Operating System Layer.
##Prepare a Windows 7 image<a name="Prepare_a_Windows_7_image_..586"></a><a name="Prepare_..121"></a>
###STEP 1: Set up a Windows 7 OS Image on a virtual machine<a name="STEP_1:_Set_up_a_Windows_7_OS_Image_on_a_virtual_machine_..587"></a><a name="STEP1_win7_..122"></a>
In the Prism console:
<ol><li><p><a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> Create a VM for your OS Image.</p><p>Important: When creating the image, be sure to choose the default cluster allocation size of 4K.</p></li><li><p><a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> Configure the virtual machine hardware settings, for example, the NIC and video memory.</p></li><li><p>Disable Windows System Restore and Windows Automatic Updates. The Unidesk<a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> system handles restore points for you, and Unidesk layer versions allow you to control when updates occur.</p></li><li><p>Make sure you have installed VMware Tools on the OS image.</p></li></ol>
###STEP 2: Mount or copy the Unidesk Tools onto the OS Image<a name="STEP_2:_Mount_or_copy_the_Unidesk_Tools_onto_the_OS_Image_..588"></a><a name="STEP3_win7_..123"></a>
<ol><li><a href="http://www.unidesk.com/support/downloads">Download</a> the Unidesk_OS_Machine_Tools ZIP file onto the OS Image.</li><li>Extract the Unidesk_OS_Machine_Tools_<em>x.x.x</em> to c:\windows\setup\scripts.</li></ol>
###STEP 3: (Optional) Create an answer file for unattended installation on Unidesk desktops<a name="STEP_3:_(Optional)_Create_an_answer_file_for_unattended_installation_on_Unide..._..589"></a><a name="STEP4_win7_..124"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, right-click the unattend.exe tool and choose <strong>Run as administrator</strong>. The unattend builder form opens.</p></li><li><p>Complete the unattend form.</p><ul><li>Product key activation<ul><li>For KMS activation, select KMS Server.</li><li>For KMS with a Multiple Activation Key (MAK), select KMS with MAK and enter the MAK.</li><li>For Retail Licensing with a MAK, select Retail with MAK, and the MAK.</li></ul></li><li>Domain Join<ul><li>Select Enable if you want to configure the unattend.xml file to join desktops to a specific domain. If you plan to use AD join scripts, ensure Enable is <em>not</em> selected.</li><li><a href="http://www.unidesk.com/support/downloads"></a><a href="http://www.unidesk.com/support/downloads"></a>You can add desktops to the Computer's container in Active Directory by deleting the OU entry. However, we recommend that you use an alternate OU for Unidesk desktops, both to segregate the desktop from other machines and to avoid applying virtual desktop-specific GPOs to other types of machines.</li><li><a href="http://www.unidesk.com/support/downloads"></a> If you are supporting multiple OUs within one or more domains, you can join machines in different Domains or OUs by creating different unattend.xml files in different application layers.</li><li><p><a href="http://www.unidesk.com/support/downloads"></a>For information about domain join scripts,see the following Support articles:</p><p><a href="troubleshoot_domain_join.htm">Debugging Domain Join Problems in Windows 7 and Windows 2008 R2</a></p><p><a href="http://www.unidesk.com/support/kb/using-powershell-advanced-domain-join-operations">Using PowerShell for Advanced Domain Join Operations</a></p></li></ul></li><li>Local Administrator account<ul><li><a href="http://www.unidesk.com/support/kb/using-powershell-advanced-domain-join-operations"></a>If you want to use the unattend.xml file to enable the Administrator account on each Unidesk desktop, select Enable. Remember to also enable this account in your OS Image or Operating System Layer revision. It is possible to enable the Administrator account for your OS Image and then have it disabled in the deployed desktops by clearing the check box.</li><li>If you want to add an alternate Administrator account, select Enable and enter the account information. This account cannot be pre-configured in the OS Image.</li><li>You can create a desktop where the Administrator is disabled and the alternate administrator is created and enabled. However for this to work, the Administrator account must be enabled in the OS Image and it cannot be renamed.</li></ul></li><li>Time zone<ul><li><a href="http://www.unidesk.com/support/kb/using-powershell-advanced-domain-join-operations"></a>Select the time zone. If your time zone is not listed, you can add it to the Other box. Be sure to use the time zone, <em>not</em> the display setting. A list of time zone settings can be found <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx">here</a>.</li></ul></li><li>Disabling automatic activation<ul><li>Select this option if you plan to use the Microsoft Volume Activation Management Tool.</li></ul></li></ul></li><li><p>Click <strong>Save File</strong>.</p></li></ol>
###STEP 4: (Optional) Optimize the OS Image for the Unidesk environment<a name="STEP_4:_(Optional)_Optimize_the_OS_Image_for_the_Unidesk_environment_..590"></a><a name="STEP6_win7_..125"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, run the Optimize executable to create a .cmd file (optimize.cmd) that will be run to optimize the image during desktop creation.</p></li><li><p>Follow the instructions to run the optimize.cmd file on the OS Image. This removes installation-specific drivers and settings.</p><p>If you are using the Unidesk Optimizer script and you are enabling the View Persona feature, you must go to the section of the Optimizer script called <strong>Disable Unnecessary Services to Save Memory and CPU</strong>, <em>deselect</em> the option to <strong>Disable Offline File Service</strong>, and click <strong>Save File</strong>. This is because View Persona folder redirection requires Offline files to be enabled, and by default, the Unidesk Optimizer turns off Offline files, which are not a requirement for Unidesk.</p></li></ol>
###STEP 5: If using PVS, follow these steps to avoid ghost NICs<a name="STEP_5:_If_using_PVS,_follow_these_steps_to_avoid_ghost_NICs_..591"></a>
<ol><li>Install KB2550978 hotfix.</li><li>Reboot the VM,</li><li><p>Enter the commands:</p><pre>set devmgr_show_nonpresent_devices=1devmgmt.msc</pre></li><li>Remove any ghost NICs.</li><li>Reboot the system.</li></ol>
###STEP 6: Create a snapshot of the OS Image<a name="STEP_6:_Create_a_snapshot_of_the_OS_Image"></a><a name="STEP2_win7_..126"></a>
<ol><li><p>Create a snapshot of the OS image so you can return to this state at any time.</p><p><span>Important:</span> It is critical to create a snapshot before installing the Unidesk software onto the OS Image. Without this snapshot, returning to this state requires rebuilding the image.</p></li></ol>
###STEP 7: Install the Unidesk software onto the OS Image<a name="STEP_7:_Install_the_Unidesk_software_onto_the_OS_Image_..592"></a><a name="STEP5_win7_..127"></a>
<ol><li>In the Unidesk_OS_Machine_Tools folder, run the Unidesk setup_x86.exe (32-bit) or setup_x64.exe (64-bit).</li><li><p><a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> The installation prompts for the location of the unattend.xml file (the default location is c:\windows\panther).</p></li></ol>
Once this is done, you are ready to [create a Unidesk Operating System Layer](deploy_os_layer_create_first.htm)[.](deploy_os_layer_create_first.htm)

# Prepare the OS Image (XenServer)<a name="Prepare_the_OS(SPACE)Image_(XenServer)"></a>
This topic explains how to prepare an OS Image for the Unidesk environment, using the ***OS Machine Tools***  available for download on the Unidesk [Download](http://www.unidesk.com/support/downloads)[ page.](http://www.unidesk.com/support/downloads)
Notes:
<ul><li>The OS Image should <em>not</em> be in a domain.</li><li>The OS Image should get its IP address from DHCP.</li><li>Using Third-party optimization scripts can have adverse effects in Unidesk, as they can change services and features that Unidesk uses, for example, Universal Plug and Play and the 8.3 file names setting. Use the optimization tools in the Unidesk Installer download to optimize your image.</li><li>Ensure that the VM for your OS Layer is MBR partitioned, rather than GPT partitioned. Otherwise, you will not be able to install the Unidesk OS Machine Tools.</li><li>XenCenter uses Port 5900 to access the console on each VM. Make sure that this port is open on your OS image. Otherwise, the packaging machines or publish images the console will not work until you reboot the VM.</li></ul>
## Which operating system are you using?<a name="Which_operating_system_are_you_using__..593"></a>
Choose the operating system you are using for the OS Image:
<ul><li><a href="#Prepare_win2012_..128">Windows Server 2012 R2 (Session Host)</a></li><li><a href="#Prepare2_..135">Windows Server 2008 R2 </a></li><li><a href="#Prepare3_..142">Windows 10</a></li><li><a href="#Prepare_..151">Windows 7 </a></li></ul>
##Prepare a Windows Server 2012 R2 image (Session Host)<a name="Prepare_a_Windows_Server_2012_R2_image_(Session_Host)_..594"></a><a name="Prepare_win2012_..128"></a>
###STEP 1: Set up a Windows Server 2012 R2 OS Image on a virtual machine<a name="STEP_1:_Set_up_a_Windows_Server_2012_R2_OS_Image_on_a_virtual_machine_..595"></a><a name="STEP1_win2012r2_..129"></a>
In the XenServer client:
<ol><li><a href="#Prepare_..151"></a> Create a VM for the OS image.</li><li><p><a href="#Prepare_..151"></a> Configure the virtual machine hardware settings, for example, the NIC and video memory.</p></li><li>Configure a virtual hard disk that is large enough for a Windows operating system installation, and make sure it is accessible by the Unidesk Management Appliance.</li><li>Install Windows Server 2012 R2.</li><li>Disable Windows System Restore and Windows Automatic Updates. The Unidesk<a href="#Prepare_..151"></a> system handles restore points for you, and Unidesk layer versions allow you to control when updates occur.</li><li>Install XenServer Tools on your OS image.</li></ol>
###STEP 2: Copy the Unidesk OS Machine Tools onto the OS Image<a name="STEP_2:_Copy_the_Unidesk_OS(SPACE)Machine_Tools_onto_the_OS_Image_..596"></a><a name="STEP4_win2012r2_..130"></a>
<ol><li><a href="http://www.unidesk.com/support/downloads">Download</a> the Unidesk_OS_Machine_Tools ZIP file onto the OS Image.</li><li>Extract the Unidesk_OS_Machine_Tools_<em>x.x.x</em> to c:\windows\setup\scripts.</li></ol>
###STEP 3: (Optional) Create an answer file for unattended installation on Unidesk desktops<a name="STEP_3:_(Optional)_Create_an_answer_file_for_unattended_installation_on_Unide..._..597"></a><a name="STEP5_win2012r2_..131"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, right-click the unattend.exe tool and choose <strong>Run as administrator</strong>. The unattend builder form opens.</p></li><li><p>Complete the unattend form.</p><ul><li>Product key activation<ul><li>For KMS activation, select KMS Server.</li><li>For KMS with a Multiple Activation Key (MAK), select KMS with MAK and enter the MAK.</li><li>For Retail Licensing with a MAK, select Retail with MAK, and the MAK.</li></ul></li><li>Domain Join<ul><li>Select Enable if you want to configure the unattend.xml file to join desktops to a specific domain. If you plan to use AD join scripts, ensure Enable is <em>not</em> selected.</li><li><a href="http://www.unidesk.com/support/downloads"></a><a href="http://www.unidesk.com/support/downloads"></a>You can add desktops to the Computer's container in Active Directory by deleting the OU entry. However, we recommend that you use an alternate OU for Unidesk desktops, both to segregate the desktop from other machines and to avoid applying virtual desktop-specific GPOs to other types of machines.</li><li><a href="http://www.unidesk.com/support/downloads"></a> If you are supporting multiple OUs within one or more domains, you can join machines in different Domains or OUs by creating different unattend.xml files in different application layers.</li></ul></li><li>Local Administrator account<ul><li><a href="http://www.unidesk.com/support/downloads"></a>If you want to use the unattend.xml file to enable the Administrator account on each Unidesk desktop, select <strong>Enable</strong>. Remember to also enable this account in your OS Image or Operating System Layer revision. It is possible to enable the Administrator account for your OS Image and then have it disabled in the deployed desktops by clearing the check box.</li><li>If you want to add an alternate Administrator account, select Enable and enter the account information. This account cannot be pre-configured in the OS Image.</li><li>You can create a desktop where the Administrator is disabled and the alternate administrator is created and enabled. However for this to work, the Administrator account must be enabled in the OS Image and it cannot be renamed.</li></ul></li><li>Time zone<ul><li><a href="http://www.unidesk.com/support/downloads"></a>Select the time zone. If your time zone is not listed, you can add it to the Other box. Be sure to use the time zone, <em>not</em> the display setting. A list of time zone settings can be found <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx">here</a>.</li></ul></li><li>Disabling automatic activation<ul><li>Select this option if you plan to use the Microsoft Volume Activation Management Tool.</li></ul></li></ul></li><li><p>Click <strong>Save File</strong>.</p></li></ol>
###STEP 4: (Optional) Optimize the OS Image for the Unidesk environment<a name="STEP_4:_(Optional)_Optimize_the_OS_Image_for_the_Unidesk_environment_..598"></a><a name="STEP7_win2012r2_..132"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, run the Optimize executable to create a .cmd file (optimization.cmd) that will be run to optimize the image during Desktop creation.</p></li><li><p>Follow the instructions to run the optimize.cmd file on the OS Image. This removes installation-specific drivers and settings.</p><p>If you are using the Unidesk Optimizer script and you are enabling the View Persona feature, you must go to the section of the Optimizer script called <strong>Disable Unnecessary Services to Save Memory and CPU</strong>, <em>deselect</em> the option to <strong>Disable Offline File Service</strong>, and click <strong>Save File</strong>. This is because View Persona folder redirection requires Offline files to be enabled, and by default, the Unidesk Optimizer turns off Offline files, which are not a requirement for Unidesk.</p></li></ol>
###STEP 5: Create a snapshot of the OS Image<a name="STEP_5:_Create_a_snapshot_of_the_OS_Image_..599"></a><a name="STEP3_win2012r2_..133"></a>
Once the OS Image is ready, create a snapshot of it, so that you can return to this state at any time.
Important: It is critical to create a snapshot before installing the Unidesk software onto the OS Image. Without this snapshot, returning to this state requires rebuilding the image.
###STEP 6: Install the Unidesk tools onto the OS Image<a name="STEP_6:_Install_the_Unidesk_tools_onto_the_OS_Image_..600"></a><a name="STEP6_win2012r2_..134"></a>
<ol><li>In the Unidesk_OS_Machine_Tools folder, run the Unidesk setup_x86.exe (32-bit) or setup_x64.exe (64-bit).</li><li><p>The installation prompts for the location of the unattend.xml file (the default location is c:\windows\panther).</p></li></ol>
Once this is done, you are ready to [create a Unidesk Operating System Layer](#Create_an_OS_Layer_(vSphere))[.](#Create_an_OS_Layer_(vSphere))
##Prepare a Windows 2008 R2 image<a name="Prepare_a_Windows_2008_R2_image_..601"></a><a name="Prepare2_..135"></a>
###STEP 1: Set up a Windows Server 2008 R2 OS Image on a virtual machine<a name="STEP_1:_Set_up_a_Windows_Server_2008_R2_OS_Image_on_a_virtual_machine_..602"></a><a name="STEP1_win2008r2_..136"></a>
In the XenServer client:
<ol><li><p><a href="#Create_an_OS_Layer_(vSphere)"></a> Create a VM for your OS image, making sure to choose the default cluster allocation size of 4K.</p></li><li><p><a href="#Create_an_OS_Layer_(vSphere)"></a> Configure the virtual machine hardware settings, for example, the NIC and video memory.</p></li><li><p>If you are using Citrix PVS or VMware Horizon View, install Windows Server 2008 R2 Service Pack 1 (SP1).</p><p><span>Notes:</span> </p><ul><li>When creating the image, be sure to choose the default cluster allocation size of 4K.</li></ul></li><li><p>If using PVS:</p><ol><li><p>Install KB255098 hitfix.</p></li><li><p>Reboot the VM.</p></li><li><p>Enter the commands:</p><pre>set devmgr_show_nonpresent_devices=1devmgmt.msc</pre></li><li><p>Uninstall any dead (guost) NICs.</p></li><li><p>Reboot the system.</p></li></ol></li><li>Disable Windows System Restore and Windows Automatic Updates. The Unidesk<a href="#Create_an_OS_Layer_(vSphere)"></a> system handles restore points for you, and Unidesk layer versions allow you to control when updates occur.</li><li><p>Install XenTools on the OS image.</p></li></ol>
###STEP 2: Copy the Unidesk Tools onto the OS Image<a name="STEP_2:_Copy_the_Unidesk_Tools_onto_the_OS_Image_..603"></a><a name="STEP4_win2008r2_..137"></a>
<ol><li><a href="http://www.unidesk.com/support/downloads">Download</a> the Unidesk_OS_Machine_Tools ZIP file onto the OS Image.</li><li>Extract the Unidesk_OS_Machine_Tools_<em>x.x.x</em> to c:\windows\setup\scripts.</li></ol>
###STEP 3: (Optional) Create an answer file for unattended installation on Unidesk desktops<a name="STEP_3:_(Optional)_Create_an_answer_file_for_unattended_installation_on_Unide..._..604"></a><a name="STEP5_win2008r2_..138"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, right-click the unattend.exe tool and choose <strong>Run as administrator</strong>. The unattend builder form opens.</p></li><li><p>Complete the unattend form.</p><ul><li>Product key activation<ul><li>For KMS activation, select KMS Server.</li><li>For KMS with a Multiple Activation Key (MAK), select KMS with MAK and enter the MAK.</li><li>For Retail Licensing with a MAK, select Retail with MAK, and the MAK.</li></ul></li><li>Domain Join<ul><li>Select Enable if you want to configure the unattend.xml file to join desktops to a specific domain. If you plan to use AD join scripts, ensure Enable is <em>not</em> selected.</li><li><a href="http://www.unidesk.com/support/downloads"></a><a href="http://www.unidesk.com/support/downloads"></a>You can add desktops to the Computer's container in Active Directory by deleting the OU entry. However, we recommend that you use an alternate OU for Unidesk desktops, both to segregate the desktop from other machines and to avoid applying virtual desktop-specific GPOs to other types of machines.</li><li><a href="http://www.unidesk.com/support/downloads"></a> If you are supporting multiple OUs within one or more domains, you can join machines in different Domains or OUs by creating different unattend.xml files in different application layers.</li><li><p><a href="http://www.unidesk.com/support/downloads"></a>For information about domain join scripts, see the following Support articles:</p><p><a href="troubleshoot_domain_join.htm">Debugging Domain Join Problems in Windows 7 and Windows Server 2008 R2</a></p></li></ul></li><li>Local Administrator account<ul><li><a href="troubleshoot_domain_join.htm"></a>If you want to use the unattend.xml file to enable the Administrator account on each Unidesk desktop, select Enable. Remember to also enable this account in your OS Image or Operating System Layer revision. It is possible to enable the Administrator account for your OS Image and then have it disabled in the deployed desktops by clearing the check box.</li><li>If you want to add an alternate Administrator account, select Enable and enter the account information. This account cannot be pre-configured in the OS Image.</li><li>You can create a desktop where the Administrator is disabled and the alternate administrator is created and enabled. However for this to work, the Administrator account must be enabled in the OS Image and it cannot be renamed.</li></ul></li><li>Time zone<ul><li><a href="troubleshoot_domain_join.htm"></a>Select the time zone. If your time zone is not listed, you can add it to the Other box. Be sure to use the time zone, <em>not</em> the display setting. A list of time zone settings can be found <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx">here</a>.</li></ul></li><li>Disabling automatic activation<ul><li>Select this option if you plan to use the Microsoft Volume Activation Management Tool.</li></ul></li></ul></li><li><p>Click <strong>Save File</strong>.</p></li></ol>
###STEP 4: (Optional) Optimize the OS Image for the Unidesk environment<a name="STEP_4:_(Optional)_Optimize_the_OS_Image_for_the_Unidesk_environment_..605"></a><a name="STEP7_win2008r2_..139"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, run the Optimize executable to create a .cmd file (optimize.cmd) that will be run to optimize the image during desktop creation.</p></li><li><p>Follow the instructions to run the optimize.cmd file on the OS Image. This removes installation-specific drivers and settings.</p><p>If you are using the Unidesk Optimizer script and you are enabling the View Persona feature, you must go to the section of the Optimizer script called <strong>Disable Unnecessary Services to Save Memory and CPU</strong>, <em>deselect</em> the option to <strong>Disable Offline File Service</strong>, and click <strong>Save File</strong>. This is because View Persona folder redirection requires Offline files to be enabled, and by default, the Unidesk Optimizer turns off Offline files, which are not a requirement for Unidesk.</p></li></ol>
###STEP 5: Create a snapshot of the OS Image<a name="STEP_5:_Create_a_snapshot_of_the_OS_Image_..606"></a><a name="STEP3_win2008r2_..140"></a>
Once the OS Image is ready, create a VMware snapshot of it so you can return to this state at any time.
Important: It is critical to create a snapshot before installing the Unidesk software onto the OS Image. Without this snapshot, returning to this state requires rebuilding the image.
###STEP 6: Install the Unidesk tools onto the OS Image<a name="STEP_6:_Install_the_Unidesk_tools_onto_the_OS_Image_..607"></a><a name="STEP6_win2008r2_..141"></a>
<ol><li>In the Unidesk_OS_Machine_Tools folder, run the Unidesk setup_x86.exe (32-bit) or setup_x64.exe (64-bit).</li><li><p><a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> The installation prompts for the location of the unattend.xml file (the default location is c:\windows\panther).</p></li></ol>
Once this is done, you are ready to [create a Unidesk Operating System Layer](deploy_os_layer_create_first.htm)[.](deploy_os_layer_create_first.htm)
##Prepare a Windows 10 image<a name="Prepare_a_Windows_10_image_..608"></a><a name="Prepare3_..142"></a>
When preparing the OS Image for import into a Unidesk Operating System Layer, you can speed up start times by [removing Windows 10 built-in applications](http://www.howtogeek.com/224798/how-to-uninstall-windows-10s-built-in-apps-and-how-to-reinstall-them/)[. If you do, we recommend removing these applications either on the OS Image itself, or on the Operating System Layer.](http://www.howtogeek.com/224798/how-to-uninstall-windows-10s-built-in-apps-and-how-to-reinstall-them/)
###STEP 1: Set up a Windows 10 image on a virtual machine<a name="STEP_1:_Set_up_a_Windows_10_image_on_a_virtual_machine_..609"></a><a name="STEP1_8.1_..143"></a>
In the XenServer client:
<ol><li><p><a href="http://www.howtogeek.com/224798/how-to-uninstall-windows-10s-built-in-apps-and-how-to-reinstall-them/"></a> Create a VM for your OS image.</p><p><strong>Important:</strong> When creating the image, be sure to choose the default cluster allocation size of 4K.</p></li><li><p><a href="http://www.howtogeek.com/224798/how-to-uninstall-windows-10s-built-in-apps-and-how-to-reinstall-them/"></a> Configure the virtual machine hardware settings, for example, the NIC and video memory.</p></li><li><p>Disable Windows System Restore and Windows Automatic Updates:</p><ol><li><p>Log into the VM.</p></li><li>Select <strong>Computer Config > Administrative Templates > Windows Components > Windows Updates > Config Auto Updates</strong>.</li><li>Set this to <strong>Disabled</strong>.</li></ol><p>The Unidesk<a href="http://www.howtogeek.com/224798/how-to-uninstall-windows-10s-built-in-apps-and-how-to-reinstall-them/"></a> system handles restore points for you, and Unidesk layer versions allow you to control when updates occur.</p></li><li><p>If using KMS licensing, run a command window as Administrator, and enter these commands:</p><pre>slmgr /skms <kmsserverhost>slmgr /rearmrebootslmgr /ipk XXXX-YOUR-KMS-KEY-XXXXslmgr /ato</pre></li><li>Install the VMware Tools on the OS image.</li></ol>
###STEP 2: Copy the Unidesk Tools onto the OS Image<a name="STEP_2:_Copy_the_Unidesk_Tools_onto_the_OS_Image_..610"></a><a name="STEP3_8.1_..144"></a>
<ol><li><a href="http://www.unidesk.com/support/downloads">Download</a> the Unidesk_OS_Machine_Tools ZIP file onto the OS Image.</li><li>Extract the Unidesk_OS_Machine_Tools_<em>x.x.x</em> to c:\windows\setup\scripts.</li></ol>
###STEP 3: (Optional) Create an answer file for unattended installation on Unidesk Desktops<a name="STEP_3:_(Optional)_Create_an_answer_file_for_unattended_installation_on_Unide..._..611"></a><a name="STEP5_8.1_..145"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, right-click the unattend.exe tool and choose <strong>Run as administrator</strong>. The unattend builder form opens.</p></li><li><p>Complete the unattend form.</p>Product key activation<p>For KMS activation, select KMS Server.</p><p>For KMS with a Multiple Activation Key (MAK), select KMS with MAK and enter the MAK.</p><p>For Retail Licensing with a MAK, select Retail with MAK, and the MAK.</p>Domain Join<p>Select Enable if you want to configure the unattend.xml file to join Desktops to a specific domain. If you plan to use AD join scripts, ensure Enable is <em>not</em> selected.</p><p>You can add Desktops to the Computer's container in Active Directory by deleting the OU entry. However, we recommend that you use an alternate OU for Unidesk Desktops, both to segregate the Desktop from other machines and to avoid applying virtual Desktop-specific GPOs to other types of machines.</p><p>If you are supporting multiple OUs within one or more domains, you can join machines in different Domains or OUs by creating different unattend.xml files in different application layers.</p>Local Administrator account<p>You can enable the Administrator account on each Unidesk Desktop by selecting Enable. Remember to also enable this account in your OS Image or Operating System Layer version. You can also enable the Administrator account for your OS Image and then have it disabled in the deployed Desktops by clearing the check box.</p><p>If you want to add an alternate Administrator account, select Enable and enter the account information. This account <em>cannot</em> be preconfigured in the OS Image.</p><p>You can create a Desktop where the Administrator is disabled and the alternate administrator is created and enabled. However for this to work, the Administrator account must be enabled in the OS Image and it cannot be renamed.</p>Time Zone<p>If your time zone is not listed, you can add it to the <strong>Other</strong> box. Be sure to use the <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx">time zone</a>, <em>not</em> the display setting.</p>Disabling automatic activation<p>Select this option if you plan to use the Microsoft Volume Activation Management Tool.</p></li><li><p>Click <strong>Save File</strong>.</p></li></ol>
###STEP 4: (Optional) Optimize the OS Image for the Unidesk environment<a name="STEP_4:_(Optional)_Optimize_the_OS_Image_for_the_Unidesk_environment_..612"></a><a name="STEP6_8.1_..146"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, right-click the optimizations.exe tool and choose <strong>Run as administrator</strong>. This creates a .cmd file (optimizations.cmd) that will be run during Desktop creation to optimize the image.</p></li><li><p>Follow the instructions to run the optimizations.cmd file on the OS Image. This removes installation-specific drivers and settings.</p><p>If you are using the Unidesk Optimizer script and you are enabling the View Persona feature, you must go to the section of the Optimizer script called <strong>Disable Unnecessary Services to Save Memory and CPU</strong>, <em>deselect</em> the option to <strong>Disable Offline File Service</strong>, and click <strong>Save File</strong>. This is because View Persona folder redirection requires Offline files to be enabled, and by default, the Unidesk Optimizer turns off Offline files, which are not a requirement for Unidesk.</p></li></ol>
###STEP 5: Install .Net Framework 3.5.1<a name="STEP_5:_Install_.Net_Framework_3.5.1_..613"></a><a name="STEP2_8.1_..147"></a>
The .Net Framework is a software framework provided by Microsoft that is required for many 3rd party applications to run. To install this feature, follow the steps below.
<ol><li><p>On the Start menu, select <strong>Control Panel > Programs and Features</strong>.</p></li><li><p>In the left panel select <strong>Turn Windows features on or off.</strong> A window opens.</p></li><li><p>Select <strong>.NET Framework 3.5</strong>, click <strong>OK</strong>, and wait for the installation to complete.</p><p><strong>Important:</strong> Even if .NET is already installed, continue with the rest of these steps.</p></li><li><p>Exit the Control Panel.</p></li><li><p>In Notifications in the right-side of your taskbar, click <strong>All Settings</strong>, and open the Windows 10 Settings app.</p></li><li><p>Select Settings > Update ; Security.</p></li><li><p>Check for updates, and install all updates available.</p></li><li><p>Exit Settings.</p></li><li><p>Open an administrator-level command prompt, and enter the following commands:</p><pre>cd \windows\Microsoft.Net\Framework\v4.nnnnnngen update /force</pre></li><li><p>Wait for the command to complete, and enter the following commands:</p><pre>cd \windows\Microsoft.Net\Framework64\v4.nnnnnngen update /force</pre></li><li>Exit the command prompt.</li></ol>
###STEP 6: If using PVS, follow these steps to avoid ghost NICs.<a name="STEP_6:_If_using_PVS,_follow_these_steps_to_avoid_ghost_NICs._..614"></a><a name="Step6_..148"></a>
<ol><li><p>Enter the commands:</p><pre>set devmgr_show_nonpresent_devices=devmgmt.msc</pre></li><li><p>Remove any ghost NICs.</p></li><li><p>Reboot the system.</p></li></ol>
###STEP 7: Create a backup copy of the OS Image<a name="STEP_7:_Create_a_backup_copy_of_the_OS_Image_..615"></a><a name="STEP7_..149"></a>
Once the OS Image is ready, create a copy of it so you can return to this state at any time.
Important: It is critical to create a backup copy before installing the Unidesk software onto the OS Image. Without this backup copy, returning to this state requires rebuilding the image.
###STEP 8: Install the Unidesk software onto the OS Image<a name="STEP_8:_Install_the_Unidesk_software_onto_the_OS_Image_..616"></a><a name="STEP8_..150"></a>
<ol><li>Run setup_x64.exe from c:\Windows\setup\scripts.</li></ol>
Once this is done, you are ready to create a Unidesk Operating System Layer.
##Prepare a Windows 7 image<a name="Prepare_a_Windows_7_image_..617"></a><a name="Prepare_..151"></a>
###STEP 1: Set up a Windows 7 OS Image on a virtual machine<a name="STEP_1:_Set_up_a_Windows_7_OS_Image_on_a_virtual_machine_..618"></a><a name="STEP1_win7_..152"></a>
In the XenServer client:
<ol><li><p><a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> Create a VM for your OS Image.</p><p>Important: When creating the image, be sure to choose the default cluster allocation size of 4K.</p></li><li><p><a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> Configure the virtual machine hardware settings, for example, the NIC and video memory.</p></li><li><p>Disable Windows System Restore and Windows Automatic Updates. The Unidesk<a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> system handles restore points for you, and Unidesk layer versions allow you to control when updates occur.</p></li><li><p>Make sure you have installed VMware Tools on the OS image.</p></li></ol>
###STEP 2: Mount or copy the Unidesk Tools onto the OS Image<a name="STEP_2:_Mount_or_copy_the_Unidesk_Tools_onto_the_OS_Image_..619"></a><a name="STEP3_win7_..153"></a>
<ol><li><a href="http://www.unidesk.com/support/downloads">Download</a> the Unidesk_OS_Machine_Tools ZIP file onto the OS Image.</li><li>Extract the Unidesk_OS_Machine_Tools_<em>x.x.x</em> to c:\windows\setup\scripts.</li></ol>
###STEP 3: (Optional) Create an answer file for unattended installation on Unidesk desktops<a name="STEP_3:_(Optional)_Create_an_answer_file_for_unattended_installation_on_Unide..._..620"></a><a name="STEP4_win7_..154"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, right-click the unattend.exe tool and choose <strong>Run as administrator</strong>. The unattend builder form opens.</p></li><li><p>Complete the unattend form.</p><ul><li>Product key activation<ul><li>For KMS activation, select KMS Server.</li><li>For KMS with a Multiple Activation Key (MAK), select KMS with MAK and enter the MAK.</li><li>For Retail Licensing with a MAK, select Retail with MAK, and the MAK.</li></ul></li><li>Domain Join<ul><li>Select Enable if you want to configure the unattend.xml file to join desktops to a specific domain. If you plan to use AD join scripts, ensure Enable is <em>not</em> selected.</li><li><a href="http://www.unidesk.com/support/downloads"></a><a href="http://www.unidesk.com/support/downloads"></a>You can add desktops to the Computer's container in Active Directory by deleting the OU entry. However, we recommend that you use an alternate OU for Unidesk desktops, both to segregate the desktop from other machines and to avoid applying virtual desktop-specific GPOs to other types of machines.</li><li><a href="http://www.unidesk.com/support/downloads"></a> If you are supporting multiple OUs within one or more domains, you can join machines in different Domains or OUs by creating different unattend.xml files in different application layers.</li><li><p><a href="http://www.unidesk.com/support/downloads"></a>For information about domain join scripts,see the following Support articles:</p><p><a href="troubleshoot_domain_join.htm">Debugging Domain Join Problems in Windows 7 and Windows 2008 R2</a></p><p><a href="http://www.unidesk.com/support/kb/using-powershell-advanced-domain-join-operations">Using PowerShell for Advanced Domain Join Operations</a></p></li></ul></li><li>Local Administrator account<ul><li><a href="http://www.unidesk.com/support/kb/using-powershell-advanced-domain-join-operations"></a>If you want to use the unattend.xml file to enable the Administrator account on each Unidesk desktop, select Enable. Remember to also enable this account in your OS Image or Operating System Layer revision. It is possible to enable the Administrator account for your OS Image and then have it disabled in the deployed desktops by clearing the check box.</li><li>If you want to add an alternate Administrator account, select Enable and enter the account information. This account cannot be pre-configured in the OS Image.</li><li>You can create a desktop where the Administrator is disabled and the alternate administrator is created and enabled. However for this to work, the Administrator account must be enabled in the OS Image and it cannot be renamed.</li></ul></li><li>Time zone<ul><li><a href="http://www.unidesk.com/support/kb/using-powershell-advanced-domain-join-operations"></a>Select the time zone. If your time zone is not listed, you can add it to the Other box. Be sure to use the time zone, <em>not</em> the display setting. A list of time zone settings can be found <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx">here</a>.</li></ul></li><li>Disabling automatic activation<ul><li>Select this option if you plan to use the Microsoft Volume Activation Management Tool.</li></ul></li></ul></li><li><p>Click <strong>Save File</strong>.</p></li></ol>
###STEP 4: (Optional) Optimize the OS Image for the Unidesk environment<a name="STEP_4:_(Optional)_Optimize_the_OS_Image_for_the_Unidesk_environment_..621"></a><a name="STEP6_win7_..155"></a>
<ol><li><p>In the c:\windows\setup\scripts folder, run the Optimize executable to create a .cmd file (optimize.cmd) that will be run to optimize the image during desktop creation.</p></li><li><p>Follow the instructions to run the optimize.cmd file on the OS Image. This removes installation-specific drivers and settings.</p><p>If you are using the Unidesk Optimizer script and you are enabling the View Persona feature, you must go to the section of the Optimizer script called <strong>Disable Unnecessary Services to Save Memory and CPU</strong>, <em>deselect</em> the option to <strong>Disable Offline File Service</strong>, and click <strong>Save File</strong>. This is because View Persona folder redirection requires Offline files to be enabled, and by default, the Unidesk Optimizer turns off Offline files, which are not a requirement for Unidesk.</p></li></ol>
###STEP 5: If using PVS, follow these steps to avoid ghost NICs<a name="STEP_5:_If_using_PVS,_follow_these_steps_to_avoid_ghost_NICs_..622"></a>
<ol><li>Install KB2550978 hotfix.</li><li>Reboot the VM,</li><li><p>Enter the commands:</p><pre>set devmgr_show_nonpresent_devices=1devmgmt.msc</pre></li><li>Remove any ghost NICs.</li><li>Reboot the system.</li></ol>
###STEP 6: Create a snapshot of the OS Image<a name="STEP_6:_Create_a_snapshot_of_the_OS_Image_..623"></a><a name="STEP2_win7_..156"></a>
<ol><li><p>Create a snapshot of the OS image so you can return to this state at any time.</p><p><span>Important:</span> It is critical to create a snapshot before installing the Unidesk software onto the OS Image. Without this snapshot, returning to this state requires rebuilding the image.</p></li></ol>
###STEP 7: Install the Unidesk software onto the OS Image<a name="STEP_7:_Install_the_Unidesk_software_onto_the_OS_Image_..624"></a><a name="STEP5_win7_..157"></a>
<ol><li>In the Unidesk_OS_Machine_Tools folder, run the Unidesk setup_x86.exe (32-bit) or setup_x64.exe (64-bit).</li><li><p><a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> <a href="http://technet.microsoft.com/en-us/library/cc749073(v=ws.10).aspx"></a> The installation prompts for the location of the unattend.xml file (the default location is c:\windows\panther).</p></li></ol>
Once this is done, you are ready to [create a Unidesk Operating System Layer](deploy_os_layer_create_first.htm)[.](deploy_os_layer_create_first.htm)

#Create an OS Layer<a name="Create_an_OS_Layer"></a>
Where are you importing the OS from?



#Create an OS Layer (vSphere)<a name="Create_an_OS_Layer_(vSphere)"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Prepare your OS Image</p><p>Import the OS Image into a new OS Layer</p><p>Reference: Create OS Wizard values</p></td></tr></tbody></table>
The Unidesk Operating System (OS) Layer contains the Windows Operating System that is assigned to any Unidesk Layered Images you create using that OS Layer. Once created, you can use the OS Layer to build as many Layered Images as you want.
The OS Layer includes a virtual machine in your infrastructure running the Unidesk-supported Windows Operating System that you want to use for your Layered Images.
To create an OS Layer, you need to create a virtual machine in vSphere to serve as the OS Machine, download the OS to a network file share, and then import theOS into Unidesk to create the OS Layer.
##Before you start<a name="Before_you_start_..625"></a><a name="Before_..158"></a>
Before you can create an OS Layer, you'll need to:
<ul><li><a href="#Install_the_Unidesk_Enterprise_Layer_Manager_(ELM)_(vSphere)">Deploy the Unidesk ELM</a></li><li><a href="#Set_up_a_network_file_share">Configure a Network File Share</a></li></ul>
##Prepare your OS Image<a name="Prepare_your_OS_Image"></a><a name="Create"></a>
<ol><li>In vSphere, create a Windows Server 2012 R2 VM, specifying a network adaptor of <strong>VMXNet3</strong>.</li><li>Log into the new VM.</li><li>Check to see if the operating system is configured with a VMXNet3 card, and if not, change the setting to VMXNet3. Then restart the system and ensure the new network adapter setting is working.</li><li>Turn off Windows Automatic Updates.</li><li>Download the <strong>Unidesk OS Machine Tools</strong>.</li><li>If you are not going to be publishing to PVS or Azure, you should run the Unattend.exe to build your unattend.xlm file for use in machine creation.</li><li>Double-click the executable to copy the scripts and files to <code>C:\Windows\Setup\scripts</code>.</li><li>Create a snapshot of the VM.</li><li>From the <code>C:\Windows\Setup\scripts</code> folder, run the included Setup_x64.exe file on the VM to install the Unidesk tools.</li><li>Shut down the new VM.</li><li>Log into a system that has access to the ELM's Network File Share.</li><li><p>Open the vCenter console and find VM.</p></li><li>Right-click the VM and select <strong>Template > Export OVF Template</strong>. This preserves any snapshots you may have done.</li><li>In the wizard that opens, select the name of the file that will be created, and the directory in which you would like to store the file and format: "Folder of files (OVF)". Files are downloaded to the Network File Share.</li></ol>
##Import the OS Image into a new OS Layer<a name="Import_the_OS_Image_into_a_new_OS(SPACE)Layer"></a><a name="Import"></a>
<ol><li>In the Unidesk ELM, select <strong>Layers > OS Layers</strong> and click <strong>Create OS Layer</strong> in the Action bar. This opens the Create Operating System Layer Wizard.</li><li>In the Layer Details tab, specify a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. Optionally, you can enter <strong>Descriptions</strong> of the Layer and Version, and change the <strong>Max Layer Size</strong> to accommodate the OS you are going to import. For details, see more about these values <a href="#Referenc">below</a>.</li><li>In the Connector tab, select the file share where you downloaded the vSphere OVF file that you exported in the above procedure.</li><li>In the OS Disk Details tab, click <strong>Browse</strong> to select the OVF file that you downloaded to your file share.</li><li>In the Icon Assignment tab, select an icon image to assign to this Layer.</li><li>In the Confirm and Complete tab, review the details of the OS Layer, enter a comment if required, and click <strong>Create Layer</strong>. If you enter comments, they appear in the Information view Audit History.</li></ol>
When the task completes, the new OS Layer in the Unidesk Management Console displays a "Deployable" status.
Reference: Create OS Wizard values<a name="Reference"></a>
<ul><li><p><em>Version</em> - (Required) This can be the version of the OS Layer or a version you assign to the Layer. This value is displayed in the Details view of the Layer.</p></li><li><em>Version Description</em> - (Optional) Enter a description of the version.</li><li><em>Max Layer Size</em> - (Optional) Maximum layer size in gigabytes. Layers are <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/dn265487(v=vs.85).aspx">thin provisioned</a>, and will grow as needed, up to the maximum size. The default Max Layer Size is 100 gigabytes. If the version you are creating could requires more space, change this to a realistic value.</li><li><em>Select a Connector configuration</em> - (Required) Specify a Unidesk Connector for the platform where you'll be publishing your Layered Images. For example, if you're publishing to vSphere or PVS, select the vSphere or PVS connector with the credentials required to access the account. If the Connector Configuration you need is not listed, add a <strong>New</strong> one and select it from this list. If you want to change the settings of a Connector configuration, select it and click <strong>Edit</strong>.</li><li><em>Packaging Disk Filename</em> - (Required) The name of the Packaging Machine you created in your environment.</li></ul>
#Create an OS Layer (Azure)<a name="Create_an_OS_Layer_(Azure)"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Create an OS Machine in Azure</p><p>Prepare the OS Image (Windows 2012 R2)</p><p>Import the OS Image into a new OS Layer</p></td></tr></tbody></table>
The Unidesk Operating System (OS) Layer contains the Windows Operating System that is assigned to any Unidesk Layered Images you create using that OS Layer. Once created, you can use the OS Layer to build as many Layered Images as you need.
The OS Layer is created using a virtual machine in your infrastructure and the Windows Operating System that you want to use for your Layered Images. You can import the OS from your Azure environment or from the Network File Share attached to the Unidesk ELM.
***Note:***  The OS image ***must***  be created from a Microsoft ISO, rather than an existing template.
##Before you start<a name="Before_you_start_..626"></a><a name="Before_..159"></a>
<ul><li><a href="#Install_the_Unidesk_Enterprise_Layer_Manager_(ELM)_with_local_storage_(Azure)">Deploy ELM from the Microsoft Azure Marketplace</a></li><li><a href="#Set_up_a_network_file_share">Configure a Network File Share</a></li></ul>
##Create an OS Machine in Azure<a name="Create_an_OS_Machine_in_Azure"></a><a name="Create_..160"></a>
To create an OS Layer, you create a virtual machine in Azure, prepare the OS in Azure, and then import the resulting OS Disk into Unidesk to create the OS Layer.
<ol><li><p>In the <a href="https://portal.azure.com/">Microsoft Azure portal</a>, create a new VM from the "Windows Server Remote Desktop Session Host Windows Server 2012 R2" image (<strong>New > Compute > Virtual Machine > From Gallery > Windows Server Remote Desktop Session Host Windows Server 2012 R2</strong>).</p></li><li><p>Choose <strong>Resource Manager</strong> from the <strong>Select a deployment model</strong> option list and click <strong>Create</strong>.</p><p><strong>Note:</strong> Unidesk for Azure does not support the <strong>Classic</strong> option from the <strong>Select a deployment model</strong> option list.</p></li><li><p>Complete the Create virtual machine wizard to create the OS machine.</p><ul><li>The name of the new server machine you specify must comply with Azure naming conventions.</li><li>The User name and Password of the new server machine you specify becomes the User name and Password of any Packaging Machines that are subsequently created containing this OS Layer.</li><li>Be sure that the value for the Resource group location matches the Storage account location that you configured in the Platform Connector Configuration.</li></ul></li></ol>
##Prepare the OS Image (Windows 2012 R2)<a name="Prepare_the_OS_Image_(Windows_2012_R2)"></a><a name="Prepare_..161"></a>
<ol><li><p>After the new server machine has been successfully created, reboot the machine, and log into it remotely.</p></li><li><p>Turn off Windows Automatic Updates (<strong>Control Panel > System and Security > Windows Update > Change Settings</strong>).</p></li><li><p>From the new machine, open a web browser, navigate to the <a href="http://www.unidesk.com/support/unidesk-4-download">Unidesk Download Center</a> and download the Unidesk OS Machine Tools.</p></li><li><p>Rename or delete the "Unattend.wsf" file in the C:\Windows\OEM directory.</p><p><strong>Note:</strong> Do <em>not</em> use the Unattend.exe, as this is <em>not</em> needed and will cause issues with Azure.</p></li><li><p>On the new server machine, run the setup_x64.exe file to install the Unidesk drivers on the OS Machine.</p></li><li><p>Ensure that this machine is <em>not</em> joined to a domain.</p><p><strong>Note:</strong> Session Hosts will join a domain when you provision them from a Layered Image.</p></li><li><p>Optionally, you can shut down the new OS machine.</p><p><strong>Notes:</strong></p><ul><li>Before you can import the OS Disk (as described in the following section), the state of the OS Machine must be either Stopped, Stopped (deallocated), or Running. Unidesk cannot import the OS Disk if the OS machine is in a Starting or Updating state.</li><li>You must perform any pending reboots to the OS machine before importing the OS Disk.</li></ul></li></ol>
##Import the OS Image into a new OS Layer<a name="Import_the_OS_Image_into_a_new_OS(SPACE)Layer_..627"></a><a name="Import_..162"></a>
To import an OS disk into Unidesk:
<ol><li><p>In the Unidesk ELM, select <strong>Layers > OS Layers</strong> and click <strong>Create OS Layer</strong> in the Action bar. This opens the Create Operating System Layer Wizard.</p></li><li><p>In the Layer Details tab, specify a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. Optionally, you can enter <strong>Descriptions</strong> of the Layer and Version, and change the <strong>Max Layer Size</strong> to accommodate the OS you are going to import. For details, see more about these values <a href="#Referenc">below</a>.</p></li><li><p>In the Connector tab, choose a <strong>Connector Configuration</strong> for the platform where you'll be publishing your Layered Images. If the configuration you need is not listed, add a <strong>New</strong> one and select it from this list. For information about creating a new Platform Connector Configuration, see <a href="#Azure_Connector_Configuration">Create a Connector Configuration</a>.</p><p><strong>Note:</strong> Alternatively, if you have a *.vhd file of the OS disk in your Network File Share, you can select the file share instead of a Unidesk Connector.</p></li><li><p>In the Import Disk Details tab, enter the name of the Azure Resource Group that contains the OS disk and the name of the OS disk, both required values.</p><p><strong>Note:</strong> If you specified a file share on the Connector tab, enter the name of the OS disk residing on that file share or click <strong>Browse</strong> to select it.</p></li><li><p>In the Icon Assignment tab, select an icon image to assign to this Layer.</p></li><li><p>In the Confirm and Complete tab, review the details of the OS Layer, enter a comment if required, and click <strong>Create Layer</strong>. If you enter comments, they appear in the Information view Audit History.</p></li></ol>
When the task completes, the new OS Layer in the Unidesk Management Console displays a "Deployable" status.
##Reference: Create Operating System Layer Wizard values<a name="Reference:_Create_Operating_System_Layer_Wizard_values"></a><a name="Referenc"></a>
<ul><li><em>Layer Name</em> - (Required) A name that will let you know what app(s) the layer will be used for, for example, 2012_64_OS. Layer Names can be from 1 to 100 characters in length.</li><li><em>Layer Description</em> - (Optional) Enter a description of the OS Layer.</li><li><p><em>Version</em> - (Required) This can be the version of the OS Layer or a version you assign to the Layer. This value is displayed in the Details view of the OS Layer. It may be useful to include the date in the version name. Version names can be from 1 to 100 characters in length.</p></li><li><em>Version Description</em> - (Optional) Enter a description of the OS version.</li><li><em>Max Layer Size</em> - (Optional) Lets you specify how large the OS is that you are going to import. The default is 30 GB.</li><li><em>Select a Connector Configuration</em> - (Required) Specify a Unidesk Platform Connector for the platform where you'll be publishing your Layered Images. For example, if you're publishing to Azure RD Session Host, select the Azure RDSH connector with the credentials required to access the account. If the configuration you need is not listed, add a <strong>New</strong> one and select it from this list. If you want to change the settings of a Platform Connect, select it and click <strong>Edit</strong>.</li><li><em>Resource Group</em> - (Required) The name of the Azure Resource Group containing the OS Import disk.</li><li><em>Virtual Machine Name</em> - (Required) The name of the server machine you created in Azure.</li><li><em>OS Disk</em> - (Required) If you chose a file share in the Connector tab, enter the path to the *.vhd file here or click <strong>Browse</strong> to select it.</li><li><em>Icon Assignment</em> - You can select a default image or browse to select an image of your own. Icon images must have a .jpg or a .png file format.</li></ul>



#Create an OS Layer (Nutanix AHV)<a name="Create_an_OS_Layer_(Nutanix_AHV)"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Import the OS Image into a new OS Layer</p></td></tr></tbody></table>
The Unidesk Operating System (OS) Layer contains the Windows Operating System that is assigned to any Unidesk Layered Images you create using that OS Layer. Once created, you can use the OS Layer to build as many Layered Images as you want.
The OS Layer includes a virtual machine in your infrastructure running the [supported](#Session)[ Windows OS that you use for your Layered Images.](#Session)
To create an OS Layer, you create a virtual machine in Nutanix AHV to serve as the OS Machine, and import it into the new OS Layer.
##Before you start<a name="Before_you_start_..628"></a><a name="Before_..163"></a>
Assuming you have [installed](#Install_the_Unidesk_Enterprise_Layer_Manager_(ELM)_(Nutanix_AHV))[ and ](#Install_the_Unidesk_Enterprise_Layer_Manager_(ELM)_(Nutanix_AHV))[set up](#Set_up_Unidesk)[ the Unidesk Enterprise Layer Manager (ELM Install the Unidesk Enterprise Layer Manager (ELM) (Nutanix AHV), you'll need to:](#Set_up_Unidesk)
<ul><li><a href="#Prepare_the_OS(SPACE)Image_(Nutanix_AHV)">Prepare</a> a clean OS image.</li></ul>
##Import the OS Image into a new OS Layer<a name="Import_the_OS_Image_into_a_new_OS(SPACE)Layer_..629"></a><a name="Import_..164"></a>
<ol><li>In the Unidesk ELM, select <strong>Layers > OS Layers</strong> and click <strong>Create OS Layer</strong> in the Action bar. This opens the Create Operating System Layer Wizard.</li><li>In the Layer Details tab, specify a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. You can enter <strong>Descriptions</strong> of the Layer and Version, and change the <strong>Max Layer Size</strong> to accommodate the OS you are going to import.</li><li><p>In the Connector tab, choose a Nutanix AHV <strong>Connector Configuration</strong> that specifies where your clean OS is located. If the configuration you need is not listed, add a <strong>New</strong> one and then select it from this list. For information about adding this Connector Configuration, see <a href="#Connector_Configuration_(AND)_Optional_Script__(Nutanix_AHV)">Create a Connector Configuration</a>.</p></li><li>In the OS Disk Details tab, click the <strong>Select Virtual Machine</strong> field. The Virtual Machine field appears.</li><li>Click in the <strong>Virtual Machine</strong> field to reveal a list of all VMs.</li><li>Select a VM from the list, or start by typing the name to filter the list to VMs that contain the search text, and then select the VM.</li><li><p>Click <strong>OK</strong>. The selected VM is validated to ensure that:</p><ul><ul><li>The VM has a single OS disk attached as a SCSI disk. (Attaching the OS disk as IDE is not supported.)</li><li>The OS disk can be downloaded via the storage container where that disk resides. The storage container housing the OS disk:</li><ul><li><p>Does <em>not</em> need to be the same as the configured storage container.</p></li><li><p><em>Must</em> be configured so the ELM is in its white list of clients allowed to perform an NFS mount. If the ELM does <em>not</em> have permissions to mount the VM's storage container, you must correct this through the Nutanix UI.</p></li></ul></ul></ul><p>If there are problems with the VM or OS Disk, an error is displayed. Otherwise, you are returned to the wizard where the VM's name, and the size of the OS disk are listed.</p></li><li>In the Icon Assignment tab, select an icon image to assign to this Layer.</li><li>In the Confirm and Complete tab, review the details of the OS Layer, enter a comment if required, and click <strong>Create Layer</strong>. If you enter comments, they appear in the Information view Audit History.</li></ol>
When the task completes, the new OS Layer in the Unidesk Management Console displays a "Deployable" status.

#Create an OS Layer (XenServer)<a name="Create_an_OS_Layer_(XenServer)"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Prepare your OS Image</p><p>Import the OS Image into a new OS Layer</p></td></tr></tbody></table>
The Unidesk Operating System (OS) Layer contains the Windows Operating System that is assigned to any Unidesk Layered Images you create using that OS Layer. Once created, you can use the OS Layer to build as many Layered Images as you want.
The OS Layer includes a virtual machine in your infrastructure running the Unidesk-supported Windows Operating System that you want to use for your Layered Images.
To create an OS Layer, you create a virtual machine in XenServer to serve as the OS Machine, then export the OS to the ELM's network file share, and import the OS into Unidesk to create the OS Layer.
##Before you start<a name="Before_you_start_..630"></a><a name="Before_..165"></a>
Before you can create an OS Layer, you'll need to:
<ul><li><a href="#Install_the_Unidesk_Enterprise_Layer_Manager_(ELM)_(vSphere)">Deploy the Unidesk ELM</a></li><li><a href="#Set_up_a_network_file_share">Configure a Network File Share for the ELM</a></li></ul>
##Prepare your OS Image<a name="Prepare_your_OS_Image_..631"></a><a name="Create_..166"></a>
<ol><li>In XenServer, create a Windows Server 2012 R2 VM, specifying a valid network adaptor.</li><li>Log into the new VM.</li><li>Turn off Windows Automatic Updates.</li><li>Download the <strong>Unidesk OS Machine Tools</strong>.</li><li>If you are not going to be publishing to PVS or Azure, you should run the Unattend.exe to build your unattend.xlm file for use in machine creation.</li><li>Double-click the executable to copy the scripts and files to <code>C:\Windows\Setup\scripts</code>.</li><li>Create a snapshot of the VM.</li><li>From the <code>C:\Windows\Setup\scripts</code> folder, run the included Setup_x64.exe file on the VM to install the Unidesk tools.</li><li>Shut down the new VM.</li><li>Log into a system that has access to the ELM's Network File Share.</li><li>Log into XenCenter and select the Infrastructure view.</li><li>Shut down the VM, then right-click the VM and choose <strong>Export</strong>.</li><li><p>For the Location value, select the ELM's <strong>Network File Share</strong>.</p></li><li><p>For the Format, choose the <strong>OVF/OVA Package</strong>.</p></li><li><p>Complete the wizard, no specific values required for the remaining choices. The Export runs.</p></li><li><p>To see the status of the Export, click the <strong>Notifications</strong> view in the bottom left corner of the XenCenter UI.</p></li><li>In the wizard that opens, select the name of the file that will be created, the directory in which you would like to store the file, and the format <strong>Folder of files (OVF)</strong>. The files are downloaded to the Network File Share.</li></ol>
##Import the OS Image into a new OS Layer<a name="Import_the_OS_Image_into_a_new_OS(SPACE)Layer_..632"></a><a name="Import_..167"></a>
<ol><li>In the Unidesk ELM, select <strong>Layers > OS Layers</strong> and click <strong>Create OS Layer</strong> in the Action bar. This opens the Create Operating System Layer Wizard.</li><li>In the Layer Details tab, specify a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. Optionally, you can enter <strong>Descriptions</strong> of the Layer and Version, and change the <strong>Max Layer Size</strong> to accommodate the OS you are going to import. For details, see more about these values <a href="#Referenc">below</a>.</li><li>In the Connector tab, select the Network File Share where you downloaded the XenServer .VHD files.</li><li>In the OS Disk Details tab, click <strong>Browse</strong> to select the *.VHD file that you downloaded to your file share.</li><li>In the Icon Assignment tab, select an icon image to assign to this Layer.</li><li>In the Confirm and Complete tab, review the details of the OS Layer, enter a comment if required, and click <strong>Create Layer</strong>. If you enter comments, they appear in the Information view Audit History.</li></ol>
When the task completes, the new OS Layer in the Unidesk Management Console displays a "Deployable" status.

#Create an OS Layer (network file share)<a name="Create_an_OS_Layer_(network_file_share)"></a>
In this article:
<table><tbody><tr><td><p><a href="#Create_..168">Create an OS Machine</a></p><p><a href="#Prepare_..169">Prepare the OS</a></p><p><a href="#Import_..170">Import the OS Disk</a></p></td></tr></tbody></table>
The Unidesk Operating System (OS) Layer contains the Windows Operating System that is assigned to any Unidesk Layered Images you create using that OS Layer. Once created, you can use the OS Layer to build as many Layered Images as you want.
The OS Layer includes a virtual machine in your infrastructure running the Unidesk-supported Windows Operating System that you want to use for your Layered Images. You can import the OS from the Network File Share attached to the Unidesk ELM.
##Create an OS Machine<a name="Create_an_OS_Machine"></a><a name="Create_..168"></a>
To create an OS Layer:
<ul><li>Prepare the OS in your hypervisor</li><li>Create a VM in your hypervisor to serve as the OS Machine.</li><li>Import the resulting OS Disk into Unidesk to create the OS Layer.</li></ul>
##Prepare the OS<a name="Prepare_the_OS"></a><a name="Prepare_..169"></a>
To prepare the OS image:
<ol><li><p>After the new server machine has been successfully created, reboot the machine, and log into it remotely.</p></li><li><p>Turn off Windows Automatic Updates (<strong>Control Panel -> System and Security -> Windows Update -> Change Settings</strong>).</p></li><li><p>From the new machine, open a web browser, navigate to the <a href="http://www.unidesk.com/support/download-center">Unidesk Download Center</a> for your platform, and download the Unidesk OS Machine Tools.</p></li><li><p>Rename or delete the "Unattend.wsf" file in the C:\Windows\OEM directory.</p></li><li><p>On the new server machine, run the setup_x64.exe file to install the Unidesk drivers on the OS Machine.</p></li><li><p>Ensure this machine is <em>not</em> joined to a domain.</p><p><strong>Note:</strong> Session Hosts will join a domain when you provision them from a Layered Image.</p></li><li><p>(Optional) Shut down the new OS Machine.</p><p><strong>Notes:</strong></p><ul><li>You must perform any pending reboots to the OS machine before importing the OS Disk.</li></ul></li><li>Copy the OS image to the Network File Share for importing into a new OS Layer.</li></ol>
##Import the OS Image<a name="Import_the_OS_Image"></a><a name="Import_..170"></a>
To import an OS disk into Unidesk:
<ol><li><p>In the Unidesk ELM, select <strong>Layers > OS Layers</strong> and click <strong>Create OS Layer</strong> in the Action bar. This opens the Create Operating System Layer Wizard.</p></li><li><p>In the Layer Details tab, specify a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. Optionally, you can enter <strong>Descriptions</strong> of the Layer and Version, and change the <strong>Max Layer Size</strong> to accommodate the OS you are going to import. For details, see more about these values <a href="#Referenc_..171">below</a>.</p></li><li><p>In the Connector tab, choose <strong>Network File Share. </strong></p></li><li><p>In the Import Disk Details tab, enter the required values. Enter the name of the OS disk residing on the file share, or click <strong>Browse</strong> to select it.</p></li><li><p>In the Icon Assignment tab, select an icon image to assign to this Layer.</p></li><li><p>In the Confirm and Complete tab, review the details of the OS Layer, enter a comment if required, and click <strong>Create Layer</strong>. If you enter comments, they appear in the Information view Audit History.</p></li></ol>
When the task completes, the new OS Layer in the Unidesk Management Console displays a ***Deployable***  status.
##Reference: Create Operating System Layer Wizard values<a name="Reference:_Create_Operating_System_Layer_Wizard_values_..633"></a><a name="Referenc_..171"></a>
<ul><li><em>Layer Name</em> - (Required) A name that will let you know what app(s) the layer will be used for, for example, 2012_64_OS. Layer Names can be from 1 to 100 characters in length.</li><li><em>Layer Description</em> - (Optional) Enter a description of the OS Layer.</li><li><p><em>Version</em> - (Required) This can be the version of the OS Layer or a version you assign to the Layer. This value is displayed in the Details view of the OS Layer. It may be useful to include the date in the version name. Version names can be from 1 to 100 characters in length.</p></li><li><em>Version Description</em> - (Optional) Enter a description of the OS version.</li><li><em>Max Layer Size</em> - (Optional) Lets you specify how large the OS is that you are going to import. The default is 30 GB.</li><li><em>Select a Connector Configuration</em> - (Required) Specify a Unidesk Platform Connector for the platform where you'll be publishing your Layered Images. For example, if you're publishing to Azure RD Session Host, select the Azure RDSH connector with the credentials required to access the account. If the configuration you need is not listed, add a <strong>New</strong> one and select it from this list. If you want to change the settings of a Platform Connect, select it and click <strong>Edit</strong>.</li><li><em>Resource Group</em> - (Required) The name of the Azure Resource Group containing the OS Import disk.</li><li><em>Virtual Machine Name</em> - (Required) The name of the server machine you created in Azure.</li><li><em>OS Disk</em> - (Required) If you chose a file share in the Connector tab, enter the path to the *.vhd file here or click <strong>Browse</strong> to select it.</li><li><em>Icon Assignment</em> - You can select a default image or browse to select an image of your own. Icon images must have a .jpg or a .png file format.</li></ul>

#Add a version to an OS Layer<a name="Add_a_version_to_an_OS_Layer"></a>
Where are you creating this App Layer Version?




#Add a version to an OS Layer (XenServer)<a name="Add_a_version_to_an_OS_Layer_(XenServer)"></a>
In this article:
<table><tbody><tr><td><p><a href="#Before_..172">Before you start </a></p><p><a href="#New">Add a Version to an OS Layer</a></p><p><a href="#Deploy">Deploy a Packaging Machine</a></p><p><a href="#Install">Install your changes</a></p><p><a href="#Verify">Verify the Layer and shut down the Packaging Machine</a></p><p><a href="#Finalize">Finalize the OS Layer</a></p><p><a href="#Create_..175">Reference: Create OS Version Wizard values</a></p></td></tr></tbody></table>
The Unidesk OS Layer contains the Windows Operating System that is assigned to any Unidesk Layered Images you create using that OS Layer. Once created, you can use the OS Layer to build as many Layered Images as you want.
The OS Layer includes a virtual machine in your infrastructure running the Unidesk-supported Windows Operating System that you want to use for your Layered Images.
##Before you start<a name="Before_you_start_..634"></a><a name="Before_..172"></a>
Before you can create an OS Layer version, you'll need to:
<ul><li><a href="#Set_up_a_network_file_share">Configure a fileshare</a></li></ul>
##Add a version of an OS Layer<a name="Add_a_version_of_an_OS_Layer"></a><a name="New"></a>
To add a version of an OS Layer, take the following steps:
<ol><li><p>In the Unidesk Management Console, select <strong>Layers > OS Layers.</strong></p></li><li><p>Select or right-click an OS Layer icon and click <strong>Add Version</strong>. This opens the Create OS Version Wizard.</p></li><li><p>(Required) In the Version Details tab, enter a Version identifier. This can be the application version, or anything you choose.</p></li><li><p>In the Connector tab, select a <strong>Connector configuration</strong> for the platform where you'll be publishing your Layered Images. You can also modify an existing configuration by selecting it and clicking <strong>Edit</strong>. If you have not yet created a Connector Configuration or if the configuration you need is not present, click <strong>New</strong> to create a new <a href="#Connector_Configuration_(AND)_Optional_Script__(Citrix_XenServer)">Connector Configuration</a> and select it from this list.</p></li><li><p>In the Platform Layer tab, select a Platform Layer that contains the tools and hardware settings that you need to install and package the OS when adding a Layer Version. Once created, the new Layer Version can be used in Layered Images published to any platform.</p></li><li><p>In the Packaging Disk tab, enter a <strong>file name</strong> for the Packaging Disk, and select the disk format. This disk will be used for the Packaging Machine (the VM) where you will install the application, as described in the next two sections.</p></li><li><p>Confirm and Complete tab - Verify your settings and click <strong>Create Version</strong>. Unidesk runs the task of creating a new OS version. When the task completes, it shows a status of <em>Action Required</em>. When you double-click the task to expand it, the task contains the following text (refer to the image in the next section): </p><p>"The Packaging Disk has been published. The virtual machine '<...>' can be found in folder '<...>' in datacenter '<...>'. Power on this virtual machine to install your application. When the installation is complete, power off the virtual machine before clicking Finalize on the Action bar."</p></li></ol>
Next, you can deploy a Packaging Machine for this OS Layer version.
##Deploy a Packaging Machine to XenServer<a name="Deploy_a_Packaging_Machine_to_XenServer"></a><a name="Deploy"></a>
The Packaging Machine is a virtual machine where you install any updates or applications you want to include in the OS Layer. It is strongly recommended that you use a unique Packaging Machine for each Layer. The Packaging Machine is a temporary VM that will be deleted once the OS Layer has been finalized.
The Task Description (example shown in the last step above) contains directions to navigate to the location in XenServer where the Packaging Machine for this Layer has been created.
To create your Packaging Machine in XenServer, begin with the expanded Packaging Disk task shown in step 2 below.
<ol><li>Log into your XenServer web client.</li><li><p>Back in the Unidesk Management Console, use the instructions in the expanded Packaging Disk Task (example shown below) to navigate to the Packaging Machine.</p><p><img></img></p><p>The Packaging Machine will be powered on.</p></li></ol>
##Install the OS update<a name="Install_the_OS(SPACE)update"></a><a name="Install"></a>
<ol><li><p>Remote log into the Packaging Machine in XenServer. Be sure to log in with the User account you used to create the OS in XenServer.</p></li><li><p>Install any updates or applications you want to include in the new OS Layer version, such as Windows Updates or anti-virus applications.</p><p>If an application installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</p></li><li><p>Make sure the Packaging Machine is in the state you want it to be for the user:</p><ul><li>If the applications you install require any post-installation setup or application registration, complete those steps now.</li><li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li></ul></li></ol>
Next, you will shut down the Packaging Machine and verify that the Layer is ready to finalize.
##Verify the Layer and shut down the Packaging Machine<a name="Verify_the_Layer_and_shut_down_the_Packaging_Machine"></a><a name="Verify"></a>
Once the application is installed on the Packaging Machine, the next step is to verify that the Layer is ready to be finalized. To be ready for finalization, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the ***Shutdown For Finalize***  tool (icon below), which appears on the Packaging Machine's desktop.

To use the Shutdown For Finalize tool:
<ol><li>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</li><li>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages detailing the layer verification process.</li><li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Layer_Integrity_Check_..173">below</a>.</li><li>Once any pending operations are complete, double-click the <em>Shutdown For Finalize</em> icon again. This shuts down the Packaging Machine.</li></ol>
The Layer is now ready to finalize.
###Layer integrity messages you may see during<a name="Layer_integrity_messages_you_may_see_during"></a><a name="Layer_Integrity_Check_..173"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p>Note: If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
###Expediting a Microsoft NGen operation<a name="Expediting_a_Microsoft_NGen_operation_..635"></a><a name="Complete_MS_NGen_Operations_..174"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>
##Finalize the OS Layer<a name="Finalize_the_OS_Layer"></a><a name="Finalize"></a>
Once the Packaging Machine is created and any apps or updates installed, you'll need to finalize the layer.
***Note:***  When you finalize a new version of an OS Layer, Unidesk deletes the Packaging Machine so as not to incur more costs.
When a layer is ready to finalize:
<ol><li><p>Return to the Unidesk Management Console.</p></li><li><p>In the Layers module, select the Layer.</p></li><li><p>Select <strong>Finalize</strong> in the Action bar.</p></li><li><p>Monitor the Task bar to verify that the action completes successfully and that the layer is deployable.</p></li></ol>
##Reference: Create OS Version Wizard values<a name="Reference:_Create_OS_Version_Wizard_values"></a><a name="Create_..175"></a>
<ul><li><p><em>Version</em> - (Required) This can be the version of the OS Layer or a version you assign to the Layer. This value is displayed in the Details view of the Layer.</p></li><li><em>Version Description</em> - (Optional) Enter a description of the version.</li><li><em>Max Layer Size</em> - (Optional) Maximum layer size in gigabytes. Layers are <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/dn265487(v=vs.85).aspx">thin provisioned</a>, and will grow as needed, up to the maximum size. The default Max Layer Size is 100 gigabytes. If the version you are creating could requires more space, change this to a realistic value.</li><li><em>Select a Platform Connector configuration</em> - (Required) Specify a Unidesk Platform Connector for the platform where you'll be publishing your Layered Images. For example, if you're publishing to Azure RD Session Host, select the Azure RDSH connector with the credentials required to access the account. If the configuration you need is not listed, add a <strong>New</strong> one and select it from this list. If you want to change the settings of a Platform Connector configuration, select it and click <strong>Edit</strong>.</li><li><em>Packaging Disk Filename</em> - (Required) The name of the Packaging Machine you created in Azure.</li></ul>

#Add a version to an OS Layer (Azure)<a name="Add_a_version_to_an_OS_Layer_(Azure)"></a>
In this article:
[Before you start ](#Before_..176)
[Add a Version to an OS Layer](#New_..177)
[Deploy a Packaging Machine](#Deploy_..178)
[Install your changes](#Install_..179)
[Verify the Layer and shut down the Packaging Machine](#Verify_..180)
[Finalize the OS Layer](#Finalize_..184)
[Reference: Create OS Version Wizard values](#Create_..185)
The Unidesk Operating System (OS) Layer contains the Windows Operating System that is assigned to any Unidesk Layered Images you create using that OS Layer. Once created, you can use the OS Layer to build as many Layered Images as you want.
The OS Layer includes a virtual machine in your infrastructure running the Unidesk-supported Windows Operating System that you want to use for your Layered Images.
##Before you start<a name="Before_you_start_..636"></a><a name="Before_..176"></a>
Before you can create an OS Layer version, you'll need to:
<ul><li><a href="#Set_up_a_network_file_share">Configure a fileshare</a></li></ul>
##Add a version of an OS Layer<a name="Add_a_version_of_an_OS_Layer_..637"></a><a name="New_..177"></a>
To add a version of an OS Layer, take the following steps:
<ol><li><p>In the Unidesk UMC, select <strong>Layers > OS Layers.</strong></p></li><li><p>Select or right-click an OS Layer icon and click <strong>Add Version</strong>. This opens the Create OS Version Wizard.</p></li><li><p>(Required) In the Version Details tab, enter a version identifier. This can be the application version, or anything you choose.</p></li><li><p>In the Connector tab, select a <strong>Connector Configuration</strong> for the platform where you'll be publishing your Layered Images. If you have not yet created a Platform Connector configuration or if the configuration you need is not present, click <strong>New</strong> to create a new <a href="#Azure_Connector_Configuration">Connector Configuration</a> and select it from this list.</p></li><li><p>Packaging Disk tab - Specify the file name and format of the packaging disk.</p></li><li><p>Confirm and Complete tab - Verify your settings and click <strong>Create Version</strong>. Unidesk runs the task of creating a new OS version. When the task completes, it shows a status of Action Required and contains the following text:</p><p>"The Packaging Disk has been published to Azure. Click <u>here</u> to create a Packaging Machine and install your app. When the app installation is complete, finish creating the new Layer Version by clicking Finalize on the Action bar."</p></li><li><p>Expand the Tasks bar at the bottom of the UI, and double-click the Packaging Disk task. In the description, either Click here, or copy the link to Azure portal where the Packaging Disk has been published. Click the link in the task to open the Custom deployment window in Azure. Unidesk has pre-populated the fields of the Custom VM window with default values. Log into Azure and create the VM.</p></li><li><p>Log into the new VM and install any apps on it that you want to include in the new version of the OS, such as Windows Updates or anti-virus software.</p><p><img></img></p></li></ol>
Next, you can deploy a Packaging Machine for this OS Layer.
##Deploy a Packaging Machine<a name="Deploy_a_Packaging_Machine"></a><a name="Deploy_..178"></a>
The Packaging Machine is a virtual machine where you install any applications or updates you want to include in this Layer. Typically, we recommend using a unique VM for each Layer.
###Azure environment<a name="Azure_environment"></a>
To deploy your Packaging Machine to Azure:
<ol><li><p>Click the link (shown in red below) in the Unidesk Management Console task to open the Azure portal to the Custom deployment area where you can create the virtual machine that you will use as your Unidesk Packaging Machine.</p><p><strong>Note:</strong> We recommend that you log into the Microsoft Azure account that has the same Subscription before clicking the link or pasting it into a browser.</p><p><img></img></p></li><li><p>Complete the required fields for customizing your Azure parameters.</p><p><img></img></p></li></ol>
***Notes:*** 
<ul><li>Unidesk does not recommend using less than two CPUs for the Packaging Machine. Consequently, the machine size must be at least A2.</li><li>On the Custom deployment panel, ensure that the value for the Resource Group location matches the Storage location you specified earlier.</li></ul>
##Install your changes<a name="Install_your_changes"></a><a name="Install_..179"></a>
This section explains how to install your changes on the Packaging Machine you created in Azure.
To make changes to this version of the OS Layer:
<ol><li><p>Remote log into the Packaging Machine you created in Azure.</p><p><strong>Note:</strong> The User Name and Password to use when you log into the Packaging Machine are the same User Name and Password that were used when the OS Machine was created for the current OS Layer.</p></li><li><p>Install any updates or applications you want to include in the new OS Layer version, such as Windows Updates or anti-virus applications.</p><p>If an application installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</p></li><li><p>Make sure the Packaging Machine is in the state you want it to be for the user:</p><ul><li>If the applications you install require any post-installation setup or application registration, complete those steps now.</li><li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li></ul></li></ol>
Next, shut down the Packaging Machine when you have verified that the Layer is ready to finalize as described in the following section.
##Verify the Layer and shut down the Packaging Machine<a name="Verify_the_Layer_and_shut_down_the_Packaging_Machine_..638"></a><a name="Verify_..180"></a>
Once the application is installed on the Packaging Machine, the next step is to verify that the Layer is ready to be finalized. To be ready for finalization, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the ***Shutdown For Finalize***  tool (icon below), which appears on the Packaging Machine's desktop.

To use the Shutdown For Finalize tool:
<ol><li>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</li><li>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages detailing the layer verification process.</li><li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Layer_Integrity_Check_..181">below</a>.</li><li>Once any pending operations are complete, double-click the <em>Shutdown For Finalize</em> icon again. This shuts down the Packaging Machine.</li></ol>
The Layer is now ready to finalize.
###Layer integrity messages you may see during<a name="Layer_integrity_messages_you_may_see_during_..639"></a><a name="Layer_Integrity_Check_..181"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:<a name="Layer_Integrity_Messages_..182"></a>
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p>Note: If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
###Expediting a Microsoft NGen operation<a name="Expediting_a_Microsoft_NGen_operation_..640"></a><a name="Complete_MS_NGen_Operations_..183"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>
##Finalize the OS Layer<a name="Finalize_the_OS_Layer_..641"></a><a name="Finalize_..184"></a>
Once the Packaging Machine is created and any apps or updates installed, you'll need to finalize the layer.
***Note:***  When you finalize a new version of an OS Layer, Unidesk deletes the Packaging Machine so as not to incur more costs.
When a layer is ready to finalize:
<ol><li><p>Return to the Unidesk Management Console.</p></li><li><p>In the Layers module, select the layer.</p></li><li><p>Select <strong>Finalize</strong> in the Action bar.</p></li><li><p>Monitor the Task bar to verify that the action completes successfully and that the layer is deployable.</p></li></ol>
##Reference: Create OS Version Wizard values<a name="Reference:_Create_OS_Version_Wizard_values_..642"></a><a name="Create_..185"></a>
<ul><li><p><em>Version</em> - (Required) This can be the version of the OS Layer or a version you assign to the Layer. This value is displayed in the Details view of the Layer.</p></li><li><em>Version Description</em> - (Optional) Enter a description of the version.</li><li><em>Max Layer Size</em> - (Optional) Maximum layer size in gigabytes. Layers are <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/dn265487(v=vs.85).aspx">thin provisioned</a>, and will grow as needed, up to the maximum size. The default Max Layer Size is 100 gigabytes. If the version you are creating could requires more space, change this to a realistic value.</li><li><em>Select a Platform Connector configuration</em> - (Required) Specify a Unidesk Platform Connector for the platform where you'll be publishing your Layered Images. For example, if you're publishing to Azure RD Session Host, select the Azure RDSH connector with the credentials required to access the account. If the configuration you need is not listed, add a <strong>New</strong> one and select it from this list. If you want to change the settings of a Platform Connector configuration, select it and click <strong>Edit</strong>.</li><li><em>Packaging Disk Filename</em> - (Required) The name of the Packaging Machine you created in Azure.</li></ul>

#Add a version to an OS Layer (Nutanix AHV)<a name="Add_a_version_to_an_OS_Layer_(Nutanix_AHV)"></a>
In this article:
<table><tbody><tr><td><p><a href="#Before_..186">Before you start </a></p><p><a href="#New_..187">Add a Version to an OS Layer</a></p><p><a href="#Deploy_..188">Deploy a Packaging Machine</a></p><p><a href="#Install_..189">Install your changes</a></p><p><a href="#Verify_..190">Verify the Layer and shut down the Packaging Machine</a></p><p><a href="#Finalize_..193">Finalize the OS Layer</a></p><p><a href="#Create_..194">Reference: Create OS Version Wizard values</a></p></td></tr></tbody></table>
The Unidesk OS Layer contains the Windows Operating System that is assigned to any Unidesk Layered Images you create using that OS Layer. Once created, you can use the OS Layer to build as many Layered Images as you want.
The OS Layer includes a virtual machine in your infrastructure running the Unidesk-supported Windows Operating System that you want to use for your Layered Images.
##Before you start<a name="Before_you_start_..643"></a><a name="Before_..186"></a>
Before you can create an OS Layer version, you'll need to:
<ul><li><a href="#Set_up_a_network_file_share">Configure a fileshare</a></li></ul>
##Add a version of an OS Layer<a name="Add_a_version_of_an_OS_Layer_..644"></a><a name="New_..187"></a>
To add a version of an OS Layer, take the following steps:
<ol><li><p>In the Unidesk Management Console, select <strong>Layers > OS Layers.</strong></p></li><li><p>Select or right-click an OS Layer icon and click <strong>Add Version</strong>. This opens the Create OS Version Wizard.</p></li><li><p>(Required) In the Version Details tab, enter a Version identifier. This can be the application version, or anything you choose.</p></li><li><p>In the Connector tab, select a <strong>Connector configuration</strong> for the platform where you'll be publishing your Layered Images. You can also modify an existing configuration by selecting it and clicking <strong>Edit</strong>. If you have not yet created a Connector Configuration or if the configuration you need is not present, click <strong>New</strong> to create a new <a href="#Connector_Configuration_(AND)_Optional_Script__(Citrix_XenServer)">Connector Configuration</a> and select it from this list.</p><p>Example: If you're using the Nutanix AHV environment to create the Layer, select the <em>Nutanix AHV</em> connector with the credentials and location required to access the Nutanix Storage Container where you want to build the Layer.</p></li><li><p>In the Platform Layer tab, select a Platform Layer that contains the tools and hardware settings that you need to install and package the OS when adding a Layer Version. Once created, the new Layer Version can be used in Layered Images published to any platform.</p></li><li><p>In the Packaging Disk tab, enter a <strong>file name</strong> for the Packaging Disk, and select the disk format. This disk will be used for the Packaging Machine (the VM) where you will install the application, as described in the next two sections.</p></li><li><p>Confirm and Complete tab - Verify your settings and click <strong>Create Version</strong>. Unidesk runs the task of creating a new OS version. When the task completes, it shows a status of <em>Action Required</em>. When you double-click the task to expand it, the task contains the following text (refer to the image in the next section): </p><p>"The Packaging Disk has been published. The virtual machine '<...>' can be found in folder '<...>' in datacenter '<...>'. Power on this virtual machine to install your application. When the installation is complete, power off the virtual machine before clicking Finalize on the Action bar."</p></li></ol>
Next, you can deploy a Packaging Machine for this OS Layer version.
##Access the Packaging Machine in Nutanix AHV<a name="Access_the_Packaging_Machine_in_Nutanix_AHV"></a>
<ol><li>Log into Nutanix Prism.</li><li><p>Back in the Unidesk Management Console (UMC), expand the Tasks bar at the bottom of the UI, and double-click the <em>Create Platform Layer</em> task to see the full Task Description (example below).</p><p><img></img></p></li><li>Use the instructions in the Task Description to navigate to the Packaging Machine in Prism.</li><li>Install the app for your Layer. This may require a reboot as part of the installation. Once complete, you should see that you have access to the tools, as well as all of the <em>data</em> available under the Performance tab for your VM.</li></ol>
##Deploy a Packaging Machine to Nutanix AHV<a name="Deploy_a_Packaging_Machine_to_Nutanix_AHV"></a><a name="Deploy_..188"></a>
The Packaging Machine is a virtual machine where you install any updates or applications you want to include in the OS Layer. It is strongly recommended that you use a unique Packaging Machine for each Layer. The Packaging Machine is a temporary VM that will be deleted once the OS Layer has been finalized.
The Task Description (example shown in the last step above) contains directions to navigate to the Storage Container in Nutanix AHV, where the Packaging Machine for this Layer has been created.
To create your Packaging Machine in Nutanix AHV, begin with the expanded Packaging Disk task shown in step 2 below.
<ol><li><p>Log into Nutanix Prism.</p></li><li><p>Back in the Unidesk Management Console, use the instructions in the expanded Packaging Disk Task (example shown below) to navigate to the Packaging Machine.</p><p><img></img></p><p>The Packaging Machine will be powered on.</p></li><li><p>Use the instructions in the Task Description to navigate to the Packaging Machine in Prism.</p></li></ol>
##Install the OS update<a name="Install_the_OS(SPACE)update_..645"></a><a name="Install_..189"></a>
<ol><li><p>Remote log into the Packaging Machine in Nutanix AHV. Be sure to log in with the User account you used to create the OS in Nutanix AHV.</p></li><li><p>Install any updates or applications you want to include in the new OS Layer version, such as Windows Updates or anti-virus applications.</p><p>If an application installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</p></li><li><p>Make sure the Packaging Machine is in the state in which you want it to be in for the user.</p></li></ol>
Next, you will shut down the Packaging Machine and verify that the Layer is ready to finalize.
##Verify the Layer and shut down the Packaging Machine<a name="Verify_the_Layer_and_shut_down_the_Packaging_Machine_..646"></a><a name="Verify_..190"></a>
Once the application is installed on the Packaging Machine, the next step is to verify that the Layer is ready to be finalized. To be ready for finalization, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the ***Shutdown For Finalize***  tool (icon below), which appears on the Packaging Machine's desktop.

To use the Shutdown For Finalize tool:
<ol><li>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</li><li>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages detailing the layer verification process.</li><li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Layer_Integrity_Check_..191">below</a>.</li><li>Once any pending operations are complete, double-click the <em>Shutdown For Finalize</em> icon again. This shuts down the Packaging Machine.</li></ol>
The Layer is now ready to finalize.
###Layer integrity messages you may see during<a name="Layer_integrity_messages_you_may_see_during_..647"></a><a name="Layer_Integrity_Check_..191"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p>Note: If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
###Expediting a Microsoft NGen operation<a name="Expediting_a_Microsoft_NGen_operation_..648"></a><a name="Complete_MS_NGen_Operations_..192"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>
##Finalize the OS Layer<a name="Finalize_the_OS_Layer_..649"></a><a name="Finalize_..193"></a>
Once the Packaging Machine is created and any apps or updates installed, you'll need to finalize the layer.
***Note:***  When you finalize a new version of an OS Layer, Unidesk deletes the Packaging Machine so as not to incur more costs.
When a layer is ready to finalize:
<ol><li><p>Return to the Unidesk Management Console.</p></li><li><p>In the Layers module, select the Layer.</p></li><li><p>Select <strong>Finalize</strong> in the Action bar.</p></li><li><p>Monitor the Task bar to verify that the action completes successfully and that the layer is deployable.</p></li></ol>
##Reference: Create OS Version Wizard values<a name="Reference:_Create_OS_Version_Wizard_values_..650"></a><a name="Create_..194"></a>
<ul><li><p><em>Version</em> - (Required) This can be the version of the OS Layer or a version you assign to the Layer. This value is displayed in the Details view of the Layer.</p></li><li><em>Version Description</em> - (Optional) Enter a description of the version.</li><li><em>Max Layer Size</em> - (Optional) Maximum layer size in gigabytes. Layers are <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/dn265487(v=vs.85).aspx">thin provisioned</a>, and will grow as needed, up to the maximum size. The default Max Layer Size is 100 gigabytes. If the version you are creating could requires more space, change this to a realistic value.</li><li><em>Select a Platform Connector configuration</em> - (Required) Specify a Unidesk Platform Connector for the platform where you'll be publishing your Layered Images. For example, if you're publishing to Azure RD Session Host, select the Azure RDSH connector with the credentials required to access the account. If the configuration you need is not listed, add a <strong>New</strong> one and select it from this list. If you want to change the settings of a Platform Connector configuration, select it and click <strong>Edit</strong>.</li><li><em>Packaging Disk Filename</em> - (Required) The name of the Packaging Machine you created in Azure.</li></ul>

#Add a version to an OS Layer (vSphere)<a name="Add_a_version_to_an_OS_Layer_(vSphere)"></a>
In this article:
[Before you start ](#Before_..195)
[Add a Version to an OS Layer](#New_..196)
[Deploy a Packaging Machine](#Deploy_..197)
[Install your changes](#Install_..198)
[Verify the Layer and shut down the Packaging Machine](#Verify_..199)
[Finalize the OS Layer](#Finalize_..202)
[Reference: Create OS Version Wizard values](#Create_..203)
The Unidesk Operating System (OS) Layer contains the Windows Operating System that is assigned to any Unidesk Layered Images you create using that OS Layer. Once created, you can use the OS Layer to build as many Layered Images as you want.
The OS Layer includes a virtual machine in your infrastructure running the Unidesk-supported Windows Operating System that you want to use for your Layered Images.
##Before you start<a name="Before_you_start_..651"></a><a name="Before_..195"></a>
Before you can create an OS Layer version, you'll need to:
<ul><li><a href="#Set_up_a_network_file_share">Configure a fileshare</a></li></ul>
##Add a version of an OS Layer<a name="Add_a_version_of_an_OS_Layer_..652"></a><a name="New_..196"></a>
To add a version of an OS Layer, take the following steps:
<ol><li><p>In the Unidesk Management Console, select <strong>Layers > OS Layers.</strong></p></li><li><p>Select or right-click an OS Layer icon and click <strong>Add Version</strong>. This opens the Create OS Version Wizard.</p></li><li><p>(Required) In the Version Details tab, enter a Version identifier. This can be the application version, or anything you choose.</p></li><li><p>In the Connector tab, select a <strong>Platform Connector configuration</strong> for the platform where you'll be publishing your Layered Images. You can also modify an existing configuration by selecting it and clicking <strong>Edit</strong>. If you have not yet created a Platform Connector configuration or if the configuration you need is not present, click <strong>New</strong> to create a new <a href="#Connector_Configuration_(AND)_Optional_Script__(vSphere)">Connector Configuration</a> and select it from this list.</p></li><li><p>In the Platform Layer tab, select a Platform Layer that contains the tools and hardware settings that you need to install and package an application when adding a Layer Version. Once created, the new Layer Version can be used in Layered Images published to any platform.</p></li><li><p>In the Packaging Disk tab, enter a <strong>file name</strong> for the Packaging Disk, and select the disk format. This disk will be used for the Packaging Machine (the VM) where you will install the application, as described in the next two sections.</p></li><li><p>Confirm and Complete tab - Verify your settings and click <strong>Create Version</strong>. Unidesk runs the task of creating a new OS version. When the task completes, it shows a status of Action Required. When you double-click the task to expand it, the task contains the following text (refer to the image in the next section): </p><p>"The Packaging Disk has been published. The virtual machine '<...>' can be found in folder '<...>' in datacenter '<...>'. Power on this virtual machine to install your application. When the installation is complete, power off the virtual machine before clicking Finalize on the Action bar."</p></li></ol>
Next, you can deploy a Packaging Machine for this OS Layer.
##Deploy a Packaging Machine to vSphere<a name="Deploy_a_Packaging_Machine_to_vSphere"></a><a name="Deploy_..197"></a>
The Packaging Machine is a virtual machine where you install any updates or applications you want to include in the OS Layer. It is strongly recommended that you use a unique Packaging Machine for each Layer. The Packaging Machine is a temporary VM that will be deleted once the OS Layer has been finalized.
The Task Description (example shown in the last step above) contains directions to navigate to the location in vSphere where the Packaging Machine for this Layer has been created.
To create your Packaging Machine in vSphere, begin with the expanded Packaging Disk task shown in step 2 below.
<ol><li>Log into your vSphere web client.</li><li><p>Back in the Unidesk Management Console, use the instructions in the expanded Packaging Disk Task (example shown below) to navigate to the Packaging Machine.</p><p><img></img></p><p>The Packaging Machine will be powered on.</p></li></ol>
##Install the OS update<a name="Install_the_OS(SPACE)update_..653"></a><a name="Install_..198"></a>
<ol><li><p>Remote log into the Packaging Machine in vSphere. Be sure to log in with the User account you used to create the OS in vSphere.</p></li><li><p>Install any updates or applications you want to include in the new OS Layer version, such as Windows Updates or anti-virus applications.</p><p>If an application installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</p></li><li><p>Make sure the Packaging Machine is in the state you want it to be for the user:</p><ul><li>If the applications you install require any post-installation setup or application registration, complete those steps now.</li><li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li></ul></li></ol>
Next, you will shut down the Packaging Machine and verify that the Layer is ready to finalize.
##Verify the Layer and shut down the Packaging Machine<a name="Verify_the_Layer_and_shut_down_the_Packaging_Machine_..654"></a><a name="Verify_..199"></a>
Once the application is installed on the Packaging Machine, the next step is to verify that the Layer is ready to be finalized. To be ready for finalization, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the ***Shutdown For Finalize***  tool (icon below), which appears on the Packaging Machine's desktop.

To use the Shutdown For Finalize tool:
<ol><li>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</li><li>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages detailing the layer verification process.</li><li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Layer_Integrity_Check_..200">below</a>.</li><li>Once any pending operations are complete, double-click the <em>Shutdown For Finalize</em> icon again. This shuts down the Packaging Machine.</li></ol>
The Layer is now ready to finalize.
###Layer integrity messages you may see during<a name="Layer_integrity_messages_you_may_see_during_..655"></a><a name="Layer_Integrity_Check_..200"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p>Note: If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
###Expediting a Microsoft NGen operation<a name="Expediting_a_Microsoft_NGen_operation_..656"></a><a name="Complete_MS_NGen_Operations_..201"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>
##Finalize the OS Layer<a name="Finalize_the_OS_Layer_..657"></a><a name="Finalize_..202"></a>
Once the Packaging Machine is created and any apps or updates installed, you'll need to finalize the layer.
***Note:***  When you finalize a new version of an OS Layer, Unidesk deletes the Packaging Machine so as not to incur more costs.
When a layer is ready to finalize:
<ol><li><p>Return to the Unidesk Management Console.</p></li><li><p>In the Layers module, select the layer.</p></li><li><p>Select <strong>Finalize</strong> in the Action bar.</p></li><li><p>Monitor the Task bar to verify that the action completes successfully and that the layer is deployable.</p></li></ol>
##Reference: Create OS Version Wizard values<a name="Reference:_Create_OS_Version_Wizard_values_..658"></a><a name="Create_..203"></a>
<ul><li><p><em>Version</em> - (Required) This can be the version of the OS Layer or a version you assign to the Layer. This value is displayed in the Details view of the Layer.</p></li><li><em>Version Description</em> - (Optional) Enter a description of the version.</li><li><em>Max Layer Size</em> - (Optional) Maximum layer size in gigabytes. Layers are <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/dn265487(v=vs.85).aspx">thin provisioned</a>, and will grow as needed, up to the maximum size. The default Max Layer Size is 100 gigabytes. If the version you are creating could requires more space, change this to a realistic value.</li><li><em>Select a Platform Connector configuration</em> - (Required) Specify a Unidesk Platform Connector for the platform where you'll be publishing your Layered Images. For example, if you're publishing to Azure RD Session Host, select the Azure RDSH connector with the credentials required to access the account. If the configuration you need is not listed, add a <strong>New</strong> one and select it from this list. If you want to change the settings of a Platform Connector configuration, select it and click <strong>Edit</strong>.</li><li><em>Packaging Disk Filename</em> - (Required) The name of the Packaging Machine you created in Azure.</li></ul>

#Create a Platform Layer<a name="Create_a_Platform_Layer"></a>
Which ***Connector***  are you using to create this Platform Layer?

For more about Platform Layers, see [Layer Essentials: Platform Layers](#Layer_Essentials)
#Create a Platform Layer (Azure connector)<a name="Create_a_Platform_Layer_(Azure_connector)"></a>
In this article:
<table><tbody><tr><td><p>Create a Platform Layer (Azure connector)</p><p>Prepare a new Platform Layer</p><p>Deploy a Packaging Machine</p><p>Install the platform software</p><p>Verify the Layer and shut down the Packaging Machine</p><p>Finalize the Layer</p></td></tr></tbody></table>
A Platform Layer is intended to include the platform software and settings required to deploy images in your environment. For example, a Platform Layer for publishing to PVS in vSphere with XenApp as the broker would include the PVS Target Device Imaging software, vmTools, and the XenApp Virtual Delivery Agent Installer (and other platform-related software as well).
You can create two kinds of Platform Layers:
<ul><li><p>Platform Layers for <em>publishing Layered Images</em> (Required) - These Layers include the software and settings required for a Layered Image to run flawlessly in your environment.</p></li><li><p>Platform Layers for <em>packaging Layers</em> (Required in some cases) - These Layers include the hypervisor software and settings you need to easily install the software for your other layers on a VM in your hypervisor environment.</p></li></ul>
##Prerequisites<a name="Prerequisites_..659"></a>
When creating a Platform Layer, the software installers for your platform must be available in a location that's accessible to the Packaging Machine VM where you are going to create the Layer. As summarized in the following table, the prerequisites vary based on the ***type***  of Platform Layer you choose to create.
<table><thead><tr><th>Type of Platform Layer</th><th>Prerequisites</th></tr></thead><tbody><tr><td>Publishing Layered Images</td><td><p>Software installers, and settings you use for your:</p><ul><li>Hypervisor</li><li>Provisioning service</li><li>Connection broker</li></ul></td></tr><tr><td>Packaging Layers</td><td><p>The software and settings for your:</p><ul><li>Hypervisor</li></ul><p>For example, your hypervisor installer and settings.</p><p><strong>Note:</strong> You only need a Platform Layer for <em>packaging</em> Layers if you are creating your Layers on a different hypervisor than the one from which you imported your OS image.</p></td></tr></tbody></table>
##Prepare a new Platform Layer<a name="Prepare_a_new_Platform_Layer"></a><a name="Create2"></a>
<ol><li><p>Select <strong>Layers > Platform Layers</strong> and select <strong>Create Platform Layer</strong> in the Action bar. This opens the Create Platform Layer wizard.</p></li><li><p>In the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. Optionally, you can also enter other values. For details, see more about these values <a href="#Create">below</a>.</p></li><li><p>In the OS Layer tab, select the OS Layer you want to associate with this Platform Layer.</p></li><li><p>In the Connector tab, choose a Connector Configuration for the platform where you are creating this layer. If the configuration you need isn't listed, add a <strong>New</strong><a href="#Azure_Connector_Configuration">Connector Configuration</a> and select it from this list.</p><p>Example: If you are creating the layer in a vSphere environment, select the vSphere connector with the information needed to access the location where you will package this layer.</p></li><li><p>In the Platform Types tab, select the radio button that describes the purpose of this Platform Layer: to create and update layers, or to publish Layered Images. For more about these choices, see Platform Layers.</p></li><li><p>From the dropdown menus, select the platform(s) you are using.</p></li><li><p>In the Packaging Disk tab, enter a <strong>file name</strong> for the Packaging Disk, and select the disk format. This disk will be used for the Packaging Machine (the VM) where you will install the tools, as described in the next two sections.</p></li><li><p>In the Icon Assignment tab, select an icon to assign to the layer. This icon represents the layer in the Layers Module.</p><ul><li>To use an existing image, select an image in the image box.</li><li>To import a new image, click <strong>Browse</strong> and select an image in PNG or JPG format.</li></ul></li><li><p>In the Confirm and Complete tab, review the details of the App Layer, enter a comment if required, and click <strong>Create Layer</strong>. Any comments you enter will appear in the Information view Audit History.</p></li><li><p>Expand the Tasks bar at the bottom of the UI, and double-click the Packaging Disk task to show the full task description.</p><p>Once the Packaging Disk has been created, the Task bar displays the location of the Packaging Disk in your environment.</p><p><img></img></p></li></ol>
Next, you can deploy the Packaging Machine for your Layer.
##Deploy a Packaging Machine<a name="Deploy_a_Packaging_Machine_..660"></a><a name="Deploy_..204"></a>
The Packaging Machine is a virtual machine where you install the app(s) you want to include in this Layer. It is strongly recommended that you use a unique Packaging Machine for each Layer. The Packaging Machine is a temporary VM that will be deleted once the Layer has been finalized.
###Deploy a Packaging Machine to Azure<a name="Deploy_a_Packaging_Machine_to_Azure"></a>
The Task Description (example shown in the last step above) contains a link to the location in the Azure portal where the Packaging Machine for this Layer has been published.
To create your Packaging Machine in Azure, begin with the expanded Packaging Disk Task shown in the last step above.
<ol><li>Log into the Azure portal (https://portal.azure.com) from your web browser.</li><li><p>In the expanded Packaging Disk Task shown below, copy the full URL and paste it into the web browser where you logged into the Azure portal. This opens the Microsoft Azure portal to the <em>Custom deployment</em> template where you can create the virtual machine that you will use as your Unidesk Packaging Machine.</p><p><strong>Note:</strong> We recommend copying the full URL instead of using the Click <u>here</u> link.</p><p><img></img></p></li><li><p>On the Custom deployment panel, complete the required fields for customizing your Azure parameters.</p><ul><li>Packaging Machine Name - must conform to Azure VM name requirements.</li><li>Size - the Azure VM size of the packaging machine.</li><li>Virtual Network and Subnet - the virtual network and subnet for deploying the Packaging Machine.</li></ul><p>IMPORTANT: Be sure that the value for the <strong>Resource group location</strong> matches the <strong>Storage account location</strong> that you configured in the Platform Connector Configuration. If these locations are not the same, the Packaging Machine will fail to deploy and you will have to reattempt deployment. If your deployment does fail, you can simply re-paste the link into the browser to start over.</p><p><img></img></p></li></ol>
##Install the platform software<a name="Install_the_platform_software"></a><a name="Install_..205"></a>
This section explains how to install your application(s) on the Packaging Machine you created in Azure. Keep in mind that the state of the software before you finalize the layer is what users experience when they access it.
To install the application(s):
<ol><li><p>Remote log in to the Packaging Machine you created in Azure. Be sure to log in using the User account you used to create the OS in Azure.</p></li><li><p>Install the Azure hypervisor software, along with any drivers, boot-level applications, or files that you need for packaging Layers in Azure.</p></li><li><p>Make sure the Packaging Machine is in the state you want it to be for the user:</p><ul><li>If the software you install requires any post-installation setup or registration, complete those steps now.</li><li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li></ul></li></ol>
Next, you'll need to shut down the Packaging Machine and verify that the Layer is ready to finalize.
##Verify the Layer and shut down the Packaging Machine<a name="Verify_the_Layer_and_shut_down_the_Packaging_Machine_..661"></a><a name="Verify_..206"></a>
Once the application is installed on the Packaging Machine, the next step is to verify that the Layer is ready to be finalized. To be ready for finalization, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the ***Shutdown For Finalize***  tool (icon below), which appears on the Packaging Machine's desktop.

To use the Shutdown For Finalize tool:
<ol><li>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</li><li>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages detailing the layer verification process.</li><li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Layer_Integrity_Check_..207">below</a>.</li><li>Once any pending operations are complete, double-click the <em>Shutdown For Finalize</em> icon again. This shuts down the Packaging Machine.</li></ol>
The Layer is now ready to finalize.
###Layer integrity messages you may see during the finalization process<a name="Layer_integrity_messages_you_may_see_during_the_finalization_process"></a><a name="Layer_Integrity_Check_..207"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:<a name="Layer_Integrity_Messages_..208"></a>
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p><strong>Note:</strong> If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
###Expediting a Microsoft NGen operation<a name="Expediting_a_Microsoft_NGen_operation_..662"></a><a name="Complete_MS_NGen_Operations_..209"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>
##Finalize the Layer<a name="Finalize_the_Layer"></a><a name="Finalize_..210"></a>
Once the Packaging Machine is created, the platform software is installed and ready to finalize, and you have shut down the machine, you'll need to finalize the layer.
***Note:***  When you finalize a Platform Layer, Unidesk deletes the Packaging Machine.
When a layer is ready to finalize:
<ol><li>Return to the Unidesk Management Console.</li><li>In the Layers module, select the layer.</li><li>Select <span>Finalize</span> in the Action bar.</li><li><a href="#Layer_Integrity_Check_..207"></a> Monitor the Task bar to verify that the action completes successfully and that the layer is deployable.</li></ol>

#Create a Platform Layer (Citrix MCS for vSphere)<a name="Create_a_Platform_Layer_(Citrix_MCS_for_vSphere)"></a>
In this article:
<table><tbody><tr><td><p> </p><p>Prepare a new Platform Layer</p><p>Deploy a Packaging Machine</p><p>Create a Platform Layer (Citrix MCS for vSphere)</p><p>Verify the Layer and shut down the Packaging Machine</p><p><a href="#Finalize_..218">Finalize the Layer</a></p></td></tr></tbody></table>
A Platform Layer includes the platform software and settings required to deploy images in your environment. For example, a Platform Layer for publishing to Citrix MCS in vSphere with XenApp as the broker would include the MCS Target Device Imaging software, vmTools, and the XenApp Virtual Delivery Agent Installer (and other platform-related software as well).
This article explains the next steps to create a Platform Layer, based on your connector and platform choices. If you need more information than is included here, check these other Unidesk sources: [Layer essentials (Unidesk Learning Center)](#Layer_Essentials)[ and the ](#Layer_Essentials)[Unidesk Forum](http://www.unidesk.com/forum/unidesk-4)[.](http://www.unidesk.com/forum/unidesk-4)
A Platform Layer should include the platform software and settings required to deploy images in your environment, given your choice of hypervisor, provisioning service, and connection broker.
You can create two kinds of Platform Layers:
<ul><li><p>Platform Layers for <em>publishing Layered Images</em> (Required) - A Platform Layer for <em>publishing</em> is used in Image Templates to ensure that your published Layered Images include the software and settings required to run flawlessly in your environment.</p></li><li><p>Platform Layers for <em>packaging Layers</em> (Required in some cases) - A Platform Layer for <em>packaging</em> is used for creating App Layers and OS Layer Versions in your hypervisor environment. This Layer includes the hypervisor software and settings required to easily install the app or OS update on a VM in the selected hypervisor.</p></li></ul>

##Prerequisites<a name="Prerequisites_..663"></a>
When creating a Platform Layer, the software installers for your platform must be available in a location that's accessible to the Packaging Machine VM where you are going to create the Layer. As summarized in the following table, the prerequisites vary based on the ***type***  of Platform Layer you choose to create.
<table><thead><tr><th>Type of Platform Layer</th><th>Prerequisites</th></tr></thead><tbody><tr><td>Publishing Layered Images</td><td><p>Software installers, and settings you use for your:</p><ul><li>Hypervisor</li><li>Provisioning service</li><li>Connection broker</li></ul></td></tr><tr><td>Packaging Layers</td><td><p>The software and settings for your:</p><ul><li>Hypervisor</li></ul><p>For example, your hypervisor installer and settings.</p><p><strong>Note:</strong> You only need a Platform Layer for <em>packaging</em> Layers if you are creating your Layers on a different hypervisor than the one from which you imported your OS image.</p></td></tr></tbody></table>
###Citrix MCS prerequisites<a name="Citrix_MCS_prerequisites"></a>
When creating a Platform Layer for publishing images to an MCS environment, you need:
<ul><li><p><a href="#Create_an_OS_Layer">An OS Layer</a></p></li><li><p><strong>Network access to Unidesk Tools</strong></p><p>Access from the Platform Layer Packaging Machine VM to the Unidesk Tools download (available on the Unidesk Download page).</p></li><li><p><strong>Citrix Virtual Delivery Agent (VDA) installed on the Platform Layer</strong></p><p>The Citrix VDA installer for the Windows OS you are using must be installed on the Platform Layer.</p></li><li><p><strong>Citrix Desktop Delivery Controller (DDC)</strong></p><p>The Citrix DDC software must be installed on the server where the Layered Image will be published.</p><p>As part of the Connector Configuration, if you include a script to run on the newly published Layered Image, you will need the following:</p><ul><li><strong>Unidesk Agent</strong> - Installed and running on the DDC. This allows Unidesk to run the script on the DDC.</li><li><strong>PowerShell Snap-in</strong> - Appropriate PowerShell Snap-in must be installed on the DDC.</li></ul></li><li><p><strong>Citrix resource information</strong></p><p>The Citrix info listed in this <a href="../../../../connector_config_fields_mc4.htm">MCS Connector Configuration</a> topic.</p></li></ul>
##Prepare a new Platform Layer<a name="Prepare_a_new_Platform_Layer_..664"></a><a name="Create2_..212"></a>
To create a Platform Layer you prepare the layer using the Create Platform Layer wizard, deploy a Packaging Machine in your environment, install the tools and configure the settings for MCS, and finalize the Layer.
<ol><li><p>Select <strong>Layers > Platform Layers</strong> and select <strong>Create Platform Layer</strong> in the Action bar. This opens the Create Platform Layer wizard.</p></li><li><p>In the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. Optionally, you can also enter other values. For details, see more about these values <a href="#Create">below</a>.</p></li><li><p>In the OS Layer tab, select the OS Layer you want to associate with this Platform Layer.</p></li><li><p>In the Connector tab, choose a Connector Configuration for the platform where you are creating this layer. If the configuration you need isn't listed, add a <strong>New</strong> <a href="#Welcome_to_Citrix_App_Layering_4">Connector Configuration</a> and select it from this list.</p><p>Example: If you are creating the layer in your vSphere environment, select the vSphere connector with the information needed to access the temporary storage location where you will package this layer.</p></li><li><p>In the Recipe Associations tab, select all of the platforms to which you will be publishing the Layered Image.</p><p>Example: If you want to use this Platform Layer to publish Layered Images to both vSphere and Azure, select both environments.</p></li><li><p>In the Packaging Disk tab, enter a <strong>file name</strong> for the Packaging Disk, and select the disk format. This disk will be used for the Packaging Machine (the VM) where you will install the tools, as described in the next two sections.</p></li><li><p>In the Icon Assignment tab, select an icon to assign to the layer. This icon represents the layer in the Layers Module.</p><ul><li>To use an existing image, select an image in the image box.</li><li>To import a new image, click <strong>Browse</strong> and select an image in PNG or JPG format.</li></ul></li><li><p>In the Confirm and Complete tab, review the details of the App Layer, enter a comment if required, and click <strong>Create Layer</strong>. Any comments you enter will appear in the Information view Audit History.</p></li><li><p>Expand the Tasks bar at the bottom of the UI, and double-click the Packaging Disk task to show the full task description.</p><p>Once the Packaging Disk has been created, the Task bar displays the location of the Packaging Disk in your environment.</p><p><img></img></p></li></ol>
Next, you can deploy the Packaging Machine for your Layer.
##Deploy a Packaging Machine<a name="Deploy_a_Packaging_Machine_..665"></a><a name="Deploy_..213"></a>
The Packaging Machine is a virtual machine where you install the tools for your selected environment.
***Note:***  The Packaging Machine is a temporary VM that will be deleted once the new Platform Layer has been finalized.
###Log into the Packaging Machine<a name="Log_into_the_Packaging_Machine"></a>
The Task Description (example shown in the last step above) contains the location of the Packaging Machine in your environment.
<ol><li>Log into your vSphere web client.</li><li><p>Back in the Unidesk Management Console, use the instructions in the expanded Packaging Disk Task shown below to navigate to the Packaging Machine.</p><p><img></img></p></li><li>Power on the Packaging Machine.</li></ol>

##Install the required platform tools<a name="Install_the_required_platform_tools"></a>
This section explains how to install the platform software to be used by the Platform Layer. The platform software to install includes the provisioning server software and/or connection broker software that your Layered Images will need to run in the target environment.
###Platform software to install<a name="Platform_software_to_install"></a>
You need the installers for your hypervisor, provisioning service, and connection broker.
If you are using a supported Unidesk Connector to connect to your environment, you will install the provisioning service and/or connection broker software on the Packaging Machine that Unidesk created in that environment. Otherwise, you will be installing the software on a VM in your hypervisor of choice, moving the VM to the Unidesk network file share, from which you can import the VM into Unidesk.
Keep in mind that the state of the software before you finalize the layer is what the image will use.
<ol><li><p>Remote log in to the Packaging Machine you created. Be sure to log in using the User account you used to create the OS.</p></li><li><p>Install the tools that your Layered Image will need to run on vSphere and in PVS, along with any drivers, boot-level applications, or files needed.</p><p>If a software installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</p></li><li><p>Make sure the Packaging Machine is in the state you want it to be in when the image is booted:</p><ul><li>If the tools you install require any post-installation setup or registration, complete those steps now.</li><li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li></ul></li></ol>
Next, you'll need to shut down the Packaging Machine and verify that the Platform Layer is ready to finalize.
Verify the Layer and shut down the Packaging Machine<a name="Verify_..214"></a>
Once the tools are installed on the Packaging Machine, the next step is to verify that the Layer is ready to finalize. At this point, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the ***Shutdown For Finalize***  tool (icon below), which appears on the Packaging Machine's desktop.

To use the Shutdown For Finalize tool:
<ol><li>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</li><li>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages detailing the layer verification process.</li><li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Layer_Integrity_Check_..215">below</a>.</li><li>Once any pending operations are complete, double-click the <em>Shutdown For Finalize</em> icon again. This shuts down the Packaging Machine.</li></ol>
The Layer is now ready to finalize.
###Layer integrity messages you may see during the finalization process<a name="Layer_integrity_messages_you_may_see_during_the_finalization_process_..666"></a><a name="Layer_Integrity_Check_..215"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:<a name="Layer_Integrity_Messages_..216"></a>
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p><strong>Note:</strong> If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
###Expediting a Microsoft NGen operation<a name="Expediting_a_Microsoft_NGen_operation_..667"></a><a name="Complete_MS_NGen_Operations_..217"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>

##Finalize the Layer<a name="Finalize_the_Layer_..668"></a>
Once the Packaging Machine is created, the software is installed and ready to finalize, and you have shut down the machine, you'll need to finalize the Layer.
***Note:***  When you finalize a Layer, Unidesk may delete the Packaging Machine so as not to incur extra cost for storage.
When the Layer has been verified and is ready to finalize:
<ol><li>Return to the Unidesk Management Console.</li><li>Select <strong>Layers >App Layers</strong>, and then the layer you just prepared.</li><li>Select <span>Finalize</span> in the Action bar.</li><li><a href="#Layer_Integrity_Check_..215"></a> Monitor the Task bar to verify that the action completes successfully and that the Layer is deployable.</li></ol>



#Create a Platform Layer (Citrix MCS for Nutanix AHV)<a name="Create_a_Platform_Layer_(Citrix_MCS_for_Nutanix_AHV)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Prepare a new Platform Layer</p><p>Install the required platform tools</p><p>Verify the Layer and shut down the Packaging Machine</p><p>Finalize the Layer</p></td></tr></tbody></table>
For cross-platform deployments, a Platform Layer includes the platform software and settings required to deploy images in your environment.
You can create two kinds of Platform Layers:
<ul><li><p>Platform Layers for <em>publishing Layered Images</em> (Required) - These Layers include the software and settings required for a Layered Image to run flawlessly in your environment. Use this type of Platform Layer when publishing Layered Images to a platform other than the one where you created the OS Layer.</p></li><li><p>Platform Layers for <em>packaging Layers</em> (Required in some cases) - These Layers include the hypervisor software and settings you need to easily install the software for your other layers on a VM in your hypervisor environment. Use this type of Platform Layer when creating Layers on a platform other than the one from which you imported the OS for your OS Layer.</p></li></ul>
##Prerequisites<a name="Prerequisites_..669"></a><a name="Prerequi_..219"></a>
###Citrix MCS prerequisites<a name="Citrix_MCS_prerequisites_..670"></a>
When creating a Platform Layer for publishing images to an MCS environment, you need:
<ul><li><p><a href="#Create_an_OS_Layer">An OS Layer</a></p></li><li><p><strong>Network access to Unidesk Tools</strong></p><p>Access from the Platform Layer Packaging Machine VM to the Unidesk Tools download (available on the Unidesk Download page).</p></li><li><p><strong>Citrix Virtual Delivery Agent (VDA) installed on the Platform Layer</strong></p><p>The Citrix VDA installer for the Windows OS you are using must be installed on the Platform Layer.</p></li><li><p><strong>Citrix Desktop Delivery Controller (DDC)</strong></p><p>The Citrix DDC software must be installed on the server where the Layered Image will be published.</p><p>As part of the Connector Configuration, if you include a script to run on the newly published Layered Image, you will need the following:</p><ul><li><strong>Unidesk Agent</strong> - Installed and running on the DDC. This allows Unidesk to run the script on the DDC.</li><li><strong>PowerShell Snap-in</strong> - Appropriate PowerShell Snap-in must be installed on the DDC.</li></ul></li><li><p><strong>Citrix resource information</strong></p><p>The Citrix info listed in this <a href="../../../../connector_config_fields_mc4.htm">MCS Connector Configuration</a> topic.</p></li></ul>
###Nutanix AHV (Acropolis) prerequisites<a name="Nutanix_AHV(SPACE)(Acropolis)_prerequisites"></a>
<ul><li><p><strong>Nutanix Prism account and privileges</strong></p><ul><li>A Nutanix Prism account (new or existing) to use for Unidesk.</li><li>The account must have privileges to perform the following operations:<ul><li><p>VM operations:</p><ul><li><p>clone</p></li><li><p>delete</p></li><li><p>power on/off</p></li><li><p>attach virtual disks</p></li></ul></li><li><p>Image operations:</p><ul><li><p>create</p></li><li><p>update (aka upload)</p></li><li><p>delete</p></li></ul></li><li>Virtual disks<ul><li>create</li><li>attach to VMs</li></ul></li></ul></li></ul></li><li><p><strong>Nutanix AHV software and settings</strong></p><p>Access to the VM Mobility Tools to install on the layer.</p></li><li><p><strong>Nutanix AHV resource information</strong></p><p>The Acropolis Server info listed in <a href="#Connector_Configuration_(AND)_Optional_Script__(Nutanix_AHV)">Nutanix AHV Connector Configuration</a> or <a href="#Connector_Configuration_(AND)_Optional_Script__(MCS_for_Nutanix_AHV)">MCS for Nutanix AHV Connector Configuration</a>.</p></li><li><p><strong>Nutanix AHV Connector</strong> </p><p>When creating Layers for the Nutanix environment, you must use a Nutanix AHV Connector Configuration. The MCS for Nutanix AHV Connector does not support Layer creation.</p></li></ul>
##Prepare a new Platform Layer<a name="Prepare_a_new_Platform_Layer_..671"></a><a name="Create2_..220"></a>
<ol><li><p>Select <strong>Layers > Platform Layers</strong> and select <strong>Create Platform Layer</strong> in the Action bar. This opens the Create Platform Layer wizard.</p></li><li><p>In the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. Optionally, you can also enter other values.</p></li><li><p>In the OS Layer tab, select the OS Layer you want to associate with this Platform Layer.</p></li><li><p>In the Connector tab, choose a Connector Configuration for the platform where you are creating this layer. If the configuration you need isn't listed, Click <strong>New</strong>, select an <em>MCS for Nutanix AHV</em> Connector from this list, and <a href="#Add_a_new_Connector_Configuration">Add a Configuration</a> for it.</p><p><strong>Important:</strong> The MCS for Nutanix AHV Connector can <em>only</em> be used to publish Layered Images, <em>not</em> to create Layers.</p></li><li><p>In the Platform Types tab, select the radio button that describes the purpose of this Platform Layer: to create and update layers, or to publish Layered Images. For more about these choices, see Platform Layers.</p></li><li><p>From the drop-down menus, select the hypervisor, provisioning service, and connection broker you are using, in this case, <strong>Nutanix AHV </strong> and <strong>Citrix MCS</strong>.</p></li><li><p>In the Packaging Disk tab, enter a <strong>file name</strong> for the Packaging Disk, and select the disk format. This disk will be used for the Packaging Machine (the VM) where you will install the tools, as described in the next two sections.</p></li><li><p>In the Icon Assignment tab, select an icon to assign to the layer. This icon represents the layer in the Layers Module.</p><ul><li>To use an existing image, select an image in the image box.</li><li>To import a new image, click <strong>Browse</strong> and select an image in PNG or JPG format.</li></ul></li><li><p>In the Confirm and Complete tab, review the details of the App Layer, enter a comment if required, and click <strong>Create Layer</strong>. Any comments you enter will appear in the Information view Audit History.</p></li><li><p>Expand the Tasks bar at the bottom of the UI, and double-click the Packaging Disk task to show the full task description.</p><p>Once the Packaging Disk has been created, the Task bar displays the location of the Packaging Disk in your environment (example task message shown below).</p><p><img></img></p></li></ol>
Next, you can access the Packaging Machine for your Layer, and install the software for your environment.
The Packaging Machine is a virtual machine where you install the tools for your selected environment(s). It is a temporary VM that will be deleted once the new Platform Layer has been finalized. When the Unidesk software powers on the Packaging Machine for you.
##Access the Packaging Machine in Nutanix AHV<a name="Access_the_Packaging_Machine_in_Nutanix_AHV_..672"></a><a name="Copy"></a>
<ol><li>Log into Nutanix Prism.</li><li><p>Back in the Unidesk Management Console (UMC), expand the Tasks bar at the bottom of the UI, and double-click the <em>Create Platform Layer</em> task to see the full Task Description (example below).</p><p><img></img></p></li><li>Use the instructions in the Task Description to navigate to the Packaging Machine in Prism.</li></ol>
##Install the required platform tools<a name="Install_the_required_platform_tools_..673"></a><a name="Install_..221"></a>
If you created the OS Layer on a hypervisor other than Nutanix, install the VM Mobility Tools. (If the OS was created in Nutanix, it already has the tools installed.) The tools installation may require multiple reboots. Once complete, you should see that you have access to the tools, as well as all of the ***data***  available under the Performance tab for your VM.
When installing your platform software on the Packaging Machine, keep in mind that the state of the software before you finalize the layer is what the image will use.
To install the tools for the selected platform:
<ol><li><p>Remote log in to the Packaging Machine you created. Be sure to log in using the User account you used to create the OS.</p></li><li><p>Install the platform software and tools, along with any drivers, boot-level applications, or files needed.</p><ul><li>If this Platform Layer is going to be used for publishing Layered Images, install and configure your hypervisor, provisioning service, and connection broker tools and settings.</li><li>If a software installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</li></ul></li><li><p>Install an empty <em>flag</em> file called <span>Shutdown_published_Image.txt</span> in the following directory:</p><pre>  c:\windows\setup\scripts\kmsdir</pre><p>This enables automated shutdown of the OS.</p></li><li><p>Make sure the Packaging Machine is in the state you want it to be in when the image is booted:</p><ul><li>If the tools you install require any post-installation setup or registration, complete those steps now.</li><li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li></ul></li></ol>
Next, you'll need to shut down the Packaging Machine and verify that the Platform Layer is ready to finalize.
##Verify the Layer and shut down the Packaging Machine<a name="Verify_the_Layer_and_shut_down_the_Packaging_Machine_..674"></a><a name="Verify_..222"></a>
Once the tools are installed on the Packaging Machine, the next step is to verify that the Layer is ready to finalize. At this point, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the ***Shutdown For Finalize***  tool (icon below), which appears on the Packaging Machine's desktop.

To use the Shutdown For Finalize tool:
<ol><li><p>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</p></li><li><p>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages detailing the layer verification process.</p></li><li><p>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Layer_Integrity_Check_..223">below</a>.</p></li><li><p>Once any pending operations are complete, double-click the <em>Shutdown For Finalize</em> icon again. This shuts down the Packaging Machine.</p></li></ol>
The ***Shutdown for Finalize***  task will remain in the ***Action Required***  state until you finalize the Layer.
The Layer is now ready to finalize.
###Layer integrity messages you may see during the finalization process<a name="Layer_integrity_messages_you_may_see_during_the_finalization_process_..675"></a><a name="Layer_Integrity_Check_..223"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:<a name="Layer_Integrity_Messages_..224"></a>
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p><strong>Note:</strong> If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
###Expediting a Microsoft NGen operation<a name="Expediting_a_Microsoft_NGen_operation_..676"></a><a name="Complete_MS_NGen_Operations_..225"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>
##Finalize the Layer<a name="Finalize_the_Layer_..677"></a><a name="Finalize_..226"></a>
Once the Packaging Machine is created, the tools are installed and ready to finalize, and you have shut down the machine, you'll need to finalize the layer.
When a layer is ready to finalize:
<ol><li>Return to the Unidesk Management Console.</li><li>Select <strong>Layers > Platform Layers</strong>, and select the Platform Layer you just prepared.</li><li>Select <span>Finalize</span> in the Action bar.</li><li><a href="#Layer_Integrity_Check_..223"></a> Monitor the Task bar to verify that the action completes successfully and that the layer is deployable.</li></ol>

#Create a Platform Layer (PVS)<a name="Create_a_Platform_Layer_(PVS)"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Prepare a new Platform Layer</p><p>Deploy a Packaging Machine</p><p>Create a Platform Layer (PVS)</p><p>Verify the Layer and shut down the Packaging Machine</p><p><a href="#Finalize_..235">Finalize the Layer</a></p></td></tr></tbody></table>
A Platform Layer is intended to include the platform software and settings required to deploy images in your environment. For example, a Platform Layer for publishing to PVS in vSphere with XenApp as the broker would include the PVS Target Device Imaging software, vmTools, and the XenApp Virtual Delivery Agent Installer (and other platform-related software as well).
You can create two kinds of Platform Layers:
<ul><li><p>Platform Layers for <em>publishing Layered Images</em> (Required) - These Layers include the software and settings required for a Layered Image to run flawlessly in your environment.</p></li><li><p>Platform Layers for <em>packaging Layers</em> (Required in some cases) - These Layers include the hypervisor software and settings you need to easily install the software for your other layers on a VM in your hypervisor environment.</p></li></ul>
To create a Platform Layer you prepare the layer using the Create Platform Layer wizard, deploy a Packaging Machine in your environment, install the tools and configure the settings for PVS, and finalize the Layer.
##Before you start<a name="Before_you_start_..678"></a><a name="Before_..227"></a>
###Platform Layer Prerequisites<a name="Platform_Layer_Prerequisites"></a>
<ul><li><p><a href="#Create_an_OS_Layer">An OS Layer</a></p></li></ul>
###PVS Prerequisites<a name="PVS(SPACE)Prerequisites"></a>
<ul><li><p><strong>IPv6 must be </strong><em>disabled</em><strong> on the OS Layer.</strong> </p><p>If IPv6 is not disabled on your OS Layer, add a new Version to the OS Layer and disable IPv6 in the new Version.</p><p><strong>IMPORTANT:</strong> If you disable IPv6 on the <em>Platform Layer</em> instead of on the <em>OS Layer</em>, the resulting PVS machines will lose their network connection and hang when they are booted.</p></li><li><p><strong>Unidesk Agent</strong></p><p>The Unidesk Agent must be installed on all PVS servers used to access the PVS servers to which you will publish images. (Each Agent must be registered wit the Unidesk ELM.)</p></li><li><p><strong>PVS servers where the Unidesk Agent is installed</strong></p><p>The PVS Console must be installed on all PVS servers where the Unidesk Agent is installed.</p></li><li><p><strong>PVS Target Device Imaging software</strong></p><p>The PVS Target Device Imaging software must be available to install on the Platform Layer. The version must match the PVS server where the Layered Image will be published.</p></li><li><p><strong>PVS resource information</strong></p><p>The PVS info listed in this <a href="#Connector_Configuration_(AND)_Optional_Script_(PVS)">PVS Connector Configuration</a> topic.</p></li><li><p><strong>PowerShell Snap-in</strong></p><p>Appropriate PowerShell Snap-in must be installed.</p></li><li><p><strong>Unique CMID for each target device (if using KMS)</strong></p><p>When using KMS licensing, PVS requires that each target device has a unique CMID. For the full story, check out this Citrix article, <a href="https://www.citrix.com/blogs/2014/05/01/demystifying-kms-and-provisioning-services/">Demystifying KMS and Provisioning Services</a>. Rearming KMS is covered in the steps to Create a Platform Layer.</p></li><li><p><strong>Any additional PVS settings you use in your environment</strong></p><p>Any settings you need to configure PVS on your Platform Layer so that it matches the environment where the Layered Image will be used.</p></li></ul>
###Required Tools and Settings<a name="Required_Tools_and_Settings"></a>
<ul><li>Unidesk Tools download</li><li>PVS settings</li><li>KMS settings</li></ul>
##Prepare a new Platform Layer<a name="Prepare_a_new_Platform_Layer_..679"></a><a name="Create2_..228"></a>
<ol><li><p>Select <strong>Layers > Platform Layers</strong> and select <strong>Create Platform Layer</strong> in the Action bar. This opens the Create Platform Layer wizard.</p></li><li><p>In the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. Optionally, you can also enter other values. For details, see more about these values <a href="#Create">below</a>.</p></li><li><p>In the OS Layer tab, select the OS Layer you want to associate with this Platform Layer.</p></li><li><p>In the Connector tab, choose a Connector Configuration for the platform where you are creating this layer. If the configuration you need isn't listed, add a <strong>New</strong> <a href="#Welcome_to_Citrix_App_Layering_4">Connector Configuration</a> and select it from this list.</p><p>Example: If you are creating the layer in your vSphere environment, select the vSphere connector with the information needed to access the temporary storage location where you will package this layer.</p></li><li><p>In the Recipe Associations tab, select all of the platforms to which you will be publishing the Layered Image.</p><p>Example: If you want to use this Platform Layer to publish Layered Images to both vSphere and Azure, select both environments.</p></li><li><p>In the Packaging Disk tab, enter a <strong>file name</strong> for the Packaging Disk, and select the disk format. This disk will be used for the Packaging Machine (the VM) where you will install the tools, as described in the next two sections.</p></li><li><p>In the Icon Assignment tab, select an icon to assign to the layer. This icon represents the layer in the Layers Module.</p><ul><li>To use an existing image, select an image in the image box.</li><li>To import a new image, click <strong>Browse</strong> and select an image in PNG or JPG format.</li></ul></li><li><p>In the Confirm and Complete tab, review the details of the App Layer, enter a comment if required, and click <strong>Create Layer</strong>. Any comments you enter will appear in the Information view Audit History.</p></li><li><p>Expand the Tasks bar at the bottom of the UI, and double-click the Packaging Disk task to show the full task description.</p><p>Once the Packaging Disk has been created, the Task bar displays the location of the Packaging Disk in your environment.</p><p><img></img></p></li></ol>
Next, you can deploy the Packaging Machine for your Layer.
##Deploy a Packaging Machine<a name="Deploy_a_Packaging_Machine_..680"></a><a name="Deploy_..229"></a>
The Packaging Machine is a virtual machine where you install the tools for your selected environment.
***Note:***  The Packaging Machine is a temporary VM that will be deleted once the new Platform Layer has been finalized.
###Log into the Packaging Machine<a name="Log_into_the_Packaging_Machine_..681"></a>
The Task Description (example shown in the last step above) contains the location of the Packaging Machine in your environment.
<ol><li>Log into your vSphere web client.</li><li><p>Back in the Unidesk Management Console, use the instructions in the expanded Packaging Disk Task shown below to navigate to the Packaging Machine.</p><p><img></img></p></li><li>Power on the Packaging Machine.</li></ol>

##Install the required platform tools<a name="Install_the_required_platform_tools_..682"></a>
This section explains how to install the platform software to be used by the Platform Layer. The platform software to install includes the provisioning server software and/or connection broker software that your Layered Images will need to run in the target environment.
###Platform software to install<a name="Platform_software_to_install_..683"></a>
You need the installers for your hypervisor, provisioning service, and connection broker.
If you are using a supported Unidesk Connector to connect to your environment, you will install the provisioning service and/or connection broker software on the Packaging Machine that Unidesk created in that environment. Otherwise, you will be installing the software on a VM in your hypervisor of choice, moving the VM to the Unidesk network file share, from which you can import the VM into Unidesk.
Keep in mind that the state of the software before you finalize the layer is what the image will use.
<ol><li><p>Remote log in to the Packaging Machine you created. Be sure to log in using the User account you used to create the OS.</p></li><li><p>Install the tools that your Layered Image will need to run on vSphere and in PVS, along with any drivers, boot-level applications, or files needed.</p><p>If a software installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</p></li><li><p>Make sure the Packaging Machine is in the state you want it to be in when the image is booted:</p><ul><li>If the tools you install require any post-installation setup or registration, complete those steps now.</li><li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li></ul></li></ol>
Next, you'll need to shut down the Packaging Machine and verify that the Platform Layer is ready to finalize.
Verify the Layer and shut down the Packaging Machine<a name="Verify_..231"></a>
Once the tools are installed on the Packaging Machine, the next step is to verify that the Layer is ready to finalize. At this point, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the ***Shutdown For Finalize***  tool (icon below), which appears on the Packaging Machine's desktop.

To use the Shutdown For Finalize tool:
<ol><li>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</li><li>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages detailing the layer verification process.</li><li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Layer_Integrity_Check_..232">below</a>.</li><li>Once any pending operations are complete, double-click the <em>Shutdown For Finalize</em> icon again. This shuts down the Packaging Machine.</li></ol>
The Layer is now ready to finalize.
###Layer integrity messages you may see during the finalization process<a name="Layer_integrity_messages_you_may_see_during_the_finalization_process_..684"></a><a name="Layer_Integrity_Check_..232"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:<a name="Layer_Integrity_Messages_..233"></a>
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p><strong>Note:</strong> If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
###Expediting a Microsoft NGen operation<a name="Expediting_a_Microsoft_NGen_operation_..685"></a><a name="Complete_MS_NGen_Operations_..234"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>

##Finalize the Layer<a name="Finalize_the_Layer_..686"></a>
Once the Packaging Machine is created, the software is installed and ready to finalize, and you have shut down the machine, you'll need to finalize the Layer.
***Note:***  When you finalize a Layer, Unidesk may delete the Packaging Machine so as not to incur extra cost for storage.
When the Layer has been verified and is ready to finalize:
<ol><li>Return to the Unidesk Management Console.</li><li>Select <strong>Layers >App Layers</strong>, and then the layer you just prepared.</li><li>Select <span>Finalize</span> in the Action bar.</li><li><a href="#Layer_Integrity_Check_..232"></a> Monitor the Task bar to verify that the action completes successfully and that the Layer is deployable.</li></ol>



#Create a Platform Layer (XenServer Connector)<a name="Create_a_Platform_Layer_(XenServer_Connector)"></a>
In this article:
<table><tbody><tr><td><p> </p><p>Prepare a new Platform Layer</p><p> </p><p> </p><p> </p></td></tr></tbody></table>
A Platform Layer should include the platform software and settings required to deploy images in your environment, given your choice of hypervisor, provisioning service, and connection broker.
You can create two kinds of Platform Layers:
<ul><li><p>Platform Layers for <em>publishing Layered Images</em> (Required) - A Platform Layer for <em>publishing</em> is used in Image Templates to ensure that your published Layered Images include the software and settings required to run flawlessly in your environment.</p></li><li><p>Platform Layers for <em>packaging Layers</em> (Required in some cases) - A Platform Layer for <em>packaging</em> is used for creating App Layers and OS Layer Versions in your hypervisor environment. This Layer includes the hypervisor software and settings required to easily install the app or OS update on a VM in the selected hypervisor.</p></li></ul>

##Prerequisites<a name="Prerequisites_..687"></a>
When creating a Platform Layer, the software installers for your platform must be available in a location that's accessible to the Packaging Machine VM where you are going to create the Layer. As summarized in the following table, the prerequisites vary based on the ***type***  of Platform Layer you choose to create.
<table><thead><tr><th>Type of Platform Layer</th><th>Prerequisites</th></tr></thead><tbody><tr><td>Publishing Layered Images</td><td><p>Software installers, and settings you use for your:</p><ul><li>Hypervisor</li><li>Provisioning service</li><li>Connection broker</li></ul></td></tr><tr><td>Packaging Layers</td><td><p>The software and settings for your:</p><ul><li>Hypervisor</li></ul><p>For example, your hypervisor installer and settings.</p><p><strong>Note:</strong> You only need a Platform Layer for <em>packaging</em> Layers if you are creating your Layers on a different hypervisor than the one from which you imported your OS image.</p></td></tr></tbody></table>
###Citrix XenServer prerequisites<a name="Citrix_XenServer_prerequisites_..688"></a>
<ul><li><p><strong>XenServer account and privileges</strong></p><ul><li>A XenServer account (new or existing) to use for Unidesk.</li><li>The account must have XenServer privileges to:<ul><li>Create and remove virtual disks.</li><li>Copy and delete layers on virtual disks using XenServer file APIs.</li></ul></li></ul></li><li><p><strong>Citrix XenServer software and settings</strong></p><p>Access to the XenServer Tools to install on the layer.</p></li><li><p><strong>XenServer resource information</strong></p><p>The XenServer info listed in <a href="#Connector_Configuration_(AND)_Optional_Script__(Citrix_XenServer)">Citrix XenServer Connector Configuration</a>.</p></li><li><p><strong>Network access to Unidesk OS Machine Tools</strong></p><p>When you create Layer or add a Version to it, the Unidesk Management Console (UMC) uses a Connector Configuration to create a VM called a Packaging Machine for the Layer you are building. The Packaging Machine <em>must</em> have access to the Unidesk OS Machine Tools download, which is available on the Unidesk Download page.</p></li></ul>
##Prepare a new Platform Layer<a name="Prepare_a_new_Platform_Layer_..689"></a><a name="Create2_..237"></a>
<ol><li><p>Select <strong>Layers > Platform Layers</strong> and select <strong>Create Platform Layer</strong> in the Action bar. This opens the Create Platform Layer wizard.</p></li><li><p>In the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. Optionally, you can also enter other values.</p></li><li><p>In the OS Layer tab, select the OS Layer you want to associate with this Platform Layer.</p></li><li><p>In the Connector tab, choose a Connector Configuration for the platform where you are creating this layer. If the configuration you need isn't listed, Click <strong>New</strong>, select your platform from this list, and <a href="#Add_a_new_Connector_Configuration">Add a Configuration</a> for it.</p><p><strong>Example:</strong> If you are creating the layer in a XenServer environment, select the XenServer connector with the information needed to access the location where you will package this layer.</p></li><li><p>In the Platform Types tab, select the radio button that describes the purpose of this Platform Layer: to create and update layers, or to publish Layered Images. For more about these choices, see Platform Layers.</p></li><li><p>From the dropdown menus, select the platform(s) you are using.</p></li><li><p>In the Packaging Disk tab, enter a <strong>file name</strong> for the Packaging Disk, and select the disk format. This disk will be used for the Packaging Machine (the VM) where you will install the tools, as described in the next two sections.</p></li><li><p>In the Icon Assignment tab, select an icon to assign to the layer. This icon represents the layer in the Layers Module.</p><ul><li>To use an existing image, select an image in the image box.</li><li>To import a new image, click <strong>Browse</strong> and select an image in PNG or JPG format.</li></ul></li><li><p>In the Confirm and Complete tab, review the details of the Layer, enter a comment if required, and click <strong>Create Layer</strong>. Any comments you enter will appear in the Information view Audit History.</p></li><li><p>At the bottom of the UI, expand the Tasks bar and double-click the task to show the full task description.</p><p>Once the task is complete, the location of the Packaging Disk is shown (example task message shown below).</p><p><img></img></p></li></ol>
Next, you can deploy the ***Packaging Machine***  for your Layer. The Packaging Machine is a temporary virtual machine where you install the software to include in the Layer being created.

##Power on the Packaging Machine in Citrix XenServer<a name="Power_on_the_Packaging_Machine_in_Citrix_XenServer"></a><a name="Copy_..238"></a>
<ol><li>Log into your XenServer client.</li><li><p>Back in the Unidesk Management Console (UMC), expand the Tasks bar at the bottom of the UI, and double-click the <em>Create Platform Layer</em> task to see the full Task Description (example below).</p><p><img></img></p></li><li>Use the instructions in the Task Description to navigate to the Packaging Machine in your XenCenter client.</li><li>While in the Infrastructure View, select your Packaging Machine's <strong>VM</strong> from the list of machines.</li><li><p>In the XenCenter UI in the panel on the right, choose the <strong>Console</strong> option for the VM.</p></li><li>Power on the VM.</li><li>Select the <strong>Click here to create a DVD drive</strong> link.</li><li>Power cycle the VM (yes, you have to in order to get the DVD Drive).</li><li>At the top of the console window, click the <em>DVD Drive 1</em> drop down menu and select the <strong>xs-tools.iso</strong>.</li><li><p>Install the XenTools. This will require multiple reboots as part of the tools installation. Once complete, you should see that you have access to all <em>XenTools</em>, as well as all of the <em>data</em> available under the Performance tab for your VM.</p><p><strong>Note:</strong> The XenCenter console uses <em>RFB</em> for it's console connection, which uses <em>Port 5900</em>. On Windows 2008 and Windows 7, this port is closed in the Firewall by default and should be opened so you can use the console to access any VMs</p></li></ol>

##Install the platform tools on the Packaging Machine<a name="Install_the_platform_tools_on_the_Packaging_Machine"></a>
Whether you are creating a Platform Layer or adding a version to it:
<ol><li><p>Remote log in to the Packaging Machine. Be sure to log in using the User account you used to create the OS.</p></li><li><p>Install the platform software and tools, along with any drivers, boot-level applications, or files needed. Keep in mind that the state of the software before you finalize the layer is what the image will use.</p><ul><li>If this Platform Layer is going to be used for packaging new layers, install and configure your hypervisor tools and settings.</li><li>If this Platform Layer is going to be used for publishing Layered Images, install and configure your hypervisor, provisioning service, and connection broker tools and settings.</li><li>If a software installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</li></ul></li><li><p>Make sure the Packaging Machine is in the state you want it to be in for users:</p><ul><li>If the tools you install require any post-installation setup or registration, complete those steps now.</li><li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li><li><p>When using PVS, if your OS image was activated using KMS, rearm KMS <em>just before you shut down</em></p><ol><li><p>Verify the Rearm count on the OS by running slmgr /dlv from a command prompt. The Rearm count must <em>not</em> be zero.</p><pre>slmgr /dlv</pre></li><li><p>Rearm KMS:</p><pre>slmgr /rearm</pre></li></ol></li></ul></li></ol>

##Verify the Layer and shut down the Packaging Machine<a name="Verify_the_Layer_and_shut_down_the_Packaging_Machine_..690"></a>
Once the software is installed on the Packaging Machine, it is important to verify that the Layer is ready to be finalized. To be ready for finalization, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the ***Shutdown For Finalize***  tool (icon below), which appears on the Packaging Machine's desktop.

To use the Shutdown For Finalize tool:
<ol><li>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</li><li>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages detailing the layer verification process.</li><li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation. For details, see Verifying Layers.</li><li><p>If you are using KMS licensing, once any pending operations are complete, be sure to rearm KMS yet again <em>just before you shutdown</em>. First, enter this command to verify that the Rearm count is > 0:</p><pre>slmgr /dlv</pre><p>Then, rearm KMS:</p><pre>slmgr /rearm</pre></li><li>Double-click the <em>Shutdown For Finalize</em> icon again to shut down the Packaging Machine.</li></ol>
The Layer should be ready to finalize.
###During the shutdown for finalization<a name="During_the_shutdown_for_finalization"></a><a name="Layer_Integrity_Check_..241"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:<a name="Layer_Integrity_Messages_..242"></a>
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p><strong>Note:</strong> If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
###Expediting a Microsoft NGen operation<a name="Expediting_a_Microsoft_NGen_operation_..691"></a><a name="Complete_MS_NGen_Operations_..243"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>

##Finalize the Layer<a name="Finalize_the_Layer_..692"></a>
To finalize the Layer, you import the installed software into the Platform Layer you prepared in the Unidesk Management Console (UMC).
<ol><li>Return to the UMC.</li><li>Select <strong>Layers > Platform Layers</strong>.</li><li>Select <span>Finalize</span> in the Action bar.</li><li>Monitor the Task bar to verify that the action completes successfully and that the layer is deployable.</li></ol>

#Create a Platform Layer (Network File Share Connector)<a name="Create_a_Platform_Layer_(Network_File_Share_Connector)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Prepare a new Platform Layer</p><p>Deploy a Packaging Machine</p><p>Install the required platform tools</p><p>Verify the Layer and shut down the Packaging Machine</p><p>Finalize the Layer</p></td></tr></tbody></table>
A Platform Layer includes the platform software and settings required to deploy images in your environment. For example, a Platform Layer for publishing to PVS in vSphere with XenApp as the broker would include the PVS Target Device Imaging software, vmTools, and the XenApp Virtual Delivery Agent Installer (and other platform-related software as well).
When do you need a Platform Layer?
<ul><li>When creating your App Layers and OS Layer Versions, you will need a Platform Layer for Packaging Layers, if you imported your OS image (aka gold image) from a different hypervisor than the one where the ELM is installed.</li><li>Whenever you publish a Layered Image, you will need a Platform Layer for Publishing.</li></ul>
You can create two kinds of Platform Layers:
<ul><li>Platform Layers for <em>publishing Layered Images</em> (Required)<ul><li>These Layers include the software and settings required for a Layered Image to run flawlessly in your environment.</li></ul></li><li>Platform Layers for <em>packaging Layers</em> (Required in some cases)<ul><li>These Layers include the hypervisor software and settings you need to easily install the software for your other layers on a VM in your hypervisor environment.</li></ul></li></ul>
##Prerequisites<a name="Prerequisites_..693"></a><a name="Other"></a>
<ul><li><p>Prerequisites for creating a Platform Layer for Packaging Layers</p><p>You need the <a href="platforms_for_publishing_pb_hy4.htm">hypervisor</a> software for your environment.</p></li><li><p>Prerequisites for creating a Platform Layer for publishing Layered Images</p><p>You need the <a href="platforms_for_publishing_pb_hy4.htm">hypervisor</a> prerequisites, plus the prerequisites for the <a href="platforms_for_publishing_pb_ps4.htm">provisioning service</a> and/or <a href="platforms_for_publishing_pb_bk4.htm">connection broker</a> software for your environment.</p></li></ul>
##Prepare a new Platform Layer<a name="Prepare_a_new_Platform_Layer_..694"></a><a name="Create2_..245"></a>
<ol><li><p>Select <strong>Layers > Platform Layers</strong> and select <strong>Create Platform Layer</strong> in the Action bar. This opens the Create Platform Layer wizard.</p></li><li><p>In the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. Optionally, you can also enter other values. For details, see more about these values <a href="#Create">below</a>.</p></li><li><p>In the OS Layer tab, select the OS Layer you want to associate with this Platform Layer.</p></li><li><p>In the Connector tab, choose the <strong>Network File Share</strong> for your Connector Configuration.</p></li><li><p>In the Platform Types tab, select the radio button that describes the purpose of this Platform Layer:</p><ul><li>For creating and updating Layers - <em>Only</em> required if you will create Layers on a different hypervisor than the one from which you imported your OS.</li><li>For publishing Layered Images - Required whenever you publish Layered Images.</li></ul><p>For more about these choices, see Platform Layer Essentials.</p></li><li><p>If this Platform Layer is for:</p><ul><li>Creating and updating Layers - Select the Hypervisor where you will be creating and updating (packaging) Layers.</li><li>Publishing Layered Images - Select the Hypervisor, Provisioning Service, and Connector Broker that make up the environment where you will be <em>publishing</em> images.</li></ul></li><li><p>In the Packaging Disk tab, enter a <strong>file name</strong> for the Packaging Disk, and select the disk format. This disk will be used for the Packaging Machine (the VM) where you will install the tools, as described in the next two sections.</p></li><li><p>In the Icon Assignment tab, select an icon to assign to the layer. This icon represents the layer in the Layers Module.</p><ul><li>To use an existing image, select an image in the image box.</li><li>To import a new image, click <strong>Browse</strong> and select an image in PNG or JPG format.</li></ul></li><li><p>In the Confirm and Complete tab, review the details of the App Layer, enter a comment if required, and click <strong>Create Layer</strong>. Any comments you enter will appear in the Information view Audit History.</p><p>A Boot disk and a Packaging disk are created, and the Tasks bar displays instructions to navigate to them.</p></li><li><p>Expand the Tasks bar at the bottom of the UI, and double-click the Packaging Disk task to show the full task description.</p><p>Once the disks have been created, the Task bar displays the location of the disks on the Network File Share: /Unidesk/Packaging Disks.</p><p><img></img></p></li></ol>
Next, you can deploy the Packaging Machine for your Layer.
##Deploy a Packaging Machine<a name="Deploy_a_Packaging_Machine_..695"></a><a name="Deploy_..246"></a>
The Packaging Machine is a temporary VM where you install the platform tools you want to include in the Layer.
###Create the Packaging Machine<a name="Create_the_Packaging_Machine"></a>
The Task Description (example shown in the last step above) contains the location in your environment where the disks for this Layer have been created.
<ol><li>Log into the client for your hypervisor.</li><li><p>Locate the Packaging disks in the following directory on the Network File Share:</p><p>\Unidesk\Packaging Disks</p></li><li><p>Copy the disks to the hypervisor where you will install the software for the Layer.</p><p><strong>Note:</strong> Even if the Packaging Disks in \Unidesk\Packaging Disks are already in the hypervisor where you will be installing the tools, we recommend copying the disks to another location. This is because when you use the disk to create a new VM, the directory will quickly become crowded with files generated by your hypervisor.</p><p><strong>Important:</strong> Do not copy the disk to the Finalize folder until it is ready to finalize. A disk in the Finalize folder cannot be attached to the new VM that you are going to create next.</p></li><li><p>In your hypervisor, create a VM from the <strong>Boot</strong> disk and name it <em>Layer_Name</em><strong>Boot</strong>.<em>xxx</em>.</p></li><li><p>In your hypervisor, select the VM, and attach the disk called <em>Layer_Name</em><strong>Pkg</strong>.<em>xxx</em> to the VM.</p></li><li><p>Create a virtual machine using the Packaging Disk as the boot disk. This is the Packaging Machine where you will install the application(s) to include in the layer.</p></li><li>Power on the Packaging Machine.</li></ol>
##Install the required platform tools<a name="Install_the_required_platform_tools_..696"></a><a name="Install_..247"></a>
This section explains how to install the tools your Layered Images will need to run your the target platform onto the Packaging Machine you just created. Keep in mind that the state of the software before you finalize the layer is what the image will use.
To install the tools for the selected platform:
<ol><li><p>Remote log in to the Packaging Machine you created. Be sure to log in using the User account you used to create the OS.</p></li><li><p>Install the tools that your Layered Image will need to run on vSphere and in PVS, along with any drivers, boot-level applications, or files needed.</p><p>If a software installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</p></li><li><p>Make sure the Packaging Machine is in the state you want it to be in when the image is booted:</p><ul><li>If the tools you install require any post-installation setup or registration, complete those steps now.</li><li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li></ul></li></ol>
Next, you'll need to shut down the Packaging Machine and verify that the Platform Layer is ready to finalize.
##Verify the Layer and shut down the Packaging Machine<a name="Verify_the_Layer_and_shut_down_the_Packaging_Machine_..697"></a><a name="Verify_..248"></a>
Once the tools are installed on the Packaging Machine, the next step is to verify that the Layer is ready to finalize. At this point, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the ***Shutdown For Finalize***  tool (icon below), which appears on the Packaging Machine's desktop.

To use the Shutdown For Finalize tool:
<ol><li><p>Copy the Packaging Machine to the Finalize folder on the Network File Share:</p><p>\Unidesk\Finalize</p></li><li>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</li><li>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages detailing the layer verification process.</li><li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Layer_Integrity_Check_..249">below</a>.</li><li>Once any pending operations are complete, double-click the <em>Shutdown For Finalize</em> icon again. This shuts down the Packaging Machine.</li></ol>
###Layer integrity messages you may see during the finalization process<a name="Layer_integrity_messages_you_may_see_during_the_finalization_process_..698"></a><a name="Layer_Integrity_Check_..249"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:<a name="Layer_Integrity_Messages_..250"></a>
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p><strong>Note:</strong> If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
###Expediting a Microsoft NGen operation<a name="Expediting_a_Microsoft_NGen_operation_..699"></a><a name="Complete_MS_NGen_Operations_..251"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>
##Finalize the Layer<a name="Finalize_the_Layer_..700"></a><a name="Finalize_..252"></a>
Once the platform tools are installed and the Packaging Machine has been verified and shut down, you are ready to finalize the layer.
***Note:***  When you finalize a Layer, Unidesk may delete the Packaging Machine to minimize storage space used.
<ol><li>Return to the Unidesk Management Console (UMC).</li><li>Select <strong>Layers > Platform Layers</strong>.</li><li>Select the Layer to finalize, and then select <strong>Finalize</strong> on the Action bar. The Layer is finalized and becomes Deployable.</li></ol>
When a layer is ready to finalize:
<ol><li>Return to the Unidesk Management Console.</li><li>Select <strong>Layers > Platform Layers</strong>.</li><li>Select the Platform Layer you just prepared, and select <span>Finalize</span> in the Action bar.</li><li><a href="#Layer_Integrity_Check_..249"></a> Monitor the Task bar and verify that the layer becomes deployable.</li></ol>
#Create a Platform Layer (Nutanix AHV)<a name="Create_a_Platform_Layer_(Nutanix_AHV)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Prepare a new Platform Layer</p><p>Install the required platform tools</p><p>Verify the Layer and shut down the Packaging Machine</p><p>Finalize the Layer</p></td></tr></tbody></table>
For cross-platform deployments, a Platform Layer includes the platform software and settings required to deploy images in your environment.
You can create two kinds of Platform Layers:
<ul><li><p>Platform Layers for <em>publishing Layered Images</em> (Required) - These Layers include the software and settings required for a Layered Image to run flawlessly in your environment. Use this type of Platform Layer when publishing Layered Images to a platform other than the one where you created the OS Layer.</p></li><li><p>Platform Layers for <em>packaging Layers</em> (Required in some cases) - These Layers include the hypervisor software and settings you need to easily install the software for your other layers on a VM in your hypervisor environment. Use this type of Platform Layer when creating Layers on a platform other than the one from which you imported the OS for your OS Layer.</p></li></ul>
##Prerequisites<a name="Prerequisites_..701"></a><a name="Prerequi_..253"></a>
###Nutanix AHV (Acropolis) prerequisites<a name="Nutanix_AHV(SPACE)(Acropolis)_prerequisites_..702"></a>
<ul><li><p><strong>Nutanix Prism account and privileges</strong></p><ul><li>A Nutanix Prism account (new or existing) to use for Unidesk.</li><li>The account must have privileges to perform the following operations:<ul><li><p>VM operations:</p><ul><li><p>clone</p></li><li><p>delete</p></li><li><p>power on/off</p></li><li><p>attach virtual disks</p></li></ul></li><li><p>Image operations:</p><ul><li><p>create</p></li><li><p>update (aka upload)</p></li><li><p>delete</p></li></ul></li><li>Virtual disks<ul><li>create</li><li>attach to VMs</li></ul></li></ul></li></ul></li><li><p><strong>Nutanix AHV software and settings</strong></p><p>Access to the VM Mobility Tools to install on the layer.</p></li><li><p><strong>Nutanix AHV resource information</strong></p><p>The Acropolis Server info listed in <a href="#Connector_Configuration_(AND)_Optional_Script__(Nutanix_AHV)">Nutanix AHV Connector Configuration</a> or <a href="#Connector_Configuration_(AND)_Optional_Script__(MCS_for_Nutanix_AHV)">MCS for Nutanix AHV Connector Configuration</a>.</p></li><li><p><strong>Nutanix AHV Connector</strong> </p><p>When creating Layers for the Nutanix environment, you must use a Nutanix AHV Connector Configuration. The MCS for Nutanix AHV Connector does not support Layer creation.</p></li></ul>
##Prepare a new Platform Layer<a name="Prepare_a_new_Platform_Layer_..703"></a><a name="Create2_..254"></a>
<ol><li><p>Select <strong>Layers > Platform Layers</strong> and select <strong>Create Platform Layer</strong> in the Action bar. This opens the Create Platform Layer wizard.</p></li><li><p>In the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. Optionally, you can also enter other values.</p></li><li><p>In the OS Layer tab, select the OS Layer you want to associate with this Platform Layer.</p></li><li><p>In the Connector tab, choose a Connector Configuration for the platform where you are creating this layer. If the configuration you need isn't listed, Click <strong>New</strong>, select a Nutanix AHV Connector from this list, and <a href="#Add_a_new_Connector_Configuration">Add a Configuration</a> for it.</p><p><strong>Important:</strong> You must use a Nutanix AHV Connector to create a Layer in Nutanix. The MCS for Nutanix AHV Connector can only be used for publishing Layered Images, not for creating Layers.</p></li><li><p>In the Platform Types tab, select the radio button that describes the purpose of this Platform Layer: to create and update layers, or to publish Layered Images. For more about these choices, see Platform Layers.</p></li><li><p>From the dropdown menus, select the platform(s) you are using.</p></li><li><p>In the Packaging Disk tab, enter a <strong>file name</strong> for the Packaging Disk, and select the disk format. This disk will be used for the Packaging Machine (the VM) where you will install the tools, as described in the next two sections.</p></li><li><p>In the Icon Assignment tab, select an icon to assign to the layer. This icon represents the layer in the Layers Module.</p><ul><li>To use an existing image, select an image in the image box.</li><li>To import a new image, click <strong>Browse</strong> and select an image in PNG or JPG format.</li></ul></li><li><p>In the Confirm and Complete tab, review the details of the App Layer, enter a comment if required, and click <strong>Create Layer</strong>. Any comments you enter will appear in the Information view Audit History.</p></li><li><p>Expand the Tasks bar at the bottom of the UI, and double-click the Packaging Disk task to show the full task description.</p><p>Once the Packaging Disk has been created, the Task bar displays the location of the Packaging Disk in your environment (example task message shown below).</p><p><img></img></p></li></ol>
Next, you can access the Packaging Machine for your Layer, and install the software for your environment.
The Packaging Machine is a virtual machine where you install the tools for your selected environment(s). It is a temporary VM that will be deleted once the new Platform Layer has been finalized. When the Unidesk software powers on the Packaging Machine for you.
##Access the Packaging Machine in Nutanix AHV<a name="Access_the_Packaging_Machine_in_Nutanix_AHV_..704"></a><a name="Copy_..255"></a>
<ol><li>Log into Nutanix Prism.</li><li><p>Back in the Unidesk Management Console (UMC), expand the Tasks bar at the bottom of the UI, and double-click the <em>Create Platform Layer</em> task to see the full Task Description (example below).</p><p><img></img></p></li><li>Use the instructions in the Task Description to navigate to the Packaging Machine in Prism.</li></ol>
##Install the required platform tools<a name="Install_the_required_platform_tools_..705"></a><a name="Install_..256"></a>
If this is a Platform Layer for Publishing and you created the OS Layer using a different hypervisor than Nutanix AHV, install the VM Mobility Tools. (If the OS was created in Nutanix, it already has the tools installed.) The tools installation may require multiple reboots. Once complete, you should see that you have access to the tools, as well as all of the ***data***  available under the Performance tab for your VM.
If this is a Platform Layer for Packaging a Layer, install the application software, and configure the app settings as you want them to be for the user.
When installing your platform software on the Packaging Machine, keep in mind that the state of the software before you finalize the layer is what the image will use.
To install the tools for the selected platform:
<ol><li><p>Remote log in to the Packaging Machine you created. Be sure to log in using the User account you used to create the OS.</p></li><li><p>Install the platform software and tools, along with any drivers, boot-level applications, or files needed.</p><ul><li>If this Platform Layer is going to be used for packaging new layers, install and configure your hypervisor tools and settings.</li><li>If this Platform Layer is going to be used for publishing Layered Images, install and configure your hypervisor, provisioning service, and connection broker tools and settings.</li><li>If a software installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</li></ul></li><li><p>Install an empty <em>flag</em> file called <span>Shutdown_published_Image.txt</span> in the following directory:</p><pre>  c:\windows\setup\scripts\kmsdir</pre><p>This enables automated shutdown of the OS.</p></li><li><p>Make sure the Packaging Machine is in the state you want it to be in when the image is booted:</p><ul><li>If the tools you install require any post-installation setup or registration, complete those steps now.</li><li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li></ul></li></ol>
Next, you'll need to shut down the Packaging Machine and verify that the Platform Layer is ready to finalize.
##Verify the Layer and shut down the Packaging Machine<a name="Verify_the_Layer_and_shut_down_the_Packaging_Machine_..706"></a><a name="Verify_..257"></a>
Once the tools are installed on the Packaging Machine, the next step is to verify that the Layer is ready to finalize. At this point, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the ***Shutdown For Finalize***  tool (icon below), which appears on the Packaging Machine's desktop.

To use the Shutdown For Finalize tool:
<ol><li><p>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</p></li><li><p>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages detailing the layer verification process.</p></li><li><p>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Layer_Integrity_Check_..258">below</a>.</p></li><li><p>Once any pending operations are complete, double-click the <em>Shutdown For Finalize</em> icon again. This shuts down the Packaging Machine.</p></li></ol>
The ***Shutdown for Finalize***  task will remain in the ***Action Required***  state until you finalize the Layer.
The Layer is now ready to finalize.
###Layer integrity messages you may see during the finalization process<a name="Layer_integrity_messages_you_may_see_during_the_finalization_process_..707"></a><a name="Layer_Integrity_Check_..258"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:<a name="Layer_Integrity_Messages_..259"></a>
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p><strong>Note:</strong> If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
###Expediting a Microsoft NGen operation<a name="Expediting_a_Microsoft_NGen_operation_..708"></a><a name="Complete_MS_NGen_Operations_..260"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>
##Finalize the Layer<a name="Finalize_the_Layer_..709"></a><a name="Finalize_..261"></a>
Once the Packaging Machine is created, the tools are installed and ready to finalize, and you have shut down the machine, you'll need to finalize the layer.
When a layer is ready to finalize:
<ol><li>Return to the Unidesk Management Console.</li><li>Select <strong>Layers > Platform Layers</strong>, and select the Platform Layer you just prepared.</li><li>Select <span>Finalize</span> in the Action bar.</li><li><a href="#Layer_Integrity_Check_..258"></a> Monitor the Task bar to verify that the action completes successfully and that the layer is deployable.</li></ol>

#Create a Platform Layer (VMware Horizon for vSphere)<a name="Create_a_Platform_Layer_(VMware_Horizon_for_vSphere)"></a>
In this article:
<table><tbody><tr><td><p> </p><p>Prepare a new Platform Layer</p><p>Deploy a Packaging Machine</p><p>Create a Platform Layer (VMware Horizon for vSphere)</p><p>Verify the Layer and shut down the Packaging Machine</p><p><a href="#Finalize_..270">Finalize the Layer</a></p></td></tr></tbody></table>
A Platform Layer includes the platform software and settings required to deploy images in your environment. For example, a Platform Layer for publishing to VMware Horizon in vSphere with XenDesktop as the broker would include the VMware View Agent, vmTools, and other platform-related software..
This article explains the next steps to create a Platform Layer, based on your connector and platform choices. If you need more information than is included here, check these other Unidesk sources: [Layer essentials (Unidesk Learning Center)](#Layer_Essentials)[ and the ](#Layer_Essentials)[Unidesk Forum](http://www.unidesk.com/forum/unidesk-4)[.](http://www.unidesk.com/forum/unidesk-4)
A Platform Layer should include the platform software and settings required to deploy images in your environment, given your choice of hypervisor, provisioning service, and connection broker.
You can create two kinds of Platform Layers:
<ul><li><p>Platform Layers for <em>publishing Layered Images</em> (Required) - A Platform Layer for <em>publishing</em> is used in Image Templates to ensure that your published Layered Images include the software and settings required to run flawlessly in your environment.</p></li><li><p>Platform Layers for <em>packaging Layers</em> (Required in some cases) - A Platform Layer for <em>packaging</em> is used for creating App Layers and OS Layer Versions in your hypervisor environment. This Layer includes the hypervisor software and settings required to easily install the app or OS update on a VM in the selected hypervisor.</p></li></ul>

##Prerequisites<a name="Prerequisites_..710"></a>
When creating a Platform Layer, the software installers for your platform must be available in a location that's accessible to the Packaging Machine VM where you are going to create the Layer. As summarized in the following table, the prerequisites vary based on the ***type***  of Platform Layer you choose to create.
<table><thead><tr><th>Type of Platform Layer</th><th>Prerequisites</th></tr></thead><tbody><tr><td>Publishing Layered Images</td><td><p>Software installers, and settings you use for your:</p><ul><li>Hypervisor</li><li>Provisioning service</li><li>Connection broker</li></ul></td></tr><tr><td>Packaging Layers</td><td><p>The software and settings for your:</p><ul><li>Hypervisor</li></ul><p>For example, your hypervisor installer and settings.</p><p><strong>Note:</strong> You only need a Platform Layer for <em>packaging</em> Layers if you are creating your Layers on a different hypervisor than the one from which you imported your OS image.</p></td></tr></tbody></table>
###VMware Horizon View Composer prerequisites<a name="VMware_Horizon_View_Composer_prerequisites"></a>
When creating a Platform Layer for publishing images to an MCS environment, you need:
<ul><li><p><a href="#Create_an_OS_Layer">An OS Layer</a></p></li><li><p><strong>Network access to Unidesk Tools</strong></p><p>Access from the Platform Layer Packaging Machine VM to the Unidesk Tools download (available on the Unidesk Download page).</p></li><li><p><strong>VMware View Agent installed on the Platform layer</strong></p><p>The VMware View Agent installer for the Windows OS you are using must be installed on the Platform Layer.</p></li><li><p><strong>Unidesk Agent and PowerShell Snap-in, if using a Script as part of the Connector Configuration</strong> </p><p>As part of the Connector Configuration, if you include a script to run on the newly published Layered Image, you will need the Unidesk Agent and PowerShell Snap-in installed and running.</p></li><li><p><strong>VMware Horizon View Composer resource information</strong></p><p>The Horizon View info listed in this <a href="#Connector_Configuration_(AND)_Optional_Script__(VMware_Horizon_View_for_vSphere)">VMware Horizon for vSphere Connector Configuration</a> topic.</p></li><li><p><strong>vSphere resource information</strong></p><p>The vSphere info listed in <a href="#Connector_Configuration_(AND)_Optional_Script__(vSphere)">vSphere Connector Configuration</a>.</p></li><li><p><strong>vSphere software and settings</strong></p><p>Access to the vSphere software to install on the layer.</p></li></ul>
##Prepare a new Platform Layer<a name="Prepare_a_new_Platform_Layer_..711"></a><a name="Create2_..263"></a>
To create a Platform Layer you prepare the layer using the Create Platform Layer wizard, deploy a Packaging Machine in your environment, install the tools and configure the settings for Horizon View, and finalize the Layer.
<ol><li><p>Select <strong>Layers > Platform Layers</strong> and select <strong>Create Platform Layer</strong> in the Action bar. This opens the Create Platform Layer wizard.</p></li><li><p>In the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. Optionally, you can also enter other values. For details, see more about these values <a href="#Create">below</a>.</p></li><li><p>In the OS Layer tab, select the OS Layer you want to associate with this Platform Layer.</p></li><li><p>In the Connector tab, choose a Connector Configuration for the platform where you are creating this layer. If the configuration you need isn't listed, add a <strong>New</strong> <a href="#Welcome_to_Citrix_App_Layering_4">Connector Configuration</a> and select it from this list.</p><p>Example: If you are creating the layer in your vSphere environment, select the vSphere connector with the information needed to access the temporary storage location where you will package this layer.</p></li><li><p>In the Recipe Associations tab, select all of the platforms to which you will be publishing the Layered Image.</p><p>Example: If you want to use this Platform Layer to publish Layered Images to both vSphere and Azure, select both environments.</p></li><li><p>In the Packaging Disk tab, enter a <strong>file name</strong> for the Packaging Disk, and select the disk format. This disk will be used for the Packaging Machine (the VM) where you will install the tools, as described in the next two sections.</p></li><li><p>In the Icon Assignment tab, select an icon to assign to the layer. This icon represents the layer in the Layers Module.</p><ul><li>To use an existing image, select an image in the image box.</li><li>To import a new image, click <strong>Browse</strong> and select an image in PNG or JPG format.</li></ul></li><li><p>In the Confirm and Complete tab, review the details of the App Layer, enter a comment if required, and click <strong>Create Layer</strong>. Any comments you enter will appear in the Information view Audit History.</p></li><li><p>Expand the Tasks bar at the bottom of the UI, and double-click the Packaging Disk task to show the full task description.</p><p>Once the Packaging Disk has been created, the Task bar displays the location of the Packaging Disk in your environment.</p><p><img></img></p></li></ol>
Next, you can deploy the Packaging Machine for your Layer.
##Deploy a Packaging Machine<a name="Deploy_a_Packaging_Machine_..712"></a><a name="Deploy_..264"></a>
The Packaging Machine is a virtual machine where you install the tools for your selected environment.
***Note:***  The Packaging Machine is a temporary VM that will be deleted once the new Platform Layer has been finalized.
###Log into the Packaging Machine<a name="Log_into_the_Packaging_Machine_..713"></a>
The Task Description (example shown in the last step above) contains the location of the Packaging Machine in your environment.
<ol><li>Log into your vSphere web client.</li><li><p>Back in the Unidesk Management Console, use the instructions in the expanded Packaging Disk Task shown below to navigate to the Packaging Machine.</p><p><img></img></p></li><li>Power on the Packaging Machine.</li></ol>

##Install the required platform tools<a name="Install_the_required_platform_tools_..714"></a>
This section explains how to install the platform software to be used by the Platform Layer. The platform software to install includes the provisioning server software and/or connection broker software that your Layered Images will need to run in the target environment.
###Platform software to install<a name="Platform_software_to_install_..715"></a>
You need the installers for your hypervisor, provisioning service, and connection broker.
If you are using a supported Unidesk Connector to connect to your environment, you will install the provisioning service and/or connection broker software on the Packaging Machine that Unidesk created in that environment. Otherwise, you will be installing the software on a VM in your hypervisor of choice, moving the VM to the Unidesk network file share, from which you can import the VM into Unidesk.
Keep in mind that the state of the software before you finalize the layer is what the image will use.
<ol><li><p>Remote log in to the Packaging Machine you created. Be sure to log in using the User account you used to create the OS.</p></li><li><p>Install the tools that your Layered Image will need to run on vSphere and in PVS, along with any drivers, boot-level applications, or files needed.</p><p>If a software installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</p></li><li><p>Make sure the Packaging Machine is in the state you want it to be in when the image is booted:</p><ul><li>If the tools you install require any post-installation setup or registration, complete those steps now.</li><li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li></ul></li></ol>
Next, you'll need to shut down the Packaging Machine and verify that the Platform Layer is ready to finalize.
Verify the Layer and shut down the Packaging Machine<a name="Verify_..266"></a>
Once the tools are installed on the Packaging Machine, the next step is to verify that the Layer is ready to finalize. At this point, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the ***Shutdown For Finalize***  tool (icon below), which appears on the Packaging Machine's desktop.

To use the Shutdown For Finalize tool:
<ol><li>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</li><li>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages detailing the layer verification process.</li><li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Layer_Integrity_Check_..267">below</a>.</li><li>Once any pending operations are complete, double-click the <em>Shutdown For Finalize</em> icon again. This shuts down the Packaging Machine.</li></ol>
The Layer is now ready to finalize.
###Layer integrity messages you may see during the finalization process<a name="Layer_integrity_messages_you_may_see_during_the_finalization_process_..716"></a><a name="Layer_Integrity_Check_..267"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:<a name="Layer_Integrity_Messages_..268"></a>
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p><strong>Note:</strong> If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
###Expediting a Microsoft NGen operation<a name="Expediting_a_Microsoft_NGen_operation_..717"></a><a name="Complete_MS_NGen_Operations_..269"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>

##Finalize the Layer<a name="Finalize_the_Layer_..718"></a>
Once the Packaging Machine is created, the software is installed and ready to finalize, and you have shut down the machine, you'll need to finalize the Layer.
***Note:***  When you finalize a Layer, Unidesk may delete the Packaging Machine so as not to incur extra cost for storage.
When the Layer has been verified and is ready to finalize:
<ol><li>Return to the Unidesk Management Console.</li><li>Select <strong>Layers >App Layers</strong>, and then the layer you just prepared.</li><li>Select <span>Finalize</span> in the Action bar.</li><li><a href="#Layer_Integrity_Check_..267"></a> Monitor the Task bar to verify that the action completes successfully and that the Layer is deployable.</li></ol>



#Create a Platform Layer (vSphere connector)<a name="Create_a_Platform_Layer_(vSphere_connector)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Prepare a new Platform Layer</p><p>Connect to and log into the Packaging Machine</p><p>Install the required platform tools</p><p>Verify the Layer and shut down the Packaging Machine</p><p> </p></td></tr></tbody></table>
A Platform Layer is intended to include the platform software and settings required to deploy images in your environment. For example, a Platform Layer for publishing to PVS in vSphere with XenApp as the broker would include the PVS Target Device Imaging software, vmTools, and the XenApp Virtual Delivery Agent Installer (and other platform-related software as well).
You can create two kinds of Platform Layers:
<ul><li><p>Platform Layers for <em>publishing Layered Images</em> (Required) - These Layers include the software and settings required for a Layered Image to run flawlessly in your environment.</p></li><li><p>Platform Layers for <em>packaging Layers</em> (Required in some cases) - These Layers include the hypervisor software and settings you need to easily install the software for your other layers on a VM in your hypervisor environment.</p></li></ul>
The general steps for creating a Platform Layer are:
<ol><li>Prepare a Platform Layer</li><li>Connect to and log into the Packaging Machine</li><li>Install the Platform Software</li><li>Verify the Layer and Shutdown the Packaging Machine</li><li>Copy the Packaging Machine to the ELM's Network File Share (if needed)</li><li>Finalize the Layer</li></ol>
##Prerequisites<a name="Prerequisites_..719"></a><a name="Prerequi_..271"></a>

###vSphere prerequisites<a name="vSphere_prerequisites_..720"></a>
<ul><li><p><strong>Network access to Unidesk Tools</strong></p><p>Access from the Packaging Machine VM in vSphere to the Unidesk Tools download (available on the Unidesk Download page).</p></li><li><p><strong>vSphere software and settings</strong></p><p>Access to the vSphere software to install on the layer.</p></li><li><p><strong>vSphere resource information</strong></p><p>The vSphere info listed in <a href="#Connector_Configuration_(AND)_Optional_Script__(vSphere)">vSphere Connector Configuration</a>.</p></li></ul>
###Other prerequisites<a name="Other_prerequisites"></a><a name="Other_..272"></a>
If you are creating a Platform Layer to use when publishing Layered Images, you need the above prerequisites plus the prerequisites for the provisioning service and connection broker software for your environment.
##Prepare a new Platform Layer<a name="Prepare_a_new_Platform_Layer_..721"></a><a name="Create2_..273"></a>
<ol><li><p>Select <strong>Layers > Platform Layers</strong> and select <strong>Create Platform Layer</strong> in the Action bar. This opens the Create Platform Layer wizard.</p></li><li><p>In the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. Optionally, you can also enter other values.</p></li><li><p>In the OS Layer tab, select the OS Layer you want to associate with this Platform Layer.</p></li><li><p>In the Connector tab, choose a Connector Configuration for the platform where you are creating this layer. If the configuration you need isn't listed, Click <strong>New</strong>, select your platform from this list, and <a href="#Add_a_new_Connector_Configuration">Add a Configuration</a> for it.</p><p><strong>Example:</strong> If you are creating the layer in a vSphere environment, select the vSphere connector with the information needed to access the location where you will package this layer.</p></li><li><p>In the Platform Types tab, select the radio button that describes the purpose of this Platform Layer: to create and update layers, or to publish Layered Images. For more about these choices, see Platform Layers.</p></li><li><p>From the dropdown menus, select the platform(s) you are using.</p></li><li><p>In the Packaging Disk tab, enter a <strong>file name</strong> for the Packaging Disk, and select the disk format. This disk will be used for the Packaging Machine (the VM) where you will install the tools, as described in the next two sections.</p></li><li><p>In the Icon Assignment tab, select an icon to assign to the layer. This icon represents the layer in the Layers Module.</p><ul><li>To use an existing image, select an image in the image box.</li><li>To import a new image, click <strong>Browse</strong> and select an image in PNG or JPG format.</li></ul></li><li><p>In the Confirm and Complete tab, review the details of the App Layer, enter a comment if required, and click <strong>Create Layer</strong>. Any comments you enter will appear in the Information view Audit History.</p></li><li><p>Expand the Tasks bar at the bottom of the UI, and double-click the Packaging Disk task to show the full task description.</p><p>Once the Packaging Disk has been created, the Task bar displays the location of the Packaging Disk in your environment (example task message shown below).</p><p><img></img></p></li></ol>
Next, you can deploy the Packaging Machine for your Layer.
The Packaging Machine is a virtual machine where you install the tools for your selected environment(s). It is a temporary VM that will be deleted once the new Platform Layer has been finalized. When the Unidesk software powers on the Packaging Machine for you.
##Connect to and log into the Packaging Machine<a name="Connect_to_and_log_into_the_Packaging_Machine"></a><a name="Connect"></a>
<ol><li><p>Expand the Tasks bar at the bottom of the UI, and double-click the Packaging Disk task to show the full task description.</p><p>Once the Packaging Disk has been created, the Task bar displays the location of the Packaging Disk in your environment (example task message shown below).</p><p><img></img></p></li></ol>

##Install the required platform tools<a name="Install_the_required_platform_tools_..722"></a><a name="Install_..274"></a>
This section explains how to install your platform software onto the Packaging Machine. Keep in mind that the state of the software before you finalize the layer is what the image will use.
To install the tools for the selected platform:
<ol><li><p>Remote log in to the Packaging Machine you created. Be sure to log in using the User account you used to create the OS.</p></li><li><p>Install the platform software and tools, along with any drivers, boot-level applications, or files needed.</p><ul><li>If this Platform Layer is going to be used for packaging new layers, install and configure your hypervisor tools and settings.</li><li>If this Platform Layer is going to be used for publishing Layered Images, install and configure your hypervisor, provisioning service, and connection broker tools and settings.</li><li>If a software installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</li></ul></li><li><p>Make sure the Packaging Machine is in the state you want it to be in when the image is booted:</p><ul><li>If the tools you install require any post-installation setup or registration, complete those steps now.</li><li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li></ul></li></ol>
Next, you'll need to shut down the Packaging Machine and verify that the Platform Layer is ready to finalize.
##Verify the Layer and shut down the Packaging Machine<a name="Verify_the_Layer_and_shut_down_the_Packaging_Machine_..723"></a><a name="Verify_..275"></a>
Once the tools are installed on the Packaging Machine, the next step is to verify that the Layer is ready to finalize. At this point, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the ***Shutdown For Finalize***  tool (icon below), which appears on the Packaging Machine's desktop.

To use the Shutdown For Finalize tool:
<ol><li>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</li><li>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages detailing the layer verification process.</li><li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Layer_Integrity_Check_..276">below</a>.</li><li>Once any pending operations are complete, double-click the <em>Shutdown For Finalize</em> icon again. This shuts down the Packaging Machine.</li></ol>
The Layer is now ready to finalize.
###Layer integrity messages you may see during the finalization process<a name="Layer_integrity_messages_you_may_see_during_the_finalization_process_..724"></a><a name="Layer_Integrity_Check_..276"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:<a name="Layer_Integrity_Messages_..277"></a>
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p><strong>Note:</strong> If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
###Expediting a Microsoft NGen operation<a name="Expediting_a_Microsoft_NGen_operation_..725"></a><a name="Complete_MS_NGen_Operations_..278"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>

##Finalize the Layer<a name="Finalize_the_Layer_..726"></a>
To finalize the Layer, you import the installed software into the Platform Layer you prepared in the Unidesk Management Console (UMC).
<ol><li>Return to the UMC.</li><li>Select <strong>Layers > Platform Layers</strong>.</li><li>Select <span>Finalize</span> in the Action bar.</li><li>Monitor the Task bar to verify that the action completes successfully and that the layer is deployable.</li></ol>

#App Layers<a name="App_Layers"></a>
Would you like to create an App Layer, assign one to Layered Images or to specific users, or learn how to layer some of the more challenging apps (most are easy to layer)?




#Create an App Layer<a name="Create_an_App_Layer"></a>
What type of Connector are you using to create this App Layer?




#Create an App Layer (vSphere)<a name="Create_an_App_Layer_(vSphere)"></a>
In this article:
Before you start
Prepare a new App Layer
[Install the software on the Packaging Machine](#Install_..287)
Finalize the Layer
Reference: Create App Layer Wizard values
An App Layer is a bootable software image (virtual disk) containing one or more applications that you can use in any number of Layered Images. When publishing a Layered Image, you can combine an App Layer with the OS Layer used to create it, other App Layers, and a Platform Layer.
To create an App Layer, you open the Create Layer wizard, deploy a Packaging Machine in your environment, then install the application(s). Once the application(s) are installed, you finalize the Layer.
A Packaging Machine is a VM where you install the application(s) that will be included in the Layer. Unidesk creates the Packaging Machine in the location and using the credentials you supply by choosing the Platform Target (hypervisor) and selecting a Connector Configuration containing this information. If you don't yet have the Connector Configuration you need, you can add a new one, as described in the steps below.
##Before you start<a name="Before_you_start_..727"></a><a name="Before_..280"></a>
###Requirements<a name="Requirements_..728"></a>
To create an App Layer, you need:
<ul><li><a href="#Create_an_OS_Layer">Create an OS Layer</a></li></ul>
###Optional<a name="Optional"></a>
Before you create an App Layer, you may also want to create resources that facilitate the application installation process. These resources are for temporary use during installation only, and will not be used to deliver the application.
<ul><li>Prerequisite Layer</li><li>Platform Layer (Only required if creating App Layers on a hypervisor other than the one from which you imported your OS Layer)</li><li>Run Once Script</li></ul>
If the application you install affects boot-level components, you'll need to restart the Packaging Machine as part of finalizing the layer or version.
####Prerequisite Layer<a name="Prerequi_..281"></a>
Prerequisite Layers let you include existing App Layers on the Packaging Disk when creating or adding a version to an App Layer. Prerequisite Layers ***should only be used if they are required*** , since it is possible that the prerequisite applications will pull something into the Layer that is not required for the current application deployment, and which may cause conflict in the future.
Reasons to consider using Prerequisite Layers:
<ul><li>The application you are installing requires another application during installation. For example, if you are installing an application that requires Java and you have Java in a separate layer.</li><li>The add-in or plugin you are installing adds settings to an application. For example, when installing an Office add-in, you would use your Microsoft Office App Layer as a prerequisite layer.</li><li>Two applications modify the same registry key, and the second application must add to an existing key rather than replace it. For example, Citrix Agent and Imprivata software both modify login keys in Windows.</li></ul>
***Note:***  Some of these issues can also be handled by putting the two applications in the same layer.
####Platform Layer (Only required if creating App Layers on a hypervisor other than the one from which you imported your OS Layer)<a name="Platform_..282"></a>
If you are creating App Layers and Versions on a different hypervisor than the one you used to create your OS Layer, you should consider creating a Platform Layer with the hypervisor tools and hardware settings that will make it easy to install and package applications in your environment.
####Run Once Script<a name="Run_..283"></a>
You can include a Run Once script in an App Layer. This allows you to run a script the first time any Layered Image that includes the App Layer boots. If the App Layer is elastically layered, the Run Once script runs when the App Layer Disk is mounted. Run Once scripts are typically used for apps, such as MS Office, that require license activation on the first boot.
####Layer Caching for faster App Layer creation<a name="Layer_caching"></a>
If you will be creating multiple App Layers that use the same OS Layer, Prerquisite Layer(s), and Platform Layer, you can save significant time by setting the Layer Disk Cache Size in the vSphere Connector. If Cache Size is set to a value greater than 0, the first time you create an App Layer with a specific OS Layer, Prerequisite Layer(s) and Platform Layer, Unidesk will save a template in the cache that consists of the boot disk and the empty packaging disk. The next time you create an App Layer that uses the same OS Layer, Prerequisite Layer(s) and Platform Layer, Unidesk will re-use this template, thereby significantly cutting the time it takes to create this App Layer in half.
Please note that if you create an App Layer that uses a different OS Layer, Prerequisite Layer(s) or Platform Layers from what is saved in the template, Unidesk will create a new template and store it in cache.
The size that you need to set for your cache depends on how many different combinations of OS Layers, Prerequisite Layer(s), Platform Layer combinations and therefore how many cached templates you will use as you layer various Apps. To estimate the space required for each template you can you can determine how much space a Boot disk will use by selecting the i for the OS Layer you are using and observing the Maximum Layer Size value in the Version Information section.
Likewise, you can obtain the Pkg disk size for an existing Application/Platform layer using the same approach. When creating new layers, you can set the Max Layer Size used by setting the Max Layer Size (GB) field in the Create Layer Wizard. By looking at the size of your existing layers, and estimating how many layers you are going to be creating/editing you can determine how large to set the Cache Size in your connector configuration.
##Prepare a new App Layer<a name="Prepare_a_new_App_Layer"></a><a name="Create2_..284"></a>
<ol><li><p>Select <strong>Layers > App Layers</strong> and select <strong>Create Layer</strong> in the Action bar. This opens the Create Layer wizard.</p></li><li><p>In the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. Optionally, you can also enter other values. For details, see more about these values <a href="#Create_..293">below</a>.</p></li><li><p>In the OS Layer tab, select the OS Layer you want to associate with this App Layer.</p></li><li><p>(Optional) In the Prerequisite Layers tab, if the application you are layering requires other App Layers to be present during installation, select the <strong>Include Prerequisite Layers</strong> check box, and pick the necessary App Layer(s).</p><p><strong>Notes:</strong> </p><ul><li>Prerequisite layers are used while installing applications, and are <em>not included</em> in the App Layer.</li><li>Prerequisite layers are <em>not</em> included by default when adding a new <em>Version</em> to this App Layer. So, when you add a new Version to this App Layer, you must choose the Prerequisite Layers again, if needed.</li><li>The App Layer you are creating and each of its Prerequisite Layers must be associated with the selected OS Layer.</li></ul></li><li><p>In the Connector tab, choose a <strong>Platform Connector Configuration</strong> that contains the credentials for the platform where you plan to build the Layer, along with the storage location. If the configuration you need isn't listed, add a <strong>New</strong> <a href="#Connector_Configuration_(AND)_Optional_Script__(vSphere)">Connector Configuration</a> and select it from this list.</p><p>Example: If you're using the vSphere environment to create the Layer, select the vSphere connector with the credentials and location required to access the location where you want to build the Layer.</p></li><li><p>In the Platform Layer tab you can select a Platform Layer containing the tools and hardware settings that you need to install and package an application during Layer creation. This selection is only used during layer creation. Once created, the Layer can be used in Layered Images published to any platform.</p></li><li><p>In the Packaging Disk tab, enter a <strong>file name</strong> for the Packaging Disk, and select the disk format. This disk will be used for the Packaging Machine (the VM) where you will install the application, as described in the next two sections.</p></li><li><p>In the Icon Assignment tab, select an icon to assign to the layer. This icon represents the layer in the Layers Module.</p><ul><li>To use an existing image, select an image in the image box.</li><li>To import a new image, click <strong>Browse</strong> and select an image in PNG or JPG format.</li></ul></li><li><p>In the Confirm and Complete tab, review the details of the App Layer, enter a comment if required, and click <strong>Create Layer</strong>. Any comments you enter will appear in the Information view Audit History. Once the Packaging Disk has been created, the Task bar displays instructions to navigate to the Packaging Machine in vSphere.</p></li></ol>
Next, you can log into the Packaging Machine for your Layer, and install the software for the layer on it.

##Install the software on the Packaging Machine<a name="Install_the_software_on_the_Packaging_Machine"></a><a name="Install2"></a>
When you've completed the Layer wizard, Unidesk creates a Packaging Machine in your environment, in the location defined in the Connector Configuration. The Packaging Machine is a virtual machine where you install the software to be included in the layer.
***Note:***  The Packaging Machine is a temporary VM that will be deleted once the new Platform Layer has been finalized.
###Log into the Packaging Machine<a name="Log_into_the_Packaging_Machine_..729"></a><a name="Deploy_..286"></a>
<ol><li><p>Log into your vSphere web client.</p></li><li><p>Back in the Unidesk Management Console, expand the Tasks bar at the bottom of the UI, and double-click the <em>Create App Layer</em> task to see the full Task Description.</p></li><li><p>Use the instructions in the Task Description to navigate to the Packaging Machine in your vSphere web client.</p><p>The Packaging Machine will be powered on.</p></li></ol>
###Install the Application(s)<a name="Install_the_Application(s)"></a><a name="Install_..287"></a>
When installing your application(s) on the Packaging Machine, leave each application as you want users to see it when they log in. The state of the applications when you finalize the layer is what users experience when they access the application. More guidance about this is included in the steps below.
<ol><li><p>Remote log in to the Packaging Machine in vSphere. Be sure to log in with the User account you used to create the OS in vSphere.</p></li><li><p>Install the applications, along with any drivers, boot-level applications, or files that the user will need with it.</p><p>If an application installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</p></li><li><p>Make sure the Packaging Machine is in the state you want it to be for the user:</p><ul><li>If the applications you install require any post-installation setup or application registration, complete those steps now.</li><li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li></ul></li></ol>
###Verify the Layer and shut down the Packaging Machine<a name="Verify_the_Layer_and_shut_down_the_Packaging_Machine_..730"></a><a name="Verify_..288"></a>
Once the application is installed on the Packaging Machine, it is important to verify that the Layer is ready to be finalized. To be ready for finalization, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the ***Shutdown For Finalize***  tool (icon below), which appears on the Packaging Machine's desktop.

To use the Shutdown For Finalize tool:
<ol><li>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</li><li>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages detailing the layer verification process.</li><li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Layer_Integrity_Check_..289">below</a>.</li><li>Once any pending operations are complete, double-click the <em>Shutdown For Finalize</em> icon again. This shuts down the Packaging Machine.</li></ol>
The Layer is now ready to finalize.
####Layer integrity messages you may see during the finalization process<a name="Layer_Integrity_Check_..289"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:<a name="Layer_Integrity_Messages_..290"></a>
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p><strong>Note:</strong> If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
####Expediting a Microsoft NGen operation<a name="Complete_MS_NGen_Operations_..291"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>
##Finalize the Layer<a name="Finalize_the_Layer_..731"></a><a name="Finalize_..292"></a>
Once the software has been installed and the Packaging Machine has been verified and shut down, you are ready to finalize the layer.
***Note:***  When you finalize a Layer, Unidesk may delete the Packaging Machine to minimize storage space used.
When the Layer has been verified and is ready to finalize:
<ol><li>Return to the Unidesk Management Console.</li><li>Select <strong>Layers >App Layers</strong>, and then the layer you just prepared.</li><li>Select <span>Finalize</span> in the Action bar. The Finalize wizard appears.</li><li>(Optional) On the Script Path wizard tab, you can enter the path to a Run Once Script located on a server on your network.<ul><li>If the App Layer is elastically assigned, the Run Once script will be executed the first time the app is used.</li><li>If the App Layer is included in a Layered Image, the Run Once script will be executed the first time the Layered Image is booted.</li></ul></li><li>Click <strong>Finalize</strong> to finish creating the Layer.</li><li><a href="#Layer_Integrity_Check_..289"></a> Monitor the Task bar to verify that the action completes successfully and that the Layer is ready to be deployed.</li></ol>
##Reference: Create App Layer Wizard values<a name="Reference:_Create_App_Layer_Wizard_values"></a><a name="Create_..293"></a>
<ul><li><em>Layer Name</em> - (Required) A name that will let you know what app(s) the layer will be used for.</li><li><em>Layer Description</em> - (Optional) Description of the Layer</li><li><p><em>Version</em> - (Required) This can be the version of the application or a version you assign to the Layer. This value is displayed in the Details view of the Layer. Keep in mind that you'll add a new version to this layer whenever you update the app(s) included in it, and this is where the version will be described.</p></li><li><em>Version Description</em> - (Optional) Enter a description of the version.</li><li><em>Specify the Max Layer Size</em> - Maximum layer size in gigabytes. Layers are <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/dn265487(v=vs.85).aspx">thin provisioned</a>, and will grow as needed, up to the maximum size. The default Max Layer Size is 10 gigabytes. If the application you are installing could eventually require more space, change this to an appropriate value.</li></ul>


#Create an App Layer (Azure)<a name="Create_an_App_Layer_(Azure)"></a>
In this article:
<table><tbody><tr><td>Before you start<p>Prepare a new App Layer</p><p>Deploy a Packaging Machine</p><p>Install the Application(s)</p><p>Verify the Layer and shut down the Packaging Machine</p><p>Finalize the Layer</p></td></tr></tbody></table>
An App Layer includes one or more installed applications that you can use in your Layered Images. You can create any number of App Layers, each with one or more applications. When it's time to update an app, you can add a new version to the layer. When you are ready to deliver the application updates to users, you can update your Image Templates, republish your Layered Images, and provision your servers with the new Layered Image.
To create an App Layer, you open the Create Layer wizard, deploy a Packaging Machine, then install the application(s). Once the application(s) are installed, you finalize the Layer.
##Before you start<a name="Before_you_start_..732"></a><a name="Before_..294"></a>
###Requirements<a name="Requirements_..733"></a>
To create an App Layer, you need:
<ul><li><a href="#Create_an_OS_Layer">Create an OS Layer</a></li></ul>
###Optional<a name="Optional_..734"></a>
Before you create an App Layer, you may also want to create resources that facilitate the application installation process. These resources are for temporary use during installation only, and will not be used to deliver the application.
<ul><li><a href="#Does">Create Prerequisite Layers</a> </li><li>Create a Platform Layer (Azure connector)</li><li>Run Once Script</li></ul>
If the application you install affects boot-level components, you'll need to restart the Packaging Machine as part of finalizing the layer or version.
####Does this App Layer require Prerequisite Layers?<a name="Does"></a>
Prerequisite Layers provide a mechanism to include existing Application Layers on the Packaging Disk when creating or adding a version to an Application Layer. Prerequisite Layers ***should only be used if they are required*** , since it is possible that the prerequisite applications will pull something into the Layer that is not required for the current application deployment, and which may cause conflict in the future. Prerequisite Layers can be required for several reasons:
<ul><li>If the software installed in one layer is required by the current layer's application just to be installed. For example, if you are installing an application that requires Java and you have Java in a separate layer.</li><li>If the software to be installed adds settings of an existing application. For example, when installing an Office add-in, Microsoft Office must first be installed.</li><li>If two applications modify the same registry key and the second application must add to a key and not replace it. For example, two application that both modify logon keys in Windows like a Citrix Agent and Imprivata.</li></ul>
***Note:***  Some of these issues can also be handled by putting the two applications in the same layer rather than using prerequisite layers.
####Run Once Script<a name="Run_..295"></a>
You can include a Run Once script in an App Layer. This allows you to run a script the first time any Layered Image that includes the App Layer boots. If the App Layer is elastically layered, the Run Once script runs when the App Layer Disk is mounted. Run Once scripts are typically used for apps, such as MS Office, that require license activation on the first boot.
##Prepare a new App Layer<a name="Prepare_a_new_App_Layer_..735"></a><a name="Create2_..296"></a>
<ol><li><p>Select <strong>Layers > App Layers</strong> and select <strong>Create Layer</strong> in the Action bar. This opens the Create Layer wizard.</p></li><li><p>In the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. Optionally, you can also enter other values. For details, see more about these values <a href="#Create_..304">below</a>.</p></li><li><p>In the OS Layer tab, select the OS Layer you want to associate with this App Layer.</p></li><li><p>In the Prerequisite Layers tab, if the application you are layering requires other App Layers to be present during installation, select the <strong>Include Prerequisite Layers</strong> check box, and pick the necessary App Layer(s).</p><p><strong>Notes:</strong> </p><ul><li>Prerequisite layers are <em>not included</em> in the App Layer being created.</li><li>Prerequisite layers are <em>not included</em> when adding a new <em>Version</em> to this App Layer. So, when you add a new Version to this App Layer, you must choose the Prerequisite Layers again.</li><li>The App Layer you are creating and each of its Prerequisite Layers must be associated with the selected OS Layer.</li></ul></li><li><p>In the Connector tab, choose a <strong>Platform Connector Configuration</strong> that contains the credentials for the platform where you plan to build the Layer, along with the storage location. If the configuration you need isn't listed, add a <strong>New</strong><a href="#Connector_Configuration_(AND)_Optional_Script__(vSphere)">Connector Configuration</a> and select it from this list.</p><p>Example: If you're using the Azure environment to create the Layer, select the Azure connector with the credentials and location required to access the location where you want to build the Layer.</p></li><li><p>In the Platform Layer tab you can select a Platform Layer containing the tools and hardware settings that you need to install and package an application during Layer creation. This selection is only used during layer creation. Once created, the Layer can be used in Layered Images published to any platform.</p></li><li><p>In the Packaging Disk tab, enter a <strong>file name</strong> for the Packaging Disk, and select the disk format. This disk will be used for the Packaging Machine (the VM) where you will install the application, as described in the next two sections.</p></li><li><p>In the Icon Assignment tab, select an icon to assign to the layer. This icon represents the layer in the Layers Module.</p><ul><li>To use an existing image, select an image in the image box.</li><li>To import a new image, click <strong>Browse</strong> and select an image in PNG or JPG format.</li></ul></li><li><p>In the Confirm and Complete tab, review the details of the App Layer, enter a comment if required, and click <strong>Create Layer</strong>. Any comments you enter will appear in the Information view Audit History. Once the Packaging Disk has been created, the Task bar displays a link to the Packaging Disk on the Azure portal. You will use this link to deploy the Packaging Machine.</p></li><li><p>Expand the Tasks bar at the bottom of the UI, and double-click the Packaging Disk task. The task expands to show the full task description. This description contains a link to the location in the Azure portal where the Packaging Machine for this Layer has been published.</p><p><img></img></p></li></ol>
Next, you can deploy the Packaging Machine for your Layer.
##Deploy a Packaging Machine<a name="Deploy_a_Packaging_Machine_..736"></a><a name="Deploy_..297"></a>
The Packaging Machine is a virtual machine where you install the app(s) you want to include in this Layer. It is strongly recommended that you use a unique Packaging Machine for each Layer. The Packaging Machine is a temporary VM that will be deleted once the Layer has been finalized.
###Deploy a Packaging Machine to Azure<a name="Deploy_a_Packaging_Machine_to_Azure_..737"></a>
The Task Description (example shown in the last step above) contains a link to the location in the Azure portal where the Packaging Machine for this Layer has been published.
To create your Packaging Machine in Azure, begin with the expanded Packaging Disk Task shown in the last step above.
<ol><li>Log into the Azure portal (https://portal.azure.com) from your web browser.</li><li><p>In the expanded Packaging Disk Task shown below, copy the full URL and paste it into the web browser where you logged into the Azure portal. This opens the Microsoft Azure portal to the <em>Custom deployment</em> template where you can create the virtual machine that you will use as your Unidesk Packaging Machine.</p><p><strong>Note:</strong> We recommend copying the full URL instead of using the Click <u>here</u> link.</p><p><img></img></p></li><li><p>On the Custom deployment panel, complete the required fields for customizing your Azure parameters.</p><ul><li>Packaging Machine Name - must conform to Azure VM name requirements.</li><li>Size - the Azure VM size of the packaging machine.</li><li>Virtual Network and Subnet - the virtual network and subnet for deploying the Packaging Machine.</li></ul><p>IMPORTANT: Be sure that the value for the <strong>Resource group location</strong> matches the <strong>Storage account location</strong> that you configured in the Platform Connector Configuration. If these locations are not the same, the Packaging Machine will fail to deploy and you will have to reattempt deployment. If your deployment does fail, you can simply re-paste the link into the browser to start over.</p><p><img></img></p></li></ol>
##Install the Application(s)<a name="Install_the_Application(s)_..738"></a><a name="Install_..298"></a>
This section explains how to install your application(s) on the Packaging Machine you created in Azure. Keep in mind that the state of the app before you finalize the layer is what users experience when they access it.
To install the application(s):
<ol><li><p>Remote log in to the Packaging Machine you created in Azure. Be sure to log in using the User account you used to create the OS in Azure.</p></li><li><p>Install the applications, along with any drivers, boot-level applications, or files that the user will need with it.</p><p>If an application installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</p></li><li><p>Make sure the Packaging Machine is in the state you want it to be for the user:</p><ul><li>If the applications you install require any post-installation setup or application registration, complete those steps now.</li><li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li></ul></li></ol>
Next, you'll need to shut down the Packaging Machine and verify that the Layer is ready to finalize.
##Verify the Layer and shut down the Packaging Machine<a name="Verify_the_Layer_and_shut_down_the_Packaging_Machine_..739"></a><a name="Verify_..299"></a>
Once the application is installed on the Packaging Machine, the next step is to verify that the Layer is ready to be finalized. To be ready for finalization, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the ***Shutdown For Finalize***  tool (icon below), which appears on the Packaging Machine's desktop.

To use the Shutdown For Finalize tool:
<ol><li>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</li><li>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages detailing the layer verification process.</li><li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Layer_Integrity_Check_..300">below</a>.</li><li>Once any pending operations are complete, double-click the <em>Shutdown For Finalize</em> icon again. This shuts down the Packaging Machine.</li></ol>
The Layer is now ready to finalize.
###Layer integrity messages you may see during the finalization process<a name="Layer_integrity_messages_you_may_see_during_the_finalization_process_..740"></a><a name="Layer_Integrity_Check_..300"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:<a name="Layer_Integrity_Messages_..301"></a>
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p><strong>Note:</strong> If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
###Expediting a Microsoft NGen operation<a name="Expediting_a_Microsoft_NGen_operation_..741"></a><a name="Complete_MS_NGen_Operations_..302"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>
##Finalize the Layer<a name="Finalize_the_Layer_..742"></a><a name="Finalize_..303"></a>
Once the software has been installed and the Packaging Machine has been verified and shut down, you are ready to finalize the layer.
***Note:***  When you finalize a Layer, Unidesk may delete the Packaging Machine to minimize storage space used.
When the Layer has been verified and is ready to finalize:
<ol><li>Return to the Unidesk Management Console.</li><li>Select <strong>Layers >App Layers</strong>, and then the layer you just prepared.</li><li>Select <span>Finalize</span> in the Action bar. The Finalize wizard appears.</li><li>(Optional) On the Script Path wizard tab, you can enter the path to a Run Once Script located on a server on your network.<ul><li>If the App Layer is elastically assigned, the Run Once script will be executed the first time the app is used.</li><li>If the App Layer is included in a Layered Image, the Run Once script will be executed the first time the Layered Image is booted.</li></ul></li><li>Click <strong>Finalize</strong> to finish creating the Layer.</li><li><a href="#Layer_Integrity_Check_..300"></a> Monitor the Task bar to verify that the action completes successfully and that the Layer is ready to be deployed.</li></ol>
##Reference: Create App Layer Wizard values<a name="Reference:_Create_App_Layer_Wizard_values_..743"></a><a name="Create_..304"></a>
<ul><li><em>Layer Name</em> - (Required) A name that will let you know what app(s) the layer will be used for.</li><li><em>Layer Description</em> - (Optional) Description of the Layer</li><li><p><em>Version</em> - (Required) This can be the version of the application or a version you assign to the Layer. This value is displayed in the Details view of the Layer. Keep in mind that you'll add a new version to this layer whenever you update the app(s) included in it, and this is where the version will be described.</p></li><li><em>Version Description</em> - (Optional) Enter a description of the version.</li><li><em>Specify the Max Layer Size</em> - Maximum layer size in gigabytes. Layers are <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/dn265487(v=vs.85).aspx">thin provisioned</a>, and will grow as needed, up to the maximum size. The default Max Layer Size is 10 gigabytes. If the application you are installing could eventually require more space, change this to an appropriate value.</li></ul>


#Create an App Layer (vSphere)<a name="Create_an_App_Layer_(vSphere)_..7"></a>
In this article:
Before you start
Prepare a new App Layer
Deploy a Packaging Machine
Install the Application(s)
Verify the Layer and shut down the Packaging Machine
Finalize the Layer
An App Layer is a bootable software image (virtual disk) containing one or more applications that you can use in any number of Layered Images. When creating an Image Template to use for publishing a Layered Image, you can include an OS Layer, a Platform Layer, and any combination of App Layers, as long as the OS Layer used to create all of them is the same.
To create an App Layer, you open the Create Layer wizard, deploy a Packaging Machine in your environment, then install the application on it. Once the application is installed, you finalize the Layer.
A Packaging Machine is a VM where you install the application(s) that will be included in the Layer. Unidesk creates the Packaging Machine using the location and credentials you supply by selecting the Platform Target (hypervisor) and Connector Configuration containing this information. If you don't yet have the Connector Configuration you need, you can add a new one, as described in the steps below.
##Before you start<a name="Before_you_start_..744"></a><a name="Before_..305"></a>
###Requirements<a name="Requirements_..745"></a>
To create an App Layer, you need:
<ul><li><a href="layer_os_create.htm">Create an OS Layer</a> (Contains the OS for this application.)</li></ul>
###Optional resources<a name="Optional_resources"></a>
You may want to create resources to facilitate the application installation process. These resources are for temporary use during installation only, and will not be used to deliver the application.
<ul><li><a href="#Prerequi_..306">Prerequisite Layers</a> </li><li><a href="#Platform_..307">Platform Layer for Packaging Layers (Required if creating App Layers on a different hypervisor than the one from which you imported your OS Layer)</a></li><li>Run Once Script</li></ul>
####Prerequisite Layers: What are they and do I need any?<a name="Prerequi_..306"></a>
Prerequisite Layers provide a mechanism to include existing Application Layers on the Packaging Disk when creating or adding a version to an Application Layer. Prerequisite Layers ***should only be used if they are required*** , since it is possible that the prerequisite applications will pull something into the Layer that is not required for the current application deployment, and which may cause conflict in the future. Prerequisite Layers can be required for several reasons:
<ul><li>If the software installed in one layer is required by the current layer's application just to be installed. For example, if you are installing an application that requires Java and you have Java in a separate layer.</li><li>If the software to be installed adds settings of an existing application. For example, when installing an Office add-in, Microsoft Office must first be installed.</li><li>If two applications modify the same registry key and the second application must add to a key and not replace it. For example, two application that both modify logon keys in Windows like a Citrix Agent and Imprivata.</li></ul>
***Note:***  Some of these issues can also be handled by putting the two applications in the same layer rather than using prerequisite layers.
####Platform Layer: What is it and do I need one?<a name="Platform_..307"></a>
A Platform Layer is a Unidesk Layer that contains the tools and hardware settings needed to either install and package an application during Layer creation, or to publish a Layered Image for provisioning servers in a specific environment. You can create a different Platform Layer for each environment in which you are creating Layers, or publishing Layered Images.
There are two types of Platform Layers you can create: Platform Layers to use for Packaging other Layers, and Platform Layers for Publishing Layered Images.
####Run Once Script<a name="Run_..308"></a>
You can include a Run Once script in an App Layer. This allows you to run a script the first time any Layered Image that includes the App Layer boots. If the App Layer is elastically layered, the Run Once script runs when the App Layer Disk is mounted. Run Once scripts are typically used for apps, such as MS Office, that require license activation on the first boot.
##Prepare a new App Layer<a name="Prepare_a_new_App_Layer_..746"></a><a name="Create2_..309"></a>
<ol><li><p>Select <strong>Layers > App Layers</strong> and select <strong>Create Layer</strong> in the Action bar. This opens the Create Layer wizard.</p></li><li><p>On the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. Optionally, you can also enter other values. For details, see more about these values <a href="#Create_..317">below</a>.</p></li><li><p>On the OS Layer tab, select the OS Layer you want to associate with this App Layer.</p></li><li><p>(Optional) On the Prerequisite Layers tab, if the application you are layering requires other App Layers to be present during installation, select the <strong>Include Prerequisite Layers</strong> check box, and pick the necessary App Layer(s).</p><p><strong>Notes:</strong> </p><ul><li>Prerequisite layers are used while installing applications, and are <em>not included</em> in the App Layer.</li><li>Prerequisite layers are <em>not</em> included by default when adding a new <em>Version</em> to this App Layer. So, when you add a new Version to this App Layer, you must choose the Prerequisite Layers again, if needed.</li><li>The App Layer you are creating and each of its Prerequisite Layers must be associated with the selected OS Layer.</li></ul></li><li><p>On the Connector tab, select <strong>Network File Share</strong>.</p></li><li><p>On the Platform Layer tab, you can select a Platform Layer for Packaging Layers, <em>if</em> you need one.</p><p><strong>Note:</strong> You <em>only</em> need a Platform Layer for Packaging this Layer if you imported your OS from a different environment than the one where you will install the software on this Layer.</p></li><li><p>On the Packaging Disk tab, enter a <strong>file name</strong> for the Packaging Disk, and select the disk format. This disk will be used for the Packaging Machine (the VM) where you will install the application, as described in the next two sections.</p></li><li><p>On the Icon Assignment tab, select an icon to assign to the layer. This icon represents the layer in the Layers Module.</p><ul><li>To use an existing image, select an image in the image box.</li><li>To import a new image, click <strong>Browse</strong> and select an image in PNG or JPG format.</li></ul></li><li><p>On the Confirm and Complete tab, review the App Layer details, enter a comment if required, and click <strong>Create Layer</strong>. Any comments you enter will appear in the Information view Audit History.</p><p>A Boot disk and a Packaging disk are created, and the Tasks bar displays instructions to navigate to them.</p></li><li><p>Expand the Tasks bar at the bottom of the UI, and double-click the Packaging Disk task to show the full description. A message displays the location of the disks in your environment.</p><p><img></img></p></li></ol>
Next, you can deploy the Packaging Machine for your Layer.
##Deploy a Packaging Machine<a name="Deploy_a_Packaging_Machine_..747"></a><a name="Deploy_..310"></a>
The Packaging Machine is a temporary VM where you install the app(s) you want to include in the Layer.
###Create the Packaging Machine<a name="Create_the_Packaging_Machine_..748"></a>
The Task Description (example shown in the last step above) contains the location in your hypervisor environment where the disks for this Layer have been created.
<ol><li><p>Log into your hypervisor.</p></li><li><p>Back in the Unidesk Management Console, use the instructions in the expanded Packaging Disk Task shown below to navigate to the location where the Boot Disk and Packaging Disk have been created.</p><p><img></img></p></li><li><p>In your hypervisor, create a VM from the Boot disk and name it <em>Layer_Name</em>Boot.<em>xxx</em>.</p></li><li><p>Use the hypervisor to attach the disk called <em>Layer_Name</em>Pkg.<em>xxx</em> to the VM you just created.</p><p><strong>Important:</strong> Both disks you exported <em>must</em> be attached to the IDE.</p></li><li><p>Power on the VM. This is your Packaging Machine where you will install the app(s) to include in this Layer.</p></li></ol>
##Install the Application(s)<a name="Install_the_Application(s)_..749"></a><a name="Install_..311"></a>
Now you can install your application(s) on the Packaging Machine. Keep in mind that the state of the app before you finalize the layer is what users experience when they access it, so it's important to leave the app as you want users to see it when they log in. More guidance about this is included in the steps below.
To install the application(s):
<ol><li><p>Remote log in to the Packaging Machine in vSphere. Be sure to log in with the User account you used to create the OS in vSphere.</p></li><li><p>Install the applications, along with any drivers, boot-level applications, or files that the user will need with it.</p><p>If an application installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</p></li><li><p>Make sure the Packaging Machine is in the state you want it to be for the user:</p><ul><li>If the applications you install require any post-installation setup or application registration, complete those steps now.</li><li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li></ul></li></ol>
Next, you will shut down the Packaging Machine and verify that the Layer is ready to finalize.
##Verify the Layer and shut down the Packaging Machine<a name="Verify_the_Layer_and_shut_down_the_Packaging_Machine_..750"></a><a name="Verify_..312"></a>
Once the application is installed on the Packaging Machine, it is important to verify that the Layer is ready to be finalized. To be ready for finalization, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the ***Shutdown For Finalize***  tool (icon below), which appears on the Packaging Machine's desktop.

To use the Shutdown For Finalize tool:
<ol><li>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</li><li>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages detailing the layer verification process.</li><li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Layer_Integrity_Check_..313">below</a>.</li><li>Once any pending operations are complete, double-click the <em>Shutdown For Finalize</em> icon again. This shuts down the Packaging Machine.</li></ol>
The Layer is now ready to finalize.
###Layer integrity messages you may see during the finalization process<a name="Layer_integrity_messages_you_may_see_during_the_finalization_process_..751"></a><a name="Layer_Integrity_Check_..313"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:<a name="Layer_Integrity_Messages_..314"></a>
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p><strong>Note:</strong> If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
###Expediting a Microsoft NGen operation<a name="Expediting_a_Microsoft_NGen_operation_..752"></a><a name="Complete_MS_NGen_Operations_..315"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>
##Finalize the Layer<a name="Finalize_the_Layer_..753"></a><a name="Finalize_..316"></a>
Once the software has been installed and the Packaging Machine has been verified and shut down, you are ready to finalize the layer.
***Note:***  When you finalize a Layer, Unidesk may delete the Packaging Machine to minimize storage space used.
When the Layer has been verified and is ready to finalize:
<ol><li>Return to the Unidesk Management Console.</li><li>Select <strong>Layers >App Layers</strong>, and then the layer you just prepared.</li><li>Select <span>Finalize</span> in the Action bar. The Finalize wizard appears.</li><li>(Optional) On the Script Path wizard tab, you can enter the path to a Run Once Script located on a server on your network.<ul><li>If the App Layer is elastically assigned, the Run Once script will be executed the first time the app is used.</li><li>If the App Layer is included in a Layered Image, the Run Once script will be executed the first time the Layered Image is booted.</li></ul></li><li>Click <strong>Finalize</strong> to finish creating the Layer.</li><li><a href="#Layer_Integrity_Check_..313"></a> Monitor the Task bar to verify that the action completes successfully and that the Layer is ready to be deployed.</li></ol>
##Reference: Create App Layer Wizard values<a name="Reference:_Create_App_Layer_Wizard_values_..754"></a><a name="Create_..317"></a>
<ul><li><em>Layer Name</em> - (Required) A name that will let you know what app(s) the layer will be used for.</li><li><em>Layer Description</em> - (Optional) Description of the Layer</li><li><p><em>Version</em> - (Required) This can be the version of the application or a version you assign to the Layer. This value is displayed in the Details view of the Layer. Keep in mind that you'll add a new version to this layer whenever you update the app(s) included in it, and this is where the version will be described.</p></li><li><em>Version Description</em> - (Optional) Enter a description of the version.</li><li><em>Specify the Max Layer Size</em> - Maximum layer size in gigabytes. Layers are <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/dn265487(v=vs.85).aspx">thin provisioned</a>, and will grow as needed, up to the maximum size. The default Max Layer Size is 10 gigabytes. If the application you are installing could eventually require more space, change this to an appropriate value.</li></ul>


#Create an App Layer (Nutanix AHV Connector)<a name="Create_an_App_Layer_(Nutanix_AHV_Connector)"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Prepare a new App Layer</p><p><a href="#Install_..326">Install the software on the Packaging Machine </a></p><p>Finalize the Layer</p><p>Reference: Create App Layer Wizard values</p></td></tr></tbody></table>
An App Layer is a bootable software image (virtual disk) containing one or more applications that you can use in any number of Layered Images. When publishing a Layered Image, you can combine an App Layer with the OS Layer used to create it, other App Layers, and a Platform Layer.
To create an App Layer, you open the Create Layer wizard, deploy a Packaging Machine in your environment, then install the application(s). Once the application(s) are installed, you finalize the Layer.
A Packaging Machine is a VM where you install the application(s) that will be included in the Layer. Unidesk creates the Packaging Machine in the location and using the credentials you supply by choosing the Platform Target (hypervisor) and selecting a Connector Configuration containing this information. If you don't yet have the Connector Configuration you need, you can add a new one, as described in the steps below.
Before you start<a name="Before_..318"></a>
###Requirements<a name="Requirements_..755"></a>
To create an App Layer, you need:
<ul><li><a href="#Create_an_OS_Layer">Create an OS Layer</a></li></ul>
###Optional<a name="Optional_..756"></a>
Before you create an App Layer, you may also want to create resources that facilitate the application installation process. These resources are for temporary use during installation only, and will not be used to deliver the application.
<ul><li>Prerequisite Layer</li><li>Platform Layer (for cross-platform deployments) (Only required if creating App Layers on a hypervisor other than the one from which you imported your OS Layer)</li><li>Run Once Script</li></ul>
If the application you install affects boot-level components, you'll need to restart the Packaging Machine as part of finalizing the layer or version.
####Prerequisite Layer<a name="Prerequi_..319"></a>
Prerequisite Layers let you include existing App Layers on the Packaging Disk when creating or adding a version to an App Layer. Prerequisite Layers ***should only be used if they are required*** , since it is possible that the prerequisite applications will pull something into the Layer that is not required for the current application deployment, and which may cause conflict in the future.
Reasons to consider using Prerequisite Layers:
<ul><li>The application you are installing requires another application during installation. For example, if you are installing an application that requires Java and you have Java in a separate layer.</li><li>The add-in or plugin you are installing adds settings to an application. For example, when installing an Office add-in, you would use your Microsoft Office App Layer as a prerequisite layer.</li><li>Two applications modify the same registry key, and the second application must add to an existing key rather than replace it. For example, Citrix Agent and Imprivata software both modify login keys in Windows.</li></ul>
***Note:***  Some of these issues can also be handled by putting the two applications in the same layer.
####Platform Layer (for cross-platform deployments)<a name="Platform_..320"></a>
A Platform Layer is ***only***  required when creating App Layers on a hypervisor other than the one from which you imported your OS Layer.
If you are creating App Layers and Versions on a different hypervisor than the one you used to create your OS Layer, it is strongly recommended that you create a Platform Layer containing the hypervisor tools and hardware settings you need to seamlessly install and package applications in your environment.
####Run Once Script<a name="Run_..321"></a>
You can include a Run Once script in an App Layer. This allows you to run a script the first time any Layered Image that includes the App Layer boots. If the App Layer is elastically layered, the Run Once script runs when the App Layer Disk is mounted. Run Once scripts are typically used for apps, such as MS Office, that require license activation on the first boot.
##Prepare a new App Layer<a name="Prepare_a_new_App_Layer_..757"></a><a name="Create2_..322"></a>
<ol><li><p>Select <strong>Layers > App Layers</strong> and select <strong>Create Layer</strong> in the Action bar. This opens the Create Layer wizard.</p></li><li><p>In the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. Optionally, you can also enter other values. For details, see more about these values <a href="#Create_..332">below</a>.</p></li><li><p>In the OS Layer tab, select the <strong>OS Layer</strong> you want to associate with this App Layer.</p></li><li><p>(Optional) In the Prerequisite Layers tab, if the application you are layering requires other App Layers to be present during installation, select the <strong>Include Prerequisite Layers</strong> check box, and pick the necessary App Layer(s).</p><p><strong>Notes:</strong> </p><ul><li>Prerequisite layers are used while installing applications, and are <em>not included</em> in the App Layer.</li><li>Prerequisite layers are <em>not</em> included by default when adding a new <em>Version</em> to this App Layer. So, when you add a new Version to this App Layer, you must choose the Prerequisite Layers again, if needed.</li><li>The App Layer you are creating and each of its Prerequisite Layers must be associated with the selected OS Layer.</li></ul></li><li><p>In the Connector tab, choose a <strong>Connector Configuration</strong> that contains the credentials for the platform where you plan to build the Layer, along with the storage location. If the configuration you need isn't listed, add a <strong>New</strong> <a href="#Connector_Configuration_(AND)_Optional_Script__(Nutanix_AHV)">Connector Configuration</a> and select it from this list.</p><p>Example: If you're using the Nutanix AHV environment to create the Layer, select the <em>Nutanix AHV</em> connector with the credentials and location required to access the location where you want to build the Layer.</p></li><li><p>In the Platform Layer tab you can select a Platform Layer containing the tools and hardware settings that you need to install and package an application during Layer creation. This selection is only used during layer creation. Once created, the Layer can be used in Layered Images published to any platform.</p></li><li><p>In the Packaging Disk tab, enter a <strong>file name</strong> for the Packaging Disk, and select the disk format. This disk will be used for the Packaging Machine (the VM) where you will install the application, as described in the next two sections.</p></li><li><p>In the Icon Assignment tab, select an icon to assign to the layer. This icon represents the layer in the Layers Module.</p><ul><li>To use an existing image, select an image in the image box.</li><li>To import a new image, click <strong>Browse</strong> and select an image in PNG or JPG format.</li></ul></li><li><p>In the Confirm and Complete tab, review the details of the App Layer, enter a comment if required, and click <strong>Create Layer</strong>. Any comments you enter will appear in the Information view Audit History. Once the Packaging Disk has been created, the Task bar displays instructions to navigate to the Packaging Machine in Nutanix AHV.</p></li></ol>
Next, you can log into the Packaging Machine for your Layer, and install the software for the layer on it.
##Access the Packaging Machine in Nutanix AHV<a name="Access_the_Packaging_Machine_in_Nutanix_AHV_..758"></a><a name="Copy_..323"></a>
<ol><li>Log into Nutanix Prism.</li><li><p>Back in the Unidesk Management Console (UMC), expand the Tasks bar at the bottom of the UI, and double-click the <em>Create App Layer</em> task to see the full Task Description (example below).</p><p><img></img></p></li><li>Use the instructions in the Task Description to navigate to the Packaging Machine in Prism.</li><li>Install the app for your Layer. This may require a reboot as part of the installation. Once complete, you should see that you have access to the tools, as well as all of the <em>data</em> available under the Performance tab for your VM.</li></ol>
##Install the software on the Packaging Machine<a name="Install_the_software_on_the_Packaging_Machine_..759"></a><a name="Install_..324"></a>
When you've completed the Layer wizard, Unidesk creates a Packaging Machine in your environment, in the location defined in the Connector Configuration. The Packaging Machine is a virtual machine where you install the software to be included in the layer.
***Note:***  The Packaging Machine is a temporary VM that will be deleted once the new App Layer has been finalized.
###Log into the Packaging Machine<a name="Log_into_the_Packaging_Machine_..760"></a><a name="Deploy_..325"></a>
<ol><li><p>Log into Nutanix Prism.</p></li><li><p>Back in the Unidesk Management Console, expand the Tasks bar at the bottom of the UI, and double-click the <em>Create App Layer</em> task to see the full Task Description.</p></li><li><p>Use the instructions in the Task Description to navigate to the Packaging Machine in Nutanix Prism.</p><p>The Packaging Machine will be powered on.</p></li></ol>
###Install the Application(s)<a name="Install_the_Application(s)_..761"></a><a name="Install_..326"></a>
When installing your application(s) on the Packaging Machine, leave each application as you want users to see it when they log in. The state of the applications when you finalize the layer is what users experience when they access the application. More guidance about this is included in the steps below.
<ol><li><p>Remote log in to the Packaging Machine in Nutanix AHV. Be sure to log in with the User account you used to create the OS in Nutanix AHV.</p></li><li><p>Install the applications, along with any drivers, boot-level applications, or files that the user will need with it.</p><p>If an application installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</p></li><li><p>Make sure the Packaging Machine is in the state you want it to be for the user:</p><ul><li>If the applications you install require any post-installation setup or application registration, complete those steps now.</li><li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li></ul></li></ol>
###Verify the Layer and shut down the Packaging Machine<a name="Verify_the_Layer_and_shut_down_the_Packaging_Machine_..762"></a><a name="Verify_..327"></a>
Once the application is installed on the Packaging Machine, it is important to verify that the Layer is ready to be finalized. To be ready for finalization, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the ***Shutdown For Finalize***  tool (icon below), which appears on the Packaging Machine's desktop.

To use the Shutdown For Finalize tool:
<ol><li>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</li><li>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages detailing the layer verification process.</li><li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Layer_Integrity_Check_..328">below</a>.</li><li>Once any pending operations are complete, double-click the <em>Shutdown For Finalize</em> icon again. This shuts down the Packaging Machine.</li></ol>
The Layer is now ready to finalize.
####Layer integrity messages you may see during the finalization process<a name="Layer_Integrity_Check_..328"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:<a name="Layer_Integrity_Messages_..329"></a>
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p><strong>Note:</strong> If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
####Expediting a Microsoft NGen operation<a name="Complete_MS_NGen_Operations_..330"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>
##Finalize the Layer<a name="Finalize_the_Layer_..763"></a><a name="Finalize_..331"></a>
Once the software has been installed and the Packaging Machine has been verified and shut down, you are ready to finalize the layer.
***Note:***  When you finalize a Layer, Unidesk may delete the Packaging Machine to minimize storage space used.
When the Layer has been verified and is ready to finalize:
<ol><li>Return to the Unidesk Management Console.</li><li>Select <strong>Layers >App Layers</strong>, and then the layer you just prepared.</li><li>Select <span>Finalize</span> in the Action bar. The Finalize wizard appears.</li><li>(Optional) On the Script Path wizard tab, you can enter the path to a Run Once Script located on a server on your network.<ul><li>If the App Layer is elastically assigned, the Run Once script will be executed the first time the app is used.</li><li>If the App Layer is included in a Layered Image, the Run Once script will be executed the first time the Layered Image is booted.</li></ul></li><li>Click <strong>Finalize</strong> to finish creating the Layer.</li><li><a href="#Layer_Integrity_Check_..328"></a> Monitor the Task bar to verify that the action completes successfully and that the Layer is ready to be deployed.</li></ol>
##Reference: Create App Layer Wizard values<a name="Reference:_Create_App_Layer_Wizard_values_..764"></a><a name="Create_..332"></a>
<ul><li><em>Layer Name</em> - (Required) A name that will let you know what app(s) the layer will be used for.</li><li><em>Layer Description</em> - (Optional) Description of the Layer</li><li><p><em>Version</em> - (Required) This can be the version of the application or a version you assign to the Layer. This value is displayed in the Details view of the Layer. Keep in mind that you'll add a new version to this layer whenever you update the app(s) included in it, and this is where the version will be described.</p></li><li><em>Version Description</em> - (Optional) Enter a description of the version.</li><li><em>Specify the Max Layer Size</em> - Maximum layer size in gigabytes. Layers are <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/dn265487(v=vs.85).aspx">thin provisioned</a>, and will grow as needed, up to the maximum size. The default Max Layer Size is 10 gigabytes. If the application you are installing could eventually require more space, change this to an appropriate value.</li></ul>


#Create an App Layer (XenServer Connector)<a name="Create_an_App_Layer_(XenServer_Connector)"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Prepare a new App Layer</p><p><a href="#Install_..342">Install the software on the Packaging Machine </a></p><p>Finalize the Layer</p><p>Reference: Create App Layer Wizard values</p></td></tr></tbody></table>
An App Layer is a bootable software image (virtual disk) containing one or more applications that you can use in any number of Layered Images. When publishing a Layered Image, you can combine an App Layer with the OS Layer used to create it, other App Layers, and a Platform Layer.
To create an App Layer, you open the Create Layer wizard, deploy a Packaging Machine in your environment, then install the application(s). Once the application(s) are installed, you finalize the Layer.
A Packaging Machine is a VM where you install the application(s) that will be included in the Layer. Unidesk creates the Packaging Machine in the location and using the credentials you supply by choosing the Platform Target (hypervisor) and selecting a Connector Configuration containing this information. If you don't yet have the Connector Configuration you need, you can add a new one, as described in the steps below.
Before you start<a name="Before_..333"></a>
###Requirements<a name="Requirements_..765"></a>
To create an App Layer, you need:
<ul><li><a href="#Create_an_OS_Layer">Create an OS Layer</a></li></ul>
###Optional<a name="Optional_..766"></a>
Before you create an App Layer, you may also want to create resources that facilitate the application installation process. These resources are for temporary use during installation only, and will not be used to deliver the application.
<ul><li>Prerequisite Layer</li><li>Platform Layer (for cross-platform deployments) (Only required if creating App Layers on a hypervisor other than the one from which you imported your OS Layer)</li><li>Run Once Script</li></ul>
If the application you install affects boot-level components, you'll need to restart the Packaging Machine as part of finalizing the layer or version.
####Prerequisite Layer<a name="Prerequi_..334"></a>
Prerequisite Layers let you include existing App Layers on the Packaging Disk when creating or adding a version to an App Layer. Prerequisite Layers ***should only be used if they are required*** , since it is possible that the prerequisite applications will pull something into the Layer that is not required for the current application deployment, and which may cause conflict in the future.
Reasons to consider using Prerequisite Layers:
<ul><li>The application you are installing requires another application during installation. For example, if you are installing an application that requires Java and you have Java in a separate layer.</li><li>The add-in or plugin you are installing adds settings to an application. For example, when installing an Office add-in, you would use your Microsoft Office App Layer as a prerequisite layer.</li><li>Two applications modify the same registry key, and the second application must add to an existing key rather than replace it. For example, Citrix Agent and Imprivata software both modify login keys in Windows.</li></ul>
***Note:***  Some of these issues can also be handled by putting the two applications in the same layer.
####Platform Layer (for cross-platform deployments)<a name="Platform_..335"></a>
A Platform Layer is ***only***  required when creating App Layers on a hypervisor other than the one from which you imported your OS Layer.
If you are creating App Layers and Versions on a different hypervisor than the one you used to create your OS Layer, it is strongly recommended that you create a Platform Layer containing the hypervisor tools and hardware settings you need to seamlessly install and package applications in your environment.
####Run Once Script<a name="Run_..336"></a>
You can include a Run Once script in an App Layer. This allows you to run a script the first time any Layered Image that includes the App Layer boots. If the App Layer is elastically layered, the Run Once script runs when the App Layer Disk is mounted. Run Once scripts are typically used for apps, such as MS Office, that require license activation on the first boot.
##Prepare a new App Layer<a name="Prepare_a_new_App_Layer_..767"></a><a name="Create2_..337"></a>
<ol><li><p>Select <strong>Layers > App Layers</strong> and select <strong>Create Layer</strong> in the Action bar. This opens the Create Layer wizard.</p></li><li><p>In the Layer Details tab, enter a <strong>Layer Name</strong> and <strong>Version</strong>, both required values. Optionally, you can also enter other values. For details, see more about these values <a href="#Create_..348">below</a>.</p></li><li><p>In the OS Layer tab, select the <strong>OS Layer</strong> you want to associate with this App Layer.</p></li><li><p>(Optional) In the Prerequisite Layers tab, if the application you are layering requires other App Layers to be present during installation, select the <strong>Include Prerequisite Layers</strong> check box, and pick the necessary App Layer(s).</p><p><strong>Notes:</strong> </p><ul><li>Prerequisite layers are used while installing applications, and are <em>not included</em> in the App Layer.</li><li>Prerequisite layers are <em>not</em> included by default when adding a new <em>Version</em> to this App Layer. So, when you add a new Version to this App Layer, you must choose the Prerequisite Layers again, if needed.</li><li>The App Layer you are creating and each of its Prerequisite Layers must be associated with the selected OS Layer.</li></ul></li><li><p>In the Connector tab, choose a <strong>Platform Connector Configuration</strong> that contains the credentials for the platform where you plan to build the Layer, along with the storage location. If the configuration you need isn't listed, add a <strong>New</strong> <a href="#Connector_Configuration_(AND)_Optional_Script__(vSphere)">Connector Configuration</a> and select it from this list.</p><p>Example: If you're using the XenServer environment to create the Layer, select the XenServer connector with the credentials and location required to access the location where you want to build the Layer.</p></li><li><p>In the Platform Layer tab you can select a Platform Layer containing the tools and hardware settings that you need to install and package an application during Layer creation. This selection is only used during layer creation. Once created, the Layer can be used in Layered Images published to any platform.</p></li><li><p>In the Packaging Disk tab, enter a <strong>file name</strong> for the Packaging Disk, and select the disk format. This disk will be used for the Packaging Machine (the VM) where you will install the application, as described in the next two sections.</p></li><li><p>In the Icon Assignment tab, select an icon to assign to the layer. This icon represents the layer in the Layers Module.</p><ul><li>To use an existing image, select an image in the image box.</li><li>To import a new image, click <strong>Browse</strong> and select an image in PNG or JPG format.</li></ul></li><li><p>In the Confirm and Complete tab, review the details of the App Layer, enter a comment if required, and click <strong>Create Layer</strong>. Any comments you enter will appear in the Information view Audit History. Once the Packaging Disk has been created, the Task bar displays instructions to navigate to the Packaging Machine in XenServer.</p></li></ol>
Next, you can log into the Packaging Machine for your Layer, and install the software for the layer on it.
##Deploy a Unidesk Packaging Machine in XenServer<a name="Deploy_a_Unidesk_Packaging_Machine_in_XenServer"></a><a name="Copy_..338"></a>
<ol><li><p>Back in the Unidesk Management Console, expand the Tasks bar at the bottom of the UI, and double-click the <em>Create App Layer</em> task to see the full Task Description (example below).</p><p><img></img></p></li><li>Use the instructions in the Task Description to navigate to the Packaging Machine in your XenServer client.</li><li>Power on the Packaging Machine.</li></ol>
You can now install the applications for this layer on the Packaging Machine.

##Install the software on the Packaging Machine<a name="Install_the_software_on_the_Packaging_Machine_..768"></a><a name="Install2_..340"></a>
When you've completed the Layer wizard, Unidesk creates a Packaging Machine in your environment, in the location defined in the Connector Configuration. The Packaging Machine is a virtual machine where you install the software to be included in the layer.
***Note:***  The Packaging Machine is a temporary VM that will be deleted once the new Platform Layer has been finalized.
###Log into the Packaging Machine<a name="Log_into_the_Packaging_Machine_..769"></a><a name="Deploy_..341"></a>
<ol><li><p>Log into your vSphere web client.</p></li><li><p>Back in the Unidesk Management Console, expand the Tasks bar at the bottom of the UI, and double-click the <em>Create App Layer</em> task to see the full Task Description.</p></li><li><p>Use the instructions in the Task Description to navigate to the Packaging Machine in your vSphere web client.</p><p>The Packaging Machine will be powered on.</p></li></ol>
###Install the Application(s)<a name="Install_the_Application(s)_..770"></a><a name="Install_..342"></a>
When installing your application(s) on the Packaging Machine, leave each application as you want users to see it when they log in. The state of the applications when you finalize the layer is what users experience when they access the application. More guidance about this is included in the steps below.
<ol><li><p>Remote log in to the Packaging Machine in vSphere. Be sure to log in with the User account you used to create the OS in vSphere.</p></li><li><p>Install the applications, along with any drivers, boot-level applications, or files that the user will need with it.</p><p>If an application installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</p></li><li><p>Make sure the Packaging Machine is in the state you want it to be for the user:</p><ul><li>If the applications you install require any post-installation setup or application registration, complete those steps now.</li><li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li></ul></li></ol>
###Verify the Layer and shut down the Packaging Machine<a name="Verify_the_Layer_and_shut_down_the_Packaging_Machine_..771"></a><a name="Verify_..343"></a>
Once the application is installed on the Packaging Machine, it is important to verify that the Layer is ready to be finalized. To be ready for finalization, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the ***Shutdown For Finalize***  tool (icon below), which appears on the Packaging Machine's desktop.

To use the Shutdown For Finalize tool:
<ol><li>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</li><li>Double-click the <em>Shutdown For Finalize</em> icon. A command line window displays messages detailing the layer verification process.</li><li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Layer_Integrity_Check_..344">below</a>.</li><li>Once any pending operations are complete, double-click the <em>Shutdown For Finalize</em> icon again. This shuts down the Packaging Machine.</li></ol>
The Layer is now ready to finalize.
####Layer integrity messages you may see during the finalization process<a name="Layer_Integrity_Check_..344"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:<a name="Layer_Integrity_Messages_..345"></a>
<ul><ul><li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li><li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li><li>An MSI install operation is in progress - please check the Packaging Machine.</li><li><p>A Microsoft NGen operation is in progress in the background.</p><p><strong>Note:</strong> If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p></li></ul></ul>
####Expediting a Microsoft NGen operation<a name="Complete_MS_NGen_Operations_..346"></a>
NGen is the Microsoft ***Native Image Generator*** . It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them. Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration. When NGen is running, you must let it complete. An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause.
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol><li><p>Force an NGen operation to the foreground.</p><p>Normally, NGen is a background operation and will pause if there is foreground activity. Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre></li><li><p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre><p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled.</p><p><strong>Note:</strong> It's okay if you see several compilation failed messages!</p></li><li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>. Do <em>not</em> reboot to stop the task. You <em>must</em> allow it to complete.</li></ol></li><li><p>Check the status of an NGen operation</p><ol><li><p>Open a command prompt as Administrator.</p></li><li><p>Check status by running this command:</p><pre>ngen queue status</pre></li><li><p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre></li></ol></li></ol>
##Finalize the Layer<a name="Finalize_the_Layer_..772"></a><a name="Finalize_..347"></a>
Once the software has been installed and the Packaging Machine has been verified and shut down, you are ready to finalize the layer.
***Note:***  When you finalize a Layer, Unidesk may delete the Packaging Machine to minimize storage space used.
When the Layer has been verified and is ready to finalize:
<ol><li>Return to the Unidesk Management Console.</li><li>Select <strong>Layers >App Layers</strong>, and then the layer you just prepared.</li><li>Select <span>Finalize</span> in the Action bar. The Finalize wizard appears.</li><li>(Optional) On the Script Path wizard tab, you can enter the path to a Run Once Script located on a server on your network.<ul><li>If the App Layer is elastically assigned, the Run Once script will be executed the first time the app is used.</li><li>If the App Layer is included in a Layered Image, the Run Once script will be executed the first time the Layered Image is booted.</li></ul></li><li>Click <strong>Finalize</strong> to finish creating the Layer.</li><li><a href="#Layer_Integrity_Check_..344"></a> Monitor the Task bar to verify that the action completes successfully and that the Layer is ready to be deployed.</li></ol>
##Reference: Create App Layer Wizard values<a name="Reference:_Create_App_Layer_Wizard_values_..773"></a><a name="Create_..348"></a>
<ul><li><em>Layer Name</em> - (Required) A name that will let you know what app(s) the layer will be used for.</li><li><em>Layer Description</em> - (Optional) Description of the Layer</li><li><p><em>Version</em> - (Required) This can be the version of the application or a version you assign to the Layer. This value is displayed in the Details view of the Layer. Keep in mind that you'll add a new version to this layer whenever you update the app(s) included in it, and this is where the version will be described.</p></li><li><em>Version Description</em> - (Optional) Enter a description of the version.</li><li><em>Specify the Max Layer Size</em> - Maximum layer size in gigabytes. Layers are <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/dn265487(v=vs.85).aspx">thin provisioned</a>, and will grow as needed, up to the maximum size. The default Max Layer Size is 10 gigabytes. If the application you are installing could eventually require more space, change this to an appropriate value.</li></ul>


#Recipes for layering Applications<a name="Recipes_for_layering_Applications"></a>
Most applications layer without a hitch, but there are a few that are trickier to layer, for example, Java, iTunes, Microsoft Office, and print drivers.
For recipes and tips about layering specific applications, visit the Unidesk Forum about [Application Layer Recipes](http://www.unidesk.com/forum/application-layer-recipes)[. If you experience issues layering an application that is not included in these Application Layer Recipes, you can post a question to this Forum.](http://www.unidesk.com/forum/application-layer-recipes)
Note: If in the unlikely event you find yourself reading the recipe for an application you want to layer in a 4.X image and it requires using a script path, please call our Tech Support so we can guide you through it.


#User Layer (Unidesk Labs)<a name="User_Layer_(Unidesk_Labs)"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Enable User Layers in the Layered Image</p><p>User Layer (Unidesk Labs)</p></td></tr></tbody></table>
With the Unidesk User Layer you now have the ability to persist user profile settings, data, and user-installed applications in non-persistent VDI environments.
User Layers are created when:
<ul><li>You set <em>Elastic Layering</em> on an Image Template to <em>Application and User Layers</em>, so that the Layered Image supports User Layers.</li><li>A user logs in to their desktop for the first time, and a User Layer is created for them. From then on, the user's data and settings are saved in the User Layer, along with any applications that the user installs locally on their desktops.</li></ul>
##Before you start<a name="Before_you_start_..774"></a><a name="Before_..349"></a>
###Prerequisites<a name="Prerequisites_..775"></a>
<ul><li>Create your <a href="#Create_an_OS_Layer">OS Layer</a>.</li><li>Create your <a href="#Create_a_Platform_Layer">Platform Layer</a> for publishing, if needed.</li><li>Create your <a href="#Create_an_App_Layer">App Layers</a>.</li><li>Enough free disk space on your ELM's file share to ensure that these additional Layers do not cause you to run out. Allow enough space for the user's locally installed apps, plus the data and configuration settings for the user's Layers.</li><li>Make sure network bandwidth is adequate, as bandwidth and latency have a significant effect on the User Layer. Every write goes across the network.</li></ul>
###Compatibility<a name="Compatibility_..776"></a>
Currently, User Layers are supported in conjunction with the following platforms:
<ul><li>Operating systems: Windows 7, 64-bit</li><li>Publishing platforms: VMware Horizon View and Citrix XenDesktop.</li></ul>
###User Layer creation process<a name="User_Layer_creation_process"></a>
<ul><li>Enable User Layers in your Image Template:<ul><li>Set <em>Elastic Layering</em> in the Image Template wizard on the Image Disk tab) to <em>Application and User Layers</em>.</li><li>Publish Layered Images using the above Image Template.</li></ul></li><li><p>When a user logs on to their desktop for the first time, a User Layer is created for them.</p></li></ul>
###User Layer size and location<a name="User_Layer_size_and_location"></a>
The default size of a User Layer is 10 GB.
User Layers are created in the ***Users***  folder on the ELM's network file share, for example:
\\***MyServer*** \***MyShare*** \Users
Each user will have his/her own directory within the Users directory, and it will be named as follows:
Users\***domainIname*** \***username*** \***OS-Layer-ID-in-hex*** _***OS-Layer-name*** \***username*** .vhd
For example:
<ul><li>User's login name: <strong>jdoe</strong> </li><li>User's Domain: <strong>testdomain1</strong> </li><li>OS layer: MyOSLayer (ID is in hexidecimal format: <em>123456</em>)</li><li>User Layer would be created in:</li></ul>
\\MyServer\MyShare\Users\testdomain1\jdoe\123456_MyOSLayer\jdoe.vhd
##Enable User Layers in the Layered Image<a name="Enable_User_Layers_in_the_Layered_Image"></a><a name="Create2_..350"></a>
<ol><li>Log into the Unidesk Management Console (UMC) as an <strong>Admin</strong> user.</li><li>Select <strong>Images</strong>.</li><li>Select the Image Template from which you will publish the Layered Image(s), and click <strong>Edit Template</strong>. This opens the Edit Image Template wizard.</li><li>On the Layered Image Disk tab, set <strong>Elastic Layering</strong> to <strong>Application and User Layers</strong>.</li><li>On the Confirm and Complete tab, click <strong>Save Template Changes</strong>.</li><li>Publish your Layered Images.</li></ol>
##Expected behavior<a name="Expected_behavior"></a>
###Considerations<a name="Considerations"></a>
Before deploying User Layers, please consider the following guidelines and limitations.
<ul><li>The User Layer is delivered via the ELM's file share, therefore:<ul><li>If the host is disconnected from the User Layer storage, the user will have to log out and log in again to re-establish the disk mount. The user will have to wait approximately 5 minutes because the user layer will be inaccessible.</li></ul></li><li>Certain enterprise applications, such as MS Office and Visual Studio should be installed in Layers, not as user-installed applications in the User Layer. In addition, the Elastic Layering limitations are applicable for User Layer. For more information on Layering limitations, please see the <a href="#Assign_App_Layers_to_users_elastically_(Elastic_Layers)">Elastic Layering Limitations</a> section.</li><li>Windows updates must be disabled on the User Layer.</li><li>VMware Horizon View:<ul><li><p>View must be configured for non-persistent desktops, and the desktop <em>must</em> be set to <em>Refresh at log off</em>. Delete or refresh the machine on log off. Example:</p><p><img></img></p></li><li>After logging off with View set to <em>Refresh Immediately</em>, the desktop goes into maintenance mode. If there is only one machine in the pool, the pool will not be available until that machine has completed the refresh.</li></ul></li></ul>
<ul><li>The first time a user logs into his/her desktop, a User Layer is created for the him/her.</li><li>If there is problem loading the elastically assigned Layers for the user, they will still receive their User Layer.</li><li>If you rename the user in AD, a new directory and User Layer will be created for the new name. To avoid this, rename the directory on the file share and the VHD file in the directory structure to the new AD user name.</li></ul>

#Assign App Layers<a name="Assign_App_Layers"></a>
Do you want to assign this App Layer to Layered Images, or directly to users as an Elastic Layer? You can make both kinds of assignments, as long as each user is assigned a single instance of the Layer, either as part of an image or as an elastic layer.




#Assign an App Layer to Image Templates<a name="Assign_an_App_Layer_to_Image_Templates"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Add an App Layer Assignment to one or more Image Templates</p><p>Update App Layers and Image Template Assignments</p><p>Remove Template Assignments</p></td></tr></tbody></table>
An Image Template is a stored selection of Layers and settings that you use to publish Layered Images. At minimum, an Image Template contains an OS Layer, Platform Layer, and settings. Ideally, each template also contains your choice of App Layers for a particular image, for example, an image suited for the users served by a particular silo. Once you publish a Layered Image, you can provision systems using the image.

When you create a new App Layer, you can assign the App Layer to one or more Unidesk Image Templates, and then use the templates to publish Layered Images that include the layer. This article explains how to assign an App Layer to one or more Image Templates, and update the assignments when you update the Layer.
When you first update an App Layer, the new Layer Version is not assigned to any Image Templates, so you'll need to update the Layer Assignments. Updating the assignments allows you to assign different Versions of the Layer to different Image Templates. You cannot assign an App Layer to
***Important:***  When assigning App Layers, be sure to avoid assigning the app elastically to a user, if the app is already in the Layered Image that the user gets.
##Prerequisites<a name="Prerequisites_..777"></a><a name="Prerequi_..351"></a>
<ul><li>One or more App Layers.</li><li>One or more Image Templates.</li></ul>
##Add an App Layer Assignment to one or more Image Templates<a name="Add_an_App_Layer_Assignment_to_one_or_more_Image_Templates"></a><a name="Assign_..352"></a>
<ol><li>Log into the Unidesk Management Console (UMC) as an Admin user, and select <strong>Layers > App Layers</strong>.</li><li>Select an App Layer to include in one or more of your Image Templates, and click <strong>Add Assignments</strong>.</li><li>In the wizard that opens, select the App Layer that you want to assign to templates.</li><li>On the Image Template Assignment tab, select the templates in which you want to include this App Layer Version.</li><li>Skip the Elastic Assignment tab.</li><li>In the Confirm and Complete tab, review your selections, and click <strong>Assign Apps</strong>.</li></ol>
When you open each of the Image Templates you will see the App Layer Version you just assigned to the template.
##Update App Layers and Image Template Assignments<a name="Update_App_Layers_and_Image_Template_Assignments"></a><a name="Update_..353"></a>
When you update an application by adding a new Version to the App Layer, the new Layer Version will ***not***  inherit the original Layer Assignments. You need to assign the new App Layer Version.
<ol><li><p>Log into the UMC and select <strong>Layers > App Layers</strong>.</p></li><li><p>Select the App Layer that has been updated.</p></li><li><p>Right-click the Layer icon and select <strong>Update Assignments</strong>.</p></li><li><p>In the wizard that opens, select the new App Layer Version.</p></li><li><p>Click the <strong>Image Template Assignment</strong> tab, and select the Image Templates to which you want to assign the new Layer Version .</p><p><strong>Notes:</strong></p><ul><li>If the list is long, use the <strong>Search</strong> field to filter the results.</li><li>If the list is empty, click the check box called, <strong>Show Image Templates already at this version</strong>. A list of grayed out names may appear. These Image Templates have already been assigned the Version.</li></ul></li><li>Skip the Elastic Assignment tab.</li><li>On the Confirm and Complete tab, verify the Image Templates selected to receive the new Version, and click <strong>Update Assignments</strong>.</li></ol>
##Remove Template Assignments<a name="Remove_Template_Assignments"></a><a name="Remove"></a>
When you remove an App Layer's Template Assignments, the assignments for all versions of the Layer are removed. If you want to remove the assignments for a specific Version of the Layer, select Update Assignments instead.
<ol><li><p>Log into the UMC and select <strong>Layers > App Layers</strong>.</p></li><li><p>Select the App Layer for which you want to remove assignments, and select <strong>Remove Assignments</strong>..</p></li><li><p>In the wizard that opens, select the assigned templates from which you want to remove the Layer. All of the assignments for that layer are listed.</p><p>If the list is long, use the Search field to filter the results.</p></li><li>On the Confirm and Complete tab, verify the Image Templates selected to receive the new Version, and click <strong>Update Assignments</strong>.</li></ol>

#Assign App Layers to users elastically (Elastic Layers)<a name="Assign_App_Layers_to_users_elastically_(Elastic_Layers)"></a><a name="top"></a>
In this article:
<table><tbody><tr><td><p>Assign apps elastically</p><p>Prerequisites and limitations</p><p>Enable Elastic Layering in the base image</p><p>Run the Elastic Fit Analyzer on App Layers (Unidesk Labs)</p><p>Elastically assign an App Layer to AD Users and Groups</p><p>Elastically assign an App Layer to users via machine assignments and associations</p><p>Manage Elastic Assignments</p></td></tr></tbody></table>
##Assign apps elastically<a name="Assign_apps_elastically"></a><a name="You"></a>
Wouldn't it be nice to drastically reduce the number of images you have to manage? What if you could leave apps that only a few users need out of your base image? And, assign the layers to specific users ***elastically***  on top of the base image. With the Elastic App Layers feature, you can do just that.
An Elastic App Layer is a Unidesk App Layer that you configure to be delivered to specific users and groups, based on user entitlements, when the users log onto their session hosts or standalone desktops. With Elastic App Layers, you can give each user his/her own unique set of applications in addition to the base Layered Image that is used across sessions in the case of session hosts), and across floating pools/shared groups in the case of desktops.
As this diagram shows, once you add Elastic Assignments to an App Layer, a copy of the Layer is stored in the ELM's Network File Share, and delivered to individual AD users and groups on-demand, in addition to the Layers that they receive via the base image.

To use this feature, you'll add ***Elastic Assignments***  specifying which users and groups should receive each of the App Layers that you would like to leave out of your base images. You'll then publish your base image(s) with the ***Elastic Layering For Session Hosts***  selected.
####How users access Elastic Layers assigned to them<a name="How_..354"></a>
When users log into their Session or Desktop, icons for their Elastic Layers will appear as shortcuts on the desktop.
A user receives an Elastic Layer in the following cases:
<ul><li>The user (an AD user in the Unidesk Management Console) is assigned the Layer.</li><li>An AD group that the user belongs to is assigned the Layer.</li><li>A machine that the user logs into is a member of an AD Group that receives the Elastic Layer.</li><li>A machine that the user logs into is associated (via the UMC) with an AD Group that is assigned the Layer via the UMC.</li></ul>
####If more than one version of the same Layer is assigned to a user
If a Layer is assigned directly to the user and indirectly to one or more of the user's groups, the user receives the most recent version of the Layer assigned ***directly***  to her/him. For example, if a user is assigned Version 2, and a group that the user belongs to is assigned Version 3, the user will get Version 2.
If the user is assigned a Layer via one or more group assignments, the user receives the most recent version of the Layer.
####If a user has an App Layer in their Layered Image, and the Layer is also assigned to them elastically
If a user has an App Layer in the Layered Image and the user is also assigned the Layer elastically, they will receive the Elastic Layer, even if the version in the base image is more recent.
##Prerequisites and limitations<a name="Prerequisites_and_limitations"></a><a name="Prerequisites"></a>
###Prerequisites<a name="Prerequisites_..778"></a>
<ul><li>The ELM's Network File Share must be configured correctly:<ul><li>The Share must be configured using SMB technology. When using Elastic Layer assignments, <em>NFS technology is not supported</em>.</li><li>The Share must be set up by the admin to be <strong>readonly</strong> for all users <em>except</em> for the one configured in the ELM. This secures the Layers and other files stored on the Share.</li><li>The User named in this configuration must have <strong>Read/Write</strong> permissions on the root of the network file share. Select <strong>System > Settings and Configuration</strong> and scroll to <strong>Network File Share</strong>.</li><li>Make sure that any users who will be assigned Elastic Layers have <strong>Read only</strong> access for the root directory of the Network File Share.</li></ul></li><li>.NET Framework 4.5 is required on any Layered Image where Elastic Layers are enabled.</li><li><p>The <a href="#Create_an_App_Layer">App Layers</a> you want to elastically assign.</p><p><strong>Note:</strong> App Layers must be created using the <em>same OS Layer</em> used to create the Layered Image that you enable to deliver the Elastic App Layer to users.</p></li></ul>
###Elastic Layering Limitations<a name="Elastic_Layering_Limitations"></a><a name="Elastic_Layering_Limitations"></a>
You cannot elastically layer the following:
<ul><li>Microsoft Office Add-ons and extensions in individual Unidesk Layers. A user must have <em>all</em> of their add-ons in <em>one</em> Layer. Note: Please use the recipe for elastically layering MS Office.</li><li>Applications with drivers that use the driver store. For example, a printer driver.</li><li>Applications that modify the network stack or hardware. For example, a VPN client.</li><li>Applications that have boot level drivers. For example, a virus scanner.</li></ul>
##Enable <a name="Enable__Elastic_Layering_in_the_base_image"></a><a name="Enable_Elastic_Layers_in_Image"></a>***Elastic Layering***  in the base image<a name="Enable__Elastic_Layering_in_the_base_image"></a><a name="Enable_Elastic_Layers_in_Image"></a>
When you publish the Layered Image that the users will log into to get the Elastic App Layer(s):
<ol><li><p>In the Image Template Wizard, on the Layered Image Disk tab, select <strong>Elastic Layering For Session Hosts</strong>.</p></li><li><p>Finish publishing the Layered Image.</p></li><li><p>Provision your Session Hosts with the new base image.</p><p>When the users log in, they should see an icon for each Elastic App Layer they've been assigned.</p></li></ol>
##Run the Elastic Fit Analyzer on App Layers (Unidesk Labs)<a name="Run_the_Elastic_Fit_Analyzer_on__App_Layers__(Unidesk_Labs)"></a><a name="Elastic_Fit"></a>
Before assigning an App Layer elastically, use the Elastic Fit Analyzer to determine the likelihood that the Layer assignment will be successful.
###Elastic Fit Analysis<a name="Elastic_Fit_Analysis"></a><a name="Elastic"></a>
In the Layer Details, the Elastic Fit rating indicates how likely it is that the Layer will work when elastically assigned.
<table><tbody><tr><td><p><img></img></p></td><td><p><strong>Good Elastic Fit.</strong> This layer should work when deployed elastically.</p></td></tr><tr><td><p><img></img></p></td><td><p><strong>Poor Elastic Fit.</strong> This layer will probably not work when deployed elastically, or may behave differently than when it is deployed in a Layered Image.</p></td></tr></tbody></table>
###Elastic Fit Details<a name="Elastic_Fit_Details"></a>
You can learn more about the Elastic Fit of a Layer by expanding the Elastic Fit Analysis. If the Elastic Fit is less than ideal, the list of violated rules will be displayed.
<table><tbody><tr><td><p><img></img></p></td><td><strong>Low Severity Warning.</strong> This is unlikely to cause any change in behavior or functionality for most applications.</td></tr><tr><td><p><img></img></p></td><td><strong>Medium Severity Warning.</strong> This may cause minor changes in behavior or functionality for some applications.</td></tr><tr><td><p><img></img></p></td><td><strong>High Severity Warning.</strong> This is likely to cause significant changes in behavior or functionality for many applications.</td></tr></tbody></table>
###Enable Elastic Fit in Unidesk Labs<a name="Enable_Elastic_Fit_in_Unidesk_Labs"></a>
To use this Unidesk Labs feature, you must enable it. To enable Elastic Fit:
<ol><li>In the Unidesk Management Appliance (UMC), select <strong>System > Settings and Configuration</strong>.</li><li>Click <strong>Edit</strong> Unidesk Labs.</li><li>Select the <strong>Elastic Fit</strong> check box.</li><li>Click <strong>Save</strong>.</li></ol>
###Analyze an App Layer for Elastic Fit<a name="Analyze_an_App_Layer_for_Elastic_Fit"></a>
All new Layer Versions will be analyzed for elastic layering compatibility when they are finalized. To analyze existing App Layers for Elastic Fit:
<ol><li>Log into the Unidesk Management Console (UMC) .</li><li>Select <strong>Layers > App Layers</strong>.</li><li>Select the Layer to analyze, and click <strong>Analyze Layer</strong>.</li><li>On the Select Versions tab, choose the Layer Versions to analyze.</li><li>On the Confirm and Complete tab, click <strong>Analyze Layer Versions</strong>. The analysis takes seconds.</li><li>To see the Elastic Fit Analysis, select the App Layers module, move the mouse pointer over the Layer icon and click the <strong>Info</strong> <img></img> icon.</li><li>Expand the <strong>Version Information</strong> for each Layer Version, and look for the Elastic Fit rating.</li><li>For a detailed report, expand the <strong>Elastic Fit Details</strong>. If the Elastic Fit is less than ideal, the list of violated rules will be displayed.</li><li>You can display the AD tree and hide the violated rules by clicking a button acknowledging that the layer is unlikely to work as expected.</li></ol>
###Upgrading from Earlier Releases<a name="Upgrading_from_Earlier_Releases"></a>
After upgrading from an earlier Unidesk release, the Elastic Fit Detail shows that any existing Layer Version(s) have not been analyzed. Until you run the analysis on existing Layer Versions, the Versions will have a single ***High severity***  Elastic Fit Detail, and a ***Poor***  Elastic Fit.
##Elastically assign an App Layer to AD Users and Groups<a name="Elastically_assign_an_App_Layer_to_AD(SPACE)Users_and_Groups"></a><a name="Assign_..355"></a>
The first time you assign an App Layer elastically, we recommend starting with an app like ***Notepad++***  or ***GIMP*** , because they are simple to .
<ol><li>Log into the Unidesk Management Console (UMC) as an Admin user, and select <strong>Layers > App Layers</strong>.</li><li>Select an App Layer that is <em>not going to be included in the base image</em>, and select <strong>Add Assignments</strong>.</li><li>In the wizard that opens, select the Version of the App Layer that you want to assign users.</li><li>Skip the <strong>Image Template Assignment</strong> tab. This tab is for assigning the Layer to an Image Template.</li><li>In the Elastic Assignment tab, select the users and groups who should get this App Layer.</li><li>In the Confirm and Complete tab, review your selections, and click <strong>Assign Apps</strong>.</li></ol>
When the users log in, they should see an icon for each Elastic App Layer they've been assigned.
##Elastically assign an App Layer to users via machine assignments and associations<a name="Elastically_assign_an_App_Layer_to_users_via_machine_assignments_and_associat..."></a><a name="AssignMachine"></a>
Any machine running the Unidesk Layering Service (ULayer.exe) can have Elastic Layers assigned to it. You can accomplish this by either adding the machine to or associating it with the AD Group, and then elastically assigning the App Layers to the AD Group.
The Layers assigned to the machine will be available to every User who successfully logs into that machine. The Unidesk Layering Service will scan for changes to the machine's AD group memberships and associations every 10 minutes. When the users log in, they should see an icon for each Elastic App Layer they've been assigned.
###Use <a name="Use_Active_Directory_to_add_the_machine_to_the_AD(SPACE)Group"></a>***Active Directory***  to <a name="Use_Active_Directory_to_add_the_machine_to_the_AD(SPACE)Group"></a>***add***  the machine to the AD Group<a name="Use_Active_Directory_to_add_the_machine_to_the_AD(SPACE)Group"></a>
Assuming you have a published Layered Image booted in your environment, you can add the machine to an AD Group, and assign Elastic Layers to the AD Group.
<ol><li>Use Active Directory (AD) to add the machine to an AD Group.</li><li>Select an App Layer that is <em>not going to be included in the base image</em>, and <a href="#Assign_..355">elastically assign</a> the Layer(s) to an AD Group.</li><li><p>You can wait for AD to propagate the changes and be recognized by the Unidesk Layering Service, or you can force the Unidesk Layering Service to update its list of machine groups by doing <em>one</em> of the following:</p><ul><li><p>Wait for the Unidesk Layering Service to detect the changes (within 10 minutes by default).</p></li><li><p>Restart the Unidesk Layering Service.</p></li><li><p>Reboot the Unidesk Layering Service Machine.</p></li><li><p>Execute the <strong>refresh.groups</strong> command:</p><pre>C:\Program Files\Unidesk\Layering Services\ulayer.exe refresh.groups</pre></li></ul></li></ol>
####Example
You start with an AD User, and AD Group, and a machine that you provisioned using a Layered Image.
<ul><li>AD User: <em>Kenya</em><ul><li>Kenya has no elastic assignments.</li></ul></li><li>AD Group: <em>Marketing</em><ul><li>The <em>Marketing</em> group includes the member Kenya.</li></ul></li><li>Machine: <em>ElasticTestMachine</em><ul><li>The <em>ElasticTestMachine</em> base image includes the <em>MS Office App Layer</em>.</li></ul></li></ul>
In this example, you elastically assign the ***Chrome App Layer***  to ***ElasticTestMachine*** :
<ol><li>In AD, you add the machine <em>ElasticTestMachine</em> to the <em>Marketing</em> AD Group.</li><li>In the Unidesk Management Console (UMC) you <a href="#Assign_..355">elastically assign</a> the <em>Chrome App Layer</em> to the <em>Marketing</em> Group.</li><li>When Kenya, who is part of the Marketing group, logs into <em>ElasticTestMachine</em>, she receives both the <em>MS Office App Layer</em>, which is in the base image, and the <em>Chrome App Layer</em>.</li><li>When any user who is <em>not</em> in the <em>Marketing</em> group logs into <em>ElasticTestMachine</em>, they also receive both Layers: <em>MS Office</em> because it is in the base image, and <em>Chrome</em> because the <em>ElasticTestMachine</em> is a member of the <em>Marketing</em> AD Group.</li></ol>
###Use the <a name="Use_the_UMC(SPACE)to_associate_the_machine_with_an_AD(SPACE)Group"></a><a name="Use"></a>***UMC***  to <a name="Use_the_UMC(SPACE)to_associate_the_machine_with_an_AD(SPACE)Group"></a><a name="Use"></a>***associate***  the machine with an AD Group<a name="Use_the_UMC(SPACE)to_associate_the_machine_with_an_AD(SPACE)Group"></a><a name="Use"></a>
Associating a set of machines with an AD Group allows any machine running the Unidesk Layering Service to have Layers elastically assigned to it via AD group membership.
Elastic Layers granted via Machine association can be thought of as ***extending***  the layers assigned to a user. For example, if a machine matches multiple Machine Associations, only the unique layers will be added to the ones the user already has.
In the UMC, you use asterisk (*) wildcards in a machine name pattern to specify a set of machine names. For example:
<table><thead><tr><th><p>Machine name pattern</p></th><th><p>Matches these names</p></th><th><p>Does <em>not</em> match these names</p></th></tr></thead><tbody><tr><td><p>machine*</p></td><td><p>machine01</p><p>machineindetroit</p></td><td><p>amachine</p><p>localtestmachine</p></td></tr><tr><td>*machine</td><td><p>amachine</p><p>localtestmachine</p></td><td><p>machine01</p><p>machineindetroit</p></td></tr><tr><td>ky*eng</td><td><p>ky02359eng</p><p>kytesteng</p></td><td><p>01ky_eng</p><p>testky01eng</p></td></tr><tr><td>*eng*</td><td><p>eng01</p><p>1eng</p><p>1eng01</p></td><td><p>en01</p><p>1en</p><p>1en01</p></td></tr></tbody></table>
You can create Machine Associations before or after elastically assigning App Layers to the AD Group. Also, the machines do not need to exist when you add the associations, as the associations exist within Unidesk only, and AD is not aware of them.
####Associate a set of machines with an AD Group
<ol><li><p>Log into the Unidesk Management Console (UMC) as an Admin user, and select <strong>Users > Tree</strong>.</p></li><li><p>Expand the Tree, select the appropriate Group and click <strong>Edit Properties</strong> in the Action bar. This opens the Edit Group Wizard.</p><p><img></img></p></li><li><p>Select the checkbox, <em>Associate machines with this AD Group</em>. This reveals the <em>Machine Name Pattern</em> field:</p><p><img></img></p></li><li><p>Specify a set of machines to associate with the AD group by entering a machine name pattern. For examples, see the above table of Machine name patterns.</p></li><li><p>On the Confirm and Complete tab, select <strong>Update Group</strong>. Notice the shape of a computer monitor superimposed over the group icon. This indicates that machines are associated with the group.</p><p><img></img></p><p>When you click the group's <img></img> icon, the Detail view now includes a field called, <em>Associate With Machines</em> where the pattern.</p><p><img></img></p></li></ol>
####Example
You start with the machine, ***Mach1*** , the AD Group, ***MachineGroup*** , and the App Layers for ***Firefox***  and ***MS Office*** .
<ul><li>Machine: <em>Mach1</em></li><li>AD Group: <em>MachineGroup</em></li><li>App Layers: <em>Firefox</em>, <em>MS Office</em></li></ul>
Further, you have elastically assigned the Firefox and MS Office Layers to the AD Group.
If you add a Machine Association to ***MachineGroup***  with a name pattern of "***Mach**** ", when any domain user logs into ***Mach1*** , they will receive the Firefox and MS Office Elastic App Layers.
##Manage Elastic Assignments<a name="Manage_Elastic_Assignments"></a><a name="Manage"></a>
You can:
<ul><li>View a user's Elastic Layer assignments.</li><li>Update an App Layer and elastically assign the new Version of the Layer.</li><li>Remove Elastic Assignments.</li><li>Debug an Elastic Assignments.</li></ul>
View a user's Elastic Layer assignments<a name="View"></a>
<ol><li>Log into the UMC and select <strong>Users > Tree</strong>.</li><li>Select an AD User or Group, and click the "i" icon to the <em>right</em> of the name. If the user or group is assigned any Elastic Layers, the Layers are listed just below the user's or group's profile information in the Details window that appears.</li></ol>
###Update an App Layer and its Elastic Assignments<a name="Update_an_App_Layer_and_its_Elastic_Assignments"></a><a name="Update_..356"></a>
You've added Elastic Assignments to an App Layer, and users are accessing the app as expected. A new version of the application is released, so you update it by adding a new Version to the Layer. Now you need to assign the new version to the users who have the Layer.
<ol><li>Log into the UMC and select <strong>Layers > App Layers</strong>.</li><li>Select the elastically assigned App Layer that you just updated.</li><li>Right-click the Layer icon and select <strong>Update Assignments</strong>.</li><li>In the wizard that opens, select the new Version.</li><li><em>Skip</em> the Image Template Assignment tab.</li><li><p>In the Elastic Assignment tab, there's a list of Users and Groups who have been assigned a different version of the selected Layer. Select the users and groups to whom you want to assign the new Version of the Layer.</p><p><strong>Notes:</strong> </p><ul><li>If the list is long, use the <strong>Search</strong> field to filter the results.</li><li>If the list is empty, click the check box called, <strong>Show AD users and groups already at this version</strong>. A list of grayed out names may appear. These users have already been assigned the Version.</li></ul></li><li>On the Confirm and Complete tab, verify the Users and Groups selected to receive the new Version, and click <strong>Update Assignments</strong>.</li></ol>
###Remove a Layer's Elastic Assignments<a name="Remove_a_Layer's_Elastic_Assignments"></a><a name="Remove_..357"></a>
<ol><li><p>Log into the UMC and select <strong>Layers > App Layers</strong>.</p></li><li><p>Select the App Layer for which you want to remove assignments, and select <strong>Remove Assignments</strong>..</p></li><li><p>In the wizard that opens, select the assigned templates from which you want to remove the Layer. All of the assignments for that layer are listed.</p><p>If the list is long, use the Search field to filter the results.</p></li><li>On the Confirm and Complete tab, verify the Image Templates selected to receive the new Version, and click <strong>Update Assignments</strong>.</li></ol>
###Debug an Elastic Layer<a name="Debug_an_Elastic_Layer"></a><a name="Debuggin"></a>
If you have an Elastic Layering issue, you can diagnose the problem by finding out whether the layer is being delivered, and if so, whether it is working correctly. If needed, collect data for Unidesk Support, as described here.
####Is this a Delivery issue?
Are the things you'd expect to see if this app were installed actually there as expected?
<ul><li>Do you see the files and registry entries for the layer?</li><li>If the app is supposed to be in the Start menu, is it there?</li><li>If there should be a shortcut for the app on the user's desktop, is there one?</li></ul>
If you discover that app delivery is an issue, you can collect the following data, open a case, and send the data to Unidesk Support.
<ol><li><p>Collect the data from these logs:</p><ul><li>Windows App Event log  In the Windows Event Viewer under Windows Logs, export the Application event log as an EVTX file.</li><li>Unidesk Layering Service log (ulayersvc.log)  C:\ProgramData\Unidesk\Logs\ulayersvc.log</li></ul></li><li><p>Collect the values of these Registry keys:</p><ul><li>HKEY_LOCAL_MACHINE\SOFTWARE\Unidesk\ULayer:AssignmentFile</li><li>HKEY_LOCAL_MACHINE\SOFTWARE\Unidesk\ULayer:RepositoryPath</li></ul></li><li><p>Collect the contents of the Assignment (ElasticLayerAssignments.json) and Layers (Layers.json) files from the Repository Path.</p></li><li><p>Contact Support.</p></li></ol>
####Is this an operational issue?
One of these issues could indicate that this is an Elastic Layering issue:
<ul><li>The app is being delivered but doesn't launch correctly.</li><li>An operation within the app doesn't work correctly.</li><li>A licensing problem or a security issue.</li><li>The app launches, but then misbehaves, for example, it crashes on startup, or starts up but doesn't work right.</li></ul>
If the problem with the Layer is operational, test the App Layer in the base image to rule out general layering issues:
<ol><li>Add the App Layer to an Image Template, and publish a Layered Image that includes the App Layer.</li><li>Log in as a user who is <em>not</em> assigned the Layer elastically, and make sure that the application is operational in the base image.</li><li>Contact Support with your findings.</li></ol>


#Delete Layers<a name="Delete_Layers"></a>
What type of layer do you want to delete?




#Delete an OS Layer<a name="Delete_an_OS_Layer"></a>
You can delete an OS Layer or Layer version, as long as it is not being used by another Unidesk Layer, or Image Template. Deleting the Layer itself removes all versions, volumes, and resources from Unidesk, where it is stored.
In this article:
[Before you can delete a Layer or Layer Version ](#Before_..358)
[Delete a Layer or Layer Version](#Delete)
##Before you can delete a Layer or Layer Version<a name="Before_you_can_delete_a_Layer_or_Layer_Version"></a><a name="Before_..358"></a>
You can delete an entire layer or a layer version if it is:
<ul><li>Not deployed to an Image Template.</li><li>Not the required OS Layer (or Layer Version) for any compatible App Layers.</li><li>Not a prerequisite for another Layer that is deployed to an Image Template.</li></ul>
##Delete a Layer or Layer Version<a name="Delete_a_Layer_or_Layer_Version"></a><a name="Delete"></a>
<ol><li>In the Unidesk Management Console, select <span>Layers</span>.</li><li>Select an OS Layer to delete.</li><li>Select <span>Delete Versions</span> in the Action bar. This opens the Delete Version Layer wizard.</li><li>In the Version Selection tab, select the Version you want to delete, or select the <span>Delete Layer</span> check box to delete the entire Layer.</li><li>In the Confirm and Complete tab, verify that the correct Version (or Layer) is selected for deletion, enter a comment if needed, and click <span>Delete Versions</span>.(missing or bad snippet)</li></ol>

#Delete a Platform Layer<a name="Delete_a_Platform_Layer"></a>
You can delete a Platform Layer or Layer version, as long as it is not being used by an Image Template. Deleting the Layer itself removes all versions and resources associated with the Layer.
In this article:
[Delete a Layer or Layer Version](#Delete_..359)
##Delete a Layer or Layer Version<a name="Delete_a_Layer_or_Layer_Version_..779"></a><a name="Delete_..359"></a>
<ol><li>In the Unidesk Management Console, select <span>Layers > Platform Layers</span>.</li><li>Select a Layer to delete.</li><li>Select <span>Delete Versions</span> in the Action bar. This opens the Delete Version Layer wizard.</li><li><p>In the Version Selection tab, select the Version you want to delete, or select the <span>Delete Layer</span> check box to delete the entire Layer and all Versions.</p></li><li>In the Confirm and Complete tab, verify that the correct Version (or Layer) is selected for deletion, enter a comment if needed, and click <span>Delete Versions</span>.(missing or bad snippet)</li></ol>

#Delete an App Layer<a name="Delete_an_App_Layer"></a>
You can delete an App Layer or Layer version, as long as it is not being used by another Unidesk Layer, or Image Template. Deleting the Layer itself removes all versions and resources associated with the Layer.
In this article:
[Before you can delete a Layer or Layer Version ](#Before_..360)
[Delete a Layer or Layer Version](#Delete_..361)
##Before you can delete a Layer or Layer Version<a name="Before_you_can_delete_a_Layer_or_Layer_Version_..780"></a><a name="Before_..360"></a>
You can delete an entire layer or a layer version if it is:
<ul><li>Not deployed to an Image Template.</li><li>Not a prerequisite for another Layer that is deployed to an Image Template.</li></ul>
##Delete a Layer or Layer Version<a name="Delete_a_Layer_or_Layer_Version_..781"></a><a name="Delete_..361"></a>
<ol><li>In the Unidesk Management Console, select <span>Layers > Application Layers</span>.</li><li>Select a Layer to delete.</li><li>Select <span>Delete Versions</span> in the Action bar. This opens the Delete Version Layer wizard.</li><li><p>In the Version Selection tab, select the Version you want to delete, or select the <span>Delete Layer</span> check box to delete the entire Layer and all Versions.</p></li><li>In the Confirm and Complete tab, verify that the correct Version (or Layer) is selected for deletion, enter a comment if needed, and click <span>Delete Versions</span>.(missing or bad snippet)</li></ol>

#Publishing essentials<a name="Publishing_essentials"></a>
Unidesk lets you publish ***Layered Images***  as disks compatible with your platform. You can use a Layered Image to provision servers, as you would with any other image.
##About Layered Images<a name="About_Layered_Images"></a>
Layered Images are bootable images composited from Unidesk Layers. Each Layered Image contains an OS Layer, a Platform Layer, and any number of App Layers.

##Creating and updating Layered Images<a name="Creating_and_updating_Layered_Images"></a>
The way you specify which layers to include in a Layered Image is by saving the combination of layers you want for a particular group of users in an Image Template. You then use this template to publish a Layered Image to your chosen platform.

When you need to update the Layered Image, you simply edit the Image Template to add or remove layer assignments, and publish a new version of the image.



#Publish Layered Images<a name="Publish_Layered_Images"></a>
Once you have an OS Layer and a Platform Layer, a best practice is to verify that the Layers can be published to your environment as part of a Layered Image. Then you can build out the image by adding App Layers to it.
To publish the Layered Image, you first add the Layers to an Image Template, and use the template to publish a Layered Image. Once you have verified that the Layered Image is successfully published, create your App Layers, add them to your Image Template, and publish a Layered Image.
##Before you start<a name="Before_you_start_..782"></a>
Install the Unidesk Enterprise Layer Manager (ELM)
Set up Unidesk
Create Layers
##Publish Layered Images<a name="Publish_Layered_Images_..783"></a>
<ol><li><a href="#Create_Image_Templates">Create an Image Template</a></li><li><a href="#Publish_Layered_Images_..8">Publish a Layered Image</a></li></ol>
##Next Steps<a name="Next_Steps"></a>
Now you can:
<ul><li><a href="#Add_a_version_to_an_OS_Layer">Update your OS Layer and App Layers, as needed</a></li><li><a href="#Manage_Image_Templates">Add the new layer version to your Image Template</a></li><li><a href="#Publish_Layered_Images_..8">Publish the Layered Image</a></li></ul>
#Create Image Templates<a name="Create_Image_Templates"></a>
On what platform are you publishing Layered Images?


#Create Image Templates (MCS for Nutanix AHV)<a name="Create_Image_Templates_(MCS_for_Nutanix_AHV)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Create an Image Template</p><p>Next Step</p></td></tr></tbody></table>
You can create Image Templates to publish Layered Images to your target platform where you can then use the Layered Image to provision servers on your chosen publishing platform. An Image Template stores your Layer assignments, along with a Layer icon and description. You can easily [edit](#Ed_Temp)[ an Image Template and use it to publish new versions of your Layered Images.](#Ed_Temp)
##Prerequisites<a name="Prerequisites_..784"></a><a name="Pre"></a>
<ul><li><p><a href="#Create_an_OS_Layer_(Nutanix_AHV)">OS Layer</a> (Required)</p></li><li><p><a href="#Create_an_OS_Layer_(Nutanix_AHV)"></a><a href="#Create_a_Platform_Layer_(Nutanix_AHV)">Platform Layer</a> (Required for cross-platform deployments)</p><p>The Platform Layer contains the software required for publishing to your environment, in this case:</p><ul><li>Nutanix Acropolis VM Mobility</li><li>Citrix MCS Device imaging tools</li></ul><p>The Platform Layer must have the same hardware settings as the OS Layer. You choose these settings when deploying the VM for the OS and Platform Layers.</p></li><li><p><a href="#Create_an_App_Layer_(Nutanix_AHV_Connector)">App Layers</a> (Optional)</p><p>You can create an Image Template without App Layers. This is useful for testing your OS Layer before using it to create App Layers.</p></li></ul>
##Create an Image Template<a name="Create_an_Image_Template"></a><a name="Cr_Temp"></a>
To create an Image Template:
<ol><li>In the Unidesk Management Console (UMC), select the <strong>Images</strong> module, then click <strong>Create Template</strong>. This opens the Create Template wizard.</li><li>In the Name and Description tab, enter a <strong>Name</strong> for the template and notes in the <strong>Description</strong> field, so you can identify the template when choosing one for publishing a Layered Image.</li><li>In the OS Layer tab, select one of the <strong>Available OS Layers</strong>. If there is more than one Layer Version, the most recent version is selected by default. You can choose an older version by expanding the Layer and choosing a different one.</li><li>In the App Assignment tab, select the <strong>App Layers</strong> to include in the Layered Images that you publish using this template.</li><li><p>On the Connector page, select a Citrix MCS for Nutanix AHV Connector Configuration for the location where you want to publish the Layered Image.</p><p>If you do not yet have a Connector Configuration for Citrix MCS for Nutanix AHV, add one. Click <strong>New</strong>, choose the Connector Type, and follow the instructions to <a href="#Connector_Configuration_(AND)_Optional_Script__(MCS_for_Nutanix_AHV)">Create a Connector Configuration</a>.</p></li><li><p>In the Platform Layer tab, select a Platform Layer with the tools and hardware settings that you need to publish Layered Images to your environment. For details, click <a href="#platform_layer_prereqs">here</a>.</p></li><li><p>On the Layered Image Disk page, edit the following fields, as needed:</p><ul><li>(Optional) <em>Layered Image Disk File name</em>. Enter a name for the Layered Image Disk.</li><li><em>Layered Image Disk Size</em>. The default disk size of 100 GB is recommended.</li><li><em>Layered Image Disk Format</em>. The default disk format is VHD, but you can also select VMDK or QCOW2.</li><li><em>Elastic Layering</em> - Controls whether Elastic Layering on this Layered Image is allowed. To allow Elastic Layers for users of this Layered Image, select <strong>Application Layers only</strong>. Otherwise, select <strong>None</strong>.</li></ul></li><li>On the Confirm and Complete tab, enter any comments you would like for this layer, and click <strong>Create Template</strong>.</li></ol>
The new Template icon appears in the Unidesk Images module.
##Next Step<a name="Next_Step_..785"></a><a name="Next_..362"></a>
Publish Layered Images (MCS for Nutanix AHV)
#Create Image Templates (Citrix MCS for vSphere)<a name="Create_Image_Templates_(Citrix_MCS_for_vSphere)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Create an Image Template</p><p>Next Step</p></td></tr></tbody></table>
You can create Image Templates to publish Layered Images to your target platform where you can then use the Layered Image to provision servers on your chosen publishing platform. An Image Template stores your Layer assignments, along with a Layer icon and description. You can easily [edit an Image Template](#Ed_Temp)[ and use it to publish new versions of your Layered Images.](#Ed_Temp)
##Prerequisites<a name="Prerequisites_..786"></a><a name="Pre_..363"></a>
To create an Image Template you need:
<ul><li>A Platform Layer containing the software required for your environment.</li><li>The Platform Layer must include:<ul><li>The same hardware settings as the OS Layer you are using. (You choose the hardware settings when deploying the VM for the OS and Platform Layers.)</li><li>The software and settings required for your environment.</li></ul></li></ul>
##Create an Image Template<a name="Create_an_Image_Template_..787"></a><a name="Cr_Temp_..364"></a>
To create an Image Template:
<ol><li>In the Unidesk Management Console (UMC), select the <strong>Images</strong> module, then click <strong>Create Template</strong>. This opens the Create Template wizard.</li><li>In the Name and Description tab, enter a <strong>Name</strong> for the template and notes in the <strong>Description</strong> field, so you can identify the template when choosing one for publishing a Layered Image.</li><li>In the OS Layer tab, select one of the <strong>Available OS Layers</strong>. If there is more than one Layer Version, the most recent version is selected by default. You can choose an older version by expanding the Layer and choosing a different one.</li><li>In the App Assignment tab, select the <strong>App Layers</strong> to include in the Layered Images that you publish using this template.</li><li><p>On the Connector page, select the Citrix MCS for vSphere Connector Configuration for the location where you want to publish the Layered Image.</p><p>If the Connector Configuration you need is not available, add one. Click <strong>New</strong>, choose the Connector Type, and follow the instructions to <a href="#Connector_Configuration_(AND)_Optional_Script__(Citrix_MCS_for_vSphere)">Create a Connector Configuration</a>.</p></li><li><p>In the Platform Layer tab, select a Platform Layer with the tools and hardware settings that you need to publish Layered Images to your environment.</p></li><li><p>On the Layered Image Disk page, edit the following fields, as needed:</p><ul><li>(Optional) <em>Layered Image Disk File name</em>. Enter a name for the Layered Image Disk.</li><li><em>Layered Image Disk Format</em>. Use the default format, since this is the one required for your selected environment.</li><li><em>Elastic Layering</em> - Controls whether Elastic Layering on this Layered Image is allowed. Select yes to allow Elastic Layers for users of this Layered Image.</li></ul></li><li>On the Confirm and Complete tab, enter any comments you would like for this layer, and click <strong>Create Template</strong>.</li></ol>
The new Template icon appears in the Unidesk Images module.
##Next Step<a name="Next_Step_..788"></a><a name="Next_..365"></a>
Publish Layered Images (Citrix MCS for vSphere)
#Create Image Templates (Citrix MCS for XenServer)<a name="Create_Image_Templates_(Citrix_MCS_for_XenServer)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Create an Image Template</p><p>Next Step</p></td></tr></tbody></table>
You can create Image Templates to publish Layered Images to your target platform where you can then use the Layered Image to provision servers on your chosen publishing platform. An Image Template stores your Layer assignments, along with a Layer icon and description. You can easily [edit an Image Template](#Ed_Temp)[ and use it to publish new versions of your Layered Images.](#Ed_Temp)
##Prerequisites<a name="Prerequisites_..789"></a><a name="Pre_..366"></a>
<ul><li><p><a href="#Create_an_OS_Layer_(Nutanix_AHV)">OS Layer</a> (Required)</p></li><li><p><a href="#Create_an_OS_Layer_(Nutanix_AHV)"></a><a href="#Create_a_Platform_Layer_(Nutanix_AHV)">Platform Layer</a> (Required for cross-platform deployments)</p><p>The Platform Layer contains the software required for publishing to your environment, in this case:</p><ul><li>Citrix XenServer</li><li>Citrix MCS Device imaging tools</li><li>XenApp VDA installed</li></ul><p>The Platform Layer must have the same hardware settings as the OS Layer. (These settings are chosen when deploying the VM for the OS and Platform Layers.)</p></li><li><p><a href="#Create_an_App_Layer_(Nutanix_AHV_Connector)">App Layers</a> (Optional)</p><p>You can create an Image Template without App Layers. This is useful for testing your OS Layer before using it to create App Layers.</p></li></ul>
##Create an Image Template<a name="Create_an_Image_Template_..790"></a><a name="Cr_Temp_..368"></a>
To create an Image Template:
<ol><li>In the Unidesk Management Console (UMC), select the <strong>Images</strong> module, then click <strong>Create Template</strong>. This opens the Create Template wizard.</li><li>In the Name and Description tab, enter a <strong>Name</strong> for the template and notes in the <strong>Description</strong> field, so you can identify the template when choosing one for publishing a Layered Image.</li><li>In the OS Layer tab, select one of the <strong>Available OS Layers</strong>. If there is more than one Layer Version, the most recent version is selected by default. You can choose an older version by expanding the Layer and choosing a different one.</li><li>In the App Assignment tab, select the <strong>App Layers</strong> to include in the Layered Images that you publish using this template.</li><li><p>On the Connector page, select the MCS for Nutanix AHV Connector Configuration for the location where you want to publish the Layered Image.</p><p>If the Connector Configuration you need is not available, add one. Click <strong>New</strong>, choose the Connector Type, and follow the instructions to <a href="#Connector_Configuration_(AND)_Optional_Script__(Citrix_MCS_for_vSphere)">Create a Connector Configuration</a>.</p></li><li><p>In the Platform Layer tab, select a Platform Layer with the tools and hardware settings that you need to publish Layered Images to your environment.</p></li><li><p>On the Layered Image Disk page, edit the following fields, as needed:</p><ul><li>(Optional) <em>Layered Image Disk File name</em>. Enter a name for the Layered Image Disk.</li><li><em>Layered Image Disk Format</em>. Use the default format, since this is the one required for your selected environment.</li><li><em>Elastic Layering</em> - Controls whether Elastic Layering on this Layered Image is allowed. Select yes to allow Elastic Layers for users of this Layered Image.</li></ul></li><li>On the Confirm and Complete tab, enter any comments you would like for this layer, and click <strong>Create Template</strong>.</li></ol>
The new Template icon appears in the Unidesk Images module.
##Next Step<a name="Next_Step_..791"></a><a name="Next_..369"></a>
Publish Layered Images (Citrix MCS for XenServer)
#Create Image Templates (PVS)<a name="Create_Image_Templates_(PVS)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Create an Image Template</p></td></tr></tbody></table>
You can create Image Templates to publish Layered Images to your target platform where you can then use the Layered Image to provision servers on your chosen publishing platform. An Image Template stores your Layer assignments, along with a Layer icon and description. You can easily [edit an Image Template](layered_images_manage_template.htm)[ and use it to publish new versions of your Layered Images.](layered_images_manage_template.htm)
##Prerequisites<a name="Prerequisites_..792"></a><a name="Pre_..370"></a>
To create an Image Template you need:
<ul><li>A Platform Layer containing the software required for your environment:<ul><li>When publishing images to PVS for XenApp users, the following must be installed on the Platform Layer:<ul><li>Citrix PVS Device imaging tools</li><li>XenApp VDA installed</li></ul></li></ul></li></ul>
##Create an Image Template<a name="Create_an_Image_Template_..793"></a><a name="Cr_Temp_..371"></a>
To create an Image Template:
<ol><li>In the Unidesk Management Console (UMC), select the <strong>Images</strong> module, then click <strong>Create Template</strong>. This opens the Create Template wizard.</li><li>In the Name and Description tab, enter a <strong>Name</strong> for the template and notes in the <strong>Description</strong> field, so you can identify the template when choosing one for publishing a Layered Image.</li><li>In the OS Layer tab, select one of the <strong>Available OS Layers</strong>. If there is more than one Layer Version, the most recent version is selected by default. You can choose an older version by expanding the Layer and choosing a different one.</li><li>In the App Assignment tab, select the <strong>App Layers</strong> to include in the Layered Images that you publish using this template.</li><li><p>On the Connector tab, select the PVS Connector Configuration that includes the information needed to publish the Layered Image to the correct location.</p><p>If the Connector Configuration you need is not available, add one. Click <strong>New</strong>, choose the Connector Type, and follow the instructions to <a href="#Connector_Configuration_(AND)_Optional_Script_(PVS)">Create a Connector Configuration</a>.</p></li><li><p>On the Platform Layer tab, select a Platform Layer containing the tools and hardware settings that you need to publish Layered Images to your PVS location.</p></li><li><p>On the Layered Image Disk tab, edit the following fields, as needed:</p><ul><li><em>Layered Image Disk File name</em>. Enter a name for the Layered Image Disk.</li><li><em>Layered Image Disk Size</em>. The default disk size of 100 GB is recommended.</li><li><em>Elastic Layering</em> - Controls whether Elastic Layering on this Layered Image is allowed. Select yes to allow Elastic Layers for users of this Layered Image.</li></ul></li><li>On the Confirm and Complete tab, enter any comments you would like for this layer, and click <strong>Create Template</strong>.</li></ol>
The new Template icon appears in the Unidesk Images module.
#Create Image Templates (XenServer)<a name="Create_Image_Templates_(XenServer)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Create an Image Template</p><p>Next Step</p></td></tr></tbody></table>
You can create Image Templates to publish Layered Images to your target platform where you can then use the Layered Image to provision servers on your chosen publishing platform. An Image Template stores your Layer assignments, along with a Layer icon and description. You can easily [edit](#Ed_Temp)[ an Image Template and use it to publish new versions of your Layered Images.](#Ed_Temp)
##Prerequisites<a name="Prerequisites_..794"></a><a name="Pre_..372"></a>
To create an Image Template you need:
<ul><li>A Platform Layer containing the software required for your environment.</li><li>The Platform Layer you choose must have the same hardware settings as the OS Layer you are using. (The hardware settings are chosen when you deploy the VM for the OS and Platform Layers.)</li><li>The Platform Layer you choose must contain the software required for your environment.<p><strong>Example:</strong> When publishing images to PVS for XenApp users running in XenServer, the following must be installed on the Platform Layer:</p><ul><li>Citrix XenServer</li><li>Citrix PVS Device imaging tools</li><li>XenApp VDA installed</li></ul></li></ul>
##Create an Image Template<a name="Create_an_Image_Template_..795"></a><a name="Cr_Temp_..373"></a>
To create an Image Template:
<ol><li>In the Unidesk Management Console (UMC), select the <strong>Images</strong> module, then click <strong>Create Template</strong>. This opens the Create Template wizard.</li><li>In the Name and Description tab, enter a <strong>Name</strong> for the template and notes in the <strong>Description</strong> field, so you can identify the template when choosing one for publishing a Layered Image.</li><li>In the OS Layer tab, select one of the <strong>Available OS Layers</strong>. If there is more than one Layer Version, the most recent version is selected by default. You can choose an older version by expanding the Layer and choosing a different one.</li><li>In the App Assignment tab, select the <strong>App Layers</strong> to include in the Layered Images that you publish using this template.</li><li><p>On the Connector page, select the XenServer Connector Configuration for the location where you want to publish the Layered Image.</p><p>If the Connector Configuration you need is not available, add one. Click <strong>New</strong>, choose the Connector Type, and follow the instructions to <a href="#Connector_Configuration_(AND)_Optional_Script__(Citrix_XenServer)">Create a Connector Configuration</a>.</p></li><li><p>In the Platform Layer tab, select a Platform Layer with the tools and hardware settings that you need to publish Layered Images to your environment.</p></li><li><p>On the Layered Image Disk page, edit the following fields, as needed:</p><ul><li>(Optional) <em>Layered Image Disk File name</em>. Enter a name for the Layered Image Disk.</li><li><em>Layered Image Disk Size</em>. The default disk size of 100 GB is recommended.</li><li><p><em>Sysprep</em>. An appropriate default value will be selected for your environment. This setting determines whether the Layered Image will be generalized, and if so, which script will be used to generalize the image and join a domain.</p><ul><li><em>Not Generalized</em> - Does <em>not</em> generalize the image nor join a domain. Machines created from this image will be identical to the OS Disk from which they are created.</li><li><p><em>Generalize Offline</em> - Generalizes the Image using Unidesk code, and without booting the VM. Machines created from this image will be unique, and will run unattend.xml to join a domain.</p></li></ul></li><li><em>Elastic Layering</em> - Controls whether Elastic Layering on this Layered Image is allowed. Select yes to allow Elastic Layers for users of this Layered Image.</li></ul></li><li>On the Confirm and Complete tab, enter any comments you would like for this layer, and click <strong>Create Template</strong>.</li></ol>
The new Template icon appears in the Unidesk Images module.
##Next Step<a name="Next_Step_..796"></a><a name="Next_..374"></a>
Publish Layered Images (vSphere)
#Create Image Templates (Azure)<a name="Create_Image_Templates_(Azure)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Create an Image Template</p><p>Next Step</p></td></tr></tbody></table>
You can create Image Templates to use for publishing Layered Images to your target platform. You can then use the published Layered Image to provision servers on your chosen publishing platform. An Image Template stores your Layer assignments, along with a Layer icon and description. You can easily [edit an Image Template](#Ed_Temp)[ and use it to publish new versions of your Layered Images.](#Ed_Temp)
##Prerequisites<a name="Prerequisites_..797"></a><a name="Pre_..375"></a>
To create an Image Template you need:
<ul><li>A Platform Layer containing the software required for your environment.</li></ul>
##Create an Image Template<a name="Create_an_Image_Template_..798"></a><a name="Cr_Temp_..376"></a>
To create an Image Template:
<ol><li>In the Unidesk Management Console (UMC), select the <strong>Images</strong> module, then click <strong>Create Template</strong>. This opens the Create Template wizard.</li><li>In the Name and Description tab, enter a <strong>Name</strong> for the template and notes in the <strong>Description</strong> field, so you can identify the template when choosing one for publishing a Layered Image.</li><li>In the OS Layer tab, select one of the <strong>Available OS Layers</strong>. If there is more than one Layer Version, the most recent version is selected by default. You can choose an older version by expanding the Layer and choosing a different one.</li><li>In the App Assignment tab, select the <strong>App Layers</strong> to include in the Layered Images that you publish using this template.</li><li><p>On the Connector tab, select the Connector Configuration that includes the information needed to publish the Layered Image to the correct location.</p><p>If the Connector Configuration you need is not available, add one. Click <strong>New</strong>, choose the Connector Type, and follow the instructions to <a href="#Connector_Configuration_(AND)_Optional_Script_(PVS)">Create a Connector Configuration</a>.</p></li><li><p>On the Platform Layer tab, select the Platform Layer that contains the tools and hardware settings required to publish Layered Images to Azure RDS.</p></li><li><p>(Optional) On the Layered Image Disk tab, edit the following fields, if needed:</p><ul><li><em>Layered Image Disk File name</em>. Enter a name for the Layered Image Disk.</li><li><em>Layered Image Disk Size</em>. The default disk size of 100 GB is recommended.</li><li><em>Elastic Layering</em> - Controls whether Elastic Layering on this Layered Image is allowed. Select yes to allow Elastic Layers for users of this Layered Image.</li></ul></li><li>On the Confirm and Complete tab, enter any comments you would like for this layer, and click <strong>Create Template</strong>.</li></ol>
The new Template icon appears in the Unidesk Images module.
##Next Step<a name="Next_Step_..799"></a><a name="Next_..377"></a>
Publish Layered Images (Azure RDSH)
#Create Image Templates (NFS)<a name="Create_Image_Templates_(NFS)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Create an Image Template</p><p>Next Step</p></td></tr></tbody></table>
You can create Image Templates to publish Layered Images to your target platform where you can then use the Layered Image to provision servers on your chosen publishing platform. An Image Template stores your Layer assignments, along with a Layer icon and description. You can easily [edit an Image Template](#Ed_Temp)[ and use it to publish new versions of your Layered Images.](#Ed_Temp)
##Prerequisites<a name="Prerequisites_..800"></a><a name="Pre_..378"></a>
To create an Image Template you need:
<ul><li>A Platform Layer containing the software required for your environment.</li><li>The Platform Layer you choose must have the same hardware settings as the OS Layer you are using. (The hardware settings are chosen when you deploy the VM for the OS and Platform Layers.)</li><li>The Platform Layer you choose must contain the software required for your environment.<p><strong>Example:</strong> When publishing images to PVS for XenApp users running in vSphere, the following must be installed on the Platform Layer:</p><ul><li>VMware vSphere</li><li>Citrix PVS Device imaging tools</li><li>XenApp VDA installed</li></ul></li></ul>
##Create an Image Template<a name="Create_an_Image_Template_..801"></a><a name="Cr_Temp_..379"></a>
To create an Image Template:
<ol><li>In the Unidesk Management Console (UMC), select the <strong>Images</strong> module, then click <strong>Create Template</strong>. This opens the Create Template wizard.</li><li>In the Name and Description tab, enter a <strong>Name</strong> for the template and notes in the <strong>Description</strong> field, so you can identify the template when choosing one for publishing a Layered Image.</li><li>In the OS Layer tab, select one of the <strong>Available OS Layers</strong>. If there is more than one Layer Version, the most recent version is selected by default. You can choose an older version by expanding the Layer and choosing a different one.</li><li>In the App Assignment tab, select the <strong>App Layers</strong> to include in the Layered Images that you publish using this template.</li><li><p>On the Connector Configuration tab, select the <strong>Network File Share</strong>.</p></li><li><p>On the Platform Layer tab, you can select a Platform Layer that contains the tools and hardware settings that you need to publish Layered Images to the location defined in the Connector Configuration.</p></li><li><p>On the Layered Image Disk tab:</p><ul><li><em>Layered Image Disk File name</em>. (Optional) You can change the default Layered Image Disk File name.</li><li><em>Layered Image Disk Format</em>. Select the Disk Format appropriate for the environment where your servers are running. For example, select VHD when publishing images to Azure or Hyper-V environments. Select VMDK when publishing images to vSphere or PVS, for example, when streaming the images to vSphere servers. Or, select QCOW2 or VHD when publishing to Nutanix AHV.</li><li><em>Layered Image Disk Size</em>. The default disk size of 100 GB is recommended.</li><li><em>Sysprep</em>. If your Platform Target is a <em>Network File Share</em>, this option lets you choose the method for generalizing the Layered Image. Select the method that is appropriate for your connection broker.<ul><li><em>Not Generalized</em> - Does <em>not</em> generalize the Layered Image nor join a domain. Machines created from this image will be identical to the OS Disk from which they are created. Machines created from this image will be identical to the OS Disk they are created from.</li><li><em>Generalize Offline</em> - Generalizes the Image using Unidesk code, and without booting the VM. Machines created from this image will be unique, and will run unattend.xml to join a domain.</li></ul></li><li><em>Elastic Layering</em> - (Available when Elastic Layering is enabled) Controls whether Elastic Layering on this Layered Image is allowed. Select yes to allow Elastic Layers for users of this Layered Image.</li></ul></li><li>On the Confirm and Complete tab, enter any comments you would like for this layer, and click <strong>Create Template</strong>.</li></ol>
The new Template icon appears in the Unidesk Images module.
##Next Step<a name="Next_Step_..802"></a><a name="Next_..380"></a>
Publish Layered Images (Network File Share)

#Create Image Templates (Nutanix AHV)<a name="Create_Image_Templates_(Nutanix_AHV)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Create an Image Template</p><p>Next Step</p></td></tr></tbody></table>
You can create Image Templates to publish Layered Images to your target platform where you can then use the Layered Image to provision servers on your chosen publishing platform. An Image Template stores your Layer assignments, along with a Layer icon and description. You can easily [edit](#Ed_Temp)[ an Image Template and use it to publish new versions of your Layered Images.](#Ed_Temp)
##Prerequisites<a name="Prerequisites_..803"></a><a name="Pre_..381"></a>
<ul><li><p><a href="#Create_an_OS_Layer_(Nutanix_AHV)">OS Layer</a> (Required)</p></li><li><p><a href="#Create_an_OS_Layer_(Nutanix_AHV)"></a><a href="#Create_a_Platform_Layer_(Nutanix_AHV)">Platform Layer</a> (Required for cross-platform deployments)</p><p>The Platform Layer contains the software required for publishing to your environment, in this case:</p><ul><li>Nutanix Acropolis VM Mobility</li><li>Citrix MCS Device imaging tools</li></ul><p>The Platform Layer must have the same hardware settings as the OS Layer. You choose these settings when deploying the VM for the OS and Platform Layers.</p></li><li><p><a href="#Create_an_App_Layer_(Nutanix_AHV_Connector)">App Layers</a> (Optional)</p><p>You can create an Image Template without App Layers. This is useful for testing your OS Layer before using it to create App Layers.</p></li></ul>
##Create an Image Template<a name="Create_an_Image_Template_..804"></a><a name="Cr_Temp_..383"></a>
To create an Image Template:
<ol><li>In the Unidesk Management Console (UMC), select the <strong>Images</strong> module, then click <strong>Create Template</strong>. This opens the Create Template wizard.</li><li>In the Name and Description tab, enter a <strong>Name</strong> for the template and notes in the <strong>Description</strong> field, so you can identify the template when choosing one for publishing a Layered Image.</li><li>In the OS Layer tab, select one of the <strong>Available OS Layers</strong>. If there is more than one Layer Version, the most recent version is selected by default. You can choose an older version by expanding the Layer and choosing a different one.</li><li>In the App Assignment tab, select the <strong>App Layers</strong> to include in the Layered Images that you publish using this template.</li><li><p>On the Connector page, select a Citrix MCS for Nutanix AHV Connector Configuration for the location where you want to publish the Layered Image.</p><p>If you do not yet have a Connector Configuration for Citrix MCS for Nutanix AHV, add one. Click <strong>New</strong>, choose the Connector Type, and follow the instructions to <a href="#Connector_Configuration_(AND)_Optional_Script__(MCS_for_Nutanix_AHV)">Create a Connector Configuration</a>.</p></li><li><p>In the Platform Layer tab, select a Platform Layer with the tools and hardware settings that you need to publish Layered Images to your environment. For details, click <a href="#platform_layer_prereqs_..382">here</a>.</p></li><li><p>On the Layered Image Disk page, edit the following fields, as needed:</p><ul><li>(Optional) <em>Layered Image Disk File name</em>. Enter a name for the Layered Image Disk.</li><li><em>Layered Image Disk Size</em>. The default disk size of 100 GB is recommended.</li><li><em>Layered Image Disk Format</em>. The default disk format is VHD, but you can also select VMDK or QCOW2.</li><li><em>Sysprep</em>. An appropriate default value is selected for your environment. This setting determines whether the Layered Image will be generalized, and if so, which script will be used to generalize the image and join a domain. Since MCS uses its own built in technology to perform the operations generally performed by sysprep, MCS requires the VMs used with their catalogs not be generalized so they do not go through the sysprep steps when first powered on in the catalog.</li><li><em>Elastic Layering</em> - Controls whether Elastic Layering on this Layered Image is allowed, and whether the user's app data and configuration settings are saved in a User Layer . , select one of the following values:<ul><li><strong>Application Layers only</strong>. Allows Elastic Layers for users who log into this Layered Image. Available for both Session Hosts and Desktops.</li><li><strong>Application and User Layers (Unidesk Labs)</strong>. Enables Elastic Layer assignments and User Layers on the Layered Image. User Layers preserve users' application data and configuration settings. Currently, User Layers can be used on <em>Windows 7</em> Layered Images only, not on Windows 10, nor on Session Hosts.</li><li><strong>None</strong>. Elastic Layers and User Layers are disabled.</li></ul></li></ul></li><li>On the Confirm and Complete tab, enter any comments you would like for this layer, and click <strong>Create Template</strong>.</li></ol>
The new Template icon appears in the Unidesk Images module.
##Next Step<a name="Next_Step_..805"></a><a name="Next_..384"></a>
Publish Layered Images (Nutanix AHV)

#Create Image Templates (VMware Horizon View for vSphere)<a name="Create_Image_Templates_(VMware_Horizon_View_for_vSphere)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Create an Image Template</p><p>Next Step</p></td></tr></tbody></table>
You can create Image Templates to publish Layered Images to VMware Horizon View Composer where you can then use the Layered Image(s) to provision servers on your chosen publishing platform. The Image Template stores your Layer assignments, along with a Layer icon and description. You can easily [edit an Image Template](#Ed_Temp)[ and use it to publish new versions of your Layered Images.](#Ed_Temp)
As long as you select a ***VMware Horizon for vSphere***  Connector Configuration, using this Image Template to publish a Layered Image will result in a VM in a ready-to-use state, the image shut down and a snapshot taken. You can use the VM in your Horizon environment without further modifications. Each Layered image is a new 'Parent VM' that you can select for your Linked Clones pool.
##Prerequisites<a name="Prerequisites_..806"></a><a name="Pre_..385"></a>
To create an Image Template you need:
<ul><li>A Platform Layer containing the software required for your environment.</li><li>The Platform Layer must include:<ul><li>The same hardware settings as the OS Layer you are using. (You choose the hardware settings when deploying the VM for the OS and Platform Layers.)</li><li>The software and settings required for your environment.</li></ul></li></ul>
##Create an Image Template<a name="Create_an_Image_Template_..807"></a><a name="Cr_Temp_..386"></a>
To create an Image Template:
<ol><li>In the Unidesk Management Console (UMC), select the <strong>Images</strong> module, then click <strong>Create Template</strong>. This opens the Create Template wizard.</li><li>In the Name and Description tab, enter a <strong>Name</strong> for the template and notes in the <strong>Description</strong> field, so you can identify the template when choosing one for publishing a Layered Image.</li><li>In the OS Layer tab, select one of the <strong>Available OS Layers</strong>. If there is more than one Layer Version, the most recent version is selected by default. You can choose an older version by expanding the Layer and choosing a different one.</li><li>In the App Assignment tab, select the <strong>App Layers</strong> to include in the Layered Images that you publish using this template.</li><li><p>On the Connector page, select the VMware Horizon for vSphere Connector Configuration for the location where you want to publish the Layered Image.</p><p>If the Connector Configuration you need is not available, add one. Click <strong>New</strong>, choose the Connector Type, and follow the instructions to <a href="#Connector_Configuration_(AND)_Optional_Script__(VMware_Horizon_View_for_vSphere)">Create a Connector Configuration</a>.</p></li><li><p>In the Platform Layer tab, select a Platform Layer with the tools and hardware settings that you need to publish Layered Images to your environment.</p></li><li><p>On the Layered Image Disk page, edit the following fields, as needed:</p><ul><li>(Optional) <em>Layered Image Disk File name</em>. Enter a name for the Layered Image Disk.</li><li><em>Layered Image Disk Format</em>. Use the default format, since this is the one required for your selected environment.</li><li><em>Elastic Layering</em> - Controls whether Elastic Layering on this Layered Image is allowed. Select yes to allow Elastic Layers for users of this Layered Image.</li></ul></li><li>On the Confirm and Complete tab, enter any comments you would like for this layer, and click <strong>Create Template</strong>.</li></ol>
The new Template icon appears in the Unidesk Images module.
##Next Step<a name="Next_Step_..808"></a><a name="Next_..387"></a>
Publish Layered Images (VMware Horizon View for vSphere)
#Create Image Templates (vSphere)<a name="Create_Image_Templates_(vSphere)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Create an Image Template</p><p>Next Step</p></td></tr></tbody></table>
You can create Image Templates to publish Layered Images to your target platform where you can then use the Layered Image to provision servers on your chosen publishing platform. An Image Template stores your Layer assignments, along with a Layer icon and description. You can easily [edit an Image Template](#Ed_Temp)[ and use it to publish new versions of your Layered Images.](#Ed_Temp)
##Prerequisites<a name="Prerequisites_..809"></a><a name="Pre_..388"></a>
To create an Image Template you need:
<ul><li>A Platform Layer containing the software required for your environment.</li><li>The Platform Layer you choose must have the same hardware settings as the OS Layer you are using. (The hardware settings are chosen when you deploy the VM for the OS and Platform Layers.)</li><li>The Platform Layer you choose must contain the software required for your environment.<p><strong>Example:</strong> When publishing images to PVS for XenApp users running in vSphere, the following must be installed on the Platform Layer:</p><ul><li>VMware vSphere</li><li>Citrix PVS Device imaging tools</li><li>XenApp VDA installed</li></ul></li></ul>
##Create an Image Template<a name="Create_an_Image_Template_..810"></a><a name="Cr_Temp_..389"></a>
To create an Image Template:
<ol><li>In the Unidesk Management Console (UMC), select the <strong>Images</strong> module, then click <strong>Create Template</strong>. This opens the Create Template wizard.</li><li>In the Name and Description tab, enter a <strong>Name</strong> for the template and notes in the <strong>Description</strong> field, so you can identify the template when choosing one for publishing a Layered Image.</li><li>In the OS Layer tab, select one of the <strong>Available OS Layers</strong>. If there is more than one Layer Version, the most recent version is selected by default. You can choose an older version by expanding the Layer and choosing a different one.</li><li>In the App Assignment tab, select the <strong>App Layers</strong> to include in the Layered Images that you publish using this template.</li><li><p>On the Connector page, select the vSphere Connector Configuration for the location where you want to publish the Layered Image.</p><p>If the Connector Configuration you need is not available, add one. Click <strong>New</strong>, choose the Connector Type, and follow the instructions to <a href="#Connector_Configuration_(AND)_Optional_Script__(vSphere)">Create a Connector Configuration</a>.</p></li><li><p>In the Platform Layer tab, select a Platform Layer with the tools and hardware settings that you need to publish Layered Images to your environment.</p></li><li><p>On the Layered Image Disk page, edit the following fields, as needed:</p><ul><li>(Optional) <em>Layered Image Disk File name</em>. Enter a name for the Layered Image Disk.</li><li><em>Layered Image Disk Format</em>. Use the default format, since this is the one required for your selected environment.</li><li><p><em>Sysprep</em>. An appropriate default value will be selected for your environment. This setting determines whether the Layered Image will be generalized, and if so, which script will be used to generalize the image and join a domain.</p><ul><li><em>Not Generalized</em> - Does <em>not</em> generalize the image nor join a domain. Machines created from this image will be identical to the OS Disk from which they are created.</li><li><p><em>Generalize Offline</em> - Generalizes the Image using Unidesk code, and without booting the VM. Machines created from this image will be unique, and will run unattend.xml to join a domain.</p></li></ul></li><li><em>Elastic Layering</em> - Controls whether Elastic Layering on this Layered Image is allowed. Select yes to allow Elastic Layers for users of this Layered Image.</li></ul></li><li>On the Confirm and Complete tab, enter any comments you would like for this layer, and click <strong>Create Template</strong>.</li></ol>
The new Template icon appears in the Unidesk Images module.
##Next Step<a name="Next_Step_..811"></a><a name="Next_..390"></a>
Publish Layered Images (vSphere)
#Publish Layered Images<a name="Publish_Layered_Images_..8"></a>
On what platform are you publishing Layered Images?

#Publish Layered Images (Azure RDSH)<a name="Publish_Layered_Images_(Azure_RDSH)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Publish a Layered Image</p><p>Provision a Session Host</p><p>Next Step</p></td></tr></tbody></table>
A Layered Image is a virtual machine that Unidesk has composited from the Layers and settings specified in an Image Template. You can publish one or more Layered Images to your chosen platform and use them to provision systems.
##Prerequisites<a name="Prerequisites_..812"></a><a name="Pre_..391"></a>
To publish Layered Images, you need:
<ul><li>One or more Image Templates.</li></ul>
##Publish a Layered Image<a name="Publish_a_Layered_Image"></a><a name="Pub"></a>
To use an Image Template to publish a Layered Image:
<ol><li><p>In the Images module, select one or more Image Templates that you want to publish.</p></li><li><p>From the Action menu, select <strong>Publish Layered Image</strong>.</p></li><li><p>Make sure you are logged onto the Azure portal before continuing.</p></li><li><p>On the Confirm and Complete page, select <strong>Publish Layered Images</strong>. For each Image Template this starts a task called, <em>Publishing Layered Image</em>. When each task completes, the task description provides the information you need to navigate to the image in your environment.</p></li><li><p>In a web browser, log into the Azure portal and use the link in the Task description (example shown below) to open to the location where the image has been published.</p><p><img></img></p></li><li><p>In the expanded Packaging Disk Task shown above, click the link to the session host template in the Azure portal. This opens the Microsoft Azure portal to the <em>Custom deployment</em> template where you can provision Azure RD Session Hosts.</p></li></ol>
The next section explains how to complete the template to provision a session host.
##Provision a Session Host<a name="Provision_a_Session_Host"></a><a name="Pro"></a>
In the ***Custom deployment***  template, enter the information to provision a Azure RD Session Host.
***Note:***  All RDSH Session Hosts must be manually restarted before you can add RDS roles to Session Hosts using PowerShell.
<ol><li>Check the Edit Template settings, and adjust as needed.</li><li><p>Complete the Session Host Parameters shown below, using the host's Fully Qualified Domain Name (FQDN).</p><p><a href="#Connector_Configuration_(AND)_Optional_Script__(vSphere)"></a>IMPORTANT: You must include the Domain Name (not fully qualified) in the <em>Admin User Name</em> field in the format, <em>mydom1\username</em>. And, in the Domain Name field, enter the Fully Qualified Domain Name, for example, <em>mydom1.local</em>.</p><p><img></img></p></li><li><p>Select the Azure Resource Group.</p><p><img></img></p></li><li><p>Specify the Resource Group Location.</p><p>IMPORTANT: Be sure that the value for the <strong>Resource group location</strong> matches the <strong>Storage account location</strong> that you configured in the Platform Connector Configuration. If these locations are not the same, the Packaging Machine will not be deployed and you will have to reattempt deployment.</p></li><li>Review the legal terms, and if you accept them, click <strong>Create</strong>. This creates a Session Host provisioned with the Layered Image in Azure.</li><li>While Azure creates the virtual machine, you can track the progress under Virtual Machines in the hub menu.</li></ol>
##Next Step<a name="Next_Step_..813"></a><a name="Next_..392"></a>
The next step is to power off the Session Host, power it back on, and add it to an RDS collection. Please see the [TechNet Reference](https://technet.microsoft.com/en-us/library/jj215452.aspx)[ for details.](https://technet.microsoft.com/en-us/library/jj215452.aspx)



#Publish Layered Images (MCS for Nutanix AHV)<a name="Publish_Layered_Images_(MCS_for_Nutanix_AHV)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Publish a Layered Image</p></td></tr></tbody></table>
A Layered Image is a virtual machine that Unidesk has composited from the Layers and settings specified in an Image Template. You can publish one or more Layered Images to Nutanix Acropolis, and add each one to a collection, provisioning service, or other method for provisioning your systems.
##Prerequisites<a name="Prerequisites_..814"></a><a name="Pre_..393"></a>
<ul><li><p>Create Image Templates (MCS for Nutanix AHV)</p></li><li><p><a href="#Connector_Configuration_(AND)_Optional_Script__(MCS_for_Nutanix_AHV)">Specify a script to run when you publish Layered Images (optional)</a> </p><p>If you want the VM to shut down on its own, you can specify a script to run when publishing the Layered Image. For details about enabling and using Scripts, see <a href="#Connector_Configuration_(AND)_Optional_Script__(MCS_for_Nutanix_AHV)">MCS for Nutanix AHV Connector</a> Configuration.</p></li></ul>
##Publish a Layered Image<a name="Publish_a_Layered_Image_..815"></a><a name="Pub_..394"></a>
<ol><li><p>In the Images module, select one or more Image Templates to publish.</p></li><li><p>From the Action menu, select <strong>Publish Layered Image</strong>.</p></li><li><p>On the Confirm and Complete page, select <strong>Publish Layered Images</strong>. For each template, this starts a task called, <em>Publishing Layered Image</em>. When each task completes, the task description provides the information you need to navigate to the image in your environment.</p><p> </p></li><li><p>Use the information in the expanded Packaging Disk Task shown above to navigate to the location in Nutanix AHV where the Layered Image has been published.</p></li><li><p>In the Prism console, power on the Packaging Machine VM. This enables the Guest OS to run and execute any Layer scripts via Unidesk's kmssetup.cmd functionality.</p><p>You can use scripts to perform important Layer-specific steps, for example, activating Microsoft Office, which may need to be done before the VM is used to create or update an MCS catalog.</p><p><strong>Note:</strong> You can execute Layer scripts using Unidesk's kmssetup.cmd functionality, Unidesk's Run-once script support, or even manual execution.</p></li><li><p>Once the VM is in the desired state the VM must be shut down. If you need to shut it down manually, do so now. Otherwise, wait for the script you've configured to do so.</p><p>When using the MCS for Nutanix AHV connector, once the VM is shutdown, a snapshot is taken to preserve the state of the VM for use in MCS. The snapshot name is prefixed with "XD_" and contains the name of the VM. This is required for the MCS for Nutanix AHV plugin and enables MCS administrators to easily identify the published Layer VM/snapshot. If the job is canceled while the connector is waiting for the VM to shutdown, the VM will <em>not</em> be deleted as part of the cleanup, in case you want to keep the VM and perform additional steps to prepare it for MCS.</p></li></ol>
##Next Step<a name="Next_Step_..816"></a>
Next you can move the image to a collection or other location for provisioning servers.


#Publish Layered Images (Citrix MCS for vSphere)<a name="Publish_Layered_Images_(Citrix_MCS_for_vSphere)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Publish a Layered Image</p></td></tr></tbody></table>
A Layered Image is a virtual machine that Unidesk has composited from the Layers and settings specified in an Image Template. You can publish one or more Layered Images to Citrix MCS in your vSphere environment and add it to a catalog for provisioning systems. In the Connector Configuration wizard, be sure to configure a ***Virtual Machine Template*** , so that the Layered Image you publish will be in a ready-to-use VM, the image shut down and a snapshot taken. You can use the VM in your Horizon environment without further modifications.
##Prerequisites<a name="Prerequisites_..817"></a><a name="Prerequi_..395"></a>
To publish a Layered Image to MCS, you need:
<ul><li>One or more Image Templates.</li></ul>
##Publish a Layered Image<a name="Publish_a_Layered_Image_..818"></a><a name="Pub_..396"></a>
<ol><li><p>In the Images module, select one or more Image Templates that you want to publish.</p></li><li><p>From the Action menu, select <strong>Publish Layered Image</strong>.</p></li><li><p>On the Confirm and Complete page, select <strong>Publish Layered Images</strong>. For each Image Template this starts a task called, <em>Publishing Layered Image</em>. When each task completes, the task description provides the information you need to navigate to the image in your environment.</p><p>At the end of the image creation process:</p><ul><li><p><strong>Unidesk powers on the VM</strong> - This will enable the guest OS to run and execute any layer scripts via our kmssetup.cmd functionality. This can be used to perform important layer specific steps like activating Microsoft Office which may need to be done before the VM is used to create a view desktop pool/RDS farm or recompose them. The mechanism used to execute these scripts can vary, including our own kmssetup.cmd functionality, run-once support, or even manual execution. It is expected that once all scripts are run or other manual steps are taken and the VM is in the desired state, a guest OS shutdown will be initiated either by the scripts, or by the user (if using the kmssetup.cmd functionality there will a documented process for initiating a shutdown after all layer scripts and other kmssetup functionality is complete).</p></li><li><p><strong>When the Task changes to Action Required, shut down the VM and take a snapshot</strong> - The status then changes to <em>Done</em>.</p></li><li><p><strong>If you want the VM to shut down on its own, you can specify a script to run when you publish Layered Images</strong> - For details about enabling and using Scripts, see the instructions for the Horizon <a href="#Connector_Configuration_(AND)_Optional_Script__(VMware_Horizon_View_for_vSphere)">View Connector</a> Configuration.</p></li></ul><p>When the task completes, the task description provides the information you need to navigate to the image in your environment.</p></li><li><p>Use the information in the expanded Packaging Disk Task to navigate to the location in your environment where the Layered Image has been published.</p></li></ol>
Next you can move the image to a collection or other location for provisioning servers.


#Publish Layered Images (Citrix MCS for XenServer)<a name="Publish_Layered_Images_(Citrix_MCS_for_XenServer)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Publish a Layered Image</p></td></tr></tbody></table>
A Layered Image is a virtual machine that Unidesk has composited from the Layers and settings specified in an Image Template. You can publish one or more Layered Images to Citrix MCS in your XenServer environment and add it to a catalog for provisioning systems. In the Connector Configuration wizard, be sure to configure a ***Virtual Machine Template*** , so that the Layered Image you publish will be in a ready-to-use VM, the image shut down and a snapshot taken. You can use the VM in your Horizon environment without further modifications.
##Prerequisites<a name="Prerequisites_..819"></a><a name="Prerequi_..397"></a>
To publish a Layered Image to MCS, you need:
<ul><li>One or more Image Templates.</li></ul>
##Publish a Layered Image<a name="Publish_a_Layered_Image_..820"></a><a name="Pub_..398"></a>
<ol><li><p>In the Images module, select one or more Image Templates that you want to publish.</p></li><li><p>From the Action menu, select <strong>Publish Layered Image</strong>.</p></li><li><p>On the Confirm and Complete page, select <strong>Publish Layered Images</strong>. For each Image Template this starts a task called, <em>Publishing Layered Image</em>. When each task completes, the task description provides the information you need to navigate to the image in your environment.</p><p>At the end of the image creation process:</p><ul><li><p><strong>Unidesk powers on the VM</strong> - This will enable the guest OS to run and execute any layer scripts via our kmssetup.cmd functionality. This can be used to perform important layer specific steps like activating Microsoft Office which may need to be done before the VM is used to create a view desktop pool/RDS farm or recompose them. The mechanism used to execute these scripts can vary, including our own kmssetup.cmd functionality, run-once support, or even manual execution. It is expected that once all scripts are run or other manual steps are taken and the VM is in the desired state, a guest OS shutdown will be initiated either by the scripts, or by the user (if using the kmssetup.cmd functionality there will a documented process for initiating a shutdown after all layer scripts and other kmssetup functionality is complete).</p></li><li><p><strong>When the Task changes to Action Required, shut down the VM and take a snapshot</strong> - The status then changes to <em>Done</em>.</p></li><li><p><strong>If you want the VM to shut down on its own, you can specify a script to run when you publish Layered Images</strong> - For details about enabling and using Scripts, see the instructions for the <a href="#Connector_Configuration_(AND)_Optional_Script__(MCS_for_XenServer)">MCS for XenServer</a> Connector Configuration.</p></li></ul><p>When the task completes, the task description provides the information you need to navigate to the image in your environment.</p></li><li><p>Use the information in the expanded Packaging Disk Task to navigate to the location in your environment where the Layered Image has been published.</p></li></ol>
Next you can move the image to a collection or other location for provisioning servers.


#Publish Layered Images (Citrix PVS)<a name="Publish_Layered_Images_(Citrix_PVS)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Publish a Layered Image</p><p>Assign the new vDisk to the targeted devices</p></td></tr></tbody></table>
A Layered Image is a virtual machine that Unidesk has composited from the Layers and settings specified in an Image Template. You can publish one or more Layered Images to PVS, and stream them to the systems you want to provision.
##Prerequisites<a name="Prerequisites_..821"></a><a name="Pre_..399"></a>
To publish a Layered Image, you need:
<ul><li>One or more Image Templates.</li></ul>
##Publish a Layered Image<a name="Publish_a_Layered_Image_..822"></a><a name="Pub_..400"></a>
To use an Image Template to publish a Layered Image:
<ol><li>Log into the UMC.</li><li>Select the <strong>Images</strong> modules.</li><li>Select one or more Image Templates, then click <strong>Publish Layered Image</strong>.</li><li>On the Confirm and Complete tab, click the <strong>Publish Layered Image</strong> button. This starts a task called, <em>Publishing Layered Image</em>. When the task completes, the task description provides the information you need to navigate to the image in your environment.</li><li>Use the information in the expanded Packaging Disk Task to navigate to the location in PVS where the Layered Image has been published.</li></ol>
Next you can assign the new disk to the targeted devices.
##Assign the new vDisk to the targeted devices<a name="Assign_the_new_vDisk_to_the_targeted_devices"></a><a name="Assign_..401"></a>
<ol><li>Log into the PVS Console.</li><li>Access the target PVS server. The new vDisk should appear under the targeted PVS store (refresh may be required).</li><li>Assign the new vDisk to the targeted devices.</li><li>Using Citrix PVS best practices, test the new vDisk to ensure that the image streams to the server as expected.</li></ol>

#Publish Layered Images (XenServer)<a name="Publish_Layered_Images_(XenServer)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Publish a Layered Image</p></td></tr></tbody></table>
A Layered Image is a virtual machine that Unidesk has composited from the Layers and settings specified in an Image Template. You can publish one or more Layered Images to XenServer and add each one to a collection, provisioning service, or other method for provisioning your systems.
##Prerequisites<a name="Prerequisites_..823"></a><a name="Pre_..402"></a>
To publish a Layered Image, you need:
<ul><li>One or more Image Templates.</li></ul>
##Publish a Layered Image<a name="Publish_a_Layered_Image_..824"></a><a name="Pub_..403"></a>
<ol><li><p>In the Images module, select one or more Image Templates to publish.</p></li><li><p>From the Action menu, select <strong>Publish Layered Image</strong>.</p></li><li><p>On the Confirm and Complete page, select <strong>Publish Layered Images</strong>. For each template, this starts a task called, <em>Publishing Layered Image</em>. When each task completes, the task description provides the information you need to navigate to the image in your environment.</p></li><li><p>Use the information in the expanded Packaging Disk Task shown above to navigate to the location in XenServer where the Layered Image has been published.</p></li></ol>
Next you can move the image to a collection or other location for provisioning servers.


#Publish Layered Images (Network File Share)<a name="Publish_Layered_Images_(Network_File_Share)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Publish a Layered Image</p><p>Next Step</p></td></tr></tbody></table>
A Layered Image is a virtual machine that Unidesk has composited from the Layers and settings specified in an Image Template. You can publish one or more Layered Images to the ELM's Network File Share, copy the Image(s) to your target environment, and use them to provision Session Hosts in your environment. This is especially useful if Unidesk does not yet include Connectors for the platform where you're provisioning systems.
##Prerequisites<a name="Prerequisites_..825"></a><a name="Pre_..404"></a>
To publish a Layered Image, you need:
<ul><li>One or more Image Templates.</li></ul>
The Image Template you select should have the correct OS Layer and any App Layers you want in the Layered Image.
##Publish a Layered Image<a name="Publish_a_Layered_Image_..826"></a><a name="Pub_..405"></a>
To use an Image Template to publish a Layered Image:
<ol><li><p>In the Images module, select one or more Image Template that you want to publish.</p></li><li><p>From the Action menu, select <strong>Publish Layered Image</strong>.</p></li><li><p>On the Confirm and Complete page, select <strong>Publish Layered Images</strong>. For each Image Template this starts a task called, <em>Publishing Layered Image</em>. When each task completes, the task description provides the information you need to navigate to the image in your environment.</p></li><li><p>Use the information in the expanded Packaging Disk Task shown above to navigate to the location where the Layered Image has been published.</p><p><strong>IMPORTANT:</strong> When publishing a Layered Image to a file share, there will be one VMDK file option, and it will generate two files: <em>layer.vmdk</em> and <em>layer-flat.vmdk</em>. You need to upload both of them.</p></li></ol>
##Next Step<a name="Next_Step_..827"></a><a name="Next_..406"></a>
Once the Layered Image is published to the file share, you can use the image to provision servers in your environment.


#Publish Layered Images (Nutanix AHV)<a name="Publish_Layered_Images_(Nutanix_AHV)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Publish a Layered Image</p></td></tr></tbody></table>
A Layered Image is a virtual machine that Unidesk has composited from the Layers and settings specified in an Image Template. You can publish one or more Layered Images to Nutanix AHV, and add each one to a collection, provisioning service, or other method for provisioning your systems.
##Prerequisites<a name="Prerequisites_..828"></a><a name="Pre_..407"></a>
Create Image Templates (Nutanix AHV)
##Publish a Layered Image<a name="Publish_a_Layered_Image_..829"></a><a name="Pub_..408"></a>
<ol><li><p>In the Images module, select one or more Image Templates to publish.</p></li><li><p>From the Action menu, select <strong>Publish Layered Image</strong>.</p></li><li><p>On the Confirm and Complete page, select <strong>Publish Layered Images</strong>. For each template, this starts a task called, <em>Publishing Layered Image</em>. When each task completes, the task description provides the information you need to navigate to the image in your environment.</p></li><li><p>Use the information in the expanded Packaging Disk Task shown above to navigate to the location in Nutanix AHV where the Layered Image has been published.</p></li><li><p>In the Prism console, power on the Packaging Machine VM. This enables the Guest OS to run and execute any Layer scripts via Unidesk's kmssetup.cmd functionality.</p><p>You can use scripts to perform important Layer-specific steps, for example, activating Microsoft Office, which may need to be done before the VM is used to create or update an MCS catalog.</p><p><em>Note:</em> You can execute Layer scripts using Unidesk's kmssetup.cmd functionality, Unidesk's Run-once script support, or even manual execution.</p></li><li>Once the VM is in the desired state the VM must be shut down. If you need to shut it down manually, do so now. Otherwise, wait for the script you've configured to do so.</li></ol>
##Next Step<a name="Next_Step_..830"></a>
Use the image to provision Nutanix AHV servers.


#Publish Layered Images (VMware Horizon View for vSphere)<a name="Publish_Layered_Images_(VMware_Horizon_View_for_vSphere)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Publish a Layered Image</p></td></tr></tbody></table>
A Layered Image is a virtual machine that Unidesk has composited from the Layers and settings specified in an Image Template. You can publish one or more Layered Images to VMware Horizon View Composer in your vSphere environment, and add it to a catalog for provisioning systems. In the Connector Configuration wizard, be sure to configure a ***Virtual Machine Template*** , so that the Layered Image you publish will be in a ready-to-use VM, the image shut down and a snapshot taken. You can use the VM in your Horizon environment without further modifications.
##Prerequisites<a name="Prerequisites_..831"></a><a name="Pre_..409"></a>
To publish a Layered Image, you need:
<ul><li>One or more Image Templates.</li></ul>
##Publish a Layered Image<a name="Publish_a_Layered_Image_..832"></a><a name="Pub_..410"></a>
<ol><li><p>In the Images module, select the Image Template that has the correct OS Layer and App Layers selected for the new Layered Image.</p></li><li><p>From the Action menu, select <strong>Publish Layered Image</strong>.</p></li><li><p>On the Confirm and Complete page, select <strong>Publish Layered Images</strong>. For each template, this starts a task called, <em>Publishing Layered Image</em>. When each task completes, the task description provides the information you need to navigate to the image in your environment. For each template, this starts a task called, <em>Publishing Layered Image</em>. When the task completes, the task description provides the information you need to navigate to the image in your environment. At the end of the image creation process:</p><ol><li><p><strong>Wait for Unidesk to power on the VM</strong> - This will enable the guest OS to run and execute any layer scripts via our kmssetup.cmd functionality.</p><p><strong>Note:</strong> This can be used to perform important layer-specific steps like activating Microsoft Office which may need to be done before the VM is used to create a View desktop pool/RDS farm or recompose them. The mechanism used to execute these scripts can vary, including our own kmssetup.cmd functionality, run-once support, or even manual execution. It is expected that once all scripts are run or other manual steps are taken and the VM is in the desired state, a guest OS shutdown will be initiated either by the scripts, or by the user (if using the kmssetup.cmd functionality there will a documented process for initiating a shutdown after all Layer scripts and other kmssetup functionality is complete).</p></li><li><p><strong>Activate the VM</strong> - Activate the machine so that Horizon View accepts it.</p></li><li><p><strong>When the Task changes to Action Required, shut down the VM and take a snapshot</strong> - The status then changes to <em>Done</em>.</p></li><li><p>If you want the VM to shut down on its own, you can specify a script to run when you publish Layered Images. For details about enabling and using Scripts, see the instructions for the Horizon <a href="#Connector_Configuration_(AND)_Optional_Script__(VMware_Horizon_View_for_vSphere)">View Connector</a> Configuration.</p></li></ol><p>When the task completes, the task description provides the information you need to navigate to the image in your environment.</p></li><li><p>Use the information in the expanded Packaging Disk Task shown above to navigate to the location in vSphere where the Layered Image has been published.</p></li></ol>
Next you can move the image to a collection or other location for provisioning servers.


#Publish Layered Images (vSphere)<a name="Publish_Layered_Images_(vSphere)"></a>
In this article:
<table><tbody><tr><td><p>Prerequisites</p><p>Publish a Layered Image</p></td></tr></tbody></table>
A Layered Image is a virtual machine that Unidesk has composited from the Layers and settings specified in an Image Template. You can publish one or more Layered Images to vSphere and add each one to a collection, provisioning service, or other method for provisioning your systems.
##Prerequisites<a name="Prerequisites_..833"></a><a name="Pre_..411"></a>
To publish a Layered Image, you need:
<ul><li>One or more Image Templates.</li></ul>
##Publish a Layered Image<a name="Publish_a_Layered_Image_..834"></a><a name="Pub_..412"></a>
<ol><li><p>In the Images module, select one or more Image Templates to publish.</p></li><li><p>From the Action menu, select <strong>Publish Layered Image</strong>.</p></li><li><p>On the Confirm and Complete page, select <strong>Publish Layered Images</strong>. For each template, this starts a task called, <em>Publishing Layered Image</em>. When each task completes, the task description provides the information you need to navigate to the image in your environment.</p></li><li><p>Use the information in the expanded Packaging Disk Task shown above to navigate to the location in vSphere where the Layered Image has been published.</p></li></ol>
Next you can move the image to a collection or other location for provisioning servers.


#Manage Image Templates<a name="Manage_Image_Templates"></a>
This article contains:
<table><tbody><tr><td><p>Update Image Templates with a new Layer Version</p><p>Edit any Image Template setting</p><p>Delete an Image Template</p></td></tr></tbody></table>
When you create new Layers and new Versions to them, you can edit the layer selection in your Image Templates, and use the templates to publish new versions of your Layered Images.
Once created, a Layered Image is no longer associated with the template used to create it. This means that you can change or delete a template without affecting any previously published Layered Images.
##Update Image Templates with a new Layer Version<a name="Update_Image_Templates_with_a_new_Layer_Version"></a><a name="Update_..413"></a>
When you add a new Version to an App Layer or an OS Layer, you can quickly identify the Image Templates that include the Layer, and select which templates to update with the new Version.
<ol><li>In the Unidesk Management Console (UMC), select <strong>Layers > App Layers</strong> or <strong>Layers > OS Layers</strong>.</li><li>Select the Layer you updated, and click <strong>Update Assignments</strong>.</li><li>In the wizard that opens, select the new Version of the Layer that you want to assign. The Image Template Assignment tab lists the Image Templates that include the Layer but are not yet assigned the new Version.</li><li><p>On the Image Template Assignment tab, select the Image Templates to which you want to assign the Layer or Layer Version.</p><p><strong>Notes:</strong> </p><ul><li>If the list is empty, click the check box called, <strong>Show Image Templates already at this version</strong>. A list of grayed out names may appear. These templates have already been assigned the Version.</li><li>You can use the <strong>Search</strong> field to filter this list by Layer or Version. If you search on part of a Layer name or Version, any entry that contains the search string is displayed.</li></ul></li><li>Skip the Elastic Assignment tab.</li><li>On the Confirm and Complete tab, verify your choices and click <strong>Update Assignments</strong>.</li></ol>
##Edit any Image Template setting<a name="Edit_any_Image_Template_setting"></a><a name="Ed_Temp"></a>
When you want to change the settings that you use to publish any of your Layered Images, you can edit the Image Template you originally used to publish the Layered Image(s) and publish a new version of the Image(s).
<ol><li>In the Unidesk Management Console (UMC), select the <strong>Images</strong> module.</li><li>Select the template you want to edit, and click <strong>Edit Template</strong>. This opens the Edit Template wizard.</li><li>On the Name and Description tab, you can change the Name, Description, and Icon for the Image.</li><li>On the OS Layer tab, you can select a different Version of your chosen <strong>OS Layer</strong> by expanding the Layer and choosing a different one.</li><li>On the App Assignment tab, you can add or remove App Layers to include in the Layered Images that you publish using this template. If there is more than one Version of a Layer, you can choose a different version by expanding the Layer and choosing a different one.</li><li>On the Connector tab, you can change the location to which the Layered Image is published by selecting a different Connector Configuration.</li><li>On the Platform Layer tab, you can change the selected Platform Layer, if for example, you are publishing to a different environment.</li><li>On the Layered Image Disk tab, you can edit the Layered Image Disk details, for example, to enable Elastic Layering on the image.</li><li>In the Confirm and Complete tab, enter any comments you would like for this layer, and click <strong>Edit Template</strong>.</li></ol>
##Delete an Image Template<a name="Delete_an_Image_Template"></a><a name="Del_Temp"></a>
When you no longer need an Image Template, you can remove it from the Unidesk Management Console (UMC).
<ol><li>In the UMC, select the <strong>Images</strong> module.</li><li>Select the template you want to delete, and click <strong>Delete Template</strong>. This opens the Delete Template wizard.</li><li>In the Confirm and Complete tab, enter any comments you would like, and click <strong>Delete Template</strong>.</li></ol>

#Connector essentials<a name="Connector_essentials"></a>
In this article:
What are Connectors?
What are Connector Configurations?
What Connector Configurations do I need?
How and when to add a new Connector Configuration
##What are Connectors?<a name="What_are_Connectors_"></a><a name="What_..414"></a>
Connectors are the interfaces to environments where layers are created and images are published. The type of platform connector determines the information required to create a specific Connector Configuration.
##What are Connector Configurations?<a name="What_are_Connector_Configurations_"></a><a name="What2_..415"></a>
A Connector Configuration is a stored set of values for connecting to a storage location in your environment. A configuration typically includes credentials for authentication, a storage location, and any other information required to interface with the environment where you will be creating layers or publishing images. You can create multiple Connector Configurations, each configured to access a unique location in your environment.
##What Connector Configurations do I need?<a name="What_Connector_Configurations_do_I_need_"></a><a name="Selectin"></a>
###Connector Configurations for importing an OS to create an OS Layer<a name="Connector_Configurations_for_importing_an_OS(SPACE)to_create_an_OS(SPACE)Layer"></a>
When you create an OS Layer, you need a Connector Configuration to give Unidesk access to the location of the OS image that you want to use for your OS Layer.
###Connector Configurations for creating and updating App Layers, and adding Versions to OS Layers<a name="Connector_Configurations_for_creating_and_updating_App_Layers,_and_adding_Ver..."></a>
When creating or updating an App Layer, or adding Versions to an OS Layer, you need a Connector Configuration for the location in your environment where you will package the Layer. You can create as many configurations as you need, for example, if you have more than one storage location in the environment.
###Connector Configurations for publishing Layered Images<a name="Connector_Configurations_for_publishing_Layered_Images"></a>
Publishing Layered Images will require different Connector Configurations than the ones you use for creating Layers, if, for example, you publish Layered Images to a variety of storage locations near the users being served. For example, you can prepare your Layers for a server farm in vSphere, and publish Layered Images to Citrix PVS for streaming to servers in vSphere. Or, you can publish Layered Images to more than one storage location in the same environment, each requiring a different Connector Configuration. Each location is likely to require different credentials.
##How and when to add a new Connector Configuration<a name="How_and_when_to_add_a_new_Connector_Configuration"></a><a name="Before_..416"></a>
If this is your first time using Unidesk, you will need to add one or more Connector Configurations in the process of adding Layers and publishing Layered Images. In the Unidesk Management Console, the wizards for Creating Layers, Adding Versions, and Publishing Layered Images each include a page for selecting and creating Connector Configurations. For details, click [Add a Connector Configuration](#Add_a_new_Connector_Configuration)[. and select a platform.](#Add_a_new_Connector_Configuration)
#Add a new Connector Configuration<a name="Add_a_new_Connector_Configuration"></a>
What platform are you using this Connector Configuration to connect to?


#Connector Configuration ; Optional Script (MCS for Nutanix AHV)<a name="Connector_Configuration_(AND)_Optional_Script__(MCS_for_Nutanix_AHV)"></a><a name="Azure_Platform_Connector_Fields"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Create a Connector Configuration</p><p>Script Configuration (Optional, Advanced feature)</p></td></tr></tbody></table>
An ***MCS for Nutanix AHV (Acropolis) Connector Configuration***  contains the credentials and storage location Unidesk needs to publish Layered Images to MCS in your Nutanix AHV environment. This connector does not support Layer creation.
##Before you start<a name="Before_you_start_..835"></a><a name="Before_..417"></a>
You can use MCS for Nutanix AHV to publish Layered Images. Each Connector Configuration accesses a specific storage location in your Nutanix AHV environment to which you can publish Layered Images.
You may need more than one Nutanix AHV Connector Configuration to access the correct location for each purpose. Further, you may want to publish each Layered Image to a location convenient to the systems you will be provisioning with the published image. For more about Connectors, and Connector Configurations, see [About Connectors](#Connector_essentials)[.](#Connector_essentials)
###If this is your first time using Unidesk<a name="If_this_is_your_first_time_using_Unidesk"></a><a name="How_..418"></a>
When publishing Layered Images to Nutanix AHV, you will need at least one Connector Configuration for each storage location you plan to publish to. You can add Connector Configurations when creating an Image Template from which you will publish Layered Images. If you don't yet have the right Connector Configuration for the task, you can create one by clicking ***New***  on the Connector wizard tab (see details below).
###Required information for Nutanix AHV Connector Configuration settings<a name="Required_information_for_Nutanix_AHV_Connector_Configuration_settings"></a><a name="Creds"></a>
The Nutanix AHV Connector Configuration wizard let's you browse for the Nutanix AHV Server, Data Store, and Host to use for a new configuration.
***Important*** : The fields are case sensitive, so any values that you enter manually must match the case of the object in Nutanix AHV, or the validation will fail.
<ul><li><strong>Connector Name</strong> - A useful name to help identify and keep track of this connector configuration.</li><li><strong>Prism Address</strong> - The host name (resolvable via DNS) or IP address of the Prism Web Console. This is the same address you use to access the Nutanix Prism Web Console..</li><li><p><strong>User Name/Password</strong> - Credentials that will be used when interacting with the Nutanix system. The specified user must have sufficient privileges for the following operations:</p><ul><li>VM operations:<ul><li>clone</li><li>delete</li><li>power on/off</li><li>attach virtual disks</li></ul></li><li>Image operations:<ul><li>create</li><li>update (aka upload)</li><li>delete</li></ul></li><li>Virtual disks:<ul><li>create</li><li>attach to VMs</li></ul></li></ul></li><li><strong>Allow Certificate Errors</strong> - Lets you use SSL encryption for the API connection traffic between the Unidesk Connector and Nutanix AHV. This field is unchecked by default.</li><li><strong>Template</strong> - This is a drop down list of existing virtual machines that can be used for cloning. There is no concept of a "template" in Nutanix, so these VMs are actual VMs. The selected template must <em>not</em> have any disks attached, and must have at least one network card attached. If it does not, you will see an error when trying to validate or save the configuration.</li><li><strong>Storage Container</strong> - Lets you select the storage container for the images (vhds) that will get uploaded and the resulting virtual disks that will get created from those images. When creating App Layers and OS Layer versions, we are required to mount the storage container as an NFS mount point. This means that the selected storage container MUST have the ELM included in a white list of clients that are allowed to mount the storage container via NFS. The white list configuration must be done through the Nutanix product (either their web console or through their CLI tools). If the ELM is not properly white listed for the selected storage container, then the validation phase will fail, and the error will be indicated with the storage container selection.</li></ul>
###How Virtual Machines are Organized<a name="How_Virtual_Machines_are_Organized"></a>
Nutanix does not provide a mechanism for organizing virtual machines. Because of this, it may be difficult to find the virtual machines created by your Unidesk ELM when the total number of virtual machines is large. To help you find these VMs, the following naming conventions are used:
<ul><li><strong>Packaging Machines</strong> (virtual machines created during the process of creating an App Layer or OS Version)<ul><li>The virtual machine name will start with the layer name that is being created/modified</li><li>The virtual machine names will end with the following text: (Unidesk Packaging Machine)</li></ul></li><li><strong>Layered Image Virtual Machines</strong> (virtual machines created as a result of publishing a Layered Image)<ul><li>The virtual machine name will start with the image name that was published</li><li>The virtual machine name will end with the following text: (Unidesk Published Image)</li></ul></li></ul>
When viewing virtual machines through the Nutanix web console, you can search for virtual machines by filtering on:
<ul><li>"Unidesk" to find all virtual machines created by Unidesk</li><li>"Unidesk Packaging Machine" to find all virtual machines created for Layer management jobs.</li><li>"Unidesk Layered Image" to find all virtual machines created to publish a Layered Image.</li><li>Image name or Layer name to find virtual machines related to a specific Layered Image publishing job or App or OS creation.</li></ul>
###Virtual Machine Network Connectivity<a name="Virtual_Machine_Network_Connectivity"></a>
The virtual network settings of the source template specified in the Nutanix AHV Connector Configuration will be carried over when creating any VMs through the Nutanix Acropolis Hypervisor (AHV) Connector. There is no option in the Connector Configuration UI to override the network settings.
##Create a Connector Configuration<a name="Create_a_Connector_Configuration"></a><a name="Create_..419"></a>
To enter values:
<ul><li>The first three Connector fields must be entered manually. Once the credentials in those fields are validated, you can select values for the remaining fields from drop-down menus.</li><li>To enter values manually, click to put the cursor in the field and type the value, making sure that the case matches the value in Nutanix AHV.</li><li>To select a value from a drop-down list, click once to put the cursor in the field, and a second time to display the list of possible values.</li></ul>
To add a new Connector Configuration:
<ol><li>On the wizard for creating a Layer or for adding a Layer Version, click the <strong>Connector</strong> tab.</li><li>Below the list of Connector Configurations, click the <strong>New</strong> button. This opens a small dialog box.</li><li>Select the Connector Type for the platform and location where you are creating the Layer or publishing the image. Then click <strong>New</strong> to open the Connector Configuration page.</li><li>Enter the configuration <em>Name</em>, and the <em>Nutanix AHV Address</em>, <em>User Name</em>, and <em>Password</em>). For guidance, see the above field definitions.</li><li>Click the <strong>CHECK CREDENTIALS</strong> button below the Nutanix AHV Configuration fields. The Virtual Machine Clone Settings field is then enabled.</li><li>Select the Virtual Machine Template.</li><li>Select the Storage Repository and click the <strong>TEST</strong> button to verify that Unidesk can access the location specified using the credentials supplied.</li><li>Click <strong>Save</strong>. The new Connector Configuration should now be listed on the Connector page.</li></ol>
##Script Configuration (Optional, Advanced feature)<a name="Script_Configuration_(Optional,_Advanced_feature)"></a><a name="Configure_Script_Path"></a>
When creating a new Connector Configuration, you can configure an optional Powershell script to run on any Windows machine running a Unidesk Agent. These scripts must be stored on the same machine that the Unidesk Agent is installed on, and will only be executed after a successful deployment of a Layered Image.
Some preset variables are available to enable scripts to be reusable with different template images and different connector configurations. These variables will also contain information needed to identify the virtual machine created as part of the published Layered Image in Nutanix AHV.
Execution of these scripts will not affect the outcome of the publish job, and progress of commands executed in the script will ***not***  be visible. The Nutanix AHV connector logs will contain the output of the executed script.
###Configure a Script (optional)<a name="Configure_a_Script_(optional)"></a>
If you want a script to run each time a Layered Image is published, complete these steps using the values described in the sections that follow.
<ol><li><p>Complete and save the Connector Configuration as described above.</p><p><strong>Note:</strong> Before selecting Script Configuration page, you must save (or discard) any edits to the Connector Configuration settings,</p></li><li><p>If the Navigation menu on the left is not open, select it and click <strong>Script Configuration</strong> to open the Script Path page.</p></li><li><p>Complete the required fields using the values detailed herein, and click <strong>Save</strong>.</p></li></ol>
###Script Configuration fields<a name="Script_Configuration_fields"></a><a name="Creds_..420"></a>
<ul><li><strong>Enable script</strong> - Select this check box to enable the remaining fields. This allows you to enter a script that will be executed each time a Layered Image is published.</li><li><strong>Script Agent</strong> - The agent machine where the scripts will be located and executed from.</li><li><strong>Username (optional)</strong> - The username to <em>impersonate</em> when running the script. This can be used to ensure the script runs in the context of a user that has the needed rights/permissions to perform the operations in the script.</li><li><strong>Password (optional)</strong> - The password for the specified username.</li><li><strong>Path</strong> - A full path and filename on the agent machine where the script file resides.</li></ul>
###Other Script Configuration values<a name="Other_Script_Configuration_values"></a>
####Powershell variables
When the script is executed the following variables will be set and can be used in the powershell script:
<table><thead><tr><th>Value</th><th>Applies to connector types:</th><th>Value determined by which code:</th><th>Description</th></tr></thead><tbody><tr><td>connectorCfgName</td><td>Common</td><td>Common</td><td>This is the name of the connector configuration that the script configuration is associated with.</td></tr><tr><td>imageName</td><td>Common</td><td>Common</td><td>This is the name of the layered image template that was used to build/publish the layered image.</td></tr><tr><td>osType</td><td>Common</td><td>Common</td><td><p>This is the OS type of the layered image that was published. It can be one of the following values:</p><ul><li>Windows7</li><li>Windows7 64-bit</li><li>Windows2008 64-bit</li><li>Windows2012 64-bit</li><li>Windows10</li><li>Windows1064</li></ul></td></tr><tr><td>virtualInfrastructureServer</td><td>Common</td><td>Nutanix AHV</td><td>The Nutanix AHV (Prism Server) specified in the connector configuraiton.</td></tr><tr><td>vmId</td><td>Common</td><td>Nutanix AHV</td><td>The virtual machine UUID (same as vmUuid).</td></tr><tr><td>vmName</td><td>Common</td><td>Nutanix AHV</td><td>The name of the virtual machine that was created.</td></tr><tr><td>vmNetwork</td><td>Common</td><td>Nutanix AHV</td><td>The name of the virtual network that the main NIC of the virtual machine is connected to.</td></tr><tr><td>vmNetworkId</td><td>Common</td><td>Nutanix AHV</td><td>The UUID of the virtual network that the main NIC of the virtual machine is connected to.</td></tr><tr><td>vmNetworkMAC</td><td>Common</td><td>Nutanix AHV</td><td>The MAC address of the main NIC that is connected to the virtual network specified in vmNetwork and vmNetworkId.</td></tr><tr><td>vmUuid</td><td>Common</td><td>Nutanix AHV</td><td>The virtual machine UUID (same as vmId).</td></tr></tbody></table>
####Definition Scope
Defines whether the ***scripts***  variable is set for all Connector types or whether it is specific to a particular Connector type.
####Value Source
Defines whether the variable value is determined by common code or by Connector-specific code.
#Connector Configuration ; Optional Script (Citrix MCS for vSphere)<a name="Connector_Configuration_(AND)_Optional_Script__(Citrix_MCS_for_vSphere)"></a><a name="Azure_Platform_Connector_Fields_..421"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Create a Connector Configuration</p><p>Script Configuration (Optional, Advanced feature)</p></td></tr></tbody></table>
A ***Citrix MCS for vSphere Connector Configuration***  contains the credentials and storage location Unidesk needs to publish Layered Images to MCS in your vSphere environment.
You can publish Layered Images to MCS running in a vSphere environment using a Citrix MCS for vSphere Connector Configuration. In the Connector Configuration wizard, be sure to configure a ***Virtual Machine Template*** , so that the Layered Image you publish will be in a ready-to-use VM, the image shut down and a snapshot taken. You can use the VM in your Horizon environment without further modifications.
Each Connector Configuration is set to publish Layered Images to a specific storage location in your MCS environment, so you may need more than one MCS Connector Configuration if publishing to multiple locations. Further, you may want to publish each Layered Image to a location convenient to the system you will be provisioning with the published image. For more about Connectors, and Connector Configurations, see Connector essentials.
***Notes:*** 
<ul><li>This Connector Configuration is for publishing Layered Images. You cannot package Layers in the MCS environment.</li><li>Personal vDisks are <em>not</em> supported for Citrix MCS. The published desktop images will be non-persistent. Currently, vDisks can only be used when publishing to Citrix PVS.</li></ul>
##Before you start<a name="Before_you_start_..836"></a><a name="Before_..422"></a>
The first time you create an Image Template for publishing Layered Images to a location in your MCS environment, you will create a Connector Configuration for that location.
###Required information for this Connector Configuration<a name="Required_information_for_this_Connector_Configuration"></a><a name="Creds_..423"></a>
The Citrix MCS for vSphere Connector Configuration wizard let's you browse for the vCenter Server, Data Store, and Host to use for a new configuration.
***Important*** : The fields are case sensitive, so any values that you enter manually must match the case of the object your environment, or the validation will fail.
<ul><li><strong>Name</strong> - A useful name to help identify and keep track of this connector configuration.</li><li><strong>vCenter Server</strong> - The name of the vSphere server with which the Unidesk ELM will integrate.</li><li><strong>vCenter User Name</strong> - The user name of the account that the Unidesk ELM will use to connect to vSphere.</li><li><strong>vCenter Password</strong> - The password of the account that the Unidesk ELM will use to connect to vSphere.</li><li><strong>DataCenter Name</strong> - The name of the vSphere DataCenter in which the Unidesk ELM will create and retrieve virtual machines.</li><li><strong>Virtual Machine Template (recommended)</strong> - The virtual machine to use as a template for cloning. Use the template to create a VM with the settings for your MCS catalog, including memory, CPUs and video settings. You can specify the host, datastore and network for configuring the resulting VMs. The VM must <em>not</em> have any connected disks.</li><li><strong>DataStore Name</strong> - The name of the vSphere DataStore in which the Unidesk ELM will create and retrieve virtual machines.</li><li><strong>ESX Host Name</strong> - The name of the vSphere ESX Host on which the Unidesk ELM will create and retrieve virtual machines.</li><li><strong>Network Name</strong> - The name of the vSphere Network in which the Unidesk ELM will create and retrieve virtual machines.</li><li><strong>Virtual Machine Folder Name</strong> - The name of the vSphere Folder in which the Unidesk ELM will create and retrieve virtual machines.</li></ul>
##Create a Connector Configuration<a name="Create_a_Connector_Configuration_..837"></a><a name="Create_..424"></a>
To enter values:
<ul><li>The first three vCenter fields must be entered manually. Once the credentials in those fields are validated, you can select values for the remaining fields from drop-down menus.</li><li>To enter values manually: Click to put the cursor in the field and type the value.</li><li>To select a value from a drop-down list: Click once to put the cursor in the field, and a second time to choose from a list of possible values.</li></ul>
To add a new Connector Configuration:
<ol><li>On the wizard for creating a Layer or for adding a Layer Version, click the <strong>Connector</strong> tab.</li><li>Below the list of Connector Configurations, click the <strong>New</strong> button. This opens a small dialog box.</li><li>Select the Connector Type for the platform and location where you are creating the Layer or publishing the image. Then click <strong>New</strong> to open the Connector Configuration page.</li><li>Enter the configuration <em>Name</em>, and the <em>vCenter Server</em>, <em>vCenter User Name</em>, and <em>vCenter Password</em>). For guidance, see the above field definitions.</li><li>Click the <strong>CHECK CREDENTIALS</strong> button below the vCenter fields. The DataCenter field is then enabled with a list of DataCenters available.</li><li>Select the DataCenter, and the remaining dropdowns will be enabled.</li><li>(Recommended) Select a virtual machine to use as the template. Although a VM Template is optional, it is strongly recommended. .</li><li>Complete the remaining fields and click the <strong>TEST</strong> button to verify that Unidesk can access the location specified using the credentials supplied.</li><li>Click <strong>Save</strong>. The new Connector Configuration should now be listed on the Connector page.</li></ol>
##Script Configuration (Optional, Advanced feature)<a name="Script_Configuration_(Optional,_Advanced_feature)_..838"></a><a name="Configure_Script_Path_..425"></a>
When creating a new Connector Configuration, you can configure an optional Powershell script on any Windows machine running a Unidesk Agent. These scripts must be stored on the same machine that the Unidesk Agent is installed on, and will only be executed after a successful deployment of a Layered Image. Some preset variables are available to enable scripts to be reusable with different template images and different connector configurations. These variables will also contain information needed to identify the virtual machine created as part of the published layered image in vSphere.
Execution of these scripts will not affect the outcome of the publish job, and progress of commands executed in the script will ***not***  be visible. The vSphere connector logs will contain the output of the executed script.
###Configure a Script (Remember, this is optional)<a name="Configure_a_Script_(Remember,_this_is_optional)"></a>
If you want a script to run each time a Layered Image is published, complete these steps using the values described in the sections that follow.
<ol><li><p>Complete and save the Connector Configuration as described above.</p><p><strong>Note:</strong> Before selecting Script Configuration page, you must save (or discard) any edits to the Connector Configuration settings,</p></li><li><p>If the Navigation menu on the left is not open, select it and click <strong>Script Configuration</strong> to open the Script Path page.</p></li><li><p>Complete the required fields using the values detailed herein, and click <strong>Save</strong>.</p></li></ol>
###Script Configuration fields<a name="Script_Configuration_fields_..839"></a><a name="Creds_..426"></a>
<ul><li><strong>Enable script</strong> - Select this check box to enable the remaining fields. This allows you to enter a script that will be executed each time a Layered Image is published.</li><li><strong>Script Agent</strong> - The agent machine where the scripts will be located and executed from.</li><li><strong>Username (optional)</strong> - The username to <em>impersonate</em> when running the script. This can be used to ensure the script runs in the context of a user that has the needed rights/permissions to perform the operations in the script.</li><li><strong>Password (optional)</strong> - The password for the specified username.</li><li><strong>Path</strong> - A full path and filename on the agent machine where the script file resides.</li></ul>
###Other Script Configuration values<a name="Other_Script_Configuration_values_..840"></a>
####Powershell variables
When the script is executed the following variables will be set and can be used in the powershell script:
<table><thead><tr><th>Value</th><th>Applies to connector types:</th><th>Value determined by which code:</th><th>Description</th></tr></thead><tbody><tr><td>connectorCfgName</td><td>All</td><td>Common code</td><td>This is the name of the connector configuration that the script configuration is associated with.</td></tr><tr><td>imageName</td><td>All</td><td>Common code</td><td>This is the name of the layered image template that was used to build/publish the layered image.</td></tr><tr><td>osType</td><td>All</td><td>Common code</td><td><p>This is the OS type of the layered image that was published. It can be one of the following values:</p><ul><li>Windows7</li><li>Windows764</li><li>Windows8</li><li>Windows864</li><li>Windows200864</li><li>Windows201264</li><li>Windows10</li><li>Windows1064</li></ul></td></tr><tr><td>virtualInfrastructureServer</td><td>All</td><td>vSphere connector code</td><td>The vCenter server specified in the connector configuration.</td></tr><tr><td>vmName</td><td>All</td><td>vSphere connector code</td><td>The name of the virtual machine that was created.</td></tr><tr><td>vmId</td><td>All</td><td>vSphere connector code</td><td>The virtual machine ID taken from the mobref of the vm (i.e. "vm-12345")</td></tr><tr><td>vmUuid</td><td>All</td><td>vSphere connector code</td><td>The virtual machine UUID as set by the underlying highbrd.</td></tr></tbody></table>
####User Impersonation
The Unidesk Agent, which runs as a service on a Windows machine, runs under either the local system account or the network account. Either of these accounts may have some special privileges, but they often are restricted when it comes to executing specific commands or seeing files in the file system. Therefore, Unidesk gives you the option of adding a domain user and password that can be used to "impersonate" a user. This means that the script can be executed as if that user had logged onto the system so that any commands or data will be accessible subject to those user rights and permissions. If no user name or password is entered, the script executes using the account under which the service is configured to run.
####Script Execution Policy
Script execution policy requirements are generally up to you. If you intend to run unsigned scripts, you must configure the execution policy to one of the more lenient policies. However, if you sign your own scripts accordingly, you can choose to use a more restrictive execution policy.
#Connector Configuration ; Optional Script (MCS for XenServer)<a name="Connector_Configuration_(AND)_Optional_Script__(MCS_for_XenServer)"></a><a name="Azure_Platform_Connector_Fields_..427"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Create a Connector Configuration</p><p>Script Configuration (Optional, Advanced feature)</p></td></tr></tbody></table>
An ***MCS for XenServer Connector Configuration***  contains the credentials and storage location Unidesk needs to publish Layered Images to MCS in your XenServer environment.
You can publish Layered Images to MCS running in a XenServer environment using an MCS for XenServer Connector Configuration. In the Connector Configuration wizard, be sure to configure a ***Virtual Machine Template*** , so that the Layered Image you publish will be in a ready-to-use VM, the image shut down and a snapshot taken. You can use the VM in your Horizon environment without further modifications.
Each Connector Configuration is set to publish Layered Images to a specific storage location in your environment, so you may need more than one MCS Connector Configuration if publishing to multiple locations. Further, you may want to publish each Layered Image to a location convenient to the system you will be provisioning with the published image. For more about Connectors, and Connector Configurations, see Connector essentials.
***Notes:*** 
<ul><li>This Connector Configuration is for publishing Layered Images. You cannot package Layers in the MCS environment. For packaging Layers, use a XenServer Connector Configuration.</li><li>Personal vDisks are <em>not</em> supported for MCS. The published desktop images will be non-persistent. Currently, vDisks can only be used when publishing to Citrix PVS.</li></ul>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Create a Connector Configuration</p><p>Script Configuration (Optional, Advanced feature)</p></td></tr></tbody></table>
A ***Citrix XenServer Connector Configuration***  contains the credentials and storage location Unidesk needs to connect to Citrix XenServer.
##Before you start<a name="Before_you_start_..841"></a><a name="Before_..428"></a>
You can use your XenServer environment for creating Layers, and for publishing Layered Images. Each Connector Configuration accesses a specific storage location in your XenServer environment. You may need more than one XenServer Connector Configuration to access the correct location for each purpose. Further, you may want to publish each Layered Image to a location convenient to the system you will be provisioning with the published image. For more about Connectors, and Connector Configurations, see [About Connectors](#Connector_essentials)[.](#Connector_essentials)
Since XenServer uses a pod-like architecture where you, the administrator, interact with individual servers or clusters of servers, rather than with a central management server, you manage these pods via command line access or GUI management software like XenCenter, which you install directly on your desktop and connect individually to each standalone host or to clusters of hosts.
###If this is your first time using Unidesk<a name="If_this_is_your_first_time_using_Unidesk_..842"></a><a name="How_..429"></a>
If this is your first time using Unidesk and you want to create Unidesk Layers using a XenServer VM, you will need a XenServer Connector within Unidesk. When publishing Layered Images to XenServer, you will need a Connector Configuration for each of your publishing locations as well.
The Create Layer and Publish Layered Image wizards each ask you to select a Connector Configuration. If you don't yet have the right Connector Configuration for the task, you can create one by clicking ***New***  on the Connector wizard tab (details below).
###Required information for XenServer Connector Configuration settings<a name="Required_information_for_XenServer_Connector_Configuration_settings"></a><a name="Creds_..430"></a>
The XenServer Connector Configuration wizard let's you browse for the XenCenter Server, Data Store, and Host to use for a new configuration.
***Important*** : The fields are case sensitive, so any values that you enter manually must match the case of the object in XenServer, or the validation will fail.
<ul><li><strong>Configuration Name</strong> - A useful name to help identify and keep track of this connector configuration.</li><li><strong>XenServer Address</strong> - The name of the XenServer host with which the Unidesk ELM will integrate.</li><li><strong>User Name/Password</strong> - The credentials for the account that the Unidesk ELM will use to connect to XenServer.</li><li><strong>Use Secured Protocol</strong> - Lets you use SSL encryption for the API connection traffic between the Unidesk Connector and Citrix XenServer. This field is checked by default.</li><li><strong>Allow Certificate Errors</strong> - Enables certificate errors to be ignored. By default, this setting is disabled.</li><li><strong>Template</strong> - VM Template that can be used for cloning. The list of choices will only contain custom VM templates, rather than actual VMs or any of the built-in templates. The selected template must <em>not</em> have any disks attached, and must have at least one network card attached. If it does not, you will see an error when trying to validate or save the configuration.</li><li><strong>Storage Repository</strong> - The storage repository for the disk that will get uploaded. The list will be filtered to only show repositories that can contain VHDs (ISO repositories are filtered out).</li><li><strong>Use HTTPS for File Transfers</strong> - Encrypts the image file transfers. HTTPS is checked by default for more secure uploads and downloads, but can be unchecked for increased performance.</li></ul>
###Virtual Machine organization<a name="Virtual_Machine_organization"></a>
XenServer allows for VMs to be organized either by folder or by tag. These organizational tools are optional when creating and managing VMs through XenCenter or other tools. Although XenServer Connector Configurations do ***not***  allow the administrator to specify folders or tags, the VMs created by the XenServer Connector, both Packaging Machines and published Layered Images, can utilize both organizational tools.
####Tags
If the template specified in the XenServer connector configuration has any tags, then those tags will be carried over to any VM cloned from that template. Therefore all packaging VMs or published layered images will be tagged with the same tags that the template has. Additionally, the XenServer connector will add three tags.
<ul><li><strong>Unidesk</strong> - All VMs created by the XenServer connector can be found by this tag regardless of their purpose or image.</li><li><strong>Purpose Tag</strong> - All packaging machines will be tagged with "Unidesk Packaging Machine" while all published layered image VMs will be tagged with "Unidesk Published Images".</li><li><strong>Image/Layer Name</strong> - All packaging machines will be tagged with the layer name for the layer which they are generated, while all published layered images will be tagged with the template image name.</li></ul>
If you are using XenCenter, you can view your VMs by tag by selecting the "Organization Views" and then select "By Tag".
####Folder
By default VMs created by the XenServer Connector will not be placed in a folder. However, if the template specified in the XenServer Connector Configuration resides in a folder, then any VM that the Connector creates from that template will also reside in the same folder. All packaging VMs and published Layered Images will be placed in that same folder. There will ***not***  be separate subfolders for packaging VMs or published Layered Iimages.
###Machine network connectivity<a name="Machine_network_connectivity"></a>
The virtual network settings of the source template specified in the XenServer Connector Configuration will be carried over when creating any VMs through the XenServer Connector. There is no option in the Connector Configuration UI to override the network settings.
###XenServer Clusters<a name="XenServer_Clusters"></a>
The XenServer Connector does ***not***  yet work correctly with XenServer clusters. If the host specified in the configuration is part of a cluster, then it must be the master host in the cluster for the connector to work. However, this means that any time the master XenServer host goes down and a new master is elected, the XenServer configuration must be updated.
##Create a Connector Configuration<a name="Create_a_Connector_Configuration_..843"></a><a name="Create_..431"></a>
To enter values:
<ul><li>The first three Connector fields must be entered manually. Once the credentials in those fields are validated, you can select values for the remaining fields from drop-down menus.</li><li>To enter values manually, click to put the cursor in the field and type the value, making sure that the case matches the value in Xen.</li><li>To select a value from a drop-down list, click once to put the cursor in the field, and a second time to display the list of possible values.</li></ul>
To add a new Connector Configuration:
<ol><li>On the wizard for creating a Layer or for adding a Layer Version, click the <strong>Connector</strong> tab.</li><li>Below the list of Connector Configurations, click the <strong>New</strong> button. This opens a small dialog box.</li><li>Select the Connector Type for the platform and location where you are creating the Layer or publishing the image. Then click <strong>New</strong> to open the Connector Configuration page.</li><li>Enter the configuration <em>Name</em>, and the <em>XenServer Address</em>, <em>User Name</em>, and <em>Password</em>). For guidance, see the above field definitions.</li><li>Click the <strong>CHECK CREDENTIALS</strong> button below the XenServer Configuration fields. The Virtual Machine Clone Settings field is then enabled.</li><li>Select the Virtual Machine Template.</li><li>Select the Storage Repository and click the <strong>TEST</strong> button to verify that Unidesk can access the location specified using the credentials supplied.</li><li>Click <strong>Save</strong>. The new Connector Configuration should now be listed on the Connector page.</li></ol>
##Script Configuration (Optional, Advanced feature)<a name="Script_Configuration_(Optional,_Advanced_feature)_..844"></a><a name="Configure_Script_Path_..432"></a>
When creating a new Connector Configuration, you can configure an optional Powershell script to run on any Windows machine running a Unidesk Agent. These scripts must be stored on the same machine that the Unidesk Agent is installed on, and will only be executed after a successful deployment of a Layered Image.
Some preset variables are available to enable scripts to be reusable with different template images and different connector configurations. These variables will also contain information needed to identify the virtual machine created as part of the published Layered Image in XenServer.
Execution of these scripts will not affect the outcome of the publish job, and progress of commands executed in the script will ***not***  be visible. The XenServer connector logs will contain the output of the executed script.
###Configure a Script (optional)<a name="Configure_a_Script_(optional)_..845"></a>
If you want a script to run each time a Layered Image is published, complete these steps using the values described in the sections that follow.
<ol><li><p>Complete and save the Connector Configuration as described above.</p><p><strong>Note:</strong> Before selecting Script Configuration page, you must save (or discard) any edits to the Connector Configuration settings,</p></li><li><p>If the Navigation menu on the left is not open, select it and click <strong>Script Configuration</strong> to open the Script Path page.</p></li><li><p>Complete the required fields using the values detailed herein, and click <strong>Save</strong>.</p></li></ol>
###Script Configuration fields<a name="Script_Configuration_fields_..846"></a><a name="Creds_..433"></a>
<ul><li><strong>Enable script</strong> - Select this check box to enable the remaining fields. This allows you to enter a script that will be executed each time a Layered Image is published.</li><li><strong>Script Agent</strong> - The agent machine where the scripts will be located and executed from.</li><li><strong>Username (optional)</strong> - The username to <em>impersonate</em> when running the script. This can be used to ensure the script runs in the context of a user that has the needed rights/permissions to perform the operations in the script.</li><li><strong>Password (optional)</strong> - The password for the specified username.</li><li><strong>Path</strong> - A full path and filename on the agent machine where the script file resides.</li></ul>
###Other Script Configuration values<a name="Other_Script_Configuration_values_..847"></a>
####Powershell variables
When the script is executed the following variables will be set and can be used in the powershell script:
<table><thead><tr><th>Value</th><th>Applies to connector types:</th><th>Value determined by which code:</th><th>Description</th></tr></thead><tbody><tr><td>connectorCfgName</td><td>All</td><td>Common code</td><td>This is the name of the connector configuration that the script configuration is associated with.</td></tr><tr><td>imageName</td><td>All</td><td>Common code</td><td>This is the name of the layered image template that was used to build/publish the layered image.</td></tr><tr><td>osType</td><td>All</td><td>Common code</td><td><p>This is the OS type of the layered image that was published. It can be one of the following values:</p><ul><li>Windows7</li><li>Windows764</li><li>Windows200864</li><li>Windows201264</li><li>Windows10</li><li>Windows1064</li></ul></td></tr><tr><td>virtualInfrastructureServer</td><td>All</td><td>XenServer connector code</td><td>The XenServer host specified in the connector configuration.</td></tr><tr><td>vmName</td><td>All</td><td>XenServer connector code</td><td>The name of the virtual machine that was created.</td></tr><tr><td>vmId</td><td>All</td><td>XenServer connector code</td><td>The virtual machine UUID (same as vmUuid)</td></tr><tr><td>vmUuid</td><td>All</td><td>XenServer connector code</td><td>The virtual machine UUID (same as vmId)</td></tr></tbody></table>
####Definition Scope
Whether the scripts variable is set for all platform connector types or whether it is specific to a particular connector type.
####Value Source
Whether the variable value is determined by common code or by platform connector specific code.

#Connector Configuration ; Optional Script (PVS)<a name="Connector_Configuration_(AND)_Optional_Script_(PVS)"></a><a name="Azure_Platform_Connector_Fields_..434"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Create a new Connector Configuration for PVS</p><p>Script Configuration (Optional, Advanced feature)</p></td></tr></tbody></table>
A PVS Connector Configuration contains the credentials and storage location Unidesk needs to connect to PVS, and it identifies the properties to be associated with the vDisk.
Each Connector Configuration is set up to access a storage location via a specific account. For more about Connectors and Connector Configurations, see [About Connectors and Connector Configurations](#Connector_essentials)[.](#Connector_essentials)
##Before you start<a name="Before_you_start_..848"></a><a name="Before_..435"></a>
The first time you create an Image Template for publishing Layered Images to your PVS environment, add a PVS Connector Configuration for that PVS location.
###PVS requirements<a name="PVS(SPACE)requirements"></a>
####PVS services must be running as a domain account
For Unidesk to work correctly with PVS, the PVS services must be running as a ***domain account*** . This is because domain accounts have permissions to access the PVS store and the local system account does not.
If your PVS server is configured to use the local system account, which is the default setting, you can change the account by running the PVS configuration tool. This tool gives you an option to run as ***local system***  or use a ***domain account*** . Choose a ***domain account*** .
####PVS server and account information<a name="Creds_..436"></a>
For Unidesk to access the location in your PVS environment where you want to publish a Layered Image, you need to supply the credentials and location in a PVS Connector Configuration.
The information you need for the PVS Connector Configuration includes.
<ul><li><strong>Name</strong> - A useful name to help identify and keep track of this connector configuration.</li><li><strong>Console</strong> - The name of the PVS server on which the Undesk agent is deployed. This is the server to which the vDisk will be published.</li><li><strong>Domain User</strong> - User name of a domain account that has permission to manage PVS. This account will be used by the agent to run PVS Powershell commands. This account <em>must</em> have <em>Read/Write</em> access to the PVS store for writing the published vDisk.</li><li><strong>Password</strong> - Password for the domain user account.</li><li><strong>Site Name</strong> - Name of the Site this vDisk is to be a member of.</li><li><strong>Store Name</strong> - Name of the Store that this vDisk is a member of.</li><li><strong>Write Cache</strong> - When a new Disk is being created, this value sets the Write Cache type of the new Disk. Possible values include:<br></br><ul><li>Cache on Server</li><li>Cache on Server, Persistent</li><li>Cache in Device RAM</li><li>Cache in Device RAM with Overflow on Hard Disk</li><li>Cache on Device Hard Drive</li></ul><p>When choosing a <em>Write Cache</em> option, consult your <a href="http://www.vhersey.com/2014/03/citrix-pvs-write-cache-design-considerations/">PVS documentation</a> to ensure that the PVS Servers and target devices that use this vDisk are properly configured for the type you select.</p></li><li><strong>License Mode</strong> - Sets the Windows License Mode to:<ul><li>KMS - Key Management Service</li><li>MAK - Multiple Activation Keys</li><li>None</li></ul></li><li><strong>Enable Active Directory machine account password management</strong> - Enables Active Directory (AD) password management. The default value is <em>Enabled</em>.</li><li><strong>Enable Load Balancing</strong> - Enables load balancing. for the streaming of the vDisk</li><li><strong>Enable Printer Management</strong> - When enabled, invalid printers will be deleted from the Device.</li></ul>
##Create a new Connector Configuration for PVS<a name="Create_a_new_Connector_Configuration_for_PVS"></a><a name="Create_..437"></a>
If you don't yet have a Connector Configuration that includes the PVS server information and credentials for the server where the Layered Image will be published, add one now.
To add a new Connector Configuration:
<ol><li>In the Publish Layered Image wizard, click the <strong>Connector</strong> tab.</li><li>Below the list of Connector Configurations, click the <strong>New</strong> button. This opens a small dialog box.</li><li>Select the Connector Type for the platform and location where you are publishing the Layered Image. Then click <strong>New</strong> to open the Connector Configuration page.</li><li>Complete the fields on the Connector Configuration page. For guidance, see the above field definitions.</li><li>Click the <strong>TEST</strong> button to verify that Unidesk can access the location specified using the credentials supplied.</li><li>Click <strong>SAVE</strong>. The new Connector Configuration should now be listed on the Connector tab.</li></ol>
##Script Configuration (Optional, Advanced feature)<a name="Script_Configuration_(Optional,_Advanced_feature)_..849"></a><a name="Configure_Script_Path_..438"></a>
When creating a new Connector Configuration, you can configure an optional Powershell script on any Windows machine running a Unidesk Agentthe same agent used on the PVS server. These scripts must be stored on the same machine that the Unidesk Agent is installed on, and will only be executed after a successful deployment of a Layered Image. Some preset variables are available to enable scripts to be reusable with different template images and different connector configurations. These variables will also contain information needed to identify the virtual machine created as part of the published layered image in PVS.
Execution of these scripts will not affect the outcome of the publish job, and progress of commands executed in the script will ***not***  be visible. The PVS connector logs will contain the output of the executed script.
###Configure a Script (Remember, this is optional)<a name="Configure_a_Script_(Remember,_this_is_optional)_..850"></a>
If you want a script to run each time a Layered Image is published, complete these steps using the values described in the sections that follow.
<ol><li><p>Complete and save the Connector Configuration as described above.</p><p><strong>Note:</strong> Before selecting Script Configuration page, you must save (or discard) any edits to the Connector Configuration settings,</p></li><li><p>If the Navigation menu on the left is not open, select it and click <strong>Script Configuration</strong> to open the Script Path page.</p></li><li><p>Complete the required fields using the values detailed herein, and click <strong>Save</strong>.</p></li></ol>
###Script Configuration fields<a name="Script_Configuration_fields_..851"></a><a name="Creds_..439"></a>
<ul><li><strong>Enable script</strong> - Select this check box to enable the remaining fields. This allows you to enter a script that will be executed each time a Layered Image is published.</li><li><strong>Script Agent</strong> - The agent machine where the scripts will be located and executed from.</li><li><strong>Username (optional)</strong> - The username to <em>impersonate</em> when running the script. This can be used to ensure the script runs in the context of a user that has the needed rights/permissions to perform the operations in the script.</li><li><strong>Password (optional)</strong> - The password for the specified username.</li><li><strong>Path</strong> - A full path and filename on the agent machine where the script file resides.</li></ul>
###Other Script Configuration values<a name="Other_Script_Configuration_values_..852"></a>
####Powershell variables
When the script is executed the following variables will be set and can be used in the powershell script:
<table><thead><tr><th>Value</th><th>Applies to connector types:</th><th>Value determined by which code:</th><th>Description</th></tr></thead><tbody><tr><td>connectorCfgName</td><td>All</td><td>Common code</td><td>This is the name of the connector configuration that the script configuration is associated with.</td></tr><tr><td>imageName</td><td>All</td><td>Common code</td><td>This is the name of the layered image template that was used to build/publish the layered image.</td></tr><tr><td>osType</td><td>All</td><td>Common code</td><td><p>This is the OS type of the layered image that was published. It can be one of the following values:</p><ul><li>Windows7</li><li>Windows764</li><li>Windows200864</li><li>Windows201264</li><li>Windows10</li><li>Windows1064</li></ul></td></tr><tr><td>diskLocatorId</td><td>All</td><td>PVS</td><td>The internal id for the vDisk.</td></tr></tbody></table>
####User Impersonation
The Unidesk Agent, which runs as a service on a Windows machine, runs under either the local system account or the network account. Either of these accounts may have some special privileges, but they often are restricted when it comes to executing specific commands or seeing files in the file system. Therefore, Unidesk gives you the option of adding a domain user and password that can be used to "impersonate" a user. This means that the script can be executed as if that user had logged onto the system so that any commands or data will be accessible subject to those user rights and permissions. If no user name or password is entered, the script executes using the account under which the service is configured to run.
####Script Execution Policy
Script execution policy requirements are generally up to you. If you intend to run unsigned scripts, you must configure the execution policy to one of the more lenient policies. However, if you sign your own scripts accordingly, you can choose to use a more restrictive execution policy.
#Connector Configuration ; Optional Script (Citrix XenServer)<a name="Connector_Configuration_(AND)_Optional_Script__(Citrix_XenServer)"></a><a name="Azure_Platform_Connector_Fields_..440"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Create a Connector Configuration</p><p>Script Configuration (Optional, Advanced feature)</p></td></tr></tbody></table>
A ***Citrix XenServer Connector Configuration***  contains the credentials and storage location Unidesk needs to connect to Citrix XenServer.
##Before you start<a name="Before_you_start_..853"></a><a name="Before_..441"></a>
You can use your XenServer environment for creating Layers, and for publishing Layered Images. Each Connector Configuration accesses a specific storage location in your XenServer environment. You may need more than one XenServer Connector Configuration to access the correct location for each purpose. Further, you may want to publish each Layered Image to a location convenient to the system you will be provisioning with the published image. For more about Connectors, and Connector Configurations, see [About Connectors](#Connector_essentials)[.](#Connector_essentials)
Since XenServer uses a pod-like architecture where you, the administrator, interact with individual servers or clusters of servers, rather than with a central management server, you manage these pods via command line access or GUI management software like XenCenter which you install directly on your desktop and connect individually to each standalone host or to clusters of hosts.
###If this is your first time using Unidesk<a name="If_this_is_your_first_time_using_Unidesk_..854"></a><a name="How_..442"></a>
If this is your first time using Unidesk and you want to create Unidesk Layers using a XenServer VM, you will need a XenServer Connector within Unidesk. When publishing Layered Images to XenServer, you will need a Connector Configuration for each of your publishing locations as well.
The Create Layer and Publish Layered Image wizards each ask you to select a Connector Configuration. If you don't yet have the right Connector Configuration for the task, you can create one by clicking ***New***  on the Connector wizard tab (see details below).
###Required information for XenServer Connector Configuration settings<a name="Required_information_for_XenServer_Connector_Configuration_settings_..855"></a><a name="Creds_..443"></a>
The XenServer Connector Configuration wizard let's you browse for the XenCenter Server, Data Store, and Host to use for a new configuration.
***Important*** : The fields are case sensitive, so any values that you enter manually must match the case of the object in XenServer, or the validation will fail.
<ul><li><strong>Configuration Name</strong> - A useful name to help identify and keep track of this connector configuration.</li><li><strong>XenServer Address</strong> - The name of the XenServer host with which the Unidesk ELM will integrate.</li><li><strong>User Name/Password</strong> - The credentials for the account that the Unidesk ELM will use to connect to XenServer.</li><li><strong>Use Secured Protocol</strong> - Lets you use SSL encryption for the API connection traffic between the Unidesk Connector and Citrix XenServer. This field is checked by default.</li><li><strong>Allow Certificate Errors</strong> - Enables certificate errors to be ignored. By default, this setting is disabled.</li><li><strong>Template</strong> - VM Template that can be used for cloning. The list of choices will only contain custom VM templates, rather than actual VMs or any of the built-in templates. The selected template must <em>not</em> have any disks attached, and must have at least one network card attached. If it does not, you will see an error when trying to validate or save the configuration.</li><li><strong>Storage Repository</strong> - The storage repository for the disk that will get uploaded. The list will be filtered to only show repositories that can contain VHDs (ISO repositories are filtered out).</li><li><strong>Use HTTPS for File Transfers</strong> - Encrypts the image file transfers. HTTPS is checked by default for more secure uploads and downloads, but can be unchecked for increased performance.</li></ul>
###Virtual Machine organization<a name="Virtual_Machine_organization_..856"></a>
XenServer allows for VMs to be organized either by folder or by tag. These organizational tools are optional when creating and managing VMs through XenCenter or other tools. Although XenServer Connector Configurations do ***not***  allow the administrator to specify folders or tags, the VMs created by the XenServer Connector, both Packaging Machines and published Layered Images, can utilize both organizational tools.
####Tags
If the template specified in the XenServer connector configuration has any tags, then those tags will be carried over to any VM cloned from that template. Therefore all packaging VMs or published layered images will be tagged with the same tags that the template has. Additionally, the XenServer connector will add three tags.
<ul><li><strong>Unidesk</strong> - All VMs created by the XenServer connector can be found by this tag regardless of their purpose or image.</li><li><strong>Purpose Tag</strong> - All packaging machines will be tagged with "Unidesk Packaging Machine" while all published layered image VMs will be tagged with "Unidesk Published Images".</li><li><strong>Image/Layer Name</strong> - All packaging machines will be tagged with the layer name for the layer which they are generated, while all published layered images will be tagged with the template image name.</li></ul>
If you are using XenCenter, you can view your VMs by tag by selecting the "Organization Views" and then select "By Tag".
####Folder
By default VMs created by the XenServer Connector will not be placed in a folder. However, if the template specified in the XenServer Connector Configuration resides in a folder, then any VM that the Connector creates from that template will also reside in the same folder. All packaging VMs and published Layered Images will be placed in that same folder. There will ***not***  be separate subfolders for packaging VMs or published Layered Iimages.
###Machine network connectivity<a name="Machine_network_connectivity_..857"></a>
The virtual network settings of the source template specified in the XenServer Connector Configuration will be carried over when creating any VMs through the XenServer Connector. There is no option in the Connector Configuration UI to override the network settings.
###XenServer Clusters<a name="XenServer_Clusters_..858"></a>
The XenServer Connector does ***not***  yet work correctly with XenServer clusters. If the host specified in the configuration is part of a cluster, then it must be the master host in the cluster for the connector to work. However, this means that any time the master XenServer host goes down and a new master is elected, the XenServer configuration must be updated.
###Scripts<a name="Scripts"></a>
The XenServer Connector supports script execution after publishing layered images just as the vSphere connectors do. The following script variables will be set:
##Create a Connector Configuration<a name="Create_a_Connector_Configuration_..859"></a><a name="Create_..444"></a>
To enter values:
<ul><li>The first three Connector fields must be entered manually. Once the credentials in those fields are validated, you can select values for the remaining fields from drop-down menus.</li><li>To enter values manually, click to put the cursor in the field and type the value, making sure that the case matches the value in Xen.</li><li>To select a value from a drop-down list, click once to put the cursor in the field, and a second time to display the list of possible values.</li></ul>
To add a new Connector Configuration:
<ol><li>On the wizard for creating a Layer or for adding a Layer Version, click the <strong>Connector</strong> tab.</li><li>Below the list of Connector Configurations, click the <strong>New</strong> button. This opens a small dialog box.</li><li>Select the Connector Type for the platform and location where you are creating the Layer or publishing the image. Then click <strong>New</strong> to open the Connector Configuration page.</li><li>Enter the configuration <em>Name</em>, and the <em>XenServer Address</em>, <em>User Name</em>, and <em>Password</em>). For guidance, see the above field definitions.</li><li>Click the <strong>CHECK CREDENTIALS</strong> button below the XenServer Configuration fields. The Virtual Machine Clone Settings field is then enabled.</li><li>Select the Virtual Machine Template.</li><li>Select the Storage Repository and click the <strong>TEST</strong> button to verify that Unidesk can access the location specified using the credentials supplied.</li><li>Click <strong>Save</strong>. The new Connector Configuration should now be listed on the Connector page.</li></ol>
##Script Configuration (Optional, Advanced feature)<a name="Script_Configuration_(Optional,_Advanced_feature)_..860"></a><a name="Configure_Script_Path_..445"></a>
When creating a new Connector Configuration, you can configure an optional Powershell script to run on any Windows machine running a Unidesk Agent. These scripts must be stored on the same machine that the Unidesk Agent is installed on, and will only be executed after a successful deployment of a Layered Image.
Some preset variables are available to enable scripts to be reusable with different template images and different connector configurations. These variables will also contain information needed to identify the virtual machine created as part of the published Layered Image in XenServer.
Execution of these scripts will not affect the outcome of the publish job, and progress of commands executed in the script will ***not***  be visible. The XenServer connector logs will contain the output of the executed script.
###Configure a Script (optional)<a name="Configure_a_Script_(optional)_..861"></a>
If you want a script to run each time a Layered Image is published, complete these steps using the values described in the sections that follow.
<ol><li><p>Complete and save the Connector Configuration as described above.</p><p><strong>Note:</strong> Before selecting Script Configuration page, you must save (or discard) any edits to the Connector Configuration settings,</p></li><li><p>If the Navigation menu on the left is not open, select it and click <strong>Script Configuration</strong> to open the Script Path page.</p></li><li><p>Complete the required fields using the values detailed herein, and click <strong>Save</strong>.</p></li></ol>
###Script Configuration fields<a name="Script_Configuration_fields_..862"></a><a name="Creds_..446"></a>
<ul><li><strong>Enable script</strong> - Select this check box to enable the remaining fields. This allows you to enter a script that will be executed each time a Layered Image is published.</li><li><strong>Script Agent</strong> - The agent machine where the scripts will be located and executed from.</li><li><strong>Username (optional)</strong> - The username to <em>impersonate</em> when running the script. This can be used to ensure the script runs in the context of a user that has the needed rights/permissions to perform the operations in the script.</li><li><strong>Password (optional)</strong> - The password for the specified username.</li><li><strong>Path</strong> - A full path and filename on the agent machine where the script file resides.</li></ul>
###Other Script Configuration values<a name="Other_Script_Configuration_values_..863"></a>
####Powershell variables
When the script is executed the following variables will be set and can be used in the powershell script:
<table><thead><tr><th>Value</th><th>Applies to connector types:</th><th>Value determined by which code:</th><th>Description</th></tr></thead><tbody><tr><td>connectorCfgName</td><td>All</td><td>Common code</td><td>This is the name of the connector configuration that the script configuration is associated with.</td></tr><tr><td>imageName</td><td>All</td><td>Common code</td><td>This is the name of the layered image template that was used to build/publish the layered image.</td></tr><tr><td>osType</td><td>All</td><td>Common code</td><td><p>This is the OS type of the layered image that was published. It can be one of the following values:</p><ul><li>Windows7</li><li>Windows764</li><li>Windows200864</li><li>Windows201264</li><li>Windows10</li><li>Windows1064</li></ul></td></tr><tr><td>virtualInfrastructureServer</td><td>All</td><td>XenServer connector code</td><td>The XenServer host specified in the connector configuration.</td></tr><tr><td>vmName</td><td>All</td><td>XenServer connector code</td><td>The name of the virtual machine that was created.</td></tr><tr><td>vmId</td><td>All</td><td>XenServer connector code</td><td>The virtual machine UUID (same as vmUuid)</td></tr><tr><td>vmUuid</td><td>All</td><td>XenServer connector code</td><td>The virtual machine UUID (same as vmId)</td></tr></tbody></table>
####Definition Scope
Whether the scripts variable is set for all platform connector types or whether it is specific to a particular connector type.
####Value Source
Whether the variable value is determined by common code or by platform connector specific code.
#Azure Connector Configuration<a name="Azure_Connector_Configuration"></a><a name="Azure_Platform_Connector_Fields_..447"></a>
This article contains:
When to add a Connector Configuration for Azure
Azure information required
Add a Connector Configuration
A Connector Configuration contains the credentials and location information that Unidesk needs to access a specific location in Azure. For example, your organization may have one Azure account and several storage locations, and you will need a Connector Configuration so Unidesk can access each storage locations. For more about Connectors and Connector Configurations, see [Connectors and Connector Configurations](#Connector_essentials)[.](#Connector_essentials)
##When to add a Connector Configuration for Azure<a name="When_to_add_a_Connector_Configuration_for_Azure"></a><a name="How_..448"></a>
When you create your first Layers, and later when you publish Layered Images for the first time you will add a Connector Configuration for each task, as described below.
##Azure information required<a name="Azure_information_required"></a><a name="Creds_..449"></a>
Your organization may have several Azure subscriptions. For Unidesk to access your Azure RD Session Host account, whether it's to download an OS Image or to publish a Layered Image, you must run this tool for each Azure subscription that you want to connect to via Unidesk. You can use the Unidesk Credentials Setup Tool to set up credentials for the Unidesk ELM, and later retrieve, the credentials you set up.
<ul><li><strong>Name</strong> - A name you enter for a new Connector Configuration.</li><li><strong>Subscription ID</strong> - In order to deploy Azure virtual machines, your organization must have an account and credentials, including a subscription ID.</li><li><strong>Tenant ID</strong> - This is a GUID that identifies your organization's dedicated instance of Azure AD.</li><li><strong>Client ID</strong> - The identifier for one of potentially many Azure accounts that your organization has.</li><li><strong>Client Secret</strong> - The password you want to use for the Client ID specified. If you already have a forgotten it, you can create a new one.</li><li><p><strong>Storage Account Name</strong> - The Azure storage account you want to use when storing Azure virtual machine disks. This name must adhere to Azure storage account naming restrictions. For example, the storage account name cannot contain uppercase characters.</p><p>You must either create a storage account through the portal or use an existing storage account that fits the following criteria. The account:</p><ul><li>Cannot be a <em>classic</em> storage account.</li><li>Should be a separate storage account from the one used for the Unidesk ELM. This new storage account will be used during Layer creation and Layered Image publishing.</li><li>Must be in the Azure location where you will deploy VMs.</li><li>Must be one of the following types:<ul><li><em>Standard</em> Locally Redundant storage (LRS)</li><li><em>Standard</em> Geo-Redundant storage (GRS)</li><li><em>Standard</em> Read-Access Geo-Redundant storage (RAGRS)</li></ul></li><li>Can be located in any resource group, as long as the resource group's location is the same as the account's location.</li></ul></li></ul>
###Tool for retrieving information from Azure<a name="Tool_for_retrieving_information_from_Azure"></a><a name="Tool"></a>
The Azure Credentials Tool is a PowerShell script that grants the Unidesk appliance restricted access to your Azure subscription so that Unidesk can retrieve the information required to create a new Azure Connector Configuration. When you run the tool, it prompts you for your Azure Login credentials, then sets up the credentials required for Unidesk to gain restricted access to your Azure subscription.
####Requirements for running the Azure Credentials Tool
<ul><li>A system with access to Azure and running the following software:<ul><li>Windows Server 2008, or later</li><li>Windows Powershell 2.0, or later (This ships with Windows Server 2008 and later.)</li><li>Storage Account in Azure</li></ul></li><li><p>Login credentials for a <em>Global Admin</em> or <em>Service Admin</em> in the Azure Active Directory Tenant associated with your subscription. In Azure, you can manage Active Directory <a href="https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview">here</a>.</p><p>An Azure AD tenant can be associated with many subscriptions, but each subscription can only have one tenant. If you are not sure which tenant is associated with which subscription, you can find out by clicking <strong>Subscriptions</strong> on the top of the old portal, and filtering by the directories listed until your subscription is listed as a check box under <strong>Filter by Subscriptions</strong>.</p></li></ul>
####Create a new storage account in Azure, if you don't have one for this purpose
<ol><li>In a web browser, navigate to the <a href="https://portal.azure.com">Microsoft Azure portal</a> and log in.</li><li>On the sidebar, select <strong>Storage accounts</strong> or <strong>Browser > Storage accounts</strong>. Do <em>not</em> select Storage accounts (classic).</li><li>Select <strong>Add</strong> in the top-left corner of the window that opens.</li><li>In the form that appears, select the options you need, making sure that the new storage location fits the same criteria for using any existing storage account.</li></ol>
####Retrieve information for a ***new***  Azure Connector Configuration
Here's how to set up your Azure credentials in the Connector Configuration wizard. It explains how to run the Azure for each Azure subscription that you want Unidesk to access.
<ol><li>On a Windows Server 2008 (or later version) machine, download and run the Unidesk Azure Credentials Tool from the <a href="http://www.unidesk.com/support/downloads">Unidesk 4 Downloads</a> page.</li><li>Follow the directions in the command prompt to select a subscription and choose a Client Secret.</li><li>When the tool is complete, it will display the fields below. These should be entered into the configuration.</li><li>Enter the Client Secret that you chose while running the tool.</li><li>If you did not enter a Client Secret, it has already been set up using this tool and you should use the one that was entered previously.</li></ol>
***Note:***  you will have to enter a new Client Secret each time you use a new subscription that has a new Tenant ID. This is because client secrets are logically associated with Azure tenants.
####Retrieve information for an <a name="Retrieve"></a>***existing***  Azure Connector Configuration<a name="Retrieve"></a>
If you have already run the Azure Credentials Tool to set up a subscription, you do not need to run the tool again. You can simply reuse the Name, Subscription ID, Tenant ID, Client ID, and Client Secret that you obtained.
####What to do if your Azure Client Secret is lost<a name="Secret"></a>
Once Unidesk creates the Client Secret for a Connector Configuration, the secret will always be hidden from view. If you forget and lose the Client Secret for a Configuration, you can reset it by using the following procedure:
***Note:***  You may have to be the primary Administrator of your Azure subscription to complete this procedure. Other Azure users may not have the access required.
<ol><li>Log in to the <em>Classic</em> Azure Portal at: <a href="https://manage.windowsazure.com/">https://manage.windowsazure.com/</a>.</li><li>In the left sidebar, select <strong>Active Directory</strong>.</li><li>From the list of Active Directories, select the entry corresponding to your Unidesk installation.</li><li>From the top menu, select <strong>Applications</strong>.</li><li>In the Show field, select <strong>Applications my company owns</strong>.</li><li>In the Search box, enter <strong>Unidesk</strong> and click the check mark to perform the search.</li><li>In the search results, locate an entry named "Unidesk ELM Access for <em>your-subscription-name</em>" and delete it. If you do not see such an entry, look for it in your other Active Directories.</li><li>Run the Unidesk Azure Credentials Tool again to create a new Client Secret.</li></ol>
##Add a Connector Configuration<a name="Add_a_Connector_Configuration"></a><a name="Create_..450"></a>
To add a new Connector Configuration:
<ol><li>In the wizard for creating a Layer or for adding a Layer Version, click the <strong>Connector</strong> tab.</li><li>Below the list of Connector Configurations, click the <strong>New</strong> button. This opens a small dialog box.</li><li>Select the Connector Type for the platform and location where you are creating the Layer or publishing the image. Then click <strong>New</strong> to open the Connector Configuration page.</li><li>Complete the fields on the Connector Configuration page. For guidance, see the above field definitions.</li><li>Click the <strong>TEST</strong> button to verify that Unidesk can access the location specified using the credentials supplied.</li><li>Click <strong>Save</strong>. The new Connector Configuration should now be listed on the Connector tab.</li></ol>


#Using the Network File Share Connector Configuration<a name="Using_the_Network_File_Share_Connector_Configuration"></a><a name="Azure_Platform_Connector_Fields_..451"></a>
In this article:
<table><tbody><tr><td><p>Network File Share location</p><p>When to select the Network File Share as your Connector Configuration</p></td></tr></tbody></table>
When the Unidesk Enterprise Layer Manager is installed, you set up a network file share that you can then use as a Connector Configuration when creating layers and publishing Layered Images. This Connector Configuration contains the ELM's Network File Share credentials and location so you can deploy a Packaging Machine to the File Share when creating layers, or publishing Layered Images.
Each Connector Configuration is set up to access a storage location via a specific account. For more about Connectors and Connector Configurations, see [About Connectors and Connector Configurations](#Connector_essentials)[.](#Connector_essentials)
##Network File Share location<a name="Network_File_Share_location"></a><a name="Network"></a>
The name of the Network File Share Connector Configuration includes its location. Look for the Unidesk folder at the top level of the Network File Share. For details, see Set up a network file share.
##When to select the Network File Share as your Connector Configuration<a name="When_to_select_the_Network_File_Share_as_your_Connector_Configuration"></a><a name="How_..452"></a>
When you publish Layered Images to a provisioning service for which we do not yet have a Connector, you can select the Network File Share Connector Configuration. You can then copy the Layered Image from the network file share to the correct location for provisioning servers.

#Connector Configuration ; Optional Script (Nutanix AHV)<a name="Connector_Configuration_(AND)_Optional_Script__(Nutanix_AHV)"></a><a name="Azure_Platform_Connector_Fields_..453"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Create a Connector Configuration</p><p>Script Configuration (Optional, Advanced feature)</p></td></tr></tbody></table>
A ***Nutanix AHV Connector Configuration***  contains the credentials and storage container Unidesk needs to connect to Nutanix Acropolis. You can use this connector for publishing Layered Images to Acropolis, and for packaging App Layers and new versions of your OS Layer using an Acropolis VM.
You can use this connector to:
<ul><li><p>Import your OS image from the Acropolis environment.</p></li><li><p>Publish Layered Images</p></li><li><p>Create a Packaging Machine for a new App Layer or OS Layer Version (for cross-platform deployments where your OS Image was imported from a hypervisor other than Acropolis)</p></li></ul>
##Before you start<a name="Before_you_start_..864"></a><a name="Before_..454"></a>
You can use your Nutanix Acropolis environment for creating Layers, and publishing Layered Images. Each Connector Configuration accesses a specific storage container in your Nutanix Acropolis environment where you can create your layers or publish layered images.
You may need more than one Nutanix Acropolis Connector Configuration to access the correct container for each purpose. Further, you may want to publish each Layered Image to a container convenient to the systems you will be provisioning with the published image. For more about Connectors, and Connector Configurations, see [About Connectors](#Connector_essentials)[.](#Connector_essentials)
###If this is your first time using Unidesk<a name="If_this_is_your_first_time_using_Unidesk_..865"></a><a name="How_..455"></a>
When publishing Layered Images to Acropolis, you will need at least one Connector Configuration for each storage container you plan to publish to. You can add Connector Configurations when creating an Image Template from which you will publish Layered Images. If you don't yet have the right Connector Configuration for the task, you can create one by clicking ***New***  on the Connector wizard tab (see details below).
###Required information for Acropolis Connector Configuration settings<a name="Required_information_for_Acropolis_Connector_Configuration_settings"></a><a name="Creds_..456"></a>
The Acropolis Connector Configuration wizard let's you define the credentials and container to use for a new configuration.
***Important*** : The fields are case sensitive, so any values that you enter manually must match the case of the object in Acropolis, or the validation will fail.
<ul><li><strong>Connector Name</strong> - A useful name to help identify and keep track of this connector configuration.</li><li><strong>Prism Address</strong> - The host name (resolvable via DNS) or IP address of the Prism Web Console. This is the same address you use to access the Nutanix Prism Web Console..</li><li><p><strong>User Name/Password</strong> - Credentials that will be used when interacting with the Nutanix system. The specified user must have sufficient privileges for the following operations:</p><ul><li>VM operations:<ul><li>clone</li><li>delete</li><li>power on/off</li><li>attach virtual disks</li></ul></li><li>Image operations:<ul><li>create</li><li>update (aka upload)</li><li>delete</li></ul></li><li>Virtual disks:<ul><li>create</li><li>attach to VMs</li></ul></li></ul></li><li><strong>Allow Certificate Errors</strong> - Lets you use SSL encryption for the API connection traffic between the Unidesk Connector and Nutanix Acropolis. This field is unchecked by default.</li><li><strong>Template</strong> - This is a drop down list of existing virtual machines that can be used for cloning. There is no concept of a "template" in Nutanix, so these VMs are actual VMs. The selected template must <em>not</em> have any disks attached, and must have at least one network card attached. If it does not, you will see an error when trying to validate or save the configuration.</li><li><strong>Storage Container</strong> - Lets you select the storage container for the images (vhds) that will get uploaded and the resulting virtual disks that will get created from those images. When creating App Layers and OS Layer versions, we are required to mount the storage container as an NFS mount point. This means that the selected storage container MUST have the ELM included in a white list of clients that are allowed to mount the storage container via NFS. The white list configuration must be done through the Nutanix product (either their web console or through their CLI tools). If the ELM is not properly white listed for the selected storage container, then the validation phase will fail, and the error will be indicated with the storage container selection.</li></ul>
###How Virtual Machines are Organized<a name="How_Virtual_Machines_are_Organized_..866"></a>
Nutanix does not provide a mechanism for organizing virtual machines. Because of this, it may be difficult to find the virtual machines created by your Unidesk ELM when the total number of virtual machines is large. To help you find these VMs, the following naming conventions are used:
<ul><li><strong>Packaging Machines</strong> (virtual machines created during the process of creating an App Layer or OS Version)<ul><li>The virtual machine name will start with the layer name that is being created/modified</li><li>The virtual machine names will end with the following text: (Unidesk Packaging Machine)</li></ul></li><li><strong>Layered Image Virtual Machines</strong> (virtual machines created as a result of publishing a Layered Image)<ul><li>The virtual machine name will start with the image name that was published</li><li>The virtual machine name will end with the following text: (Unidesk Published Image)</li></ul></li></ul>
When viewing virtual machines through the Nutanix web console, you can search for virtual machines by filtering on:
<ul><li>"Unidesk" to find all virtual machines created by Unidesk</li><li>"Unidesk Packaging Machine" to find all virtual machines created for Layer management jobs.</li><li>"Unidesk Layered Image" to find all virtual machines created to publish a Layered Image.</li><li>Image name or Layer name to find virtual machines related to a specific Layered Image publishing job or App or OS creation.</li></ul>
###Virtual Machine Network Connectivity<a name="Virtual_Machine_Network_Connectivity_..867"></a>
The virtual network settings of the source template specified in the Nutanix AHV Connector Configuration will be carried over when creating any VMs through the Nutanix Acropolis Hypervisor (AHV) Connector. There is no option in the Connector Configuration UI to override the network settings.
##Create a Connector Configuration<a name="Create_a_Connector_Configuration_..868"></a><a name="Create_..457"></a>
To enter values:
<ul><li>The first three Connector fields must be entered manually. Once the credentials in those fields are validated, you can select values for the remaining fields from drop-down menus.</li><li>To enter values manually, click to put the cursor in the field and type the value, making sure that the case matches the value in Acropolis.</li><li>To select a value from a drop-down list, click once to put the cursor in the field, and a second time to display the list of possible values.</li></ul>
To add a new Connector Configuration:
<ol><li>On the wizard for creating a Layer or for adding a Layer Version, click the <strong>Connector</strong> tab.</li><li>Below the list of Connector Configurations, click the <strong>New</strong> button. This opens a small dialog box.</li><li>Select the Connector Type for the platform and container where you are creating the Layer or publishing the image. Then click <strong>New</strong> to open the Connector Configuration page.</li><li>Enter the configuration <em>Name</em>, and the <em>Acropolis Address</em>, <em>User Name</em>, and <em>Password</em>). For guidance, see the above field definitions.</li><li>Click the <strong>CHECK CREDENTIALS</strong> button below the Acropolis Configuration fields. The Virtual Machine Clone Settings field is then enabled.</li><li>Select the Virtual Machine Template.</li><li>Select the Storage Repository and click the <strong>TEST</strong> button to verify that Unidesk can access the container specified using the credentials supplied.</li><li>Click <strong>Save</strong>. The new Connector Configuration should now be listed on the Connector page.</li></ol>
##Script Configuration (Optional, Advanced feature)<a name="Script_Configuration_(Optional,_Advanced_feature)_..869"></a><a name="Configure_Script_Path_..458"></a>
When creating a new Connector Configuration, you can configure an optional Powershell script to run on any Windows machine running a Unidesk Agent. These scripts must be stored on the same machine that the Unidesk Agent is installed on, and will only be executed after a successful deployment of a Layered Image.
Some preset variables are available to enable scripts to be reusable with different template images and different connector configurations. These variables will also contain information needed to identify the virtual machine created as part of the published Layered Image in Acropolis.
Execution of these scripts will not affect the outcome of the publish job, and progress of commands executed in the script will ***not***  be visible. The Acropolis connector logs will contain the output of the executed script.
###Configure a Script (optional)<a name="Configure_a_Script_(optional)_..870"></a>
If you want a script to run each time a Layered Image is published, complete these steps using the values described in the sections that follow.
<ol><li><p>Complete and save the Connector Configuration as described above.</p><p><strong>Note:</strong> Before selecting Script Configuration page, you must save (or discard) any edits to the Connector Configuration settings,</p></li><li><p>If the Navigation menu on the left is not open, select it and click <strong>Script Configuration</strong> to open the Script Path page.</p></li><li><p>Complete the required fields using the values detailed here, and click <strong>Save</strong>.</p></li></ol>
###Script Configuration fields<a name="Script_Configuration_fields_..871"></a><a name="Creds_..459"></a>
<ul><li><strong>Enable script</strong> - Select this check box to enable the remaining fields. This allows you to enter a script that will be executed each time a Layered Image is published.</li><li><strong>Script Agent</strong> - The agent machine where the scripts will be located and executed from.</li><li><strong>Username (optional)</strong> - The username to <em>impersonate</em> when running the script. This can be used to ensure the script runs in the context of a user that has the needed rights/permissions to perform the operations in the script.</li><li><strong>Password (optional)</strong> - The password for the specified username.</li><li><strong>Path</strong> - A full path and filename on the agent machine where the script file resides.</li></ul>
###Other Script Configuration values<a name="Other_Script_Configuration_values_..872"></a>
####Powershell variables
When the script is executed the following variables will be set and can be used in the powershell script:
<table><thead><tr><th>Value</th><th>Applies to connector types:</th><th>Value determined by which code:</th><th>Description</th></tr></thead><tbody><tr><td>connectorCfgName</td><td>Common</td><td>Common</td><td>This is the name of the connector configuration that the script configuration is associated with.</td></tr><tr><td>imageName</td><td>Common</td><td>Common</td><td>This is the name of the layered image template that was used to build/publish the layered image.</td></tr><tr><td>osType</td><td>Common</td><td>Common</td><td><p>This is the OS type of the layered image that was published. It can be one of the following values:</p><ul><li>Windows7</li><li>Windows7 64-bit</li><li>Windows2008 64-bit</li><li>Windows2012 64-bit</li><li>Windows10</li><li>Windows1064</li></ul></td></tr><tr><td>virtualInfrastructureServer</td><td>Common</td><td>Nutanix AHV</td><td>The Nutanix AHV (Prism Server) specified in the connector configuraiton.</td></tr><tr><td>vmId</td><td>Common</td><td>Nutanix AHV</td><td>The virtual machine UUID (same as vmUuid).</td></tr><tr><td>vmName</td><td>Common</td><td>Nutanix AHV</td><td>The name of the virtual machine that was created.</td></tr><tr><td>vmNetwork</td><td>Common</td><td>Nutanix AHV</td><td>The name of the virtual network that the main NIC of the virtual machine is connected to.</td></tr><tr><td>vmNetworkId</td><td>Common</td><td>Nutanix AHV</td><td>The UUID of the virtual network that the main NIC of the virtual machine is connected to.</td></tr><tr><td>vmNetworkMAC</td><td>Common</td><td>Nutanix AHV</td><td>The MAC address of the main NIC that is connected to the virtual network specified in vmNetwork and vmNetworkId.</td></tr><tr><td>vmUuid</td><td>Common</td><td>Nutanix AHV</td><td>The virtual machine UUID (same as vmId).</td></tr></tbody></table>
####Definition Scope
Defines whether the ***scripts***  variable is set for all Connector types or whether it is specific to a particular Connector type.
####Value Source
Defines whether the variable value is determined by common code or by Connector-specific code.
#Connector Configuration ; Optional Script (VMware Horizon View for vSphere)<a name="Connector_Configuration_(AND)_Optional_Script__(VMware_Horizon_View_for_vSphere)"></a><a name="Azure_Platform_Connector_Fields_..460"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Create a Connector Configuration</p><p>Script Configuration (Optional, Advanced feature)</p></td></tr></tbody></table>
A ***VMware Horizon for vSphere Connector Configuration***  contains the credentials and storage location Unidesk needs to publish Layered Images to ***VMware Horizon View***  in your vSphere environment.
You can publish Layered Images to be used in any of the following pools:
<ul><li>A Horizon View Composer <em>Linked Clone Desktop Pool</em>.</li><li>A Horizon View <em>Instant Clone Desktop Pool</em>.</li></ul>
In the Connector Configuration wizard, be sure to configure a ***Virtual Machine Template*** , so that the Layered Image you publish will be in a ready-to-use VM, the image shut down and a snapshot taken. You can use the VM in your Horizon environment without further modifications. For example, if you are publishing a Layered Image to a Linked Clone Desktop Pool, the Layered Image becomes a 'Parent VM' that you can select for your Linked Clones pool.
Each Connector Configuration is set to publish Layered Images to a specific storage location in your vSphere environment, so you may need more than one VMware Horizon Connector Configuration if publishing to multiple locations. Further, you may want to publish each Layered Image to a location convenient to the systems you will be provisioning with the published image. For more about Connectors, and Connector Configurations, see Connector essentials.
***Notes:*** 
<ul><li>This Connector Configuration is for publishing Layered Images only. (You cannot package Layers using this connector.)</li><li>Personal vDisks are <em>not</em> supported for View. The published desktop images will be non-persistent. Currently, vDisks can only be used when publishing to Citrix PVS.</li><li><p>When installing the Horizon Agent on the VM, select the custom setup option as follows:</p><ul><li>Select the <strong>VMware Horizon View Composer Agent</strong> option when deploying View Composer <em>linked-clone desktops</em>.</li><li>Select the <strong>VMware Horizon Instant Clone Agent</strong> option when deploying <em>instant-clone desktops</em>.</li></ul></li></ul>
##Before you start<a name="Before_you_start_..873"></a><a name="Before_..461"></a>
The first time you create an Image Template for publishing Layered Images to a location in your Horizon environment, you will create a Connector Configuration for that location.
###Required information for this Connector Configuration<a name="Required_information_for_this_Connector_Configuration_..874"></a><a name="Creds_..462"></a>
The Connector Configuration wizard let's you browse for the vCenter Server, Data Store, and Host to use for a new configuration.
***Important*** : The fields are case sensitive, so any values that you enter manually must match the case of the object your environment, or the validation will fail.
<ul><li><strong>Name</strong> - A useful name to help identify and keep track of this connector configuration.</li><li><strong>vCenter Server</strong> - The name of the vSphere server with which the Unidesk ELM will integrate.</li><li><strong>vCenter User Name</strong> - The user name of the account that the Unidesk ELM will use to connect to vSphere.</li><li><strong>vCenter Password</strong> - The password of the account that the Unidesk ELM will use to connect to vSphere.</li><li><strong>DataCenter Name</strong> - The name of the vSphere DataCenter in which the Unidesk ELM will create and retrieve virtual machines.</li><li><strong>Virtual Machine Template (recommended)</strong> - The VM to use as a template for cloning. Use the template to create a VM with the hardware settings for View, including memory, CPUs and video settings. You can specify the host, datastore and network for configuring the resulting VMs. The VM must <em>not</em> have any connected disks.</li><li><strong>DataStore Name</strong> - The name of the vSphere DataStore in which the Unidesk ELM will create and retrieve virtual machines.</li><li><strong>ESX Host Name</strong> - The name of the vSphere ESX Host on which the Unidesk ELM will create and retrieve virtual machines.</li><li><strong>Network Name</strong> - The name of the vSphere Network in which the Unidesk ELM will create and retrieve virtual machines.</li><li><strong>Virtual Machine Folder Name</strong> - The name of the vSphere Folder in which the Unidesk ELM will create and retrieve virtual machines.</li></ul>
##Create a Connector Configuration<a name="Create_a_Connector_Configuration_..875"></a><a name="Create_..463"></a>
To enter values:
<ul><li>The first three vCenter fields must be entered manually. Once the credentials in those fields are validated, you can select values for the remaining fields from drop-down menus.</li><li>To enter values manually: Click to put the cursor in the field and type the value.</li><li>To select a value from a drop-down list: Click once to put the cursor in the field, and a second time to choose from a list of possible values.</li></ul>
To add a new Connector Configuration:
<ol><li>On the wizard for creating a Layer or for adding a Layer Version, click the <strong>Connector</strong> tab.</li><li>Below the list of Connector Configurations, click the <strong>New</strong> button. This opens a small dialog box.</li><li>Select the Connector Type for the platform and location where you are creating the Layer or publishing the image. Then click <strong>New</strong> to open the Connector Configuration page.</li><li>Enter the configuration <em>Name</em>, and the <em>vCenter Server</em>, <em>vCenter User Name</em>, and <em>vCenter Password</em>). For guidance, see the above field definitions.</li><li>Click the <strong>CHECK CREDENTIALS</strong> button below the vCenter fields. The DataCenter field is then enabled with a list of DataCenters available.</li><li>Select the DataCenter, and the remaining dropdowns will be enabled.</li><li>(Recommended) Select a virtual machine to use as the template. Although a VM Template is optional, it is strongly recommended.</li><li>Complete the remaining fields and click the <strong>TEST</strong> button to verify that Unidesk can access the location specified using the credentials supplied.</li><li>Click <strong>Save</strong>. The new Connector Configuration should now be listed on the Connector page.</li></ol>
##Script Configuration (Optional, Advanced feature)<a name="Script_Configuration_(Optional,_Advanced_feature)_..876"></a><a name="Configure_Script_Path_..464"></a>
When creating a new Connector Configuration, you can configure an optional Powershell script on any Windows machine running a Unidesk Agent. These scripts must be stored on the same machine that the Unidesk Agent is installed on, and will only be executed after a successful deployment of a Layered Image. Some preset variables are available to enable scripts to be reusable with different template images and different connector configurations. These variables will also contain information needed to identify the virtual machine created as part of the published layered image in vSphere.
Execution of these scripts will not affect the outcome of the publish job, and progress of commands executed in the script will ***not***  be visible. The vSphere connector logs will contain the output of the executed script.
###Configure a Script (Remember, this is optional)<a name="Configure_a_Script_(Remember,_this_is_optional)_..877"></a>
If you want a script to run each time a Layered Image is published, complete these steps using the values described in the sections that follow.
<ol><li><p>Complete and save the Connector Configuration as described above.</p><p><strong>Note:</strong> Before selecting Script Configuration page, you must save (or discard) any edits to the Connector Configuration settings,</p></li><li><p>If the Navigation menu on the left is not open, select it and click <strong>Script Configuration</strong> to open the Script Path page.</p></li><li><p>Complete the required fields using the values detailed herein, and click <strong>Save</strong>.</p></li></ol>
###Script Configuration fields<a name="Script_Configuration_fields_..878"></a><a name="Creds_..465"></a>
<ul><li><strong>Enable script</strong> - Select this check box to enable the remaining fields. This allows you to enter a script that will be executed each time a Layered Image is published.</li><li><strong>Script Agent</strong> - The agent machine where the scripts will be located and executed from.</li><li><strong>Username (optional)</strong> - The username to <em>impersonate</em> when running the script. This can be used to ensure the script runs in the context of a user that has the needed rights/permissions to perform the operations in the script.</li><li><strong>Password (optional)</strong> - The password for the specified username.</li><li><strong>Path</strong> - A full path and filename on the agent machine where the script file resides.</li></ul>
###Other Script Configuration values<a name="Other_Script_Configuration_values_..879"></a>
####Powershell variables
When the script is executed the following variables will be set and can be used in the powershell script:
<table><thead><tr><th>Value</th><th>Applies to connector types:</th><th>Value determined by which code:</th><th>Description</th></tr></thead><tbody><tr><td>connectorCfgName</td><td>All</td><td>Common code</td><td>This is the name of the connector configuration that the script configuration is associated with.</td></tr><tr><td>imageName</td><td>All</td><td>Common code</td><td>This is the name of the layered image template that was used to build/publish the layered image.</td></tr><tr><td>osType</td><td>All</td><td>Common code</td><td><p>This is the OS type of the layered image that was published. It can be one of the following values:</p><ul><li>Windows7</li><li>Windows764</li><li>Windows200864</li><li>Windows201264</li><li>Windows10</li><li>Windows1064</li></ul></td></tr><tr><td>virtualInfrastructureServer</td><td>All</td><td>vSphere connector code</td><td>The vCenter server specified in the connector configuration.</td></tr><tr><td>vmName</td><td>All</td><td>vSphere connector code</td><td>The name of the virtual machine that was created.</td></tr><tr><td>vmId</td><td>All</td><td>vSphere connector code</td><td>The virtual machine ID taken from the mobref of the vm (i.e. "vm-12345")</td></tr><tr><td>vmUuid</td><td>All</td><td>vSphere connector code</td><td>The virtual machine UUID as set by the underlying highbrd.</td></tr></tbody></table>
####User Impersonation
The Unidesk Agent, which runs as a service on a Windows machine, runs under either the local system account or the network account. Either of these accounts may have some special privileges, but they often are restricted when it comes to executing specific commands or seeing files in the file system. Therefore, Unidesk gives you the option of adding a domain user and password that can be used to "impersonate" a user. This means that the script can be executed as if that user had logged onto the system so that any commands or data will be accessible subject to those user rights and permissions. If no user name or password is entered, the script executes using the account under which the service is configured to run.
####Script Execution Policy
Script execution policy requirements are generally up to you. If you intend to run unsigned scripts, you must configure the execution policy to one of the more lenient policies. However, if you sign your own scripts accordingly, you can choose to use a more restrictive execution policy.
#Connector Configuration ; Optional Script (vSphere)<a name="Connector_Configuration_(AND)_Optional_Script__(vSphere)"></a><a name="vSphere_Connector_Fields"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Create a Connector Configuration</p><p>Script Configuration (Optional, Advanced feature)</p></td></tr></tbody></table>
A ***vSphere Connector Configuration***  contains the credentials and storage location Unidesk needs to connect to vSphere.
##Before you start<a name="Before_you_start_..880"></a><a name="Before_..466"></a>
You can use your vSphere environment for creating Layers, and for publishing Layered Images. Each Connector Configuration accesses a specific storage location. You may need more than one vSphere Connector Configuration to access the correct location for each purpose. Further, you may want to publish each Layered Image to a location convenient to the system you will be provisioning with the published image. For more about Connectors, and Connector Configurations, see [About Connectors](#Connector_essentials)[.](#Connector_essentials)
###If this is your first time using Unidesk<a name="If_this_is_your_first_time_using_Unidesk_..881"></a><a name="How_..467"></a>
If this is your first time using Unidesk and you want to create Unidesk Layers using a vSphere VM, you will need a vSphere Connector. If you are also publishing Layered Images to vSphere, you can create a Connector Configuration for each of your publishing locations as well.
The Create Layer and Publish Layered Image wizards each ask you to select a Connector Configuration. If you don't yet have the right Connector Configuration for the task, you can create one by clicking ***New***  on the Connector wizard tab (details below).
###Required information for vSphere Connector Configuration settings<a name="Required_information_for_vSphere_Connector_Configuration_settings"></a><a name="Creds_..468"></a>
The vSphere Connector Configuration wizard let's you browse for the vCenter Server, Data Store, and Host to use for a new configuration.
***Important*** : The fields are case sensitive, so any values that you enter manually must match the case of the object in vSphere, or the validation will fail.
<ul><li><strong>Name</strong> - A useful name to help identify and keep track of this connector configuration.</li><li><strong>vCenter Server</strong> - The name of the vSphere server with which the Unidesk ELM will integrate.</li><li><strong>vCenter User Name</strong> - The user name of the account that the Unidesk ELM will use to connect to vSphere.</li><li><strong>vCenter Password</strong> - The password of the account that the Unidesk ELM will use to connect to vSphere.</li><li><strong>DataCenter Name</strong> - The name of the vSphere DataCenter in which the Unidesk ELM will create and retrieve virtual machines.</li><li><p><strong>Layer Disk Cache Size in GB (optional)</strong> - The size of the Disk Cache that Unidesk use when creating Layers. If you leave the size blank or set it to 0, Unidesk does not use a Disk Cache. If you specify a size, Unidesk users a Disk Cache of up to this size to keep copies of boot disks and packaging disks and reuses these disks to create new packaging machines. The reuse of these boot disks and packaging disks reduces the time it takes to package an Application Layer.</p></li><li><strong>DataStore Name</strong> - The name of the vSphere DataStore in which the Unidesk ELM will create and retrieve virtual machines.</li><li><strong>ESX Host Name</strong> - The name of the vSphere ESX Host on which the Unidesk ELM will create and retrieve virtual machines.</li><li><strong>Network Name</strong> - The name of the vSphere Network in which the Unidesk ELM will create and retrieve virtual machines.</li><li><strong>Virtual Machine Folder Name</strong> - The name of the vSphere Folder in which the Unidesk ELM will create and retrieve virtual machines.</li></ul>
##Create a Connector Configuration<a name="Create_a_Connector_Configuration_..882"></a><a name="Create_..469"></a>
To enter values:
<ul><li>The first three vCenter fields must be entered manually. Once the credentials in those fields are validated, you can select values for the remaining fields from drop-down menus.</li><li>To enter values manually, click to put the cursor in the field and type the value, making sure that the case matches the value in vCenter.</li><li>To select a value from a drop-down list, click once to put the cursor in the field, and a second time to display the list of possible values.</li></ul>
To add a new Connector Configuration:
<ol><li>On the wizard for creating a Layer or for adding a Layer Version, click the <strong>Connector</strong> tab.</li><li>Below the list of Connector Configurations, click the <strong>New</strong> button. This opens a small dialog box.</li><li>Select the Connector Type for the platform and location where you are creating the Layer or publishing the image. Then click <strong>New</strong> to open the Connector Configuration page.</li><li>Enter the configuration <em>Name</em>, and the <em>vCenter Server</em>, <em>vCenter User Name</em>, and <em>vCenter Password</em>). For guidance, see the above field definitions.</li><li>Click the <strong>CHECK CREDENTIALS</strong> button below the vCenter fields. The DataCenter field is then enabled with a list of DataCenters available.</li><li>Select the DataCenter, and the remaining dropdowns will be enabled.</li><li>Complete the remaining fields and click the <strong>TEST</strong> button to verify that Unidesk can access the location specified using the credentials supplied.</li><li>Click <strong>Save</strong>. The new Connector Configuration should now be listed on the Connector page.</li></ol>
##Script Configuration (Optional, Advanced feature)<a name="Script_Configuration_(Optional,_Advanced_feature)_..883"></a><a name="Configure_Script_Path_..470"></a>
When creating a new Connector Configuration, you can configure an optional Powershell script on any Windows machine running a Unidesk Agentthe same agent used on the PVS server. These scripts must be stored on the same machine that the Unidesk Agent is installed on, and will only be executed after a successful deployment of a Layered Image. Some preset variables are available to enable scripts to be reusable with different template images and different connector configurations. These variables will also contain information needed to identify the virtual machine created as part of the published layered image in vSphere.
Execution of these scripts will not affect the outcome of the publish job, and progress of commands executed in the script will ***not***  be visible. The vSphere connector logs will contain the output of the executed script.
###Configure a Script (Remember, this is optional)<a name="Configure_a_Script_(Remember,_this_is_optional)_..884"></a>
If you want a script to run each time a Layered Image is published, complete these steps using the values described in the sections that follow.
<ol><li><p>Complete and save the Connector Configuration as described above.</p><p><strong>Note:</strong> Before selecting Script Configuration page, you must save (or discard) any edits to the Connector Configuration settings,</p></li><li><p>If the Navigation menu on the left is not open, select it and click <strong>Script Configuration</strong> to open the Script Path page.</p></li><li><p>Complete the required fields using the values detailed herein, and click <strong>Save</strong>.</p></li></ol>
###Script Configuration fields<a name="Script_Configuration_fields_..885"></a><a name="Creds_..471"></a>
<ul><li><strong>Enable script</strong> - Select this check box to enable the remaining fields. This allows you to enter a script that will be executed each time a Layered Image is published.</li><li><strong>Script Agent</strong> - The agent machine where the scripts will be located and executed from.</li><li><strong>Username (optional)</strong> - The username to <em>impersonate</em> when running the script. This can be used to ensure the script runs in the context of a user that has the needed rights/permissions to perform the operations in the script.</li><li><strong>Password (optional)</strong> - The password for the specified username.</li><li><strong>Path</strong> - A full path and filename on the agent machine where the script file resides.</li></ul>
###Other Script Configuration values<a name="Other_Script_Configuration_values_..886"></a>
####Powershell variables
When the script is executed the following variables will be set and can be used in the powershell script:
<table><thead><tr><th>Value</th><th>Applies to connector types:</th><th>Value determined by which code:</th><th>Description</th></tr></thead><tbody><tr><td>connectorCfgName</td><td>All</td><td>Common code</td><td>This is the name of the connector configuration that the script configuration is associated with.</td></tr><tr><td>imageName</td><td>All</td><td>Common code</td><td>This is the name of the layered image template that was used to build/publish the layered image.</td></tr><tr><td>osType</td><td>All</td><td>Common code</td><td><p>This is the OS type of the layered image that was published. It can be one of the following values:</p><ul><li>Windows7</li><li>Windows764</li><li>Windows8</li><li>Windows864</li><li>Windows200864</li><li>Windows201264</li><li>Windows10</li><li>Windows1064</li></ul></td></tr><tr><td>virtualInfrastructureServer</td><td>All</td><td>vSphere connector code</td><td>The vCenter server specified in the connector configuration.</td></tr><tr><td>vmName</td><td>All</td><td>vSphere connector code</td><td>The name of the virtual machine that was created.</td></tr><tr><td>vmId</td><td>All</td><td>vSphere connector code</td><td>The virtual machine ID taken from the mobref of the vm (i.e. "vm-12345")</td></tr><tr><td>vmUuid</td><td>All</td><td>vSphere connector code</td><td>The virtual machine UUID as set by the underlying highbrd.</td></tr></tbody></table>
####User Impersonation
The Unidesk Agent, which runs as a service on a Windows machine, runs under either the local system account or the network account. Either of these accounts may have some special privileges, but they often are restricted when it comes to executing specific commands or seeing files in the file system. Therefore, Unidesk gives you the option of adding a domain user and password that can be used to "impersonate" a user. This means that the script can be executed as if that user had logged onto the system so that any commands or data will be accessible subject to those user rights and permissions. If no user name or password is entered, the script executes using the account under which the service is configured to run.
####Script Execution Policy
Script execution policy requirements are generally up to you. If you intend to run unsigned scripts, you must configure the execution policy to one of the more lenient policies. However, if you sign your own scripts accordingly, you can choose to use a more restrictive execution policy.
# System Settings and Configuration<a name="System_Settings_and_Configuration"></a><a name="$$index$$_logs:Management_Appliance_..1016"></a>
You can specify settings for the following Unidesk configuration parameters by clicking on the ***Edit***  button of each option, making your changes, and clicking the ***Save***  button.
<table><thead><tr><th>Appliance settings</th><th>Summary</th></tr></thead><tbody><tr><td>HTTP Certificate Settings</td><td><p>Displays the currently set security certificate. Use the <strong>Upload</strong> and <strong>Generate</strong> buttons to upload an existing certificate or to generate a new one. Optionally, enter a comment that describes the changes you made.</p></td></tr><tr><td>Network File Shares</td><td><p>After you specify a <strong>Network File Share Type</strong>, <strong>Network File Share Path</strong>, <strong>User name</strong>, and <strong>Password</strong>, click <strong>Test Network File Share</strong> to see if you can connect to the file share. The test returns a message stating either "Success" or "Failed to mount network file share path". Optionally, enter a comment that describes the changes you made.</p></td></tr><tr><td>Security Settings</td><td><p>Specify the number of minutes of inactivity before the Unidesk Management Console logs you out. Optionally, enter a comment that describes the changes you made.</p></td></tr><tr><td>Task Retention Settings</td><td><p>Specify the number of days that Unidesk should retain completed Tasks before deleting them. Optionally, enter a comment that describes the changes you made.</p></td></tr><tr><td>Audit Log Retention Settings</td><td><p>Specify the number of days that Unidesk should retain audit log files. After that time elapses, the software begins to overwrite the audit log. Optionally, enter a comment that describes the changes you made.</p></td></tr><tr><td>Notification Settings</td><td><p>Configure automatic email notification settings for yourself or other Unidesk users. When you export logs, Unidesk sends the specified recipients an email notification that includes a link to the log files.</p><p>To set up email notifications:</p><ol><li><p>In the Mail Server box, enter the name of your email server or the name of the SMTP relay server.</p></li><li><p>In the Mail Server port, enter the number of the port that the email server uses for communication.</p></li><li><p>In the User Name box, enter the user name for the email account you want to use for sending notifications. For example, username@domain.com.</p></li><li><p>In the Password box, enter the password for the email account.</p></li><li><p>In the From box, enter an email address to identify the source of the email message. For example, if you enter myaddress@mycompany.com, the email message displays the following in the From box of the received notification:</p><p><span>Unidesk Enterprise Layer Manager [myaddress@mycompany.com] </span></p></li><li><p>In the Recipient List box, enter the email addresses that should receive notifications. Use a comma or semicolon to separate the email addresses.</p></li><li><p>Click <span>Test Email Configuration</span> to verify that the settings for the email server and account work correctly. If the test succeeds, the software displays a success message and sends the recipients a confirmation email.</p></li><li><p>Enter a comment, if necessary, and click <span>Save </span>to save the email settings. Any comments you enter will appear in the Information view Audit History.</p></li></ol><p>For more information, see <a href="#Export_log_files_for_Support">Export log files and send to Support</a>.</p></td></tr><tr><td>Log File Retention Settings</td><td><p>Specify the maximum disk space to use for all logs (in megabytes) and the number of days that Unidesk should retain Unidesk ELM log files. Optionally, enter a comment that describes the changes you made.</p></td></tr></tbody></table>

#Manage system storage<a name="Manage_system_storage"></a>
In this article:
<table><tbody><tr><td><p>Check the amount of free space in the Unidesk ELM's local storage</p><p>Add space to an existing disk in locally attached storage</p><p>Add a disk to locally attached storage</p></td></tr></tbody></table>
##Check the amount of free space in the Unidesk ELM's local storage<a name="Check_the_amount_of_free_space_in_the_Unidesk_ELM's_local_storage"></a><a name="Check"></a>
The ELM's local storage is your Layer Repository where the ELM creates, composites, and stores Layers and Layered Images. You can see how much disk space is used in the System module of the Unidesk Management Appliance (UMC).
<ol><li><p>Log into the UMC and select <strong>System -> Manage Appliance</strong>.</p></li><li><p>In the Unidesk Services table, the Local Storage for the Layering Service shows how much space is used and how much is free.</p><p>Notes:</p><ul><li>Disk space is shown in 1024-based Gigabytes, not metric.</li><li>Free space is updated every time a Layering Service job completes. If you want to make sure the page has been refreshed, click the Refresh icon just above the Manage Appliance subtab.</li><li>When creating a Layer or adding a Version to it, extra space is temporarily required to build the Packaging Disk. You can calculate the amount of space needed during Layer creation by adding the following Layer sizes:<ul><li>The size of the OS Layer Version you're using.</li><li>The size of the writable disk you want for the App Layer.</li><li>The size of any Prerequisite Layers (if you have any).</li></ul></li></ul></li></ol>
##Add space to an existing disk in locally attached storage<a name="Add_space_to_an_existing_disk_in_locally_attached_storage"></a><a name="Add"></a>
You can add storage space to an existing local storage disk as follows.
<ol><li>Log into your hypervisor's management console, and follow the normal procedure to increase the size of the ELM's local storage disk. (You may have more than one of these disks, and can expand each one of them.)</li><li>Log into the UMC and select System -> Manage Appliance.</li><li>Select Expand Storage. A list of expanded disks is displayed. (You might also see attached disks that are not yet part of the layer repository, but you can ignore those.)</li><li>Notice that the New Size of the disk you expanded is larger than the Current Size.</li><li>Select the check box for the disk that you want to expand to the New Size.</li><li>On the Confirm and Complete tab, click Expand Storage.</li></ol>
##Add a disk to locally attached storage<a name="Add_a_disk_to_locally_attached_storage"></a><a name="Expand_..472"></a>
When you install the Unidesk ELM in vSphere, it comes equipped with an additional 200 GB data disk that is used as a Layer Repository. You can expand the ELM's local storage by adding another disk to it.
<ol><li><p>Log into your hypervisor's management console, and follow the normal procedure to add a blank SCSI disk to the ELM appliance.</p></li><li><p>Log into the UMC and select System -> Manage Appliance.</p></li><li><p>Select Expand Storage.</p></li><li><p>On the Disk Selection tab, a list is displayed of disks that are attached to the system and are not part of the layer repository.</p></li><li><p>Select the check box for each disk that you want to use to expand the layer repository.</p><p>If a check box is grayed out and a yellow icon with an ! (exclamation point) is displayed, it means that the attached disk is not eligible for use (for example, if the disk is not blank). Once the attached disk is blank and unpartitioned, you will be able to use it to expand the ELM's local storage.</p></li><li><p>On the Confirm and Complete tab, click Expand Storage.</p></li></ol>

#Manage the Unidesk ELM (virtual appliance)<a name="Manage_the_Unidesk_ELM_(virtual_appliance)"></a>
In this article:
<table><tbody><tr><td><p>Before you start</p><p>Log into the ELM using an account with administrator privileges</p><p>Change the administrator password</p><p>Configure networking (includes Static IP Address option)</p><p>Synchronize the system clock with NTP servers</p><p>Change the Time Zone</p></td></tr></tbody></table>
The Enterprise Layer Manager (ELM) is a virtual appliance that coordinates communication in the Unidesk environment and manages copies of your Layers and Image Templates. Based on CentOS, the ELM hosts the Unidesk Management Console (UMC), a friendly interface where you create Unidesk Layers and use those Layers to publish Layered Images.
You can log into the ELM and modify the administrator password, network address, NTP servers, and Time Zone settings using the Unidesk Appliance Configuration utility, as described here.
##Before you start<a name="Before_you_start_..887"></a><a name="Before_..473"></a>
o Make sure that the Unidesk Enterprise Layer Manager (ELM) is running in your hypervisor.
o Make sure you have the password for an account with administrator privileges
##Log into the ELM using an account with administrator privileges<a name="Log_into_the_ELM_using_an_account_with_administrator_privileges"></a><a name="Log_..474"></a>
<ol><li><p>Using either your hypervisor console or SSH, log into the ELM as <strong>administrator</strong> (default password <em>Unidesk1</em>).</p><ul><li><p><strong>Note:</strong> If the ELM is in <em>Azure</em>, type <strong>/opt/sbin/cfg_launcher</strong>, and press <strong>Enter</strong>.</p></li></ul><p>This opens the Unidesk Appliance Configuration utility.</p></li></ol>
##Change the administrator password<a name="Change_the_administrator_password_..888"></a><a name="Change4"></a><a name="Change_..475"></a>
<ol><li><a href="#Log_..474">Log in</a> to the ELM's Appliance Configuration utility, as described above.</li><li>At the Appliance Configuration utility's Action prompt, enter <strong>P</strong> (for <em>Password change</em>), and press <strong>Return</strong>.</li><li>When prompted, enter the new password, and then confirm the password. A message confirms that the <em>** Password changed successfully</em>.</li><li>Press the <strong>Enter</strong> key to continue.</li><li>At the Action prompt, enter <strong>Q</strong> to quit.</li></ol>
##Configure networking (includes Static IP Address option)<a name="Configure_networking_(includes_Static_IP_Address_option)"></a><a name="Change2"></a>
You can change the ELM's IP address and/or its DNS servers.
When the ELM is first deployed, the DNS settings are retrieved through DHCP. If DHCP is not available and you will be using static IP addresses, once you select ***Static*** , you will be prompted to enter the IP addresses for your DNS servers.
<ol><li><a href="#Log_..474">Log in</a> to the ELM's Appliance Configuration utility, as described above.</li><li>At the Action prompt, enter <strong>C</strong> (for Configure Networking), and press <strong>Return</strong>.</li><li>At the next prompt, type <strong>D</strong> for Dynamic (DHCP) or <strong>S</strong> for Static.<p>If you choose <em>Static</em>, you will be prompted for the IP address and Subnet mask, along with default addresses for the Gateway and DNS addresses.</p></li><li>When prompted, enter <strong>Y</strong> to save settings.</li><li>At the Action prompt, enter <strong>Q</strong> to quit.</li><li>Restart the appliance.</li></ol>
##Synchronize the system clock with NTP servers<a name="Synchronize_the_system_clock_with_NTP_servers"></a><a name="Synchron"></a>
You can synchronize the system clock on the ELM by configuring NTP servers. You can specify how many NTP servers you need, with 6 being the maximum. And, you can add and remove NTP servers, as needed. Where possible your existing servers will be used as defaults.
<ol><li><a href="#Log_..474">Log in</a> to the ELM's Appliance Configuration utility, as described above.</li><li>At the Action prompt, enter <strong>N</strong> for <em>NTP servers change</em>, and press <strong>Return</strong>. A list of your current NTP servers is displayed.</li><li><p>At the prompt, specify how many NTP servers you need by typing a number from 0 to 6.</p><ul><li>0 - All servers will be removed (you will be warned).</li><li>1-6 - You will be prompted to accept or replace each of the current servers. </li></ul></li><li>For each server, press <strong>Enter</strong> to accept the current value. Or, enter a new server address (Example: <strong>3.pool.ntp.org</strong>). Once the last address is entered, an NTP Server Summary is displayed.</li><li>Enter <strong>S</strong> to save the settings.</li><li>At the Action prompt, enter <strong>Q</strong> to quit.</li><li>Restart the appliance.</li></ol>
##Change the Time Zone<a name="Change_the_Time_Zone"></a><a name="Change3"></a>
<ol><li><a href="#Log_..474">Log in</a> to the ELM's Appliance Configuration utility, as described above.</li><li>At the Action prompt, enter <strong>T</strong> for <em>Timezone change</em>, and press <strong>Return</strong>. The current time zone is displayed.</li><li>Press <strong>Enter</strong> to display available timezones. The first bunch of time zones are displayed in alphabetical order, starting with the</li><li><p>Advance through the timezone codes until you see yours:</p><ul><li><strong>Enter</strong> - Advances one line at a time.</li><li><strong>Page Up</strong> <strong>Page Down</strong> - Displays the next or previous screen full of choices.</li></ul><p>Or search the timezones:</p><ul><li>Type <strong>Slash</strong> (<strong>/</strong>) and part of the name you are looking for.</li></ul></li><li>When your timezone is displayed, press <strong>Q</strong> to get to the prompt.</li><li>Type the number for your timezone. The timezone you entered is displayed.</li><li>Press <strong>Enter</strong> to complete the change.</li><li>At the Action prompt, enter <strong>Q</strong> to quit.</li><li>Restart the appliance.</li></ol>

#Open firewall ports for Unidesk, as needed<a name="Open_firewall_ports_for_Unidesk,_as_needed_..10"></a>
In this article:
<table><tbody><tr><td><p>Admin User</p><p>Unidesk Enterprise Layer Manager Appliance</p><p>Next step</p></td></tr></tbody></table>
The Unidesk ELM must be connected to a network file share.
The Unidesk installer opens ports that the Unidesk Enterprise Layer Manager (ELM) needs to interact with services on the virtual server where it is hosted. The default ports that Unidesk uses are listed in the tables below.
If there is a firewall between the Unidesk appliance and the machine on which you are running the Unidesk Agent or one of the Unidesk Connectors, you must manually open the port in the firewall used for that purpose. If during installation you changed any of the ports from the default setting, be sure to open the correct port.
##Admin User<a name="Admin_User_..889"></a><a name="Admin_..476"></a>
By default, Unidesk uses the following ports in your firewall for the Unidesk Admin User to interact with the Unidesk Management Console (UMC).
<table><thead><tr><th>Destination</th><th>Activity</th><th>Protocol</th><th>Ports</th></tr></thead><tbody><tr><td>Unidesk Enterprise Layer Manager (ELM)</td><td>Unidesk Management Console (UMC)</td><td>TCP</td><td>80,443</td></tr></tbody></table>
##Unidesk Enterprise Layer Manager Appliance<a name="Unidesk_Enterprise_Layer_Manager_Appliance_..890"></a><a name="Unidesk_..477"></a>
###Internal Connections<a name="Internal_Connections_..891"></a>
By default, Unidesk uses the following ports in your firewall for internal connections between the Unidesk appliance and each of the destinations listed below.
<table><thead><tr><th>Destination</th><th>Activity</th><th>Protocol</th><th>Ports</th></tr></thead><tbody><tr><td>Unidesk ELM</td><td>ActiveMQ Console</td><td>TCP</td><td>8161</td></tr><tr><td>Unidesk ELM</td><td>Log deliveries from the Unidesk Agent</td><td>TCP</td><td>8787</td></tr><tr><td>Unidesk ELM</td><td>Log deliveries from users</td><td>TCP</td><td>8888</td></tr><tr><td>Unidesk ELM</td><td>Communication with datastore via ESXI Host</td><td>TCP</td><td>443</td></tr><tr><td>Unidesk Agent</td><td>Communication</td><td>TCP</td><td>8016</td></tr><tr><td>Unidesk Agent</td><td>Log gathering</td><td>TCP</td><td>14243</td></tr><tr><td>Active Directory</td><td>LDAP</td><td>TCP</td><td>389, 636</td></tr><tr><td>Connector for Azure</td><td>Communication</td><td>TCP</td><td>3000 (HTTP) <br></br>3500 (HTTPS)</td></tr><tr><td>Connector for PVS</td><td>Communication</td><td>TCP</td><td>3009 (HTTP) <br></br>3509 (HTTPS)</td></tr><tr><td>Connector for vSphere</td><td>Communication</td><td>TCP</td><td>3004 (HTTP)<br></br>3504 (HTTPS)</td></tr><tr><td>Connector for XenServer</td><td>Communication</td><td>TCP</td><td>3002 (HTTP)<br></br>3502 (HTTPS)</td></tr></tbody></table>
###External connection<a name="External_connection_..892"></a>
By default, Unidesk uses the following port in your firewall for external connections between the Unidesk appliance and the destination listed below.
<table><thead><tr><th>Destination</th><th>Activity</th><th>Protocol</th><th>Ports</th></tr></thead><tbody><tr><td>api.unidesk.com</td><td>Logs and Phone Home data uploads from the Unidesk ELM (optional)</td><td>TCP</td><td>443</td></tr></tbody></table>
##OS Image (XenServer requirement)<a name="OS(SPACE)Image__(XenServer_requirement)_..893"></a>
Citrix XenServer uses Port 5900 for communications between your OS Image and XenCenter or other Xen client.
<table><thead><tr><th>Destination</th><th>Activity</th><th>Protocol</th><th>Ports</th></tr></thead><tbody><tr><td>XenCenter</td><td>Communications</td><td> </td><td>5900</td></tr></tbody></table>
##Next step<a name="Next_step_..894"></a><a name="Next_..478"></a>
If you are publishing to PVS: Install the Unidesk Agent (required for PVS and Connector Scripts)
If you are ***not***  publishing to PVS: Assign Unidesk Roles to users

#Update your Unidesk license<a name="Update_your_Unidesk_license_..12"></a>
In this article:
<table><tbody><tr><td><p>Log into the Unidesk site</p><p>Update your Unidesk license (with web access to the ELM)</p><p>Update your Unidesk license (without web access to the ELM))</p></td></tr></tbody></table>
To acquire a Unidesk license, you must be logged in to Unidesk. If you have not already done so, register on the Unidesk website to obtain a User Name and Password.
##Log into the Unidesk site<a name="Log_into_the_Unidesk_site_..895"></a><a name="Register_..479"></a>
<ol><li>In a web browser, navigate to <a href="http://www.unidesk.com">the Unidesk website</a> and click <strong>Login</strong>.</li><li>If you have not yet registered with Unidesk, go to the Register section of the login page, enter your email address and click <strong>Register.</strong><p>Unidesk sends a confirmation email message to the address you provided.</p></li><li>Open the confirmation email message from Unidesk, which contains the Subject line "Confirming your registration at www.unidesk.com", and click the link it contains or paste the link into a web browser.</li><li>To finish registering, fill out the fields in the "Email address confirmed" page and click the <strong>Complete registration</strong> button.</li></ol>
##Update your Unidesk license (<a name="Update_your_Unidesk_license_(with_web_access_to_the_ELM)_..896"></a><a name="Update_..480"></a>***with***  web access to the ELM)<a name="Update_your_Unidesk_license_(with_web_access_to_the_ELM)_..896"></a><a name="Update_..480"></a>
If you receive a message that your license needs updating, and your Enterprise Layer Manager has web access:
<ol><li>In the License Expired message, click <span>License</span>. This opens the Update License wizard.</li><li>Select <strong>Download your license now by entering your credentials for the www.unidesk.com website</strong>.</li><li>Enter your credentials for the Unidesk website.</li><li>On the Confirm Your License tab, click <span>Finish</span>.</li><li>You can return to the Licensing wizard at any time by logging into the Unidesk Management Console and clicking <strong>About</strong>, and then the <strong>License</strong> tab.</li></ol>
##Update your Unidesk license (<a name="Update_your_Unidesk_license_(without_web_access_to_the_ELM))_..897"></a><a name="Update2_..481"></a>***without***  web access to the ELM))<a name="Update_your_Unidesk_license_(without_web_access_to_the_ELM))_..897"></a><a name="Update2_..481"></a>
If you receive a message that your license needs updating, and your Enterprise Layer Manager does ***not***  have web access:
<ol><li>Obtain a license file from Unidesk Sales or Support, and move the file to a drive that Enterprise Layer Manager can access.</li><li>If the License Expired message, is still open, click <span>License</span> in the message. If not, click <strong>About</strong>, then the <strong>Update License</strong> button. This opens the Update License wizard.</li><li>Select <strong>Upload your license file from a local drive</strong>.</li><li>Click <strong>Browse</strong>, and select the license file.</li><li>On the Confirm Your License tab, click <span>Finish</span>.</li><li>You can return to the Licensing wizard at any time by logging into the Unidesk Management Console and clicking <strong>About</strong>, and then the <strong>License</strong> tab.</li></ol>
#Support resources<a name="Support_resources"></a>
In this article:
Need help getting started?
Questions about how Unidesk layering works?
Troubleshooting an issue?
##Need help getting started?<a name="Need_help_getting_started_"></a><a name="GS"></a>
###Try Unidesk for the first time<a name="Try_Unidesk_for_the_first_time"></a>
<ul><li>Install the Unidesk Enterprise Layer Manager (ELM)</li><li><a href="#Set_up_Unidesk">Set up the ELM in your environment</a></li><li><a href="scenarios_co4.htm">Take a test drive</a></li></ul>
###Schedule a personalized demo<a name="Schedule_a_personalized_demo"></a>
<ul><li><a href="http://get.unidesk.com/product-experience/request-demo-with-unidesk-solution-architect">Join us for a one-on-one "Day-in-the-Life" with a Unidesk Solution Architect</a></li></ul>
###Deploy rapidly with expert assistance<a name="Deploy_rapidly_with_expert_assistance"></a>
<ul><li><a href="http://get.unidesk.com/product-experience/request-a-unidesk-trial">Request a Unidesk Pilot, if you haven't already</a></li><li><a href="http://success.unidesk.com/">Create a Support Case</a></li></ul>
##Questions about how Unidesk layering works?<a name="Questions_about_how_Unidesk_layering_works_"></a><a name="Questions"></a>
###Ask Unidesk employees and contributing users<a name="Ask_Unidesk_employees_and_contributing_users"></a>
<ul><li><a href="http://www.unidesk.com/forum">Post your questions on the Unidesk Community Forum</a></li></ul>
###Search the Forum<a name="Search_the_Forum"></a>
<ul><li><a href="http://www.unidesk.com/forum/application-layer-recipes">App Layer Recipes</a></li></ul>
##Troubleshooting an issue?<a name="Troubleshooting_an_issue_"></a><a name="Trouble"></a>
<ul><li><a href="http://www.unidesk.com/forum/unidesk-4">Troubleshooting Unidesk 4.0 (Forum posts)</a> </li><li><a href="http://www.unidesk.com/search?f[0]=sm_doc_type%3ASupport">Troubleshooting Unidesk 4.0 (Knowledge base)</a> </li></ul>

# Export log files for Support<a name="Export_log_files_for_Support"></a>
 You can export logs for your Unidesk Enterprise Layer Manager (ELM), and send them to the Unidesk Support team via HTTPS or to yourself and others by email.<a name="$$index$$_Unidesk_Management_Console:System_module"></a>
This topic explains what log files are available for export, and which log files are useful for what kinds of issues. It then explains how to export each of the logs.
About exporting Unidesk logs
 Unidesk log files are text files that contain useful information for the Unidesk Support Team when helping you to resolve an issue. The exported logs are stripped of any passwords and encryption keys, so none of your credentials can be compromised.<a name="$$index$$_Task_bar:components"></a><a name="$$index$$_Management_Console:about_..1017"></a>
###What log files are exported?<a name="What_log_files_are_exported_"></a>
Each export includes the logs for the Unidesk ELM. The Database Crash Dump file export is optional. When you export logs, the Unidesk software creates a gzipped tar file (.tgz) containing the log files. A task with the URL for each tar file appears in the Task bar.
<table><thead><tr><th>Virtual Machine</th><th>Exported files</th></tr></thead><tbody><tr><td>Enterprise Layer Manager (ELM)</td><td><p>The gzipped tar file (.tgz) with:</p><ul><li>Management Services logs</li><li>Layering Services logs</li><li>Crash Dump files (optional)</li></ul></td></tr></tbody></table>
 To view the log files, download them and extract them using a file compression utility such as the WinZip<a name="$$index$$_Unidesk_Management_Console:using"></a> product.<a name="$$index$$_Unidesk_Management_Console:using"></a>
###Before you start<a name="Before_you_start_..898"></a>
<table><thead><tr><th>Before you can...</th><th>You must...</th></tr></thead><tbody><tr><td>Send logs to Unidesk Support</td><td>Have an open Support Case. Create a Support Case explaining the issue you're seeing.</td></tr><tr><td>Send email notices</td><td>Specify your email server in the System > Settings and Configuration > Notifications Settings box.</td></tr><tr><td>Export logs</td><td><p>Make sure the Log File Retention Settings are configured to keep the logs you need for the length of time you need.</p></td></tr></tbody></table>

 Export and send Unidesk ELM logs<a name="$$index$$_logs:Management_Appliance;Management_Appliance:logs"></a>
When configuring an export, you can choose to send a copy of the logs to Unidesk Support via HTTPS, or to yourself or others who need access to the logs via email.
<ol><li><p>In the Unidesk Management Console, select <strong>System > Manage Appliance</strong> and click <span>Export Logs</span>. The Export Logs Wizard opens to the Send Options tab.</p></li><li><p>If you want to send the logs to Unidesk via HTTPS and you have a Unidesk Support Case open, click <strong>Send to Unidesk Support</strong>, choose the support case, and type a description in the Comments field.</p><p><strong>Note:</strong> This option is only available if you have an open Support Case. You can open one and come back to this screen to select the option.</p></li><li><p>If you want to send the files to yourself or others who need access to the logs, select the <strong>Email</strong> check box and type the addresses in the Recipients field. (Use a comma (,) or semi-colon (;) between addresses.)</p><p><strong>Note:</strong> This field is only active if you've configured an email Notification in the <strong>System > Settings and Configuration > Notifications Settings</strong> box.</p></li><li><p>In the Log Selection tab, the Enterprise Layer Manager Logs option is selected by default. If you need to include the Crash Dump files, mark the check box to include those.</p></li><li><p>In the Confirm and Complete tab, click <span>Export Logs</span> to start the export process. The software locates the log files and exports them to a gzipped archive file (*.tgz) on the appliance.</p></li></ol>
The free [online div table generator](http://divtable.com/generator/)[ allows you to create nice grids for your websites. Please subsribe for a ](http://divtable.com/generator/)[htmlg](https://htmlg.com/)[ membership to stop adding promotional messages to the edited documents.](https://htmlg.com/)
