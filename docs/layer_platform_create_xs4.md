[Platform Layers](layer_platform_create_co4)
 > Citrix XenServer (Citrix XenServer connector)
#Create a Platform Layer (XenServer Connector)
In this article:
<table>            <col></col>            <tbody>                <tr>                    <td>                        <p><a href="#Prerequi"> </a>                        </p>                        <p><a href="#Create2"> Prepare a new Platform Layer</a>                        </p>                        <p><a href="#Install"> </a>                        </p>                        <p><a href="#Verify"> </a>                        </p>                        <p><a href="#Finalize"> </a>                        </p>                    </td>                </tr>            </tbody>        </table>
A Platform Layer should include the platform software and settings required to deploy images in your environment, given your choice of hypervisor, provisioning service, and connection broker. 
You can create two kinds of Platform Layers:
<ul>            <li>                <p>Platform Layers for <i>publishing Layered Images</i> (Required) - A Platform Layer for <i>publishing</i> is used in Image Templates to ensure that your published Layered Images include the software and settings required to run flawlessly in your environment. </p>            </li>            <li>                <p>Platform Layers for <i>packaging Layers</i> (Required in some cases) - A Platform Layer for <i>packaging</i> is used for creating App Layers and OSLayer Versions in your hypervisor environment. This Layer includes the hypervisor software and settings required to easily install the app or OSupdate on a VM in the selected hypervisor. </p>            </li>        </ul>

##Prerequisites 
When creating a Platform Layer, the software installers for your platform must be available in a location that's accessible to the Packaging Machine VM where you are going to create the Layer. As summarized in the following table, the prerequisites vary based on the type of Platform Layer you choose to create. 
<table>            <col></col>            <col></col>            <thead>                <tr>                    <th>Type of Platform Layer</th>                    <th>Prerequisites</th>                </tr>            </thead>            <tbody>                <tr>                    <td>Publishing Layered Images</td>                    <td>                        <p>Software installers, and settings you use for your:</p>                        <ul>                            <li>Hypervisor</li>                            <li>Provisioning service</li>                            <li>Connection broker  </li>                        </ul>                    </td>                </tr>                <tr>                    <td>Packaging Layers</td>                    <td>                        <p>The software and settings for your:</p>                        <ul>                            <li>Hypervisor</li>                        </ul>                        <p>For example, your hypervisor installer and settings. </p>                        <p><b>Note:</b> You only need a Platform Layer for <i>packaging</i> Layers if you are creating your Layers on a different hypervisor than the one from which you imported your OSimage.</p>                    </td>                </tr>            </tbody>        </table>
###Citrix XenServer prerequisites
<ul>            <li>                <p><b>XenServer account and privileges</b>                </p>                <ul>                    <li>A XenServer account (new or existing) to use for Unidesk.</li>                    <li>The account must have XenServer privileges to: <ul><li>Create and remove virtual disks.</li><li>Copy and delete layers on virtual disks using XenServer file APIs. </li></ul></li>                </ul>            </li>            <li>                <p><b>Citrix XenServer software and settings</b></p>                <p>Access to the XenServer Tools to install on the layer. </p>            </li>            <li>                <p><b>XenServer resource information</b></p>                <p>The XenServerinfo listed in <a href="connector_config_fields_xs4.htm">Citrix XenServer Connector Configuration</a>. </p>            </li>            <li>                <p> <b>Network access to Unidesk OSMachine Tools</b></p>                <p>When you create  Layer or add a Version to it,  the Unidesk Management Console (UMC) uses a Connector Configuration to create a VM called a Packaging Machine for the Layer you are building. The Packaging Machine <i>must</i> have access to the Unidesk OSMachine Tools download, which is available on the Unidesk Download page. </p>            </li>        </ul>
##Prepare a new Platform Layer<a name="Create2"></a>
<ol>            <li>                <p>Select <b>Layers >Platform Layers</b> and select <b>Create Platform Layer</b> in the Action bar. This opens the Create Platform Layer wizard.</p>            </li>            <li>                <p>In the Layer Details tab, enter a <b>Layer Name</b> and <b>Version</b>, both required values. Optionally, you can also enter other values.</p>            </li>            <li>                <p>In the OSLayer tab, select the OSLayer you want to associate with this Platform Layer. </p>            </li>            <li>                <p>In the Connector tab, choose a Connector Configuration for the platform where you are creating this layer. If the configuration you need isn't listed, Click <b>New</b>, select your platform from this list, and <a href="connector_config_create_co4.htm">Add a Configuration</a> for it.</p>                <p><b>Example:</b> If you are creating the layer in a XenServer environment, select the XenServer connector with the information needed to access the location where you will package this layer.</p>            </li>            <li>                <p>In the Platform Types tab, select the radio button that describes the purpose of this Platform Layer: to create and update layers, or to publish Layered Images. For more about these choices, see <a href="layer_about_co4.htm#Platform"> Platform Layers</a>.</p>            </li>            <li>                <p>From the dropdown menus, select the platform(s) you are using.</p>            </li>            <li>                <p>In the Packaging Disk tab, enter a <b>file name</b> for the Packaging Disk, and select the disk format. This disk will be used for the Packaging Machine (the VM)where you will install the tools, as described in the next two sections.</p>            </li>            <li>                <p>In the Icon Assignment tab, select an icon to assign to the layer. This icon represents the layer in the Layers Module.</p>                <ul>                    <li>To use an existing image, select an image in the image box.</li>                    <li>To import a new image, click <b>Browse</b>  and select an image in PNG or JPG format.</li>                </ul>            </li>            <li>                <p>In theConfirm and Complete tab, review the details of the Layer, enter a comment if required, and click <b>Create Layer</b>. Any comments you enter will appear in the  Information view Audit History.</p>            </li>            <li>                <p>At the bottom of the UI, expand the Tasks bar and double-click the task to show the full task description. </p>                <p>Once the task is complete,  the location of the Packaging Disk is shown (example task message shown below). </p>                <p><a href="Resources/Images/layers_app_action_required_vs.png"><img></img></a>                </p>            </li>        </ol>
Next, you can deploy the Packaging Machine for your Layer. The Packaging Machine is a temporary virtual machine where you install the software to include in the Layer being created. 

##Power on the Packaging Machine in Citrix XenServer<a name="Copy"></a>
<ol>            <li>Log into your XenServer client.</li>            <li>                <p>Back in the Unidesk Management Console (UMC), expand the Tasks bar at the bottom of the UI, and double-click the <i>Create Platform Layer</i> task to see the full Task Description (example below). </p>                <p><a href="Resources/Images/layers_app_action_required_vs.png"><img></img></a>                </p>            </li>            <li>Use the instructions in the Task Description to navigate to the Packaging Machine in your XenCenter client. </li>            <li>While in the Infrastructure View, select your Packaging Machine's <b>VM</b> from the list of machines.</li>            <li>                <p>In the XenCenter UI in the panel on the right, choose the <b>Console</b> option for the VM.</p>            </li>            <li>Power on the VM.</li>            <li>Select the <b>Click here to create a DVD drive</b> link.</li>            <li>Power cycle the VM (yes, you have to in order to get the DVD Drive).</li>            <li>At the top of the console window, click the <i>DVD Drive 1</i> drop down menu and select the <b>xs-tools.iso</b>.</li>            <li>                <p>Install the XenTools. This will require multiple reboots as part of the tools installation. Once complete, you should see that you have access to all <i>XenTools</i>, as well as all of the <i>data</i> available under the Performance tab for your VM.</p>                <p><b>Note:</b> The XenCenter console uses <i>RFB</i> for it's console connection, which uses <i>Port 5900</i>. On Windows 2008 and Windows 7, this port is closed in the Firewall by default and should be opened so you can use the console to access any VMs</p>            </li>        </ol>

##Install the platform tools on the Packaging Machine 
Whether you are creating a Platform Layer or adding a version to it:
<ol>            <li>                <p>Remote log in to the Packaging Machine. Be sure to log in using the User account you used to create the OS.</p>            </li>            <li>                <p>Install the platform software and tools, along with any drivers, boot-level applications, or files needed. Keep in mind that the state of the software before you finalize the layer is what the image will use. </p>                <ul>                    <li>If this Platform Layer is going to be used for packaging new layers, install and configure your hypervisor tools and settings.</li>                    <li>If this Platform Layer is going to be used for publishing Layered Images, install and configure your hypervisor, provisioning service, and connection broker tools and settings.</li>                    <li>If a software installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</li>                </ul>            </li>            <li>                <p>Make sure the Packaging Machine is in the state you want it to be in for users:</p>                <ul>                    <li>If the tools you install require any post-installation setup or registration, complete those steps now.  </li>                    <li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li>                    <li>                        <p>When using PVS, if your OS image was activated using KMS, rearm KMS <i>just before you shut down</i></p>                        <ol>                            <li>                                <p>Verify the Rearm count on the OS by running slmgr /dlv from a command prompt. The Rearm count must <i>not</i> be zero.</p><pre>slmgr /dlv</pre>                            </li>                            <li>                                <p>Rearm KMS:</p><pre>slmgr /rearm</pre>                            </li>                        </ol>                    </li>                </ul>            </li>        </ol>

##Verify the Layer and shut down the Packaging Machine
Once the software is installed on the Packaging Machine, it is important to verify that the Layer is ready to be finalized. To be ready for finalization, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the Shutdown For Finalize tool (icon below), which appears on the Packaging Machine's desktop.  
![](Resources/Images/shutdown_for_finalize.png)
To use the Shutdown For Finalize tool:
<ol>            <li>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</li>            <li>Double-click the <i>Shutdown For Finalize</i> icon. A command line window displays messages detailing the layer verification process. </li>            <li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation. For details, see <a href="layer_about_co4.htm#Verifyin"> Verifying Layers</a>.</li>            <li>                <p>If you are using KMS licensing, once any pending operations are complete, be sure to rearm KMS yet again <i>just before you shutdown</i>. First, enter this command to verify that the Rearm count is > 0:</p><pre>slmgr /dlv</pre>                <p>Then, rearm KMS:</p><pre>slmgr /rearm</pre>            </li>            <li>Double-click the <i>Shutdown For Finalize</i> icon again to shut down the Packaging Machine. </li>        </ol>
The Layer should be ready to finalize.
###During the shutdown for finalization <a name="Layer_Integrity_Check"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:<a name="Layer_Integrity_Messages"></a>
<ul>            <ul>                <li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li>                <li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li>                <li>An MSI install operation is in progress - please check the Packaging Machine.</li>                <li>                    <p>A Microsoft NGen operation is in progress in the background. </p>                    <p><b>Note:</b> If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p>                </li>            </ul>        </ul>
###Expediting a Microsoft NGen operation <a name="Complete_MS_NGen_Operations"></a>
NGen is the Microsoft Native Image Generator.  It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them.  Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration.  When NGen is running, you must let it complete.  An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause. 
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol>            <li>                <p>Force an NGen operation to the foreground. </p>                <p>Normally, NGen is a background operation and will pause if there is foreground activity.  Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p>                <ol>                    <li>                        <p>Open a command prompt as Administrator.</p>                    </li>                    <li>                        <p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre>                    </li>                    <li>                        <p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre>                        <p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled. </p>                        <p><b>Note:</b> It’s okay if you see several compilation failed messages!</p>                    </li>                    <li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>.  Do <i>not</i> reboot to stop the task. You <i>must</i> allow it to complete.</li>                </ol>            </li>            <li>                <p>Check the status of an NGen operation</p>                <ol>                    <li>                        <p>Open a command prompt as Administrator.</p>                    </li>                    <li>                        <p>Check status by running this command:</p><pre>ngen queue status</pre>                    </li>                    <li>                        <p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre>                    </li>                </ol>            </li>        </ol>

##Finalize the Layer
To finalize the Layer, you import the installed software into the Platform Layer you prepared in the Unidesk Management Console (UMC). 
<ol>            <li>Return to the UMC.</li>            <li>Select <b>Layers > Platform Layers</b>.</li>            <li>Select <span>Finalize</span> in the Action bar.</li>            <li>Monitor the Task bar to verify that the action completes successfully and that the layer is deployable.</li>        </ol>

