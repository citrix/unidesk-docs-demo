[OS Layer](layer_os_co4)
 > In MS Azure
#Add a version to an OS Layer (Azure)
In this article:
[Before you start ](#Before)[        ](#Before)
[Add a Version to an OS Layer](#New)[        ](#New)
[Deploy a Packaging Machine](#Deploy)[        ](#Deploy)
[Install your changes](#Install)[        ](#Install)
[Verify the Layer and shut down the Packaging Machine](#Verify)[        ](#Verify)
[Finalize the OS Layer](#Finalize)[        ](#Finalize)
[Reference: Create OS Version Wizard values](#Create)[        ](#Create)
The Unidesk Operating System (OS) Layer contains the Windows Operating System that is assigned to any Unidesk Layered Images you create using that OS Layer. Once created, you can use the OS Layer to build as many Layered Images as you want.
The OS Layer includes a virtual machine in your infrastructure running the Unidesk-supported Windows Operating System that you want to use for your Layered Images.
##Before you start<a name="Before"></a>
Before you can create an OS Layer version, you'll need to:
<ul>            <li><a href="get_started_setup_fileshare_co4.htm">Configure a fileshare</a>            </li>        </ul>
##Add a version of an OS Layer<a name="New"></a>
To add a version of an OS Layer, take the following steps: 
<ol>            <li>                <p>In the Unidesk UMC, select <b>Layers > OS Layers.</b></p>            </li>            <li>                <p>Select or right-click an OS Layer icon and click <b>Add Version</b>. This opens the Create OS Version Wizard.</p>            </li>            <li>                <p>(Required) In the Version Details tab, enter a version identifier. This can be the application version, or anything you choose.  </p>            </li>            <li>                <p>In the Connector tab, select a <b>Connector Configuration</b> for the platform where you'll be publishing your Layered Images. If you have not yet created a Platform Connector configuration or if the configuration you need is not present, click <b>New</b> to create a new <a href="connector_config_fields_az4.htm">Connector Configuration</a> and select it from this list.</p>            </li>            <li>                <p>Packaging Disk tab - Specify the file name and format of the packaging disk. </p>            </li>            <li>                <p>Confirm and Complete tab - Verify your settings and click <b>Create Version</b>. Unidesk runs the task of creating a new OS version. When the task completes, it shows a status of Action Required and contains the following text: </p>                <p>"The Packaging Disk has been published to Azure. Click <u>here</u> to create a Packaging Machine and install your app. When the app installation is complete, finish creating the new Layer Version by clicking Finalize on the Action bar."</p>            </li>            <li>                <p>Expand the Tasks bar at the bottom of the UI, and double-click the Packaging Disk task. In the description, either Click here, or copy the link to Azure portal where the Packaging Disk has been published. Click the link in the task to open the Custom deployment window in Azure. Unidesk has pre-populated the fields of the Custom VM window with default values. Log into Azure and create the VM.</p>            </li>            <li>                <p>Log into the new VM and install any apps on it that you want to include in the new version of the OS, such as Windows Updates or anti-virus software.</p>                <p><a href="Resources/Images/layers_os_action_required.png"><img></img></a>                </p>            </li>        </ol>
Next, you can deploy a Packaging Machine for this OS Layer.
##Deploy a Packaging Machine<a name="Deploy"></a>
The Packaging Machine is a virtual machine where you install any applications or updates you want to include in this Layer. Typically, we recommend using a unique VM for each Layer.
###Azure environment
To deploy your Packaging Machine to Azure:
<ol>            <li>                <p>Click the link (shown in red below) in the Unidesk Management Console task to open the Azure portal to the Custom deployment area where you can create the virtual machine that you will use as your Unidesk Packaging Machine.</p>                <p><b>Note:</b> We recommend that you log into the Microsoft Azure account that has the same Subscription before clicking the link or pasting it into a browser.                </p>                <p><a href="Resources/Images/layers_os_action_required.png"><img></img></a>                </p>            </li>            <li>                <p>Complete the required fields for customizing your Azure parameters. </p>                <p><a href="Resources/Images/layers_app_pkg_machine_az.png"><img></img></a>                </p>            </li>        </ol>
Notes:
<ul>            <li>Unidesk does not recommend using less than two CPUs for the Packaging Machine. Consequently, the machine size must be at least A2.</li>            <li>On the Custom deployment panel, ensure that the value for the Resource Group location matches the Storage location you specified earlier.</li>        </ul>
##Install your changes <a name="Install"></a>
This section explains how to install your changes on the Packaging Machine you created in Azure.
To make changes to this version of the OSLayer:
<ol>            <li>                <p>Remote log into the Packaging Machine you created in Azure. </p>                <p><b>Note:</b> The User Name and Password to use when you log into the Packaging Machine are the same User Name and Password that were used when the OS Machine was created for the current OS Layer.</p>            </li>            <li>                <p>Install any updates or applications you want to include in the new OSLayer version, such as Windows Updates or anti-virus applications.</p>                <p>If an application installation requires a system restart, restart it manually. The Packaging Machine does not restart automatically.</p>            </li>            <li>                <p>Make sure the Packaging Machine is in the state you want it to be for the user:</p>                <ul>                    <li>If the applications you install require any post-installation setup or application registration, complete those steps now.  </li>                    <li>Remove any settings, configurations, files, mapped drives, or applications that you do not want to include on the Packaging Machine.</li>                </ul>            </li>        </ol>
Next, shut down the Packaging Machine when you have verified that the Layer is ready to finalize as described in the following section.
##Verify the Layer and shut down the Packaging Machine<a name="Verify"></a>
Once the application is installed on the Packaging Machine, the next step is to verify that the Layer is ready to be finalized. To be ready for finalization, any required post-installation processing needs to be completed. For example, a reboot may be required, or a Microsoft NGen process may need to complete.
To verify that any outstanding processes are complete, you can run the Shutdown For Finalize tool (icon below), which appears on the Packaging Machine's desktop.  
![](Resources/Images/shutdown_for_finalize.png)
To use the Shutdown For Finalize tool:
<ol>            <li>If you are not logged into the Packaging Machine, remote log in as the user who created the machine.</li>            <li>Double-click the <i>Shutdown For Finalize</i> icon. A command line window displays messages detailing the layer verification process. </li>            <li>If there is an outstanding operation that must be completed before the Layer can be finalized, you are prompted to complete the process. For example, if a Microsoft NGen operation needs to complete, you may be able to expedite the NGen operation, as detailed <a href="#Layer_Integrity_Check">below</a>.</li>            <li>Once any pending operations are complete, double-click the <i>Shutdown For Finalize</i> icon again. This shuts down the Packaging Machine. </li>        </ol>
The Layer is now ready to finalize.
###Layer integrity messages you may see during <a name="Layer_Integrity_Check"></a>
Layer integrity messages let you know what queued tasks must be completed before a Layer is finalized.
The new Layer or Version can only be finalized when the following conditions have been addressed:<a name="Layer_Integrity_Messages"></a>
<ul>            <ul>                <li>A reboot is pending to update drivers on the boot disk - please check and reboot the Packaging Machine.</li>                <li>A post-installation reboot is pending - please check and reboot the Packaging Machine.</li>                <li>An MSI install operation is in progress - please check the Packaging Machine.</li>                <li>                    <p>A Microsoft NGen operation is in progress in the background. </p>                    <p>Note: If a Microsoft NGen operation is in progress, you may be able to expedite it, as described in the next section.</p>                </li>            </ul>        </ul>
###Expediting a Microsoft NGen operation <a name="Complete_MS_NGen_Operations"></a>
NGen is the Microsoft Native Image Generator.  It is part of the .NET system, and basically re-compiles .NET byte code into native images and constructs the registry entries to manage them.  Windows will decide when to run NGen, based on what is being installed and what Windows detects in the configuration.  When NGen is running, you must let it complete.  An interrupted NGen operation can leave you with non-functioning .NET assemblies or other problems in the .NET system.
You have the choice of waiting for the NGen to complete in the background, or you can force the NGen to the foreground. You can also check the status of the NGen operation, as described below. However, every time you check the queue status, you are creating foreground activity, which might cause the background processing to temporarily pause. 
Forcing the NGen to the foreground will allow you to view the progress and once the output has completed, you should be able to finalize the layer.
<ol>            <li>                <p>Force an NGen operation to the foreground. </p>                <p>Normally, NGen is a background operation and will pause if there is foreground activity.  Bringing the task into the foreground can help the task to complete as quickly as possible. To do this:</p>                <ol>                    <li>                        <p>Open a command prompt as Administrator.</p>                    </li>                    <li>                        <p>Go to the Microsoft .NET Framework directory for the version currently in use:</p><pre>cd C:\Windows\Microsoft.NET\FrameworkNN\vX.X.XXXXX</pre>                    </li>                    <li>                        <p>Enter the NGen command to execute the queued items:</p><pre>ngen update /force</pre>                        <p>This brings the NGen task to the foreground in the command prompt, and lists the assemblies being compiled. </p>                        <p><b>Note:</b> It’s okay if you see several compilation failed messages!</p>                    </li>                    <li>Look in the Task Manager to see if an instance of MSCORSVW.EXE is running. If it is, you must allow it to complete, or re-run <span>ngen update /force</span>.  Do <i>not</i> reboot to stop the task. You <i>must</i> allow it to complete.</li>                </ol>            </li>            <li>                <p>Check the status of an NGen operation</p>                <ol>                    <li>                        <p>Open a command prompt as Administrator.</p>                    </li>                    <li>                        <p>Check status by running this command:</p><pre>ngen queue status</pre>                    </li>                    <li>                        <p>When you receive the following status, the NGen is complete, and you can finalize the Layer.</p><pre>The .NET Runtime Optimization Service is stopped</pre>                    </li>                </ol>            </li>        </ol>
##Finalize the OS Layer<a name="Finalize"></a>
Once the Packaging Machine is created and any apps or updates installed, you'll need to finalize the layer.
Note: When you finalize a new version of an OS Layer, Unidesk deletes the Packaging Machine so as not to incur more costs. 
When a layer is ready to finalize:
<ol>            <li>                <p>Return to the Unidesk Management Console.</p>            </li>            <li>                <p>In the Layers module, select the layer.</p>            </li>            <li>                <p>Select <b>Finalize</b> in the Action bar.</p>            </li>            <li>                <p>Monitor the Task bar to verify that the action completes successfully and that the layer is deployable.</p>            </li>        </ol>
##Reference: Create OS Version Wizard values<a name="Create"></a>
<ul>            <li>                <p><i>Version</i> - (Required) This can be the version of the OS Layer or a version you assign to the Layer. This value is displayed in the Details view of the Layer.</p>            </li>            <li><i>Version Description</i> - (Optional) Enter a description of the version.</li>            <li><i>Max Layer Size</i> - (Optional) Maximum layer size in gigabytes. Layers are <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/dn265487(v=vs.85).aspx">thin provisioned</a>, and will grow as needed, up to the maximum size. The default Max Layer Size is 100 gigabytes. If the version you are creating could requires more space, change this to a realistic value.</li>            <li><i>Select a Platform Connector configuration</i> - (Required) Specify a Unidesk Platform Connector for the platform where you'll be publishing your Layered Images. For example, if you're publishing to Azure RD Session Host, select the Azure RDSH connector with the credentials required to access the account. If the configuration you need is not listed, add a <b>New</b> one and select it from this list. If you want to change the settings of a Platform Connector configuration, select it and click <b>Edit</b>.</li>            <li><i>Packaging Disk Filename</i> - (Required) The name of the Packaging Machine you created in Azure.</li>        </ul>

